<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { 
    background-color: #f8f9fa; 
    -webkit-print-color-adjust: exact;
}

/* --- กำหนดขนาดกระดาษ A4 --- */
@page {
    size: A4 portrait;
    margin: 0.3cm;
}

/* --- กล่อง page --- */
.page {
    page-break-after: avoid !important; /* ป้องกันตัดหน้าหลังสุดท้าย */
    page-break-before: avoid !important; /* ป้องกันตัดก่อนหน้าแรก */    
    width: 21cm; 
    min-height: 29.7cm;    
    width: 100%;
    margin: 0 auto;
    background: white;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    box-sizing: border-box;
    padding: 0;
}

/* --- ตารางทั่วไป --- */
table { 
    table-layout: fixed;  
    width: 100%;          
    border-collapse: collapse;
    font-size: clamp(10pt, 0.8vw, 12pt);  
}

th, td { 
    border: 1px solid #000 !important;
    vertical-align: middle;
    padding: 2px;
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.1;
}

/* --- ความกว้างคอลัมน์พื้นฐาน --- */
th:nth-child(1), td:nth-child(1) { width: 5%; }   
th:nth-child(2), td:nth-child(2) { width: 10%; }  
th:nth-child(3), td:nth-child(3) { width: 25%; }  

/* --- คอลัมน์ KPA และช่องเล็ก --- */
.kpa-col { width: 5px; }

/* --- หมุนข้อความ --- */
.rotated-text { 
    writing-mode: vertical-rl; 
    text-orientation: mixed; 
    transform: rotate(180deg); 
    white-space: nowrap; 
}

/* --- การพิมพ์ --- */
@media print {
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .no-print {
        display: none;
    }

    .page {
        transform: scale(0.95); 
        transform-origin: top center;
        width: 100%;
        height: auto;
        box-shadow: none;
        border: none;        
        page-break-after: avoid;
        page-break-before: avoid;
    }

    table {
        font-size: clamp(8pt, 0.8vw, 10pt);
        page-break-inside: avoid !important;  /* ห้ามตัดตาราง */
        border-collapse: collapse !important;        
    }

    tr, td, th {
        page-break-inside: avoid !important;  /* ห้ามตัดแถว */
        white-space: nowrap;
        padding: 1px !important;
    }
    body::after {
    display: none !important;
    content: none !important;
  }
}
</style>
</head>
<body>
    <div class="container-fluid no-print text-center my-3">
        <a href="{{ url_for('course.manage_course', course_id=course.id) }}" class="btn btn-secondary"> &laquo; กลับ</a>
        <button onclick="window.print()" class="btn btn-primary">พิมพ์รายงาน</button>
    </div>

    <div class="container-fluid no-print mb-3">
        <form method="GET" id="filter-form" class="row g-3 align-items-center justify-content-center">
            <div class="col-auto"><label class="col-form-label">เลือกห้องเรียนเพื่อแสดงรายงาน:</label></div>
            <div class="col-auto">
              <select class="form-select form-select-sm" name="class_group_id" onchange="this.form.submit()">
                  <option value="">-- กรุณาเลือก --</option>
                  {% for class_group in class_groups %}
                      <option value="{{ class_group.id }}" {% if class_group.id == selected_class_group_id %}selected{% endif %}>
                          {{ class_group.grade_level.name }} / ห้อง {{ class_group.room_number }}
                      </option>
                  {% endfor %}
              </select>
            </div>
        </form>
    </div>

    {% if selected_class_group_id and students %}
        
        <!-- บันทึกเวลาเรียน -->
        <div class="page page-break-after">
            <h5 class="text-center fw-bold mt-4">บันทึกเวลาเรียน</h5>
            <h6 class="text-center">{{ school_name }}</h6>
            <p class="text-center mb-1">
                รายวิชา <strong>{{ course.subject.name }} ({{ to_thai_numerals(course.subject.subject_code) }})</strong>
                กลุ่มสาระการเรียนรู้ <strong>{{ course.subject.department }}</strong>
            </p>
            <p class="text-center">
                ภาคเรียนที่ {{ to_thai_numerals(course.semester) }} ปีการศึกษา {{ to_thai_numerals(course.academic_year) }} | ชั้น <strong>{{ to_thai_numerals(students[0].class_group.grade_level.name) }}/{{ to_thai_numerals(students[0].class_group.room_number) }}</strong>
            </p>
<table class="table table-bordered text-center">
    <thead class="table-light">
        <tr>
            <th rowspan="2">เลขที่</th>
            <th rowspan="2">เลขประจำตัว</th>
            <th rowspan="2">ชื่อ – สกุล</th>
            <th colspan="20">สัปดาห์ที่</th>
            <th rowspan="2" class="rotated-text" style="width: 5%;">สรุปเวลาเรียน</th>
            <th rowspan="2" class="rotated-text" style="width: 5%;">สถานะ</th>
        </tr>
        <tr>
            {% for i in range(1, 21) %}
                <th>{{ to_thai_numerals(i) }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for student in students %}
        {% set summary = student_summary.get(student.id, {}) %}
        {% set student_att = attendance_grid.get(student.id, {}) %}
        {% set att_summary = attendance_summary.get(student.id, {}) %}
        <tr>
            <td>{{ to_thai_numerals(student.class_number) }}</td>
            <td>{{ to_thai_numerals(student.student_id) }}</td>
            <td class="text-start">{{ student.prefix }}{{ student.first_name }} {{ student.last_name }}</td>
            {% for i in range(1, 21) %}
                <td>{{ student_att.get(i, '') }}</td>
            {% endfor %}
            <td>{{ to_thai_numerals(att_summary.get('มา', 0)) }}</td>
            <td>{{ summary.get('attendance_status', '') }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
        </div>

        <!-- บันทึกคะแนนรายหน่วยการเรียนรู้ -->
        {% for component_chunk in all_components|batch(3) %}
        <div class="page page-break-after">
            <h5 class="text-center fw-bold">บันทึกคะแนนรายหน่วยการเรียนรู้ {% if not loop.first %}(ต่อ){% endif %}</h5>
            <h6 class="text-center">{{ school_name }}</h6>
            <p class="text-center mb-1">
                รายวิชา <strong>{{ course.subject.name }} ({{ to_thai_numerals(course.subject.subject_code) }})</strong>
                กลุ่มสาระการเรียนรู้ <strong>{{ course.subject.department }}</strong>
            </p>
            <p class="text-center">
                ภาคเรียนที่ {{ to_thai_numerals(course.semester) }} ปีการศึกษา {{ to_thai_numerals(course.academic_year) }} | ชั้น <strong>{{ to_thai_numerals(students[0].class_group.grade_level.name) }}/{{ to_thai_numerals(students[0].class_group.room_number) }}</strong>
            </p>
            <table class="table table-bordered text-center">
                 <thead class="table-light">
                    <tr>
                        <th rowspan="2">เลขที่</th>
                        <th rowspan="2">เลขประจำตัว</th>
                        <th rowspan="2">ชื่อ – สกุล</th>
                        <th rowspan="2" class="rotated-text" style="width: 5%;">สถานะเวลาเรียน</th>
                        {% for comp in component_chunk %}
                            <th colspan="3">{{ comp.name }} ({{ to_thai_numerals(comp.max_score_k + comp.max_score_p + comp.max_score_a) }})</th>
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for comp in component_chunk %}
                            <th class="kpa-col">K</th>
                            <th class="kpa-col">P</th>
                            <th class="kpa-col">A</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    {% set summary = student_summary.get(student.id, {}) %}
                    <tr>
                        <td>{{ to_thai_numerals(student.class_number) }}</td>
                        <td>{{ to_thai_numerals(student.student_id) }}</td>
                        <td class="text-start">{{ student.prefix }}{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ summary.get('attendance_status', '') }}</td>
                        {% for comp in component_chunk %}
                            {% set score = scores_dict.get(student.id ~ '-' ~ comp.id) %}
                            <td>{{ to_thai_numerals(score.points_k if score and score.points_k is not none else '') }}</td>
                            <td>{{ to_thai_numerals(score.points_p if score and score.points_p is not none else '') }}</td>
                            <td>{{ to_thai_numerals(score.points_a if score and score.points_a is not none else '') }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}

        <!-- ปถ.๐๕ -->
        <div class="page page-break-after">
            <h5 class="text-center fw-bold">แบบบันทึกผลการเรียนประจำรายวิชา (ปถ.๐๕)</h5>
            <h6 class="text-center">{{ school_name }}</h6>
            <p class="text-center mb-1">
                รายวิชา <strong>{{ course.subject.name }} ({{ to_thai_numerals(course.subject.subject_code) }})</strong>
                กลุ่มสาระการเรียนรู้ <strong>{{ course.subject.department }}</strong>
            </p>
            <p class="text-center">
                ภาคเรียนที่ {{ to_thai_numerals(course.semester) }} ปีการศึกษา {{ to_thai_numerals(course.academic_year) }} | ชั้น <strong>{{ to_thai_numerals(students[0].class_group.grade_level.name) }}/{{ to_thai_numerals(students[0].class_group.room_number) }}</strong>
            </p>
            <table class="table table-bordered text-center">
                <thead class="table-light">
                    <tr>
                        <th rowspan="2">เลขที่</th>
                        <th rowspan="2">เลขประจำตัว</th>
                        <th rowspan="2">ชื่อ – สกุล</th>
                        <th rowspan="2" class="rotated-text">สถานะเวลาเรียน</th>
                        <th class="rotated-text">คะแนนระหว่างภาค</th>
                        {% if final_exam_ratio > 0 %}
                        <th class="rotated-text">คะแนนปลายภาค</th>
                        {% endif %}
                        <th class="rotated-text">คะแนนรวม</th>
                        <th class="rotated-text">เกรด</th>
                        <th rowspan="2">คุณลักษณะ</th>
                        <th rowspan="2">อ่านคิดวิเคราะห์</th>
                        <th rowspan="2">สมรรถนะ</th>
                    </tr>
                    <tr>
                        <th>({{ to_thai_numerals(coursework_ratio) }})</th>
                        {% if final_exam_ratio > 0 %}
                        <th>({{ to_thai_numerals(final_exam_ratio) }})</th>
                        {% endif %}
                        <th>(๑๐๐)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    {% set summary = student_summary.get(student.id, {}) %}
                    <tr>
                        <td>{{ to_thai_numerals(student.class_number) }}</td>
                        <td>{{ to_thai_numerals(student.student_id) }}</td>
                        <td class="text-start">{{ student.prefix }}{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ summary.get('attendance_status', '') }}</td>
                        <td>{{ to_thai_numerals(summary.get('coursework_weighted', 0) | round(2)) }}</td>
                        {% if final_exam_ratio > 0 %}
                        <td>{% if max_final > 0 %}{{ to_thai_numerals(summary.get('final_weighted', 0) | round(2)) }}
            {% else %}
                <span class="text-danger">N/A</span>
            {% endif %}                            
                        </td>
                        {% endif %}
                        <td class="fw-bold">{{ to_thai_numerals(summary.get('total_score_100', 0) | round(0)) }}</td>
                        <td class="fw-bold">{{ to_thai_numerals(summary.get('grade', '')) }}
                                        {% if summary.get('was_remediated') %}
                                        <span title="มีการแก้ไขผลการเรียน">*</span>
                                        {% endif %}
                        </td>
                        <td>{{ summary.get('attributes_grade', '') }}</td>
                        <td>{{ summary.get('reading_grade', '') }}</td>
                        <td>{{ summary.get('competency_grade', '') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
    {% elif not selected_class_group_id and class_groups|length > 0 %}
        <div class="container no-print mt-4">
            <div class="alert alert-info">กรุณาเลือกห้องเรียนเพื่อแสดงรายงาน</div>
        </div>
    {% endif %}
</body>
</html>
