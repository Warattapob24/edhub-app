# run.py (ฉบับแก้ไขลำดับ)

import click, csv, re
import pandas as pd
from app import create_app, db
from app.models import (
    User, Role, Student, Course, CourseComponent, Score, ActivityLog,
    Subject, GradeLevel, ClassGroup, EvaluationTopic, AdditionalAssessment,
    AttendanceRecord, Setting, Room, SchedulingRule
)

# --- ย้ายบรรทัดนี้ขึ้นมาไว้บนสุด ---
app = create_app()

@app.shell_context_processor
def make_shell_context():
    return {
        'db': db, 'User': User, 'Role': Role, 'Student': Student, 'Course': Course,
        'CourseComponent': CourseComponent, 'Score': Score, 'ActivityLog': ActivityLog,
        'Subject': Subject, 'GradeLevel': GradeLevel, 'ClassGroup': ClassGroup,
        'EvaluationTopic': EvaluationTopic, 'AdditionalAssessment': AdditionalAssessment,
        'AttendanceRecord': AttendanceRecord, 'Setting': Setting, 'Room': Room
    }

def some_function():
    # 1. First, get a specific rule object from the database
    a_specific_rule = SchedulingRule.query.get(1) # Get the rule with ID=1

    # 2. Then, you can access its properties
    if a_specific_rule:
        the_id = a_specific_rule.course_id
        print(f"The Course ID for this rule is: {the_id}")

@app.cli.command("seed-evaluations")
def seed_evaluations():
    """Adds standard evaluation topics to the database."""
    print("Seeding evaluation topics...")
    
    # ล้างข้อมูลเก่า
    EvaluationTopic.query.delete()
    db.session.commit()

    topics_data = {
        'คุณลักษณะอันพึงประสงค์': {
            'รักชาติ ศาสน์ กษัตริย์': ['เป็นพลเมืองดีของชาติ', 'ธำรงไว้ซึ่งความเป็นชาติไทย', 'ศรัทธา ยึดมั่น และปฏิบัติตนตามหลักของศาสนา', 'เคารพเทิดทูนสถาบันพระมหากษัตริย์'],
            'ซื่อสัตย์สุจริต': ['ประพฤติตรงตามความเป็นจริงต่อตนเองทั้งทางกาย วาจา ใจ', 'ประพฤติตรงตามความเป็นจริงต่อผู้อื่นทั้งทางกาย วาจา ใจ'],
            'มีวินัย': ['ปฏิบัติตามข้อตกลง กฎเกณฑ์ ระเบียบ ข้อบังคับของครอบครัว โรงเรียน และสังคม'],
            'ใฝ่เรียนรู้': ['ตั้งใจ เพียรพยายามในการเรียน และเข้าร่วมกิจกรรมการเรียนรู้', 'แสวงหาความรู้จากแหล่งเรียนรู้ต่างๆ'],
            'อยู่อย่างพอเพียง': ['ดำเนินชีวิตอย่างพอประมาณ มีเหตุผล รอบคอบ มีคุณธรรม', 'มีภูมิคุ้มกันในตัวที่ดี ปรับตัวเพื่ออยู่ในสังคมได้อย่างมีความสุข'],
            'มุ่งมั่นในการทำงาน': ['ตั้งใจและรับผิดชอบในการปฏิบัติหน้าที่การงาน', 'ทำงานด้วยความเพียรพยายาม และอดทนเพื่อให้งานสำเร็จตามเป้าหมาย'],
            'รักความเป็นไทย': ['ภาคภูมิใจในขนบธรรมเนียมประเพณี ศิลปะ วัฒนธรรมไทย และมีความกตัญญูกตเวที', 'เห็นคุณค่าและใช้ภาษาไทยในการสื่อสาร', 'อนุรักษ์และสืบทอดภูมิปัญญาไทย'],
            'มีจิตสาธารณะ': ['ช่วยเหลือผู้อื่นด้วยความเต็มใจโดยไม่หวังผลตอบแทน', 'เข้าร่วมกิจกรรมที่เป็นประโยชน์ต่อโรงเรียน ชุมชน และสังคม']
        },
    'สมรรถนะ': {
        'สมรรถนะการจัดการตนเอง': [],
        'สมรรถนะการคิดขั้นสูง': [],
        'สมรรถนะการสื่อสาร': [],
        'สมรรถนะการรวมพลังทำงานเป็นทีม': [],
        'สมรรถนะการเป็นพลเมืองที่เข้มแข็ง': [],
        'สมรรถนะการอยู่ร่วมกับธรรมชาติและวิทยาการอย่างยั่งยืน': []
    },
    'การอ่าน คิดวิเคราะห์ และเขียน': {
    'การอ่าน': [
        'อ่านเพื่อหาข้อมูลและสารสนเทศ',
        'จับประเด็นสำคัญจากเรื่องที่อ่าน',
        'ประเมินความน่าเชื่อถือของสิ่งที่อ่าน'
    ],
    'การคิดวิเคราะห์': [
        'วิเคราะห์และตีความข้อมูล',
        'เชื่อมโยงความรู้และประสบการณ์',
        'แสดงความคิดเห็นและเสนอแนวทางแก้ปัญหา'
    ],
    'การเขียน': [
        'เขียนถ่ายทอดความเข้าใจและความคิด',
        'เขียนแสดงความคิดเห็นพร้อมเหตุผล',
        'เขียนถูกต้องตามหลักภาษา'
    ]
}
}

    for assessment_type, main_topics in topics_data.items():
        main_order = 1
        for main_name, sub_names in main_topics.items():
            main_topic = EvaluationTopic(
                assessment_type=assessment_type,
                name=main_name,
                display_order=main_order
            )
            db.session.add(main_topic)
            print(f"Added Main: {main_name}")
            db.session.flush()

            sub_order = 1
            for sub_name in sub_names:
                sub_topic = EvaluationTopic(
                    assessment_type=assessment_type,
                    name=sub_name,
                    display_order=sub_order,
                    parent_id=main_topic.id
                )
                db.session.add(sub_topic)
                print(f"  - Added Sub: {sub_name}")
                sub_order += 1
            main_order += 1
            
    db.session.commit()
    print("Seeding complete!")

    pass

@app.cli.command("seed-subjects")
def seed_subjects():
    """Adds a list of standard subjects to the database."""
    print("Seeding subjects...")
    subjects_list = [
        # ม.ต้น
        {'code': 'ศ20201', 'name': 'ศิลปะกับธรรมชาติ (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ21101', 'name': 'ทัศนศิลป์ 1', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ21102', 'name': 'ดนตรี 1', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ21103', 'name': 'นาฏศิลป์ 1', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ22101', 'name': 'ทัศนศิลป์ 2', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ22102', 'name': 'ดนตรี 2', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ22103', 'name': 'นาฏศิลป์ 2', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ23101', 'name': 'ทัศนศิลป์ 3', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ23102', 'name': 'ดนตรี 3', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ23103', 'name': 'นาฏศิลป์ 3', 'dept': 'ศิลปะ', 'credits': 0.5},
        # ม.ปลาย
        {'code': 'ศ30201', 'name': 'จิตรกรรม (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30202', 'name': 'ประติมากรรม (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30203', 'name': 'ศิลปะไทย (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30204', 'name': 'การออกแบบ (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30205', 'name': 'ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30206', 'name': 'ปฏิบัติการเครื่องดนตรีสากล (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ30207', 'name': 'นาฏศิลป์ไทย (เพิ่มเติม)', 'dept': 'ศิลปะ', 'credits': 1.0},
        {'code': 'ศ31101', 'name': 'ทัศนศิลป์ 1', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ31102', 'name': 'ดนตรี 1', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ32101', 'name': 'นาฏศิลป์ 1', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ32102', 'name': 'ทัศนศิลป์ 2', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ33101', 'name': 'ดนตรี 2', 'dept': 'ศิลปะ', 'credits': 0.5},
        {'code': 'ศ33102', 'name': 'นาฏศิลป์ 2', 'dept': 'ศิลปะ', 'credits': 0.5},
    ]
    for s in subjects_list:
        exists = Subject.query.filter_by(subject_code=s['code']).first()
        if not exists:
            subject = Subject(
                subject_code=s['code'],
                name=s['name'],
                department=s['dept'],
                default_credits=s['credits']
            )
            db.session.add(subject)
            print(f"Added: {s['code']} - {s['name']}")
    db.session.commit()
    print("Subject seeding complete!")

    pass

@app.cli.command("import-teachers")
def import_teachers_command():
    """คาถาสำหรับอ่านไฟล์ CSV แล้วสร้างบัญชีครูทั้งหมด"""
    try:
        df = pd.read_csv('รายชื่อครู.csv', encoding='cp874')
        print(f"พบรายชื่อครู {len(df)} ท่านในม้วนคัมภีร์...")

        roles = {role.key: role for role in Role.query.all()}
        if 'teacher' not in roles:
            print("!!! คำเตือน: ไม่พบบทบาท 'teacher', จะสร้างขึ้นใหม่")
            roles['teacher'] = Role(key='teacher', label='ครูผู้สอน')
            db.session.add(roles['teacher'])
            db.session.commit()

        created_count = 0
        skipped_count = 0

        for index, row in df.iterrows():
            full_name = row['ชื่อสกุล']
            position = row['ตำแหน่ง']
            department = row.get('Unnamed: 3')

            if pd.isna(full_name):
                continue

            username = str(int(row['ลำดับ']))

            if User.query.filter_by(username=username).first():
                skipped_count += 1
                continue

            new_user = User(
                username=username,
                full_name=full_name.strip(),
                department=department if pd.notna(department) else None
            )
            new_user.set_password('123456')

            new_user.roles.append(roles['teacher']) # ทุกคนเป็นครูพื้นฐาน
            if 'หัวหน้า' in position and roles.get('manager'):
                new_user.roles.append(roles['manager'])
            if 'ผู้อำนวยการ' in position and roles.get('executive'):
                new_user.roles.append(roles['executive'])

            db.session.add(new_user)
            created_count += 1
        
        db.session.commit()
        print(f"✨ จารึกนามสำเร็จ! สร้างบัญชีใหม่ {created_count} ท่าน (ข้าม {skipped_count} ท่านที่มีอยู่แล้ว)")

    except Exception as e:
        db.session.rollback()
        print(f"!!! เกิดข้อผิดพลาดร้ายแรง: {e}")

@app.cli.command("seed-course-plan")
def seed_course_plan():
    """
    Import ข้อมูลแผนการสอนจาก Raw Text เข้าสู่ฐานข้อมูล
    """
    
    # ข้อมูลดิบที่คุณให้มาทั้งหมด
    raw_data = """
"ชื่อรายวิชา","รหัสวิชา","ชั้น","หน่วยกิต","ลำดับ","ชื่อหน่วยการเรียนรู้","มาตรฐานตัวชี้วัด/ผลการเรียนรู้","เรื่อง","จำนวนชั่วโมง","คะแนน K","คะแนน P","คะแนน A","การสอบ/คะแนน" 
"ศิลปะกับธรรมชาติ (เพิ่มเติม)","ศ20201","ม.ต้น","1.0","1","องค์ประกอบศิลป์กับงานจิตรกรรม มีทักษะและเทคนิคในการสร้างสรรค์งานจิตรกรรม","- หลักองค์ประกอบศิลป์ - เอกภาพ - ดุลยภาพ - จุดเด่น - ความกลมกลืน - ความขัดแย้ง","10","10","10","5","" 
"ศิลปะกับธรรมชาติ (เพิ่มเติม)","ศ20201","ม.ต้น","1.0","2","การวาดเส้น วาดภาพโดยใช้เทคนิคการวาดเส้น","- ความหมาย - การถ่ายทอดความคิดในการวาดเส้น - แบบเหมือนจริง - แบบตัดทอนรูปทรง - แบบจินตนาการ - แนวทางการวาดเส้น","10","10","10","5","" 
"ศิลปะกับธรรมชาติ (เพิ่มเติม)","ศ20201","ม.ต้น","1.0","3","การเขียนภาพสีชอล์ก วาดภาพโดยใช้เทคนิคการวาดภาพสีชอล์ก","- คุณลักษณะของสีชอล์ก, - การระบายสีชอล์ก, - การเขียนภาพคนด้วยสีชอล์ก, - การเขียนภาพทิวทัศน์ด้วยสีชอล์ก","10","10","10","5","" 
"ศิลปะกับธรรมชาติ (เพิ่มเติม)","ศ20201","ม.ต้น","1.0","4","การเขียนภาพสีโปสเตอร์","วาดภาพโดยใช้เทคนิคการวาดภาพสีโปสเตอร์","- คุณลักษณะของสีโปสเตอร์, - การระบายสีโปสเตอร์, - การเขียนภาพคนด้วยสีโปสเตอร์, - การเขียนภาพทิวทัศน์ด้วยสีโปสเตอร์","10","10","10","5","" 
"ทัศนศิลป์ 1","ศ21101","ม.1","1.0","1","หลักการออกแบบงานทัศนศิลป์","ศ ๑.๑ ม.๑/๔, ศ ๑.๑ ม.๑/๑, ศ ๑.๑ ม.๑/๒, ศ ๑.๑ ม.๑/๕","- เอกภาพความกลมกลืนของเรื่องราวในงานปั้นฯ, - ความแตกต่างและความคล้ายคลึงกันของทัศนธาตุฯ, - ความเป็นเอกภาพ ความกลมกลืน ความสมดุล, - การออกแบบรูปภาพ สัญลักษณ์ฯ","14","15","10","5","" 
"ทัศนศิลป์ 1","ศ21101","ม.1","1.0","2","ประเมินงานทัศนศิลป์","ศ ๑.๑ ม.๑/๓, ศ ๑.๑ ม.๑/๖","- หลักการวาดภาพแสดงทัศนียภาพ, - การประเมินงานทัศนศิลป์","10","10","5","5","" 
"ทัศนศิลป์ 1","ศ21101","ม.1","1.0","3","จุดประสงค์ในการสร้างสรรค์งานทัศนศิลป์","ศ ๑.๒ ม.๑/๓, ศ ๑.๒ ม.๑/๑, ศ ๑.๒ ม.๑/๒","- ความแตกต่างของงานทัศนศิลป์ วัฒนธรรมไทยและสากล, - ลักษณะ รูปแบบงานทัศนศิลป์ของชาติและท้องถิ่น, - งานทัศนศิลป์ภาคต่าง ๆ ในประเทศไทย","12","10","5","5","" 
"ทัศนศิลป์ 1","ศ21101","ม.1","1.0","","","","","2","","","","สอบกลางภาค/10" 
"ทัศนศิลป์ 1","ศ21101","ม.1","1.0","","","","","2","","","","สอบปลายภาค/20" 
"ดนตรี 1","ศ21102","ม.1","0.5","1","ทักษะทางดนตรี","ศ ๒.๑ ม.๑/๓, ศ ๒.๑ ม.๑/๑, ศ ๒.๑ ม.๑/๗, ศ ๒.๑ ม.๑/๘, ศ ๒.๑ ม.๑/๙","- การร้องและการบรรเลงฯ, - เครื่องหมายและสัญลักษณ์ทางดนตรี, - การนำเสนอบทเพลงที่ตนสนใจ, - การประเมินคุณภาพของบทเพลง, - การใช้และบำรุงรักษาเครื่องดนตรี","8","10","15","5","" 
"ดนตรี 1","ศ21102","ม.1","0.5","2","อารมณ์ทางดนตรี","ศ ๒.๑ ม.๑/๖, ศ ๒.๑ ม.๑/๒, ศ ๒.๑ ม.๑/๕","- การถ่ายทอดอารมณ์ของบทเพลง, - เสียงร้องและเสียงของเครื่องดนตรีฯ, - ความดัง-เบากับอารมณ์เพลง","5","10","5","5","" 
"ดนตรี 1","ศ21102","ม.1","0.5","3","ประเภทของวงดนตรี","ศ ๒.๒ ม.๑/๑, ศ ๒.๑ ม.๑/๔, ศ ๒.๒ ม.๑/๒","- บทบาทและอิทธิพลของดนตรี, - วงดนตรีพื้นเมือง, วงดนตรีไทย, วงดนตรีสากล, - องค์ประกอบของดนตรีในแต่ละวัฒนธรรม","5","10","5","5","" 
"ดนตรี 1","ศ21102","ม.1","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ดนตรี 1","ศ21102","ม.1","0.5","","","","","1","","","","สอบปลายภาค/20" 
"นาฏศิลป์ 1","ศ21103","ม.1","0.5","1","การผลิตการแสดงนาฏศิลป์","ศ ๓.๑ ม.๑/๔, ศ ๓.๑ ม.๑/๒, ศ ๓.๑ ม.๑/๓, ศ ๓.๑ ม.๑/๕","- บทบาทและหน้าที่ของฝ่ายต่าง ๆ, - นาฏยศัพท์หรือศัพท์ทางการละคร, - รูปแบบการแสดงนาฏศิลป์, - หลักในการชมการแสดง","10","15","20","5","" 
"นาฏศิลป์ 1","ศ21103","ม.1","0.5","2","ประเภทของละครไทย","ศ ๓.๒ ม.๑/๑, ศ ๓.๑ ม.๑/๑, ศ ๓.๒ ม.๑/๒","- ปัจจัยที่มีผลต่อการเปลี่ยนแปลงของนาฏศิลป์, - การปฏิบัติของผู้แสดงและผู้ชม, - ประเภทของละครไทยในแต่ละยุคสมัย","8","15","10","5","" 
"นาฏศิลป์ 1","ศ21103","ม.1","0.5","","","","","1","","","","สอบกลางภาค/10" 
"นาฏศิลป์ 1","ศ21103","ม.1","0.5","","","","","1","","","","สอบปลายภาค/20" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","1","ทัศนธาตุศิลป์","ศ ๑.๑ ม.๒/๒, ศ ๑.๑ ม.๒/๑","- ความเหมือนและความแตกต่างของรูปแบบการใช้วัสดุฯ, - รูปแบบของทัศนธาตุและแนวคิดในงานทัศนศิลป์","8","5","5","5","" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","2","การวิจารณ์งานทัศนศิลป์","ศ ๑.๑ ม.๒/๕, ศ ๑.๑ ม.๒/๓, ศ ๑.๑ ม.๒/๔","- การพัฒนางานทัศนศิลป์, - เทคนิคในการวาดภาพสื่อความหมาย, - การประเมินและวิจารณ์งานทัศนศิลป์","10","5","10","5","" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","3","ทัศนศิลป์ในการโฆษณา","ศ ๑.๑ ม.๒/๗, ศ ๑.๑ ม.๒/๖","- งานทัศนศิลป์ในการโฆษณา, - การวาดภาพถ่ายทอดบุคลิกลักษณะของตัวละคร","8","5","5","5","" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","4","ทัศนศิลป์ที่มาจากวัฒนธรรม","ศ ๑.๒ ม.๒/๓, ศ ๑.๒ ม.๒/๑, ศ ๑.๒ ม.๒/๒","- การออกแบบงานทัศนศิลป์ในวัฒนธรรมไทยและสากล, - วัฒนธรรมที่สะท้อนในงานทัศนศิลป์ปัจจุบัน, - งานทัศนศิลป์ของไทยในแต่ละยุคสมัย","10","10","5","5","" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","","","","","2","","","","สอบกลางภาค/10" 
"ทัศนศิลป์ 2","ศ22101","ม.2","1.0","","","","","2","","","","สอบปลายภาค/20" 
"ดนตรี 2","ศ22102","ม.2","0.5","1","การสร้างสรรค์งานดนตรี","ศ ๒.๑ ม.๒/๓","- ปัจจัยในการสร้างสรรค์บทเพลง","2","10","5","5","" 
"ดนตรี 2","ศ22102","ม.2","0.5","2","การพัฒนาการทักษะทางดนตรี","ศ ๒.๑ ม.๒/๑, ศ ๒.๑ ม.๒/๔, ศ ๒.๑ ม.๒/๒, ศ ๒.๑ ม.๒/๕, ศ ๒.๑ ม.๒/๖","- องค์ประกอบของดนตรีจากแหล่งวัฒนธรรมต่างๆ, - เทคนิคการร้องและบรรเลงดนตรี, - เครื่องหมายและสัญลักษณ์ทางดนตรี, - การบรรยายอารมณ์และความรู้สึก, - การประเมินความสามารถทางดนตรี","10","10","15","5","" 
"ดนตรี 2","ศ22102","ม.2","0.5","3","อาชีพนักดนตรี","ศ ๒.๑ ม.๒/๗","- อาชีพทางด้านดนตรี, - บทบาทของดนตรีในธุรกิจบันเทิง","2","5","5","0","" 
"ดนตรี 2","ศ22102","ม.2","0.5","4","บทบาทและอิทธิพลของดนตรี","ศ ๒.๒ ม.๒/๒, ศ ๒.๒ ม.๒/๑","- เหตุการณ์ประวัติศาสตร์กับการเปลี่ยนแปลงทางดนตรี, - ดนตรีในวัฒนธรรมต่างประเทศ","4","5","5","0","" 
"ดนตรี 2","ศ22102","ม.2","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ดนตรี 2","ศ22102","ม.2","0.5","","","","","1","","","","สอบปลายภาค/20" 
"นาฏศิลป์ 2","ศ22103","ม.2","0.5","1","การสร้างสรรค์การแสดงนาฏศิลป์","ศ ๓.๑ ม.๒/๒, ศ ๓.๑ ม.๒/๓, ศ ๓.๑ ม.๒/๔, ศ ๓.๑ ม.๒/๕, ศ ๓.๒ ม.๒/๒","- หลักและวิธีการสร้างสรรค์การแสดง, - หลักและวิธีการวิเคราะห์การแสดง, - วิธีการวิเคราะห์ วิจารณ์การแสดง, - ความสัมพันธ์ของนาฏศิลป์, - รูปแบบการแสดงประเภทต่างๆ","11","15","20","5","" 
"นาฏศิลป์ 2","ศ22103","ม.2","0.5","2","การบูรณาการนาฏศิลป์","ศ ๓.๒ ม.๒/๑, ศ ๓.๑ ม.๒/๑, ศ ๓.๒ ม.๒/๓","- นาฏศิลป์พื้นเมือง, - ศิลปะแขนงอื่นๆ กับการแสดง, - การละครสมัยต่างๆ","7","15","10","5","" 
"นาฏศิลป์ 2","ศ22103","ม.2","0.5","","","","","1","","","","สอบกลางภาค/10" 
"นาฏศิลป์ 2","ศ22103","ม.2","0.5","","","","","1","","","","สอบปลายภาค/20" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","1","การสร้างสรรค์งานทัศนศิลป์","ศ ๑.๑ ม.๓/๗, ศ ๑.๑ ม.๓/๑, ศ ๑.๑ ม.๓/๓, ศ ๑.๑ ม.๓/๑๐","- การประยุกต์ใช้ทัศนธาตุและหลักการออกแบบ, - ทัศนธาตุ หลักการออกแบบในสิ่งแวดล้อมฯ, - วิธีการใช้ทัศนธาตุและหลักการออกแบบฯ, - การประกอบอาชีพทางทัศนศิลป์","11","10","5","5","" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","2","ทักษะในการสร้างงานทัศนศิลป์","ศ ๑.๑ ม.๓/๑๑, ศ ๑.๑ ม.๓/๔, ศ ๑.๑ ม.๓/๙","- การจัดนิทรรศการ, - การสร้างงานทัศนศิลป์ทั้งไทยและสากล, - การใช้เทคนิค วิธีการที่หลากหลาย","8","5","5","5","" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","3","ทักษะในการผสมผสานงานทัศนศิลป์","ศ ๑.๑ ม.๓/๖, ศ ๑.๑ ม.๓/๕","- การสร้างงานทัศนศิลป์แบบ ๒ มิติ และ ๓ มิติ, - การใช้หลักการออกแบบในการสร้างงานสื่อผสม","6","5","5","5","" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","4","ทัศนศิลป์แต่ละวัฒนธรรม","ศ ๑.๒ ม.๓/๒, ศ ๑.๑ ม.๓/๒, ศ ๑.๑ ม.๓/๘, ศ ๑.๒ ม.๓/๑","- ความแตกต่างของงานทัศนศิลป์ในแต่ละยุคสมัย, - เทคนิควิธีการของศิลปิน, - การวิเคราะห์รูปแบบ เนื้อหา และคุณค่า, - งานทัศนศิลป์กับการสะท้อนคุณค่าของวัฒนธรรม","11","10","5","5","" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","","","","","2","","","","สอบกลางภาค/10" 
"ทัศนศิลป์ 3","ศ23101","ม.3","1.0","","","","","2","","","","สอบปลายภาค/20" 
"ดนตรี 3","ศ23102","ม.3","0.5","1","องค์ประกอบที่ใช้ในงานดนตรี","ศ ๒.๑ ม.๓/๓, ศ ๒.๑ ม.๓/๑, ศ ๒.๑ ม.๓/๔, ศ ๒.๑ ม.๓/๕, ศ ๒.๒ ม.๓/๒","- การประพันธ์เพลง, - การเปรียบเทียบองค์ประกอบในงานศิลปะ, - การเลือกใช้องค์ประกอบในการสร้างสรรค์บทเพลง, - การเปรียบเทียบความแตกต่างของบทเพลง, - ปัจจัยที่ทำให้งานดนตรีได้รับการยอมรับ","10","15","10","5","" 
"ดนตรี 3","ศ23102","ม.3","0.5","2","การบูรณาการดนตรี","ศ ๒.๑ ม.๓/๒, ศ ๒.๑ ม.๓/๗","- เทคนิคและการแสดงออกในการขับร้องและบรรเลง, - การจัดการแสดงดนตรีในวาระต่างๆ","4","5","10","5","" 
"ดนตรี 3","ศ23102","ม.3","0.5","3","วิวัฒนาการของดนตรี","ศ ๒.๒ ม.๓/๑, ศ ๒.๑ ม.๓/๖","- ประวัติดนตรีไทยและตะวันตก, - อิทธิพลของดนตรี","4","10","5","5","" 
"ดนตรี 3","ศ23102","ม.3","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ดนตรี 3","ศ23102","ม.3","0.5","","","","","1","","","","สอบปลายภาค/20" 
"นาฏศิลป์ 3","ศ23103","ม.3","0.5","1","ทักษะการแสดงนาฏศิลป์","ศ ๓.๑ ม.๓/๔, ศ ๓.๑ ม.๓/๑, ศ ๓.๑ ม.๓/๓, ศ ๓.๑ ม.๓/๗","- การประดิษฐ์ท่ารำและท่าทางประกอบ, - องค์ประกอบของบทละคร, - รูปแบบการแสดง, - ละครกับชีวิต","7","10","15","5","" 
"นาฏศิลป์ 3","ศ23103","ม.3","0.5","2","การวิจารณ์งานแสดงนาฏศิลป์","ศ ๓.๑ ม.๓/๕, ศ ๓.๑ ม.๓/๒, ศ ๓.๑ ม.๓/๖","- องค์ประกอบนาฏศิลป์, - ภาษาท่าหรือภาษาทางนาฏศิลป์, - วิธีการเลือกการแสดง","6","10","5","5","" 
"นาฏศิลป์ 3","ศ23103","ม.3","0.5","3","ความสำคัญของนาฏศิลป์ไทย","ศ ๓.๒ ม.๓/๒, ศ ๓.๒ ม.๓/๑, ศ ๓.๒ ม.๓/๓","- ความสำคัญและบทบาทของนาฏศิลป์, - การออกแบบและสร้างสรรค์อุปกรณ์, - การอนุรักษ์นาฏศิลป์","5","10","5","5","" 
"นาฏศิลป์ 3","ศ23103","ม.3","0.5","","","","","1","","","","สอบกลางภาค/10" 
"นาฏศิลป์ 3","ศ23103","ม.3","0.5","","","","","1","","","","สอบปลายภาค/20" 
"จิตรกรรม (เพิ่มเติม)","ศ30201","ม.ปลาย","1.0","1","การสร้างสรรค์งานจิตรกรรม","มีทักษะและเทคนิคในการสร้างสรรค์งานจิตรกรรม","เทคนิค วัสดุ อุปกรณ์ กระบวนการ","4","5","5","0","" 
"จิตรกรรม (เพิ่มเติม)","ศ30201","ม.ปลาย","1.0","2","การวาดเส้น","วาดภาพโดยใช้เทคนิคการวาดเส้น","การถ่ายทอดการวาดเส้น","8","5","10","5","" 
"จิตรกรรม (เพิ่มเติม)","ศ30201","ม.ปลาย","1.0","3","การเขียนภาพสีชอล์ก","วาดภาพโดยใช้เทคนิคการวาดภาพสีชอล์ก","คุณลักษณะของสีชอล์ก","8","5","10","5","" 
"จิตรกรรม (เพิ่มเติม)","ศ30201","ม.ปลาย","1.0","4","การเขียนภาพสีโปสเตอร์","วาดภาพโดยใช้เทคนิคการวาดภาพสีโปสเตอร์","คุณลักษณะของสีโปสเตอร์","10","10","10","5","" 
"จิตรกรรม (เพิ่มเติม)","ศ30201","ม.ปลาย","1.0","5","การเขียนภาพสีน้ำ","วาดภาพโดยใช้เทคนิคการวาดภาพสีน้ำ","การวาดภาพสีน้ำ","10","10","10","5","" 
"ประติมากรรม (เพิ่มเติม)","ศ30202","ม.ปลาย","1.0","1","มนุษย์กับงานประติมากรรม","อธิบายความแตกต่างของงานประติมากรรม","ประเภทของงานประติมากรรม","4","5","5","0","" 
"ประติมากรรม (เพิ่มเติม)","ศ30202","ม.ปลาย","1.0","2","ส่วนประกอบที่สำคัญในงานประติมากรรม","อธิบายขั้นตอนการสร้างผลงาน","ขั้นตอนการสร้างงานประติมากรรม","8","10","5","5","" 
"ประติมากรรม (เพิ่มเติม)","ศ30202","ม.ปลาย","1.0","3","การออกแบบงานประติมากรรมประเภทนูนต่ำหรือนูนสูง","สร้างสรรค์ผลงานประติมากรรมประเภทนูนต่ำหรือนูนสูง","หลักการปั้นงานประติมากรรม","12","10","15","5","" 
"ประติมากรรม (เพิ่มเติม)","ศ30202","ม.ปลาย","1.0","4","การปั้น","อธิบายลักษณะของงานประติมากรรม","ลักษณะของงานประติมากรรม","4","5","5","0","" 
"ประติมากรรม (เพิ่มเติม)","ศ30202","ม.ปลาย","1.0","5","การออกแบบงานประติมากรรมแบบ 2 มิติ และ 3 มิติ","สร้างสรรค์ผลงานประติมากรรมประเภทลอยตัว","หลักการปั้นงานประติมากรรมประเภทลอยตัว","12","10","15","5","" 
"ศิลปะไทย (เพิ่มเติม)","ศ30203","ม.ปลาย","1.0","1","การสร้างสรรค์งานศิลปะไทย","อธิบายการสร้างสรรค์งานศิลปะไทย","- การสร้างสรรค์งานศิลปะไทย, - แนวทางการสร้างสรรค์งานศิลปะไทย, - ลักษณะงานศิลปะไทย","4","5","5","0","" 
"ศิลปะไทย (เพิ่มเติม)","ศ30203","ม.ปลาย","1.0","2","เทคนิคการวาดภาพลายไทย","วาดภาพศิลปะไทย โดยการใช้เส้น รูปร่างรูปทรง","วิวัฒนาการของลายไทย","24","20","30","10","" 
"ศิลปะไทย (เพิ่มเติม)","ศ30203","ม.ปลาย","1.0","3","สถาปัตยกรรมไทย","บรรยายสถาปัตยกรรมไทย","ส่วนประกอบของ โบสถ์ วิหาร วัด","6","5","5","0","" 
"ศิลปะไทย (เพิ่มเติม)","ศ30203","ม.ปลาย","1.0","4","ทักษะการวาดภาพจิตรกรรมไทย","วาดภาพงานศิลปะไทย และลงสี","การวาดภาพงานศิลปะไทย","6","5","10","5","" 
"การออกแบบ (เพิ่มเติม)","ศ30204","ม.ปลาย","1.0","1","มนุษย์กับการออกแบบ","บรรยายความแตกต่างและคล้ายคลึงกัน","ความแตกต่างและความคล้ายคลึงกันของทัศนธาตุศิลป์","4","5","5","0","" 
"การออกแบบ (เพิ่มเติม)","ศ30204","ม.ปลาย","1.0","2","ส่วนประกอบที่สำคัญในการออกแบบ","อภิปรายส่วนประกอบที่สำคัญในการออกแบบ","ส่วนประกอบที่สำคัญในการออกแบบ","10","10","5","5","" .
"การออกแบบ (เพิ่มเติม)","ศ30204","ม.ปลาย","1.0","3","การออกแบบ","ระบุและบรรยายหลักการออกแบบ","หลักการออกแบบ","6","5","5","0","" 
"การออกแบบ (เพิ่มเติม)","ศ30204","ม.ปลาย","1.0","4","การออกแบบ กราฟิก","ออกแบบรูปภาพ สัญลักษณ์ หรือกราฟิกอื่นๆ","การออกแบบรูปภาพ สัญลักษณ์หรืองานกราฟิก","10","10","15","5","" 
"การออกแบบ (เพิ่มเติม)","ศ30204","ม.ปลาย","1.0","5","งานโฆษณา","บรรยายวิธีการใช้งานทัศนศิลป์ในการโฆษณา","งานทัศนศิลป์ในการโฆษณา","10","10","15","5","" 
"ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)","ศ30205","ม.ปลาย","1.0","1","ปฐมบทดนตรีไทย","1. บรรยายวิวัฒนาการ, 2. ระบุความหลากหลาย","- ประวัติดนตรีไทย, - องค์ประกอบดนตรีไทย","4","5","5","0","" 
"ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)","ศ30205","ม.ปลาย","1.0","2","วงดนตรีไทย","เปรียบเทียบรูปแบบของวงดนตรีไทย","หลักการผสมวงดนตรีไทย","4","5","5","0","" 
"ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)","ศ30205","ม.ปลาย","1.0","3","ทฤษฎีทางดนตรีไทย","ร้อง อ่าน เขียน โน้ตดนตรีไทย","การร้อง อ่าน เขียน โน้ตดนตรีไทย","8","10","5","5","" 
"ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)","ศ30205","ม.ปลาย","1.0","4","การแสดงดนตรีไทย","ร้องเพลง หรือเล่นดนตรีเดี่ยวและรวมวง","เทคนิคและการถ่ายทอดอารมณ์เพลง","16","10","20","10","" 
"ปฏิบัติการเครื่องดนตรีไทย (เพิ่มเติม)","ศ30205","ม.ปลาย","1.0","5","ทักษะเครื่องดนตรีไทย","1. สร้างเกณฑ์ในการประเมิน, 2. ใช้และบำรุงรักษา","- สร้างเกณฑ์ในการประเมิน, - การใช้และบำรุงรักษา","8","5","10","5","" 
"ปฏิบัติการเครื่องดนตรีสากล (เพิ่มเติม)","ศ30206","ม.ปลาย","1.0","1","ปฐมบทดนตรีสากล","1. จำแนกประเภท, 2. วิเคราะห์ประวัติ","- รูปแบบบทเพลงและวงดนตรี, - ประวัติสังคีตดนตรีตะวันตก","6","10","5","0","" 
"ปฏิบัติการเครื่องดนตรีสากล (เพิ่มเติม)","ศ30206","ม.ปลาย","1.0","2","ทฤษฎีทางดนตรีสากล","ร้อง อ่าน เขียนโน้ตดนตรีสากล","การร้อง อ่าน เขียนโน้ตดนตรีสากล","10","10","10","5","" 
"ปฏิบัติการเครื่องดนตรีสากล (เพิ่มเติม)","ศ30206","ม.ปลาย","1.0","3","การแสดงดนตรีสากล","ร้องเพลง หรือเล่นดนตรีสากล","เทคนิคและการถ่ายทอดอารมณ์เพลง","16","10","20","10","" 
"ปฏิบัติการเครื่องดนตรีสากล (เพิ่มเติม)","ศ30206","ม.ปลาย","1.0","4","ทักษะเครื่องดนตรีสากล","1. สร้างเกณฑ์ในการประเมิน, 2. ใช้และบำรุงรักษา","- สร้างเกณฑ์ในการประเมิน, - การใช้และบำรุงรักษา","8","5","10","5","" 
"นาฏศิลป์ไทย (เพิ่มเติม)","ศ30207","ม.ปลาย","1.0","1","ประวัติศิลปิน","อธิบายอิทธิพลของนักแสดง","1. การปฏิบัติตัวของผู้แสดง, 2. ประวัตินักแสดง, 3. การพัฒนารูปแบบ, 4. อิทธิพลของนักแสดง","4","10","5","5","" 
"นาฏศิลป์ไทย (เพิ่มเติม)","ศ30207","ม.ปลาย","1.0","2","นาฏศิลป์มาตรฐาน","ใช้นาฏยศัพท์หรือศัพท์ทางการละคร","1. นาฏยศัพท์, 2. ภาษาท่าและการตีบท, 3. การเคลื่อนไหว, 4. ระบำเบ็ดเตล็ด, 5. รำวงมาตรฐาน","20","10","15","5","" 
"นาฏศิลป์ไทย (เพิ่มเติม)","ศ30207","ม.ปลาย","1.0","3","การจัดการแสดง","1. ใช้ทักษะการทำงานเป็นกลุ่ม, 2. ใช้เกณฑ์ง่ายๆในการพิจารณา","1. การจัดการแสดง, 2. การสร้างสรรค์กิจกรรม, 3. หลักการชมการแสดง","12","10","15","5","" 
"นาฏศิลป์ไทย (เพิ่มเติม)","ศ30207","ม.ปลาย","1.0","4","วิวัฒนาการของนาฏศิลป์และละคร","1. ระบุปัจจัย, 2. บรรยายประเภท","1. การเปลี่ยนแปลงนาฏศิลป์, 2. ประเภทของละครไทย","4","10","5","5","" 
"ทัศนศิลป์ 1","ศ31101","ม.4","0.5","1","ศิลปะตะวันออกและตะวันตก","ศ1.2 ม.4-6/1, ศ1.2 ม.4-6/3","- ศิลปะอินเดีย, จีน, ตะวันตก, - ศิลปะกับวัฒนธรรม","9","20","10","5","" 
"ทัศนศิลป์ 1","ศ31101","ม.4","0.5","2","ทัศนธาตุและการออกแบบ","ศ1.1 ม.4-6/5, ศ1.1 ม.4-6/1, ศ1.1 ม.4-6/2, ศ1.1 ม.4-6/6","- หลักการออกแบบ, - ทัศนธาตุ, - จุดประสงค์ของงานทัศนศิลป์, - การออกแบบงานทัศนศิลป์","9","15","15","5","" 
"ทัศนศิลป์ 1","ศ31101","ม.4","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ทัศนศิลป์ 1","ศ31101","ม.4","0.5","","","","","1","","","","สอบปลายภาค/20" 
"ดนตรี 1","ศ31102","ม.4","0.5","1","ดนตรีแต่ละวัฒนธรรม","ศ ๒.๑ ม.๔-๖/๓, ศ ๒.๑ ม.๔-๖/๑, ศ ๒.๑ ม.๔-๖/๒, ศ ๒.๑ ม.๔-๖/๗","- ปัจจัยในการสร้างสรรค์ผลงานดนตรี, - การจัดวงดนตรี, - ประเภทของวงดนตรี, - การถ่ายทอดอารมณ์","10","20","15","5","" 
"ดนตรี 1","ศ31102","ม.4","0.5","2","ลักษณะของดนตรีไทยและสากล","ศ ๒.๒ ม.๔-๖/๓, ศ ๒.๒ ม.๔-๖/๑, ศ ๒.๒ ม.๔-๖/๒","- ลักษณะเด่นของดนตรีในแต่ละวัฒนธรรม, - รูปแบบบทเพลงและวงดนตรีไทย, - ประวัติสังคีตกวี","8","15","10","5","" 
"ดนตรี 1","ศ31102","ม.4","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ดนตรี 1","ศ31102","ม.4","0.5","","","","","1","","","","สอบปลายภาค/20" 
"นาฏศิลป์ 1","ศ32101","ม.5","0.5","1","การแสดงนาฏศิลป์","ศ ๓.๑ ม.๔-๖/๓, ศ ๓.๑ ม.๔-๖/๑, ศ ๓.๑ ม.๔-๖/๒","- การประดิษฐ์ท่ารำ, - รูปแบบของการแสดง, - ละครสร้างสรรค์","8","10","15","5","" 
"นาฏศิลป์ 1","ศ32101","ม.5","0.5","2","การประเมินการแสดงนาฏศิลป์","ศ ๓.๑ ม.๔-๖/๖, ศ ๓.๑ ม.๔-๖/๗","- เทคนิคการจัดการแสดง, - การประเมินคุณภาพของการแสดง","5","10","5","5","" 
"นาฏศิลป์ 1","ศ32101","ม.5","0.5","3","วิวัฒนาการของนาฏศิลป์","ศ ๓.๒ ม.๔-๖/๓, ศ ๓.๒ ม.๔-๖/๒","- วิวัฒนาการของนาฏศิลป์, - บุคคลสำคัญในวงการนาฏศิลป์","5","10","5","5","" 
"นาฏศิลป์ 1","ศ32101","ม.5","0.5","","","","","1","","","","สอบกลางภาค/10" 
"นาฏศิลป์ 1","ศ32101","ม.5","0.5","","","","","1","","","","สอบปลายภาค/20" 
"ทัศนศิลป์ 2","ศ32102","ม.5","0.5","1","สร้างสรรค์งานทัศนศิลป์","ศ1.1 ม.4-6/10, ศ1.1 ม.4-6/3, ศ1.1 ม.4-6/7, ศ1.2 ม.4-6/2","- สร้างสรรค์งานทัศนศิลป์ไทย/สากล, - วัสดุอุปกรณ์ทางทัศนศิลป์, - เนื้อหางานทัศนศิลป์, - งานทัศนศิลป์ของศิลปินที่มีชื่อเสียง","9","15","15","5","" 
"ทัศนศิลป์ 2","ศ32102","ม.5","0.5","2","วิจารณ์งานทัศนศิลป์","ศ1.1 ม.4-6/8, ศ1.1 ม.4-6/4, ศ1.1 ม.4-6/9, ศ1.1 ม.4-6/11","- วิจารณ์งานทัศนศิลป์, - เทคนิคสร้างงานทัศนศิลป์, - จัดทำแฟ้มสะสมงาน, - วาดภาพล้อเลียน","9","15","15","5","" 
"ทัศนศิลป์ 2","ศ32102","ม.5","0.5","","","","","1","","","","สอบกลางภาค/10" 
"ทัศนศิลป์ 2","ศ32102","ม.5","0.5","","","","","1","","","","สอบปลายภาค/20" 
"ดนตรี 2","ศ33101","ม.6","0.5","1","เทคนิคทางดนตรี","ศ ๒.๑ ม.๔-๖/๕, ศ ๒.๑ ม.๔-๖/๔, ศ ๒.๑ ม.๔-๖/๖","- เทคนิค และ การถ่ายทอดอารมณ์เพลง, - เครื่องหมายและสัญลักษณ์ทางดนตรี, - เกณฑ์ในการประเมินผลงานดนตรี","9","15","20","5","" 
"ดนตรี 2","ศ33101","ม.6","0.5","2","บทบาทของดนตรี","ศ ๒.๑ ม.๔-๖/๘, ศ ๒.๒ ม.๔-๖/๕, ศ ๒.๒ ม.๔-๖/๔","- ดนตรีกับการประยุกต์ใช้, - แนวทางในการส่งเสริมอนุรักษ์ดนตรีไทย, - บทบาทดนตรีในการสะท้อนสังคม","9","15","10","5","" 
"ดนตรี 2","ศ33101","ม.6","0.5","","","","","1","","","","สอบกลางภาค/10" "ดนตรี 2","ศ33101","ม.6","0.5","","","","","1","","","","สอบปลายภาค/20" "นาฏศิลป์ 2","ศ33102","ม.6","0.5","1","วิเคราะห์การแสดงนาฏศิลป์","ศ ๓.๑ ม.๔-๖/๕, ศ ๓.๑ ม.๔-๖/๔, ศ ๓.๑ ม.๔-๖/๘","- ประวัติความเป็นมาของนาฏศิลป์, - หลักการสร้างสรรค์และการวิจารณ์, - การสร้างสรรค์ผลงาน","11","20","15","5","" "นาฏศิลป์ 2","ศ33102","ม.6","0.5","2","การอนุรักษ์นาฏศิลป์ไทย","ศ ๓.๒ ม.๔-๖/๔, ศ ๓.๒ ม.๔-๖/๑","- การอนุรักษ์นาฏศิลป์, - การแสดงนาฏศิลป์ในโอกาสต่างๆ","7","15","10","5","" "นาฏศิลป์ 2","ศ33102","ม.6","0.5","","","","","1","","","","สอบกลางภาค/10" "นาฏศิลป์ 2","ศ33102","ม.6","0.5","","","","","1","","","","สอบปลายภาค/20"
    """
    
    # ใช้ io.StringIO เพื่อทำให้ string กลายเป็นเหมือนไฟล์
    data_file = io.StringIO(raw_data.strip())
    # ใช้ csv.reader เพื่ออ่านข้อมูล
    reader = csv.reader(data_file, delimiter=',', quotechar='"')
    
    # ข้ามหัวข้อ (header)
    header = next(reader)
    
    # Dictionary สำหรับเก็บ Subject ที่สร้างไปแล้ว เพื่อไม่ให้สร้างซ้ำ
    subjects_cache = {}

    def to_int_or_none(value):
        """ฟังก์ชันช่วยแปลง string เป็น int ถ้าแปลงไม่ได้จะคืนค่า None"""
        if not value:
            return None
        try:
            return int(value)
        except (ValueError, TypeError):
            return None

    print("🚀 เริ่มทำการ Import ข้อมูลแผนการสอน...")
    
    for row in reader:
        subject_name, subject_code, grade, credits, unit_order, unit_title, standards, topics, hours, k, p, a, exam_info = row
        
        # --- 1. จัดการข้อมูลรายวิชา (Subject) ---
        current_subject = subjects_cache.get(subject_code)
        if not current_subject:
            # ถ้ายังไม่เคยเจอรายวิชานี้ ให้ค้นหาใน DB หรือสร้างใหม่
            current_subject = Subject.query.filter_by(code=subject_code).first()
            if not current_subject:
                print(f"  - สร้างรายวิชาใหม่: {subject_name} ({subject_code})")
                current_subject = Subject(
                    name=subject_name,
                    code=subject_code,
                    grade_level=grade,
                    credits=float(credits) if credits else None
                )
                db.session.add(current_subject)
            # เพิ่ม Subject ที่เจอเข้า cache เพื่อความรวดเร็ว
            subjects_cache[subject_code] = current_subject
            
        # --- 2. ตรวจสอบว่าเป็น "หน่วยการเรียนรู้" หรือ "การสอบ" ---
        if unit_order: # ถ้าคอลัมน์ "ลำดับ" มีข้อมูล = เป็นหน่วยการเรียนรู้
            print(f"    - เพิ่มหน่วยการเรียนรู้: '{unit_title}'")
            unit = LearningUnit(
                subject=current_subject,
                order=to_int_or_none(unit_order),
                title=unit_title,
                standards=standards,
                topics=topics,
                hours=to_int_or_none(hours),
                k_score=to_int_or_none(k),
                p_score=to_int_or_none(p),
                a_score=to_int_or_none(a)
            )
            db.session.add(unit)
        elif exam_info: # ถ้าคอลัมน์ "การสอบ/คะแนน" มีข้อมูล = เป็นการสอบ
            try:
                exam_name, exam_score = exam_info.split('/')
                print(f"    - เพิ่มการสอบ: '{exam_name}'")
                exam = Exam(
                    subject=current_subject,
                    name=exam_name,
                    score=to_int_or_none(exam_score),
                    hours=to_int_or_none(hours)
                )
                db.session.add(exam)
            except ValueError:
                print(f"    - *** ข้ามข้อมูลการสอบที่ผิดพลาด: {exam_info}")

    # --- 3. บันทึกข้อมูลทั้งหมดลงฐานข้อมูล ---
    db.session.commit()
    print("✅ ทำการ Import ข้อมูลทั้งหมดเรียบร้อยแล้ว!")

@app.cli.command("seed-all")
def seed_all_command():
    """คาถาสำหรับ Import ข้อมูลทั้งหมดจากไฟล์ CSVs (ฉบับปรับปรุง)"""

    try:
        with db.session.no_autoflush:
            # --- ลำดับการลบ (จากลูกไปหาพ่อ) ---
            delete_order = [CourseAssignment, Curriculum, Course, Subject, 
                            Room, ClassGroup, GradeLevel, User, Role, EvaluationTopic]
            print("--- Starting data cleanse ---")
            for model in delete_order:
                model.query.delete()
            db.session.commit()

            # --- ลำดับการเพิ่ม (จากพ่อไปหาลูก) ---
            import_order = [
                ('role.csv', Role, 'key'),
                ('user.csv', User, 'username'),
                ('grade_level.csv', GradeLevel, 'name'),
                ('room.csv', Room, 'name'),
                ('subject.csv', Subject, 'subject_code'),
                # ClassGroup ต้องใช้ key ที่ซับซ้อน
                # Curriculum, CourseAssignment ต้องจัดการแยก
            ]

            # --- ใช้ Pandas อ่านไฟล์ทั้งหมดเก็บไว้ใน memory ก่อน ---
            dataframes = {
                filename: pd.read_csv(filename).where(pd.notnull(df), None)
                for filename, _, _ in import_order if pd.io.common.file_exists(filename)
            }

            # --- สร้าง Mapping ของ ID เก่า -> ID ใหม่ ---
            id_maps = {}

            for filename, model_class, unique_key in import_order:
                if filename not in dataframes: continue

                print(f"Importing {model_name}...")
                id_maps[model_name] = {}

                for row in dataframes[filename].to_dict(orient='records'):
                    old_id = row.pop('id')
                    # (อาจต้องเพิ่ม Logic การสร้าง object ที่ซับซ้อนขึ้น)
                    record = model_class(**row)
                    db.session.add(record)
                    db.session.flush() # เพื่อให้ record.id พร้อมใช้งาน
                    id_maps[model_name][old_id] = record.id

            db.session.commit()
            print("Imported base data. Now handling relationships...")

            # --- จัดการความสัมพันธ์ที่ซับซ้อน ---
            # ClassGroup
            if 'export_classgroup.csv' in dataframes:
                df = dataframes['export_classgroup.csv']
                for row in df.to_dict(orient='records'):
                    row['grade_level_id'] = id_maps['GradeLevel'].get(row['grade_level_id'])
                    # (เพิ่ม logic สำหรับ advisors)
                    # ...

            # Curriculum
            if 'export_curriculum.csv' in dataframes:
                # ...

            # CourseAssignment
            if 'export_courseassignment.csv' in dataframes:
                df = dataframes['export_courseassignment.csv']
                for row in df.to_dict(orient='records'):
                    # แปลง ID เก่าเป็น ID ใหม่
                    row['curriculum_id'] = id_maps['Curriculum'].get(row['curriculum_id'])
                    row['teacher_id'] = id_maps['User'].get(row['teacher_id'])
                    row['class_group_id'] = id_maps['ClassGroup'].get(row['class_group_id'])

                    if all(row.values()): # ตรวจสอบว่า ID ทั้งหมดถูกต้อง
                        record = CourseAssignment(**row)
                        db.session.add(record)

            db.session.commit()

        print("✨ กู้คืนข้อมูลทั้งหมดสำเร็จ!")

    except Exception as e:
        db.session.rollback()
        print(f"!!! เกิดข้อผิดพลาดร้ายแรงระหว่างการกู้คืน: {e}")