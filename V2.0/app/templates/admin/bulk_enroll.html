{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Bulk Management)</h1>
        {% if active_year %}
            <span class="badge bg-primary fs-6">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: {{ active_year.year }}/{{ active_year.semester }}</span>
        {% endif %}
    </div>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <h5 class="card-title">‡∏¢‡πâ‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
            <div class="row align-items-end">
                <div class="col-md-8">
                    <label for="targetClassroom" class="form-label">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                    <select id="targetClassroom" class="form-select">
                        <option selected disabled>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --</option>
                        {% for grade in grade_levels %}
                            <optgroup label="{{ grade.name }}">
                                {% for classroom in grade.classrooms | sort(attribute='name') %}
                                <option value="{{ classroom.id }}">{{ classroom.name }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="moveStudentsBtn" class="btn btn-primary w-100">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢</button>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion" id="gradeLevelsAccordion">
        {% for grade in grade_levels %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ grade.id }}">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ grade.id }}">
                    <strong>{{ grade.name }}</strong>
                </button>
            </h2>
            <div id="collapse-{{ grade.id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" data-bs-parent="#gradeLevelsAccordion">
                <div class="accordion-body">
                    {% for classroom in grade.classrooms | sort(attribute='name') %}
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">‡∏´‡πâ‡∏≠‡∏á {{ classroom.name }}</h5>
                            <span class="badge bg-secondary">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {{ classroom.enrolled_students | length }} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-center" style="width: 5%;"><input type="checkbox" class="form-check-input" onchange="toggleAll(this, '{{ classroom.id }}')"></th>
                                        <th style="width: 20%;">Username</th>
                                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in classroom.enrolled_students %}
                                    <tr>
                                        <td class="text-center"><input type="checkbox" class="form-check-input student-checkbox" data-classroom="{{ classroom.id }}" value="{{ student.id }}"></td>
                                        <td>{{ student.username }}</td>
                                        <td>{{ student.full_name }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ --</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    function toggleAll(source, classroomId) {
        const checkboxes = document.querySelectorAll(`.student-checkbox[data-classroom='${classroomId}']`);
        for (const checkbox of checkboxes) {
            checkbox.checked = source.checked;
        }
    }

    document.getElementById('moveStudentsBtn').addEventListener('click', function() {
        const selectedStudents = document.querySelectorAll('.student-checkbox:checked');
        const studentIds = Array.from(selectedStudents).map(cb => cb.value);
        const targetClassroomId = document.getElementById('targetClassroom').value;

        if (studentIds.length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢');
            return;
        }
        if (targetClassroomId === '-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --') {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á');
            return;
        }

        const payload = {
            student_ids: studentIds,
            target_classroom_id: targetClassroomId,
            active_year_id: {{ active_year.id }}
        };

        fetch("{{ url_for('admin.api_bulk_enroll') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                window.location.reload();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        });
    });
</script>
{% endblock %}