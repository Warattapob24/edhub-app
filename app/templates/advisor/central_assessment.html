{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* NEW: Flexbox container to control the entire page layout */
    .assessment-container {
        display: flex;
        flex-direction: column;
        /* This is the key: Force the container to a fixed height */
        height: calc(100vh - 140px); /* Adjust 140px based on your nav/header height */
    }

    /* Make the content row fill the remaining space */
    .assessment-container > .row.g-0 {
        flex-grow: 1;
        overflow: hidden; /* CRITICAL: Prevents this row itself from overflowing */
    }

    /* Give the columns their own independent scrollbars */
    #left-column, #right-column {
        height: 100%;
        overflow-y: auto;
    }

    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    .main-topic-row {
        cursor: pointer;
    }
    .sub-topic-row {
        background-color: #f8f9fa;
    }
    .sub-topic-row td:first-child {
        padding-left: 2.5rem !important;
    }
    .expand-icon {
        transition: transform 0.2s ease-in-out;
    }
    tr[aria-expanded="true"] .expand-icon {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block sidebar %}
    {% include 'advisor/_sidebar.html' %}
{% endblock %}

{% block main_content %}
<div class="assessment-container">
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h2"><i class="bi bi-clipboard2-data-fill me-2"></i> {{ title }} (Accordion)</h1>
        <p class="text-muted mb-0">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô {{ classroom.name }} | ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô {{ g_current_semester.term }}/{{ g_current_semester.academic_year.year }}</p>
    </div>
    <div>
        <button class="btn btn-lg btn-success" id="submit-all-btn" {% if all_students_complete %}disabled{% endif %}>
            <i class="bi bi-send-check-fill me-2"></i> ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
        </button>
    </div>
</div>

<div class="row g-0">
    <div class="col-md-4 col-lg-3 border-end" id="left-column">
        <div class="p-3 sticky-top bg-light border-bottom">
            <input type="text" id="student-search-input" class="form-control mb-2" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
            <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#bulkAssessModal">
                <i class="bi bi-lightning-charge-fill me-2"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô
            </button>            
        </div>
        <div id="student-list-container" class="list-group list-group-flush">
            {% for student in students_data %}
            <a href="#" class="list-group-item list-group-item-action student-list-item" 
               data-student-id="{{ student.student_id }}" 
               data-student-name="{{ student.full_name }}"
               data-is-complete="{{ 'true' if student.is_complete else 'false' }}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <p class="mb-0 fw-bold">{{ student.roll_number }}. {{ student.full_name }}</p>
                    <span class="assessment-status-badge">
                        {% if student.is_complete %}
                            <i class="bi bi-check-circle-fill text-success" title="‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß"></i>
                        {% else %}
                            <i class="bi bi-dash-circle-fill text-muted" title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö"></i>
                        {% endif %}
                    </span>
                </div>
                <small class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {{ student.student_code }}</small>
            </a>
            {% else %}
            <div class="text-center text-muted p-5"><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p></div>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-8 col-lg-9" id="right-column">
        <div id="workspace-container" class="p-4">
            <div id="initial-prompt" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                <i class="bi bi-person-bounding-box" style="font-size: 5rem;"></i>
                <h3 class="mt-3">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            </div>

            <div id="assessment-workspace" class="d-none">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-person-circle fs-1 text-primary me-3"></i>
                    <div>
                        <h3 id="workspace-student-name" class="mb-0"></h3>
                    </div>
                </div>
                <ul class="nav nav-tabs" id="assessmentTab" role="tablist">
                    {% for template in templates %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ 'active' if loop.first }}" id="tab-{{ template.id }}" data-bs-toggle="tab" data-bs-target="#pane-{{ template.id }}" type="button" role="tab">{{ template.name }}</button>
                    </li>
                    {% endfor %}
                </ul>

                <div class="tab-content pt-3" id="assessmentTabContent">
                    {% for template in templates %}
                    <div class="tab-pane fade {{ 'show active' if loop.first }}" id="pane-{{ template.id }}" role="tabpanel" data-template-id="{{ template.id }}">
                         <div class="row g-3 mb-4">
                            <div class="col-lg-7">
                                <div class="card h-100">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 300px;">
                                        <canvas class="radar-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                 <div class="card h-100">
                                    <div class="card-header bg-transparent"><h5 class="mb-0">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h5></div>
                                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center overall-assessment-result"></div>
                                </div>
                            </div>
                        </div>
                        <form class="assessment-form">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover align-middle assessment-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞/‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</th>
                                            <th style="width: 30%;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</th>
                                        </tr>
                                    </thead>
                                    <tbody class="assessment-table-body"></tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkAssessModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3"><label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</label><select class="form-select" id="bulk-topic-select"><option value="">--</option>{% for template in templates %}<optgroup label="{{ template.name }}">{% for topic in template.topics|selectattr('parent_id', 'none')|sort(attribute='id') %}<option value="{{ topic.id }}">{{ topic.name }}</option>{% endfor %}</optgroup>{% endfor %}</select></div>
        <div class="mb-3"><label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û:</label><select class="form-select" id="bulk-score-select"><option value="">--</option>{% if templates %}{% for rubric in templates[0].rubric_levels|sort(attribute='value', reverse=True) %}<option value="{{ rubric.value }}">{{ rubric.label }}</option>{% endfor %}{% endif %}</select></div>
        <div class="alert alert-warning"><b><i class="bi bi-exclamation-triangle"></i> ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary" id="confirm-bulk-assess-btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    let activeStudentId = null;
    let studentDataCache = {};
    let chartInstances = {};
    let saveDebounceTimer = null;

    const initialPrompt = document.getElementById('initial-prompt');
    const workspace = document.getElementById('assessment-workspace');
    const workspaceStudentName = document.getElementById('workspace-student-name');
    const searchInput = document.getElementById('student-search-input');
    const bulkAssessBtn = document.getElementById('confirm-bulk-assess-btn');

    const calculateMode = (arr) => {
        if (!arr || arr.length === 0) return null;
        const freqMap = {};
        let maxFreq = 0;
        let modes = [];
        arr.forEach(item => {
            freqMap[item] = (freqMap[item] || 0) + 1;
            if (freqMap[item] > maxFreq) {
                maxFreq = freqMap[item];
                modes = [item];
            } else if (freqMap[item] === maxFreq && !modes.includes(item)) {
                modes.push(item);
            }
        });
        // In case of a tie, return the highest value
        return modes.length > 0 ? Math.max(...modes) : null;
    };

    const fetchData = async (url, options = {}) => {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    };

    const saveData = (scores) => {
        clearTimeout(saveDebounceTimer);
        saveDebounceTimer = setTimeout(() => {
            fetch("{{ url_for('advisor.save_advisor_assessment') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ student_id: activeStudentId, scores: scores })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error("Save failed:", data.message);
                    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                }

                // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
                const studentItem = document.querySelector(`.student-list-item[data-student-id="${activeStudentId}"]`);
                if (!studentItem) return;

                let isCurrentStudentComplete = true;
                const allPanes = document.querySelectorAll('.tab-pane');
                allPanes.forEach(pane => {
                    const mainSelects = pane.querySelectorAll('.main-topic-select');
                    if (mainSelects.length > 0) {
                        const isPaneComplete = Array.from(mainSelects).every(select => select.value !== "");
                        if (!isPaneComplete) {
                            isCurrentStudentComplete = false;
                        }
                    }
                });

                // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                studentItem.dataset.isComplete = isCurrentStudentComplete ? 'true' : 'false';
                const statusBadge = studentItem.querySelector('.assessment-status-badge');
                statusBadge.innerHTML = isCurrentStudentComplete 
                    ? `<i class="bi bi-check-circle-fill text-success" title="‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß"></i>`
                    : `<i class="bi bi-dash-circle-fill text-muted" title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö"></i>`;

                // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô" ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ú‡∏•
                const allStudentItems = document.querySelectorAll('.student-list-item');
                const areAllStudentsComplete = Array.from(allStudentItems).every(item => item.dataset.isComplete === 'true');
                document.getElementById('submit-all-btn').disabled = !areAllStudentsComplete;

            }).catch(error => console.error('Save Error:', error));
        }, 800);
    };

    const loadWorkspace = async (studentId) => {
        if (!studentId) return;
        activeStudentId = studentId;
        
        workspace.classList.add('d-none');
        initialPrompt.innerHTML = `<div class="spinner-border text-primary"></div>`;
        initialPrompt.classList.remove('d-none');
        
        try {
            if (!studentDataCache[studentId]) {
                studentDataCache[studentId] = await fetchData(`/advisor/api/assessment-workspace/student/${studentId}`);
            }
            const data = studentDataCache[studentId];
            workspaceStudentName.textContent = document.querySelector(`.student-list-item[data-student-id="${studentId}"]`).dataset.studentName;
            
            data.templates.forEach(template => {
                const pane = document.getElementById(`pane-${template.id}`);
                renderAssessmentPane(pane, template);
            });

            // This ensures the visuals for the *active* tab are rendered immediately.
            const activeTabPane = document.querySelector('.tab-pane.active');
            if (activeTabPane) {
                const activeTemplate = data.templates.find(t => t.id == activeTabPane.dataset.templateId);
                updatePaneVisuals(activeTabPane, activeTemplate);
            }

            initialPrompt.classList.add('d-none');
            workspace.classList.remove('d-none');
        } catch (error) {
            initialPrompt.innerHTML = `<div class="text-danger">${error.message}</div>`;
        }
    };

    const renderAssessmentPane = (pane, template) => {
        const tableBody = pane.querySelector('.assessment-table-body');
        let html = '';
        
        const createPopoverButton = (scores) => {
            if (!scores || scores.length === 0) return '';
            const popoverContent = scores.map(item => {
                const label = template.rubrics.find(r => r.value == item.score)?.label || 'N/A';
                return `<li class='list-group-item p-1 d-flex justify-content-between'><small>${item.subject}</small><span class='badge bg-primary rounded-pill'>${label}</span></li>`;
            }).join('');
            return `<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="popover" data-bs-html="true" title="‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô" data-bs-content="<ul class='list-group list-group-flush'>${popoverContent.replace(/"/g, '&quot;')}</ul>"><i class="bi bi-info-circle"></i></button>`;
        };

        template.topics.forEach(topic => {
            if (topic.has_sub_topics) {
                html += `
                    <tr class="main-topic-row" data-bs-toggle="collapse" data-bs-target="#collapse-${topic.id}" aria-expanded="false">
                        <td class="fw-bold"><i class="bi bi-chevron-right expand-icon me-2"></i>${topic.name}</td>
                        <td>
                            <div class="input-group">
                                <select class="form-select form-select-sm assessment-select main-topic-select" data-topic-id="${topic.id}" data-sub-target="#collapse-${topic.id}">
                                    <option value="">--</option>
                                    ${template.rubrics.map(r => `<option value="${r.value}" ${topic.advisor_score == r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                </select>
                                ${createPopoverButton(topic.evidence_scores)}
                            </div>
                        </td>
                    </tr>
                `;
                topic.sub_topics.forEach(sub => {
                    html += `
                        <tr class="collapse sub-topic-row" id="collapse-${topic.id}">
                            <td>${sub.name}</td>
                            <td>
                                <div class="input-group">
                                    <select class="form-select form-select-sm assessment-select sub-topic-select" data-main-topic-id="${topic.id}" data-topic-id="${sub.id}">
                                        <option value="">--</option>
                                        ${template.rubrics.map(r => `<option value="${r.value}" ${sub.advisor_score == r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                    </select>
                                    ${createPopoverButton(sub.evidence_scores)}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td class="fw-bold">${topic.name}</td>
                        <td>
                            <div class="input-group">
                                <select class="form-select form-select-sm assessment-select main-topic-select" data-topic-id="${topic.id}">
                                    <option value="">--</option>
                                    ${template.rubrics.map(r => `<option value="${r.value}" ${topic.advisor_score == r.value ? 'selected' : ''}>${r.label}</option>`).join('')}
                                </select>
                                ${createPopoverButton(topic.evidence_scores)}
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
        tableBody.innerHTML = html;

        // --- THE FIX IS HERE ---
        // Change the trigger to 'hover focus' to close on mouse-out
        const popoverTriggerList = [].slice.call(pane.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, { trigger: 'hover focus' }));
        
        updatePaneVisuals(pane, template);
    };

    const updatePaneVisuals = (pane, template) => {
        const scores = [];
        pane.querySelectorAll('.main-topic-select').forEach(select => {
            if (select.value) {
                scores.push({ name: template.topics.find(t => t.id == select.dataset.topicId).name, value: parseInt(select.value) });
            }
        });
        updateRadarChart(pane, scores);
        updateOverallStatus(pane, scores.length, template.topics.length, scores);
    };

    const updateRadarChart = (pane, scores) => {
        const templateId = pane.dataset.templateId;
        const canvas = pane.querySelector('.radar-chart');
        if (!canvas) return;
        const labels = scores.map(s => s.name);
        const dataValues = scores.map(s => s.value);

        if (chartInstances[templateId]) {
            chartInstances[templateId].data.labels = labels;
            chartInstances[templateId].data.datasets[0].data = dataValues;
            chartInstances[templateId].update();
        } else {
            chartInstances[templateId] = new Chart(canvas.getContext('2d'), {
                type: 'radar',
                data: { labels, datasets: [{ data: dataValues, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)' }] },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 3, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }
    };
    
    const updateOverallStatus = (pane, scoreCount, totalTopics, scores) => {
        const container = pane.querySelector('.overall-assessment-result');
        let passFailHtml = '';
        
        // --- FIX 1: Recalculate mode locally for real-time updates ---
        const allMainScores = Array.from(pane.querySelectorAll('.main-topic-select')).map(s => s.value).filter(Boolean).map(Number);
        const modeValue = calculateMode(allMainScores);
        
        let modeLabel = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        if (modeValue !== null) {
            const data = studentDataCache[activeStudentId];
            const template = data.templates.find(t => t.id == pane.dataset.templateId);
            modeLabel = template.rubrics.find(r => r.value === modeValue)?.label || "N/A";
        }
        // --- END FIX 1 ---

        if (scoreCount < totalTopics) {
            passFailHtml = `<i class="bi bi-hourglass-split fs-1 text-secondary"></i><h2 class="display-5 fw-bold text-secondary my-2">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>`;
        } else if (scores.some(s => s.value === 0)) {
            passFailHtml = `<i class="bi bi-x-circle-fill fs-1 text-danger"></i><h2 class="display-5 fw-bold text-danger my-2">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</h2>`;
        } else {
            passFailHtml = `<i class="bi bi-check-circle-fill fs-1 text-success"></i><h2 class="display-5 fw-bold text-success my-2">‡∏ú‡πà‡∏≤‡∏ô</h2>`;
        }

        container.innerHTML = `
            ${passFailHtml}
            <div class="mt-3 border-top pt-3 w-100">
                <h6 class="text-muted">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏ê‡∏≤‡∏ô‡∏ô‡∏¥‡∏¢‡∏°</h6>
                <p class="fs-4 fw-bold text-primary mb-0">${modeLabel}</p>
            </div>
        `;
    };

    // --- Event Delegation ---
    document.body.addEventListener('click', e => {
        const studentItem = e.target.closest('.student-list-item');
        if (studentItem) {
            e.preventDefault();
            // --- THE FIX IS HERE ---
            const rightColumn = document.getElementById('right-column');
            if(rightColumn) rightColumn.scrollTop = 0; // Scroll right side to top

            document.querySelectorAll('.student-list-item.active').forEach(i => i.classList.remove('active'));
            studentItem.classList.add('active');
            loadWorkspace(studentItem.dataset.studentId);
        }
    });
    
    document.body.addEventListener('change', e => {
        const select = e.target;
        if (select.classList.contains('assessment-select')) {
            const topicId = select.dataset.topicId;
            const score = select.value ? parseInt(select.value, 10) : null;
            const scoresToSave = [{ topic_id: parseInt(topicId), score_value: score }];
            
            if (select.classList.contains('main-topic-select')) {
                const subTarget = select.dataset.subTarget;
                if (subTarget) {
                    document.querySelectorAll(`${subTarget} .sub-topic-select`).forEach(subSelect => {
                        subSelect.value = select.value;
                        scoresToSave.push({ topic_id: parseInt(subSelect.dataset.topicId), score_value: score });
                    });
                }
            } 
            else if (select.classList.contains('sub-topic-select')) {
                const mainTopicId = select.dataset.mainTopicId;
                const subSelects = document.querySelectorAll(`.sub-topic-select[data-main-topic-id='${mainTopicId}']`);
                const subScores = Array.from(subSelects).map(s => s.value).filter(Boolean).map(Number);
                const mainTopicSelect = document.querySelector(`.main-topic-select[data-topic-id='${mainTopicId}']`);
                
                if (subScores.length > 0) {
                    // --- FIX 2: Revert to MODE calculation ---
                    const modeVal = calculateMode(subScores);
                    mainTopicSelect.value = modeVal;
                    scoresToSave.push({ topic_id: parseInt(mainTopicId), score_value: modeVal });
                } else {
                    mainTopicSelect.value = "";
                    scoresToSave.push({ topic_id: parseInt(mainTopicId), score_value: null });
                }
            }
            
            saveData(scoresToSave);

            const pane = select.closest('.tab-pane');
            const data = studentDataCache[activeStudentId];
            const template = data.templates.find(t => t.id == pane.dataset.templateId);
            // This call ensures visuals are updated on EVERY change.
            updatePaneVisuals(pane, template);
        }
    });

    // --- NEW Event Listener for Tab Switching ---
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabEl => {
        tabEl.addEventListener('shown.bs.tab', event => {
            const newActivePaneId = event.target.dataset.bsTarget;
            const newActivePane = document.querySelector(newActivePaneId);
            if (newActivePane && activeStudentId) {
                const data = studentDataCache[activeStudentId];
                const template = data.templates.find(t => t.id == newActivePane.dataset.templateId);
                updatePaneVisuals(newActivePane, template);
            }
        });
    });

    searchInput.addEventListener('keyup', () => {
        const filter = searchInput.value.toLowerCase();
        document.querySelectorAll('.student-list-item').forEach(item => {
            item.style.display = item.dataset.studentName.toLowerCase().includes(filter) ? '' : 'none';
        });
    });

    bulkAssessBtn.addEventListener('click', async () => {
        const topicId = document.getElementById('bulk-topic-select').value;
        const scoreValue = document.getElementById('bulk-score-select').value;
        if (!topicId || !scoreValue) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', 'warning');
        
        try {
            await fetchData("{{ url_for('advisor.bulk_assess_students') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ topic_id: parseInt(topicId), score_value: parseInt(scoreValue), classroom_id: {{ classroom.id }} })
            });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => {
                studentDataCache = {};
                if(activeStudentId) loadWorkspace(activeStudentId);
            });
        } catch (error) { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', error.message, 'error'); }
    });
    // --- NEW: Event Listener for the main Submit Button ---
    const submitAllBtn = document.getElementById('submit-all-btn');
    if (submitAllBtn) {
        submitAllBtn.addEventListener('click', async () => {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô?',
                text: "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetchData("{{ url_for('advisor.submit_class_assessment') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                            body: JSON.stringify({ classroom_id: {{ classroom.id }} })
                        });
                        
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', response.message, 'success').then(() => {
                            location.reload(); // Reload the page to reflect new status
                        });

                    } catch (error) {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}