{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}

{% block sidebar %}
    {% include 'academic/_sidebar.html' %}
{% endblock %}

{% block main_content %}
<div class="container-fluid py-4">
    <h3 class="bi bi-building-gear me-2"> {{ title }}</h3>

    <ul class="nav nav-tabs nav-fill mt-4" id="academic-dashboard-tabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="grade-summary-tab" data-bs-toggle="tab" data-bs-target="#grade-summary-content" type="button" role="tab"><i class="bi bi-bar-chart-line-fill me-1"></i> ภาพรวมผลการเรียน</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="plan-summary-tab" data-bs-toggle="tab" data-bs-target="#plan-summary-content" type="button" role="tab"><i class="bi bi-clipboard2-check-fill me-1"></i> ภาพรวมแผนการสอน</button></li>
    </ul>

    <div class="tab-content pt-4">
        <div class="tab-pane fade show active" id="grade-summary-content" role="tabpanel">
            <div class="row g-4">
                {% if overall_stats and overall_stats.total_students > 0 %}
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>ภาพรวมผลการเรียนทั้งหมด (จากรายวิชาที่ส่งแล้ว)</h5></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-7">
                                    <canvas id="gradeDistributionChart"></canvas>
                                </div>
                                <div class="col-lg-5">
                                    <div class="card-body">
                                        <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>สรุปสถิติภาพรวม</h5>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">จำนวนนักเรียนทั้งหมด<span class="badge bg-primary rounded-pill fs-6">{{ overall_stats.total_students }}</span></li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">ผลการเรียนเฉลี่ย (GPA)<span class="badge bg-info rounded-pill fs-6">{{ '%.2f'|format(overall_stats.gpa) }}</span></li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">ส่วนเบี่ยงเบนมาตรฐาน (S.D.)<span class="badge bg-secondary rounded-pill fs-6">{{ '%.2f'|format(overall_stats.sd) }}</span></li>
                                        </ul>
                                        <hr>
                                        <p class="card-text"><i class="bi bi-check-circle-fill text-success"></i> นักเรียนที่ได้ระดับผลการเรียน <strong>"1" ขึ้นไป</strong> มีจำนวน <strong>{{ overall_stats.passed_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.passed_percent) }}</strong>)</p>
                                        <p class="card-text"><i class="bi bi-award-fill text-primary"></i> นักเรียนที่ได้ระดับผลการเรียน <strong>"3" ขึ้นไป</strong> (ดี-ดีเยี่ยม) มีจำนวน <strong>{{ overall_stats.good_excellent_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.good_excellent_percent) }}</strong>)</p>
                                        <p class="card-text"><i class="bi bi-exclamation-triangle-fill text-danger"></i> นักเรียนที่มีผลการเรียน <strong>0, ร, มส</strong> มีจำนวน <strong class="text-danger">{{ overall_stats.failed_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.failed_percent) }}</strong>)</p>
                                    </div>
                                    <div class="card mt-3">
                                        <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-inbox-fill me-2"></i>ผลการเรียนรอตรวจสอบ</h5>{% if grades_pending_review %}<span class="badge bg-danger rounded-pill fs-6">{{ grades_pending_review|length }} รายการ</span>{% endif %}</div>
                                        <div class="card-body text-center">
                                        {% if grades_pending_review %}
                                            <p>มีผลการเรียนที่รอการตรวจสอบและส่งต่อให้ผู้อำนวยการ</p>
                                            <form action="{{ url_for('academic.submit_all_grades_to_director') }}" method="POST" class="d-grid">
                                                {{ form.hidden_tag() }}
                                                <button type="submit" class="btn btn-success"><i class="bi bi-send-check-fill me-2"></i>เสนอผู้อำนวยการเพื่อพิจารณาทั้งหมด</button>
                                            </form>
                                        {% else %}
                                            <div class="alert alert-success mb-0"><i class="bi bi-check-circle-fill me-2"></i> ไม่มีผลการเรียนรอการตรวจสอบ</div>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-table me-2"></i>ตารางสรุปผลการเรียนรายระดับชั้น</h5></div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-bordered table-hover table-sm text-center align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2" class="align-middle">ระดับชั้น</th><th rowspan="2" class="align-middle">จำนวน</th><th rowspan="2">(GPA)</th><th rowspan="2">S.D.</th>
                                        <th colspan="10">จำนวนนักเรียน (คน)</th>
                                    </tr>
                                    <tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr>
                                </thead>
                                <tbody>
                                    {% for item in grade_level_summary_stats %}
                                    {% set gl_stats = item.stats %}{% set gl_dist = gl_stats.grade_distribution %}
                                    <tr>
                                        <td class="text-start fw-bold">{{ item.grade_level.name }}</td><td>{{ gl_stats.total_students }}</td><td>{{ '%.2f'|format(gl_stats.gpa) }}</td><td>{{ '%.2f'|format(gl_stats.sd) }}</td>
                                        <td>{{ gl_dist.get('4', 0) }}</td><td>{{ gl_dist.get('3.5', 0) }}</td><td>{{ gl_dist.get('3', 0) }}</td><td>{{ gl_dist.get('2.5', 0) }}</td><td>{{ gl_dist.get('2', 0) }}</td><td>{{ gl_dist.get('1.5', 0) }}</td><td>{{ gl_dist.get('1', 0) }}</td>
                                        <td class="{% if gl_dist.get('0', 0) > 0 %}table-danger{% endif %}">{{ gl_dist.get('0', 0) }}</td><td class="{% if gl_dist.get('ร', 0) > 0 %}table-warning{% endif %}">{{ gl_dist.get('ร', 0) }}</td><td class="{% if gl_dist.get('มส', 0) > 0 %}table-warning{% endif %}">{{ gl_dist.get('มส', 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    {% if overall_stats %}
                                        {% set o_dist = overall_stats.grade_distribution %}
                                        {% set o_perc = overall_stats.grade_percentages %}
                                        <tr class="table-primary">
                                            <td class="text-start">รวมทั้งหมด</td>
                                            <td>{{ overall_stats.total_students }}</td>
                                            <td>{{ '%.2f'|format(overall_stats.gpa) }}</td>
                                            <td>{{ '%.2f'|format(overall_stats.sd) }}</td>
                                            <td>{{ o_dist.get('4', 0) }}</td>
                                            <td>{{ o_dist.get('3.5', 0) }}</td>
                                            <td>{{ o_dist.get('3', 0) }}</td>
                                            <td>{{ o_dist.get('2.5', 0) }}</td>
                                            <td>{{ o_dist.get('2', 0) }}</td>
                                            <td>{{ o_dist.get('1.5', 0) }}</td>
                                            <td>{{ o_dist.get('1', 0) }}</td>
                                            <td>{{ o_dist.get('0', 0) }}</td>
                                            <td>{{ o_dist.get('ร', 0) }}</td>
                                            <td>{{ o_dist.get('มส', 0) }}</td>
                                        </tr>
                                        <tr class="table-secondary">
                                            <td class="text-start">รวม (ร้อยละ)</td>
                                            <td colspan="3"></td>
                                            <td>{{ '%.1f'|format(o_perc.get('4', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('3.5', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('3', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('2.5', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('2', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('1.5', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('1', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('0', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('ร', 0)) }}%</td>
                                            <td>{{ '%.1f'|format(o_perc.get('มส', 0)) }}%</td>
                                        </tr>
                                    {% endif %}
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-table me-2"></i>ตารางสรุปผลการเรียนรายกลุ่มสาระฯ</h5></div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-bordered table-hover table-sm text-center align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2" class="align-middle">กลุ่มสาระการเรียนรู้</th><th rowspan="2" class="align-middle">จำนวน (คน)</th><th rowspan="2" class="align-middle">(GPA)</th><th rowspan="2" class="align-middle">S.D.</th>
                                        <th colspan="10">จำนวนนักเรียน (คน)</th>
                                    </tr>
                                    <tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr>
                                </thead>
                                <tbody>
                                    {% for item in group_summary_stats %}
                                    {% set group = item.group %}{% set g_stats = item.stats %}{% set g_dist = g_stats.grade_distribution %}
                                    <tr>
                                        <td class="text-start fw-bold">{{ group.name }}</td><td>{{ g_stats.total_students }}</td><td>{{ '%.2f'|format(g_stats.gpa) }}</td><td>{{ '%.2f'|format(g_stats.sd) }}</td>
                                        <td>{{ g_dist.get('4', 0) }}</td><td>{{ g_dist.get('3.5', 0) }}</td><td>{{ g_dist.get('3', 0) }}</td><td>{{ g_dist.get('2.5', 0) }}</td><td>{{ g_dist.get('2', 0) }}</td><td>{{ g_dist.get('1.5', 0) }}</td><td>{{ g_dist.get('1', 0) }}</td>
                                        <td class="{% if g_dist.get('0', 0) > 0 %}table-danger{% endif %}">{{ g_dist.get('0', 0) }}</td><td class="{% if g_dist.get('ร', 0) > 0 %}table-warning{% endif %}">{{ g_dist.get('ร', 0) }}</td><td class="{% if g_dist.get('มส', 0) > 0 %}table-warning{% endif %}">{{ g_dist.get('มส', 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {% else %}
                <div class="col-12"><div class="alert alert-info text-center">ยังไม่มีการส่งผลการเรียน</div></div>
                {% endif %}
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h4 class="card-title">มัธยมศึกษาตอนต้น</h4>
                            <p class="text-muted">ภาพรวมความคืบหน้าการส่งผลการเรียน ม.1 - ม.3</p>
                            <div class="progress" style="height: 25px;"><div class="progress-bar" role="progressbar" style="width: {{ m_ton_progress.percentage }}%;" aria-valuenow="{{ m_ton_progress.percentage }}">{{ '%.0f'|format(m_ton_progress.percentage) }}%</div></div>
                            <p class="mt-2 text-muted">ส่งแล้ว {{ m_ton_progress.submitted }} / {{ m_ton_progress.total }} ห้อง</p>
                            <a href="{{ url_for('academic.level_overview', level_group='m-ton') }}" class="btn btn-primary mt-3 {% if m_ton_progress.total == 0 %}disabled{% endif %}"><i class="bi bi-search me-2"></i>ดูรายละเอียด ม.ต้น</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                         <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h4 class="card-title">มัธยมศึกษาตอนปลาย</h4>
                            <p class="text-muted">ภาพรวมความคืบหน้าการส่งผลการเรียน ม.4 - ม.6</p>
                            <div class="progress" style="height: 25px;"><div class="progress-bar" role="progressbar" style="width: {{ m_plai_progress.percentage }}%;" aria-valuenow="{{ m_plai_progress.percentage }}">{{ '%.0f'|format(m_plai_progress.percentage) }}%</div></div>
                            <p class="mt-2 text-muted">ส่งแล้ว {{ m_plai_progress.submitted }} / {{ m_plai_progress.total }} ห้อง</p>
                            <a href="{{ url_for('academic.level_overview', level_group='m-plai') }}" class="btn btn-primary mt-3 {% if m_plai_progress.total == 0 %}disabled{% endif %}"><i class="bi bi-search me-2"></i>ดูรายละเอียด ม.ปลาย</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="plan-summary-content" role="tabpanel">
             <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>ภาพรวมข้อมูล</h5></div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3"><div class="card text-center bg-light h-100"><div class="card-body d-flex flex-column justify-content-center"><h2 class="display-6 fw-bold">{{ teacher_count or 0 }}</h2><p class="mb-0 text-muted">ครูทั้งหมด</p></div></div></div>
                                <div class="col-md-3"><div class="card text-center bg-light h-100"><div class="card-body d-flex flex-column justify-content-center"><h2 class="display-6 fw-bold text-primary">{{ stats.get('เสนอฝ่ายวิชาการ', 0) }}</h2><p class="mb-0 text-muted">แผนฯ เสนอแล้ว</p></div></div></div>
                                <div class="col-md-3"><div class="card text-center bg-light h-100"><div class="card-body d-flex flex-column justify-content-center"><h2 class="display-6 fw-bold text-warning">{{ (stats.get('รอการอนุมัติจากผู้อำวยการ', 0) or 0) + (stats.get('รอการอนุมัติ', 0) or 0) }}</h2><p class="mb-0 text-muted">แผนฯ รออนุมัติ</p></div></div></div>
                                <div class="col-md-3"><div class="card text-center bg-light h-100"><div class="card-body d-flex flex-column justify-content-center"><h2 class="display-6 fw-bold text-danger">{{ stats.get('ต้องการการแก้ไข', 0) }}</h2><p class="mb-0 text-muted">แผนฯ ต้องแก้ไข</p></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clipboard2-check-fill me-2"></i>รายการแผนการสอนที่ต้องดำเนินการ</h5>
                            <form method="GET" action="{{ url_for('academic.dashboard') }}">
                                <div class="input-group">
                                    <select name="group_id" class="form-select" onchange="this.form.submit()">
                                        <option value="">-- ทุกกลุ่มสาระฯ --</option>
                                        {% for group in all_subject_groups %}
                                            <option value="{{ group.id }}" {% if group.id == selected_group_id %}selected{% endif %}>{{ group.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="card-body">
                            {% if plans_for_checklist %}
                                <div class="row">
                                {% for plan in plans_for_checklist %}
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title mb-0">{{ plan.subject.subject_code }} - <strong>{{ plan.subject.name }}</strong></h5>
                                                {% if plan.status == 'เสนอฝ่ายวิชาการ' %}<span class="badge bg-primary">เสนอฝ่ายวิชาการ</span>
                                                {% elif plan.status == 'รอการอนุมัติจากผู้อำวยการ' %}<span class="badge bg-warning text-dark">รออนุมัติ</span>
                                                {% elif plan.status == 'อนุมัติใช้งาน' %}<span class="badge bg-success">อนุมัติใช้งาน</span>
                                                {% elif plan.status == 'ต้องการการแก้ไข' %}<span class="badge bg-danger">ต้องแก้ไข</span>
                                                {% else %}<span class="badge bg-secondary">{{ plan.status }}</span>{% endif %}
                                            </div>
                                            </div>
                                        <div class="card-footer bg-transparent border-0 text-end">
                                             <a href="{{ url_for('academic.review_plan', plan_id=plan.id) }}" class="btn btn-primary"><i class="bi bi-search me-1"></i> ตรวจสอบรายละเอียด</a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-success text-center">
                                    <i class="bi bi-check-circle-fill me-2"></i> ไม่มีแผนการสอนที่ต้องดำเนินการในขณะนี้
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Tab Memory ---
        const tabs = document.querySelectorAll('#academic-dashboard-tabs button[data-bs-toggle="tab"]');
        const lastTabId = localStorage.getItem('activeAcademicDashboardTab');
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                localStorage.setItem('activeAcademicDashboardTab', event.target.id);
            });
        });
        if (lastTabId) {
            const lastTab = document.getElementById(lastTabId);
            if (lastTab) new bootstrap.Tab(lastTab).show();
        }

        // --- Chart.js ---
        const ctx = document.getElementById('gradeDistributionChart');
        const chartData = {{ chart_data|tojson|safe if chart_data else 'null' }};
        if (ctx && chartData) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'จำนวนนักเรียน', data: chartData.data,
                        backgroundColor: ['#28a745', '#5cb85c', '#20c997', '#0dcaf0', '#0d6efd', '#fd7e14', '#ffc107', '#dc3545', '#6c757d', '#495057'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'จำนวนนักเรียน (คน)' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    });
</script>
{% endblock %}