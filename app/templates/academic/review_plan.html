
{% block title %}EdHub {{ title }}{% endblock %}

{% block sidebar %}
    {% include 'academic/_sidebar.html' %}
{% endblock %}

{% block styles %}
<style>
    .plan-actions { position: sticky; top: 70px; z-index: 1020; }
</style>
{% endblock %}

{% block main_content %}
<div class="card plan-actions mb-4">
    <div class="card-body d-flex justify-content-end align-items-center gap-2">
        <h5 class="me-auto mb-0">สถานะปัจจุบัน: <span class="badge bg-primary">{{ plan.status }}</span></h5>
        
        <button id="reject-btn" type="button" class="btn btn-outline-danger">
            <i class="bi bi-arrow-left-circle me-2"></i>ส่งกลับเพื่อแก้ไข
        </button>

        <form action="{{ url_for('department.forward_plan', plan_id=plan.id) }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check2-circle me-2"></i>เสนอเพื่ออนุมัติ
            </button>
        </form>
    </div>
</div>

<form id="reject-form" action="{{ url_for('department.reject_plan', plan_id=plan.id) }}" method="POST" class="d-none">
    <input type="hidden" name="revision_notes" id="revision-notes-input">
</form>

<div class="card">
    <div class="card-body">
        <h4>{{ plan.subject.name }}</h4>
        <p class="text-muted">{{ plan.subject.subject_code }}</p>
        <hr>
        <h5>หน่วยการเรียนรู้</h5>
        {% if plan.learning_units.all() %}
            <ul class="list-group">
                {% for unit in plan.learning_units.order_by('sequence') %}
                    <li class="list-group-item">{{ unit.title }} ({{ unit.hours }} คาบ)</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted"><em>ยังไม่มีการสร้างหน่วยการเรียนรู้</em></p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const rejectBtn = document.getElementById('reject-btn');
    const rejectForm = document.getElementById('reject-form');
    const revisionNotesInput = document.getElementById('revision-notes-input');

    if (rejectBtn) {
        rejectBtn.addEventListener('click', function () {
            Swal.fire({
                title: 'ส่งกลับเพื่อแก้ไข',
                input: 'textarea',
                inputLabel: 'เหตุผลในการส่งกลับ (จะถูกส่งไปยังครูผู้สอน)',
                inputPlaceholder: 'กรุณาระบุข้อเสนอแนะหรือจุดที่ต้องการให้แก้ไข...',
                showCancelButton: true,
                confirmButtonText: 'ยืนยันและส่งกลับ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#dc3545',
                inputValidator: (value) => {
                    if (!value) { return 'กรุณาระบุเหตุผล!' }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    revisionNotesInput.value = result.value;
                    rejectForm.submit();
                }
            });
        });
    }
});
</script>
{% endblock %}