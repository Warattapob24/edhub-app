{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}

{% block sidebar %}
    {% include 'academic/_sidebar.html' %}
{% endblock %}

{% block main_content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('academic.dashboard') }}">ภาพรวมฝ่ายวิชาการ</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
        </ol>
    </nav>    
    <h3 class="bi bi-graph-up me-2"> {{ title }}</h3>
    <hr>

    <div class="row g-4">
        {% if overall_stats and overall_stats.total_students > 0 %}
        <div class="col-12">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>ภาพรวมผลการเรียน (จากรายวิชาที่ส่งแล้ว)</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-7">
                            <canvas id="gradeDistributionChart"></canvas>
                        </div>
                        <div class="col-lg-5">
                            <div class="card-body">
                                <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>สรุปสถิติภาพรวม</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">จำนวนนักเรียนทั้งหมด<span class="badge bg-primary rounded-pill fs-6">{{ overall_stats.total_students }}</span></li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">ผลการเรียนเฉลี่ย (GPA)<span class="badge bg-info rounded-pill fs-6">{{ '%.2f'|format(overall_stats.gpa) }}</span></li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">ส่วนเบี่ยงเบนมาตรฐาน (S.D.)<span class="badge bg-secondary rounded-pill fs-6">{{ '%.2f'|format(overall_stats.sd) }}</span></li>
                                </ul>
                                <hr>
                                <p class="card-text"><i class="bi bi-check-circle-fill text-success"></i> นักเรียนที่ได้ระดับผลการเรียน <strong>"1" ขึ้นไป</strong> มีจำนวน <strong>{{ overall_stats.passed_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.passed_percent) }}</strong>)</p>
                                <p class="card-text"><i class="bi bi-award-fill text-primary"></i> นักเรียนที่ได้ระดับผลการเรียน <strong>"3" ขึ้นไป</strong> (ดี-ดีเยี่ยม) มีจำนวน <strong>{{ overall_stats.good_excellent_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.good_excellent_percent) }}</strong>)</p>
                                <p class="card-text"><i class="bi bi-exclamation-triangle-fill text-danger"></i> นักเรียนที่มีผลการเรียน <strong>0, ร, มส</strong> มีจำนวน <strong class="text-danger">{{ overall_stats.failed_count }}</strong> คน (คิดเป็นร้อยละ <strong>{{ '%.2f'|format(overall_stats.failed_percent) }}</strong>)</p>
                            </div>
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-inbox-fill me-2"></i>ผลการเรียนรอตรวจสอบ</h5>{% if grades_pending_review %}<span class="badge bg-danger rounded-pill fs-6">{{ grades_pending_review|length }} รายการ</span>{% endif %}</div>
                                <div class="card-body text-center">
                                {% if grades_pending_review %}
                                    <p>มีผลการเรียนที่รอการตรวจสอบและส่งต่อให้ผู้อำนวยการ</p>
                                    <form action="{{ url_for('academic.submit_level_grades', level_group=level_group) }}" method="POST" class="d-grid">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="btn btn-success"><i class="bi bi-send-check-fill me-2"></i>เสนอผู้อำนวยการเพื่อพิจารณาทั้งหมด</button>
                                    </form>
                                {% else %}
                                    <div class="alert alert-success mb-0"><i class="bi bi-check-circle-fill me-2"></i> ไม่มีผลการเรียนรอการตรวจสอบ</div>
                                {% endif %}
                                </div>
                            </div>
                            <div class="card mt-3" id="gradesProcessedReview">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check2-circle me-2"></i>ประวัติการตรวจสอบผลการเรียน
                                    </h5>
                                    {% if grades_processed %}
                                        <span class="badge bg-light text-dark rounded-pill fs-6">{{ grades_processed|length }} รายการ</span>
                                    {% endif %}
                                </div>
                                {% if grades_processed %}
                                    <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                                        {% for course in grades_processed %}
                                        <a href="{{ url_for('academic.review_course_grades', course_id=course.id) }}" class="list-group-item list-group-item-action list-group-item-light">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ course.subject.name }} ({{ course.classroom.name }})</h6>

                                                {% if course.grade_submission_status == 'รอการอนุมัติจากผู้อำนวยการ' %}
                                                    <span class="badge bg-info">ส่งต่อ ผอ. แล้ว</span>
                                                {% elif course.grade_submission_status == 'อนุมัติใช้งาน' %}
                                                    <span class="badge bg-success">อนุมัติแล้ว</span>
                                                {% elif course.grade_submission_status == 'ตีกลับโดยฝ่ายวิชาการ' %}
                                                    <span class="badge bg-danger">ตีกลับ (ต้องแก้ไข)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ course.grade_submission_status }}</span>
                                                {% endif %}
                                            </div>
                                        </a>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="card-body text-center">
                                        <div class="alert alert-light mb-0">
                                            <i class="bi bi-info-circle me-2"></i> ไม่มีประวัติการตรวจสอบผลการเรียน
                                        </div>
                                    </div>
                                {% endif %}
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-table me-2"></i>ตารางสรุปผลการเรียนรายระดับชั้น</h5></div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-bordered table-hover table-sm text-center align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2" class="align-middle">ระดับชั้น</th><th rowspan="2" class="align-middle">จำนวน</th><th rowspan="2">(GPA)</th><th rowspan="2">S.D.</th>
                                <th colspan="10">จำนวนนักเรียน (คน)</th>
                            </tr>
                            <tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr>
                        </thead>
                        <tbody>
                            {% for item in grade_level_summary_stats %}
                            {% set gl_stats = item.stats %}{% set gl_dist = gl_stats.grade_distribution %}
                            <tr>
                                <td class="text-start fw-bold">{{ item.grade_level.name }}</td><td>{{ gl_stats.total_students }}</td><td>{{ '%.2f'|format(gl_stats.gpa) }}</td><td>{{ '%.2f'|format(gl_stats.sd) }}</td>
                                <td>{{ gl_dist.get('4', 0) }}</td><td>{{ gl_dist.get('3.5', 0) }}</td><td>{{ gl_dist.get('3', 0) }}</td><td>{{ gl_dist.get('2.5', 0) }}</td><td>{{ gl_dist.get('2', 0) }}</td><td>{{ gl_dist.get('1.5', 0) }}</td><td>{{ gl_dist.get('1', 0) }}</td>
                                <td class="{% if gl_dist.get('0', 0) > 0 %}table-danger{% endif %}">{{ gl_dist.get('0', 0) }}</td><td class="{% if gl_dist.get('ร', 0) > 0 %}table-warning{% endif %}">{{ gl_dist.get('ร', 0) }}</td><td class="{% if gl_dist.get('มส', 0) > 0 %}table-warning{% endif %}">{{ gl_dist.get('มส', 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            {% set o_dist = overall_stats.grade_distribution %}{% set o_perc = overall_stats.grade_percentages %}
                            <tr class="table-primary">
                                <td class="text-start">รวมทั้งหมด</td><td>{{ overall_stats.total_students }}</td><td>{{ '%.2f'|format(overall_stats.gpa) }}</td><td>{{ '%.2f'|format(overall_stats.sd) }}</td>
                                <td>{{ o_dist.get('4', 0) }}</td><td>{{ o_dist.get('3.5', 0) }}</td><td>{{ o_dist.get('3', 0) }}</td><td>{{ o_dist.get('2.5', 0) }}</td><td>{{ o_dist.get('2', 0) }}</td><td>{{ o_dist.get('1.5', 0) }}</td><td>{{ o_dist.get('1', 0) }}</td>
                                <td>{{ o_dist.get('0', 0) }}</td><td>{{ o_dist.get('ร', 0) }}</td><td>{{ o_dist.get('มส', 0) }}</td>
                            </tr>
                            <tr class="table-secondary">
                                <td class="text-start">รวม (ร้อยละ)</td><td colspan="3"></td>
                                <td>{{ '%.1f'|format(o_perc.get('4', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('3.5', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('3', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('2.5', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('2', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('1.5', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('1', 0)) }}%</td>
                                <td>{{ '%.1f'|format(o_perc.get('0', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('ร', 0)) }}%</td><td>{{ '%.1f'|format(o_perc.get('มส', 0)) }}%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-table me-2"></i>ตารางสรุปผลการเรียนรายกลุ่มสาระฯ</h5></div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-bordered table-hover table-sm text-center align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2" class="align-middle">กลุ่มสาระฯ</th><th rowspan="2" class="align-middle">จำนวน</th><th rowspan="2">(GPA)</th><th rowspan="2">S.D.</th>
                                <th colspan="10">จำนวนนักเรียน (คน)</th>
                            </tr>
                            <tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr>
                        </thead>
                        <tbody>
                            {% for item in group_summary_stats %}
                            {% set g_stats = item.stats %}{% set g_dist = g_stats.grade_distribution %}
                            <tr>
                                <td class="text-start fw-bold">{{ item.group.name }}</td><td>{{ g_stats.total_students }}</td><td>{{ '%.2f'|format(g_stats.gpa) }}</td><td>{{ '%.2f'|format(g_stats.sd) }}</td>
                                <td>{{ g_dist.get('4', 0) }}</td><td>{{ g_dist.get('3.5', 0) }}</td><td>{{ g_dist.get('3', 0) }}</td><td>{{ g_dist.get('2.5', 0) }}</td><td>{{ g_dist.get('2', 0) }}</td><td>{{ g_dist.get('1.5', 0) }}</td><td>{{ g_dist.get('1', 0) }}</td>
                                <td class="{% if g_dist.get('0', 0) > 0 %}table-danger{% endif %}">{{ g_dist.get('0', 0) }}</td><td class="{% if g_dist.get('ร', 0) > 0 %}table-warning{% endif %}">{{ g_dist.get('ร', 0) }}</td><td class="{% if g_dist.get('มส', 0) > 0 %}table-warning{% endif %}">{{ g_dist.get('มส', 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% for item in progress_cards_data|sort(attribute='grade_level.id') %}
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h4 class="card-title">{{ item.grade_level.name }}</h4>
                    <p class="text-muted">ความคืบหน้าการส่งผลการเรียน</p>
                    <div class="progress" style="height: 25px;"><div class="progress-bar" role="progressbar" style="width: {{ item.percentage }}%;" aria-valuenow="{{ item.percentage }}">{{ '%.0f'|format(item.percentage) }}%</div></div>
                    <p class="mt-2 text-muted">ส่งแล้ว {{ item.submitted }} / {{ item.total }} ห้อง</p>
                    <a href="{{ url_for('academic.grade_level_detail', grade_level_id=item.grade_level.id) }}" class="btn btn-primary mt-3 {% if item.total == 0 %}disabled{% endif %}"><i class="bi bi-search me-2"></i>ดูรายละเอียด</a>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% else %}
        <div class="col-12"><div class="alert alert-info text-center">ยังไม่มีการส่งผลการเรียนในสายชั้นนี้</div></div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('gradeDistributionChart');
        const chartData = {{ chart_data|tojson|safe if chart_data else 'null' }};
        if (ctx && chartData) {
            new Chart(ctx, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label: 'จำนวนนักเรียน', data: chartData.data, backgroundColor: ['#28a745', '#5cb85c', '#20c997', '#0dcaf0', '#0d6efd', '#fd7e14', '#ffc107', '#dc3545', '#6c757d', '#495057'], borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'จำนวนนักเรียน (คน)' } } }, plugins: { legend: { display: false } } } });
        }
    });
</script>
{% endblock %}