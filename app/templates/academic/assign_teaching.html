{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}
{% block sidebar %}
    {% include 'academic/_sidebar.html' %}
{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<style>
    /* ทำให้ container หลัก เลื่อนแนวนอนได้ */
    #assignment-grid-container {
        overflow-x: auto;
    }
    /* ตาราง */
    .assignment-table {
        /* min-width: 1200px; */ /* เอา min-width ออก หรือปรับตามความเหมาะสม */
        border-collapse: separate; /* แยกเส้นขอบ */
        border-spacing: 0; /* ไม่มีช่องว่างระหว่าง cell */
    }
    /* Header และ Cell ทั่วไป */
    .assignment-table th, .assignment-table td {
        text-align: center;
        vertical-align: middle;
        /* white-space: nowrap; */ /* <-- เอาออก เพื่อให้ข้อความในเซลล์ตัดคำได้ตามปกติ */
        padding: 0.5rem; /* ลด padding เล็กน้อย */
    }
    /* --- Sticky Columns (ตรึงคอลัมน์ซ้ายและหัวตาราง) --- */
    .assignment-table th.subject-header { /* Header ของคอลัมน์วิชา */
        text-align: left;
        position: sticky;
        left: 0;
        background-color: #f8f9fa; /* สีพื้นหลังอ่อนๆ */
        z-index: 5; /* อยู่เหนือ cell แต่ใต้ header แถวบน */
        width: 250px; /* <-- [สำคัญ] กำหนดความกว้างตายตัว */
        min-width: 250px; /* <-- [สำคัญ] ความกว้างขั้นต่ำ */
        max-width: 250px; /* <-- [สำคัญ] ความกว้างสูงสุด */
        box-sizing: border-box; /* ให้ padding/border นับรวมใน width */
    }
    .assignment-table td.subject-cell { /* Cell ของคอลัมน์วิชา */
        text-align: left;
        position: sticky;
        left: 0;
        background-color: #fff; /* สีพื้นหลังขาว */
        z-index: 4; /* อยู่เหนือ cell อื่นๆ */
        box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* เพิ่มเงาเล็กน้อยด้านขวา */
        width: 250px; /* <-- [สำคัญ] กำหนดความกว้างตายตัว */
        min-width: 250px; /* <-- [สำคัญ] ความกว้างขั้นต่ำ */
        max-width: 250px; /* <-- [สำคัญ] ความกว้างสูงสุด */
        box-sizing: border-box; /* ให้ padding/border นับรวมใน width */
        overflow: hidden; /* <-- [สำคัญ] ซ่อนส่วนที่ล้นออกมา */
    }
    .assignment-table thead th { /* Header แถวบนสุด (ชื่อห้อง) */
        position: sticky;
        top: 0; /* ตรึงไว้ด้านบน */
        background-color: #e9ecef; /* สีพื้นหลังเข้มขึ้นเล็กน้อย */
        z-index: 3; /* อยู่บนสุด */
        /* width: 150px; */ /* <-- อาจจะกำหนดความกว้างตายตัวของคอลัมน์ห้องเรียนด้วย */
        /* min-width: 150px; */
    }
    .assignment-table td {
        /* background-color: lightgoldenrodyellow; /* ตรวจสอบขอบเขต */ */
        overflow: hidden; /* <-- [สำคัญมาก] ซ่อนทุกอย่างที่ล้นออกมาจาก td */
        position: relative; /* สำคัญสำหรับ TomSelect เพื่อให้ dropdown แสดงผลได้ดี */
        min-width: 180px; /* กำหนดความกว้างขั้นต่ำของแต่ละช่อง (TomSelect) */
        max-width: 250px; /* กำหนดความกว้างสูงสุดของแต่ละช่อง (TomSelect) */
    }
    .assignment-table .ts-wrapper { /* wrapper ของ TomSelect */
        width: 100% !important; /* บังคับให้ TomSelect กว้างเต็ม td */
    }
    .assignment-table .ts-control { /* ตัว input ของ TomSelect */
        width: 100% !important; /* บังคับให้ control กว้างเต็ม td */
        min-width: 0; /* ล้าง min-width เดิม */
    }


    /* เพิ่ม: สไตล์สำหรับ Grade Section */
    .grade-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #fff;
        margin-bottom: 1.5rem; /* เพิ่มระยะห่างระหว่าง Grade Section */
    }
    .grade-section h4 { /* ทำให้ Header ของ Grade ดูเด่นขึ้น */
         border-bottom: 2px solid #0d6efd; /* เส้นใต้สีน้ำเงิน */
         padding-bottom: 0.5rem;
         margin-bottom: 1rem; /* เพิ่ม margin ใต้ header */
         color: #0d6efd;
    }
    .assignment-table .quick-assign-btn {
        opacity: 0.7; /* ทำให้ปุ่มจางลงนิดหน่อย */
        transition: opacity 0.2s ease-in-out;
    }
    .assignment-table .quick-assign-btn:hover {
        opacity: 1; /* แสดงเต็มที่เมื่อเมาส์ชี้ */
    }
</style>
{% endblock %}

{% block main_content %}
<div class="row mb-3 align-items-end">
    <h2 class="bi bi-person-check-fill"> {{ title }}</h2>
    <div class="col-md-4">
        <label for="semester-select" class="form-label">เลือกภาคการเรียน</label>
        <select id="semester-select" class="form-select">
            {% for semester in all_semesters %}
            <option value="{{ semester.id }}" {% if current_semester and semester.id == current_semester.id %}selected{% endif %}>
                ภาคเรียนที่ {{ semester.term }} ปีการศึกษา {{ semester.academic_year.year }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div id="grid-status" class="col-md-8 text-end text-muted"></div>
</div>
<div id="workload-summary" class="mt-4"></div>
<div id="assignment-grid-container" class="card">
    <div class="card-body p-0">
        <div id="grid-loader" class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">กำลังโหลดข้อมูล...</p>
        </div>
        <table class="table table-bordered table-hover assignment-table d-none" id="assignment-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const semesterSelect = document.getElementById('semester-select');
    const gridContainer = document.getElementById('assignment-grid-container');
    const summaryDiv = document.getElementById('workload-summary');
    const statusDiv = document.getElementById('grid-status');
    let assignmentsData = {}; // State หลักสำหรับเก็บข้อมูลทั้งหมด
    let tomSelectInstances = {}; // เก็บ instances ของ TomSelect

    // --- 1. Fetch Data ---
    const fetchDataAndRenderUI = async () => {
        const semesterId = semesterSelect.value;
        if (!semesterId) {
            gridContainer.innerHTML = '<div class="text-center p-5 text-muted">กรุณาเลือกภาคเรียน</div>';
            return;
        }

        gridContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">กำลังโหลดข้อมูล...</p></div>';
        summaryDiv.innerHTML = ''; // เคลียร์สรุปเก่า
        Object.values(tomSelectInstances).forEach(ts => ts.destroy()); // ทำลาย TomSelect เก่า
        tomSelectInstances = {};
        assignmentsData = {}; // ล้าง State เก่า

        try {
            const response = await fetch(`/academic/api/assignments-data?semester_id=${semesterId}`); // <-- ✅ แก้ไขเป็น 'academic'
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }
            assignmentsData = await response.json();

            if (!assignmentsData.grades || !assignmentsData.teachers_by_group || assignmentsData.assignments === undefined) {
                 throw new Error("โครงสร้างข้อมูลที่ได้รับจาก API ไม่ถูกต้อง (ขาด grades, teachers_by_group, หรือ assignments)");
            }

            renderUI(assignmentsData); // Render ตาราง
            updateWorkloadSummary(); // คำนวณสรุป
            statusDiv.textContent = ''; // เคลียร์สถานะการโหลด
        } catch (error) {
            gridContainer.innerHTML = `<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</div>`;
            console.error('Fetch Error:', error);
            statusDiv.textContent = '❌ โหลดข้อมูลล้มเหลว';
            statusDiv.classList.add('text-danger');
        }
    };

    // --- 2. Render UI (สร้างตาราง) ---
    const renderUI = (data) => {
        gridContainer.innerHTML = ''; // เคลียร์ grid เก่า

        if (!data.grades || data.grades.length === 0) {
            gridContainer.innerHTML = '<div class="text-center text-muted p-5"><h4><i class="bi bi-info-circle"></i> ไม่พบข้อมูล</h4><p>ไม่พบรายวิชาในหลักสูตรสำหรับภาคเรียนนี้</p></div>';
            return;
        }

        data.grades.forEach(gradeData => {
            // ตรวจสอบข้อมูลก่อนสร้างตาราง
            if (!gradeData.all_subjects || gradeData.all_subjects.length === 0 || !gradeData.classrooms || gradeData.classrooms.length === 0) {
                 console.warn(`Skipping grade ${gradeData.name} due to missing subjects or classrooms.`);
                 return; // ข้ามระดับชั้นนี้ถ้าข้อมูลไม่ครบ
            }

            // สร้าง Container สำหรับแต่ละระดับชั้น (เพื่อให้ initializeTomSelectsForGrade ทำงานถูก)
            const gradeContainerId = `grid-container-${gradeData.id}`;
            const gradeContainer = document.createElement('div');
            gradeContainer.id = gradeContainerId;
            gradeContainer.className = 'grade-section mb-4'; // เพิ่ม class และ margin
            gridContainer.appendChild(gradeContainer);


            const gradeHeader = document.createElement('h4');
            gradeHeader.className = 'mt-4 mb-3 ps-2';
            gradeHeader.textContent = `ระดับชั้น${gradeData.name}`;
            gradeContainer.appendChild(gradeHeader); // ใส่ Header ใน Container ใหม่

            // สร้างตาราง HTML (เหมือนเดิม แต่ใช้ gradeContainer เป็น parent)
            let tableHtml = '<div class="table-responsive"><table class="table table-bordered table-hover align-middle assignment-table">';
            
            // --- Table Header (เพิ่ม program_name) ---
            tableHtml += '<thead><tr class="table-light text-center"><th class="subject-header" style="min-width: 250px;">รายวิชา</th>';
            gradeData.classrooms.forEach(c => { 
                tableHtml += `<th>${c.name}<br><small class="text-muted fw-normal">${c.program_name || 'N/A'}</small></th>`; 
            });
            tableHtml += '</tr></thead><tbody>';

            // --- Table Body ---
             gradeData.all_subjects.forEach(s => {
                 tableHtml += `<tr><td class="subject-cell">
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div><b>${s.code}</b><br>${s.name}<br><small class="text-muted">${s.credit.toFixed(1)} หน่วยกิต</small></div>
                                     <button class="btn btn-sm btn-outline-primary ms-2 flex-shrink-0 quick-assign-btn" title="มอบหมายครูคนเดียวทุกห้อง"
                                             data-subject-id="${s.id}" data-group-id="${s.group_id}" data-grade-id="${gradeData.id}">
                                         <i class="bi bi-person-fill-add"></i>
                                     </button>
                                 </div>
                               </td>`;

                 gradeData.classrooms.forEach(c => {
                     const classroomProgramId = c.program_id;
                     const subjectApplies = classroomProgramId &&
                                            gradeData.subjects_by_program &&
                                            gradeData.subjects_by_program[classroomProgramId] &&
                                            gradeData.subjects_by_program[classroomProgramId].some(subj => subj && subj.id === s.id);

                     if (subjectApplies) {
                         const cellId = `cell-${s.id}-${c.id}`;
                         tableHtml += `<td><select id="${cellId}" class="teacher-select" multiple
                                         data-subject-id="${s.id}" data-classroom-id="${c.id}"
                                         data-group-id="${s.group_id}"></select></td>`;
                     } else {
                         tableHtml += '<td class="text-center align-middle text-muted bg-light">-</td>';
                     }
                 });
                 tableHtml += '</tr>';
             });
             tableHtml += '</tbody></table></div>'; // ปิด table และ div.table-responsive

            gradeContainer.insertAdjacentHTML('beforeend', tableHtml); // ใส่ตารางใน Container

            // --- [สำคัญ] เรียก initialize TomSelect สำหรับระดับชั้นนี้ทันที ---
            initializeTomSelectsForGrade(gradeData);
        });
    };

    // --- 3. Initialize TomSelect (แก้ไข) ---
    function initializeTomSelectsForGrade(gradeData) {
        // หา container ของ grade นี้
        const gradeContainer = document.getElementById(`grid-container-${gradeData.id}`);
        if (!gradeContainer) {
             console.error(`Container not found for grade ID ${gradeData.id}`);
             return;
        }

        // --- ทำลาย instance เก่า (ถ้ามี) เฉพาะใน container นี้ ---
        gradeContainer.querySelectorAll('.teacher-select').forEach(selectEl => {
             if (selectEl.tomselect) {
                 tomSelectInstances[selectEl.id]?.destroy(); // ใช้ ?. เพื่อความปลอดภัย
                 delete tomSelectInstances[selectEl.id];
             }
        });

        // ตรวจสอบ State หลัก
        if (!assignmentsData || !assignmentsData.teachers_by_group || assignmentsData.assignments === undefined) {
             console.error("Cannot initialize TomSelects: assignmentsData is incomplete.");
             return;
        }

        // --- สร้าง Options ครู (เหมือนเดิม) ---
        const teacherOptionsByGroup = {};
        for (const groupId in assignmentsData.teachers_by_group) {
            teacherOptionsByGroup[groupId] = assignmentsData.teachers_by_group[groupId].map(t => ({ value: t.id, text: t.name }));
        }

        // --- วนลูปสร้าง TomSelect ใหม่ เฉพาะใน container นี้ ---
        gradeContainer.querySelectorAll('.teacher-select').forEach(selectEl => {
            const subjectId = selectEl.dataset.subjectId;
            const classroomId = selectEl.dataset.classroomId;
            const groupId = selectEl.dataset.groupId;

            const teacherOptionsForGroup = teacherOptionsByGroup[groupId] || []; // ใช้ options ที่สร้างไว้
            const assignmentKey = `${subjectId}-${classroomId}`;
            const selectedTeacherIds = (assignmentsData.assignments && assignmentsData.assignments[assignmentKey]) ? assignmentsData.assignments[assignmentKey] : []; // ใช้ State ล่าสุด

            try {
                const instanceId = selectEl.id; // ใช้ id เป็น key
                tomSelectInstances[instanceId] = new TomSelect(selectEl, {
                    options: teacherOptionsForGroup,
                    items: selectedTeacherIds.map(String),
                    plugins: ['remove_button'],
                    placeholder: 'เลือกครูผู้สอน...',
                    onChange: (value) => { // ใช้ anonymous function
                        const selectedIds = value.map(id => parseInt(id, 10));
                        // เรียก handleAssignmentChange โดยตรง (ไม่มี debounce)
                        handleAssignmentChange(subjectId, classroomId, selectedIds);
                    }
                });
            } catch (e) {
                console.error(`Failed to initialize TomSelect for ${selectEl.id}:`, e);
                selectEl.outerHTML = '<span class="text-danger small">Error</span>';
            }
        });
    }

    // --- 4. Workload Summary (เขียนใหม่) ---
    function updateWorkloadSummary() {
        const workload = {}; 
        if (!assignmentsData || !assignmentsData.grades || !assignmentsData.teachers_by_group) {
            renderWorkloadSummary(workload); // Render ว่างๆ
            return;
        }

        const allTeachers = Object.values(assignmentsData.teachers_by_group).flat();
        
        // สร้าง Map ของวิชาทั้งหมดเพื่อการค้นหาที่รวดเร็ว
        const allSubjectsMap = {};
        assignmentsData.grades.forEach(g => {
            if (g.all_subjects) { 
                g.all_subjects.forEach(s => {
                    if (s && s.id && !allSubjectsMap[s.id]) {
                        allSubjectsMap[s.id] = s;
                    }
                });
            }
        });

        // วนลูปผ่าน assignments ที่มีอยู่
        for (const assignmentKey in assignmentsData.assignments) {
             const [subjectIdStr, classroomIdStr] = assignmentKey.split('-');
             const subjectId = parseInt(subjectIdStr);
             const teacherIds = assignmentsData.assignments[assignmentKey] || [];
             const subject = allSubjectsMap[subjectId]; // ค้นหาวิชา

            if (!subject) continue; // ข้ามถ้าไม่พบข้อมูลวิชา

            teacherIds.forEach(teacherId => {
                if (!workload[teacherId]) {
                    const teacher = allTeachers.find(t => t.id == teacherId);
                    workload[teacherId] = {
                        name: teacher ? teacher.name : `Teacher ID: ${teacherId}`,
                        uniqueSubjectIds: new Set(),
                        rooms: 0,
                        periods: 0
                    };
                }
                workload[teacherId].uniqueSubjectIds.add(subjectId);
                workload[teacherId].rooms += 1;
                if (subject.credit) {
                     workload[teacherId].periods += (subject.credit * 2);
                }
            });
        }

        // คำนวณหน่วยกิตรวม (จาก Admin page)
        Object.values(workload).forEach(teacherData => {
            let totalCredits = 0;
            teacherData.uniqueSubjectIds.forEach(subjectId => {
                const subject = allSubjectsMap[subjectId];
                if (subject && subject.credit) {
                    totalCredits += subject.credit;
                }
            });
            teacherData.credits = totalCredits;
            teacherData.periods = teacherData.periods || 0;
        });
        
        renderWorkloadSummary(workload);
    }

    // --- 5. Render Workload Summary (เหมือนเดิม) ---
    function renderWorkloadSummary(workload) {
        if (Object.keys(workload).length === 0) {
            summaryDiv.innerHTML = '';
            return;
        }
        let html = `<div class="card"><div class="card-header"><h5><i class="bi bi-bar-chart-line-fill"></i> สรุปภาระงานสอน</h5></div><div class="card-body"><div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">`;
        const sortedTeachers = Object.values(workload).sort((a, b) => a.name.localeCompare(b.name));
        sortedTeachers.forEach(teacher => {
            html += `<div class="col"><div class="card bg-light h-100"><div class="card-body p-2"><h6 class="card-title mb-1">${teacher.name}</h6><ul class="list-unstyled mb-0 small text-muted">
                        <li><strong>หน่วยกิต:</strong> ${teacher.credits.toFixed(1)}</li>
                        <li><strong>จำนวนห้อง:</strong> ${teacher.rooms}</li>
                        <li><strong>ภาระงาน:</strong> ${teacher.periods.toFixed(1)} คาบ/สัปดาห์</li>
                     </ul></div></div></div>`;
        });
        html += `</div></div></div>`;
        summaryDiv.innerHTML = html;
    }

    // --- 6. Save Logic (ปรับปรุง) ---
    const handleAssignmentChange = async (subjectId, classroomId, selectedIds) => {
        statusDiv.textContent = 'กำลังบันทึก...';
        statusDiv.classList.remove('text-danger', 'text-success');

        const semesterId = semesterSelect.value;
        if (!semesterId) {
            statusDiv.textContent = '❌ กรุณาเลือกภาคเรียนก่อน';
            statusDiv.classList.add('text-danger');
            return Promise.reject("Missing semester ID"); // คืนค่า Promise reject สำหรับ Quick Assign
        }

        try {
            const response = await fetch("{{ url_for('admin.update_assignment') }}", { // ใช้ API ของ Admin (ตามโค้ดเดิม)
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    semester_id: parseInt(semesterId),
                    subject_id: parseInt(subjectId),
                    classroom_id: parseInt(classroomId),
                    teacher_ids: selectedIds
                })
            });

            if (!response.ok) {
                const errorResult = await response.json().catch(() => ({ message: 'Failed to parse error response' }));
                throw new Error(errorResult.message || `HTTP error! status: ${response.status}`);
            }
            const result = await response.json();

            // --- ✅ อัปเดต assignmentsData *หลังจาก* บันทึกสำเร็จ ---
            const assignmentKey = `${subjectId}-${classroomId}`;
            if (!assignmentsData.assignments) assignmentsData.assignments = {};

            if (result.status === 'deleted') {
                delete assignmentsData.assignments[assignmentKey];
                 console.log(`Local State: Deleted assignment for ${assignmentKey}`);
            } else if (result.teacher_ids !== undefined) {
                assignmentsData.assignments[assignmentKey] = result.teacher_ids;
                 console.log(`Local State: Updated assignment for ${assignmentKey} to`, result.teacher_ids);
            } else {
                 console.warn("API success but missing 'teacher_ids'. Local state unchanged.");
            }

            // --- ✅ คำนวณภาระงานใหม่ *หลังจาก* State อัปเดต ---
            updateWorkloadSummary();

            const now = new Date();
            statusDiv.textContent = `✔ บันทึกล่าสุด ${now.toLocaleTimeString('th-TH')}`;
            statusDiv.classList.add('text-success');

            return result; // คืนค่า result สำหรับ Quick Assign

        } catch (error) {
            console.error('Save error:', error);
            statusDiv.textContent = `❌ บันทึกล้มเหลว: ${error.message}`;
            statusDiv.classList.add('text-danger');
            // คืนค่า Promise reject สำหรับ Quick Assign
            return Promise.reject(error);
        }
    };

    // --- 6. Quick Assign (ใช้ Promise.all, อัปเดต UI/State หลังสำเร็จ) ---
    gridContainer.addEventListener('click', async function(e) {
        const btn = e.target.closest('.quick-assign-btn');
        if (!btn) return;

        // ป้องกันคลิกซ้ำ
        if (btn.disabled) return;
        btn.disabled = true;
        const originalIcon = btn.innerHTML; // เก็บไอคอนเดิม
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        const subjectId = btn.dataset.subjectId;
        const groupId = btn.dataset.groupId;
        const gradeId = btn.dataset.gradeId;

        // ใช้ State ล่าสุด
        const grade = assignmentsData.grades.find(g => g.id == gradeId);
        const teachers = (assignmentsData.teachers_by_group && assignmentsData.teachers_by_group[groupId]) ? assignmentsData.teachers_by_group[groupId] : [];

        // ตรวจสอบข้อมูลก่อนแสดง Swal
        if (!grade) {
            console.error("Quick Assign: Grade data not found.");
            Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลระดับชั้น', 'error');
            btn.disabled = false; btn.innerHTML = originalIcon;
            return;
        }
        if (teachers.length === 0) {
            Swal.fire('ไม่พบครู', 'ไม่พบครูที่สังกัดในกลุ่มสาระฯ นี้', 'warning');
            btn.disabled = false; btn.innerHTML = originalIcon;
            return;
        }

        // --- แสดง Swal ให้เลือกครู ---
        const inputOptions = teachers.reduce((acc, t) => { acc[t.id] = t.name; return acc; }, {});
        const { value: selectedTeacherId } = await Swal.fire({
            title: 'เลือกครูผู้สอนสำหรับทุกห้อง', input: 'select', inputOptions: inputOptions,
            inputPlaceholder: 'เลือกครู', showCancelButton: true, confirmButtonText: 'มอบหมาย', cancelButtonText: 'ยกเลิก',
            footer: 'การดำเนินการนี้จะเขียนทับข้อมูลเดิม (เฉพาะห้องที่สอน)'
        });

        // --- ถ้าผู้ใช้เลือกครู ---
        if (selectedTeacherId && selectedTeacherId !== '') {
            statusDiv.textContent = '⏳ กำลังมอบหมายด่วน...';
            // อาจจะเพิ่ม Overlay ทับตารางเฉพาะ Grade นี้ก็ได้

            const teacherIdArray = [parseInt(selectedTeacherId)];
            const teacherIdStringArray = [selectedTeacherId]; // สำหรับ TomSelect

            // กรองห้องที่เกี่ยวข้อง (เหมือนเดิม)
            const applicableClassrooms = grade.classrooms.filter(c => {
                 const classroomProgramId = c.program_id;
                 return classroomProgramId && grade.subjects_by_program &&
                        grade.subjects_by_program[classroomProgramId] &&
                        grade.subjects_by_program[classroomProgramId].some(s => s && s.id == subjectId);
            });

            // --- สร้าง Array ของ Promises ---
            const savePromises = [];
            applicableClassrooms.forEach(c => {
                 const selectElId = `cell-${subjectId}-${c.id}`;
                 const tomSelectInstance = tomSelectInstances[selectElId];
                 if (tomSelectInstance) {
                      // 1. อัปเดต UI (TomSelect) ก่อน *แบบเงียบๆ*
                     tomSelectInstance.setValue(teacherIdStringArray, true); // silent=true
                      // 2. เพิ่ม Promise ที่จะบันทึกข้อมูลนี้
                     savePromises.push(handleAssignmentChange(subjectId, c.id, teacherIdArray));
                 } else {
                      console.warn(`Quick Assign: TomSelect instance not found for ${selectElId}`);
                 }
             });

            // --- รอให้ทุกการบันทึกเสร็จสิ้น ---
            try {
                const results = await Promise.all(savePromises); // results คือ array ของ return จาก handleAssignmentChange
                 console.log("Quick Assign results:", results);

                // --- อัปเดต UI สรุป (เมื่อทุกอย่างสำเร็จ) ---
                // assignmentsData ถูกอัปเดตใน handleAssignmentChange แล้ว
                updateWorkloadSummary();

                statusDiv.textContent = '✅ มอบหมายด่วนสำเร็จ';
                statusDiv.classList.remove('text-danger');
                statusDiv.classList.add('text-success');
                setTimeout(() => { if(statusDiv.textContent === '✅ มอบหมายด่วนสำเร็จ') statusDiv.textContent = ''; }, 5000);
            } catch (error) {
                // handleAssignmentChange จัดการ error message ของตัวเองแล้ว
                console.error("Quick Assign failed for at least one item:", error);
                statusDiv.textContent = '❌ เกิดข้อผิดพลาดบางส่วน';
                statusDiv.classList.add('text-danger');
                // ไม่ต้องโหลดใหม่, ให้ผู้ใช้เห็นว่าบันทึกสำเร็จ/ล้มเหลว
            } finally {
                // ปลดล็อคปุ่มเสมอ ไม่ว่าสำเร็จหรือล้มเหลว
                btn.disabled = false;
                btn.innerHTML = originalIcon;
            }
        } else {
            // กรณีผู้ใช้กด Cancel
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        }
    });

    // --- 7. Initial Load ---
    semesterSelect.addEventListener('change', fetchDataAndRenderUI);
    fetchDataAndRenderUI(); // โหลดข้อมูลครั้งแรก
});
</script>
{% endblock %}