{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}
{% block sidebar %}
    {% include 'admin/_sidebar.html' %}
{% endblock %}
{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-person-check-fill"></i> {{ title }}</h2>
    <span id="statusIndicator" class="fw-bold"></span>
</div>

<div class="card mb-3">
    <div class="card-body">
        {{ form.hidden_tag() }}
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <label for="yearSelect" class="form-label">ปีการศึกษา:</label>
                <select id="yearSelect" class="form-select">
                    {% for year in all_years %}
                    <option value="{{ year.id }}" {% if current_semester and year.id == current_semester.academic_year_id %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="semesterSelect" class="form-label">ภาคเรียน:</label>
                <select id="semesterSelect" class="form-select">
                    {# Options will be populated by JavaScript #}
                </select>
            </div>
        </div>
    </div>
</div>
<div id="workload-summary" class="mt-4"></div>
<hr>
{# --- เพิ่ม: Loading Overlay --- #}
<div id="assignment-content" class="position-relative">
    <div id="loading-overlay" class="position-absolute w-100 h-100 d-none justify-content-center align-items-center" style="background-color: rgba(255, 255, 255, 0.7); z-index: 10; border-radius: .375rem;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    {# Content will be loaded here by JavaScript #}
</div>

{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const yearSelect = document.getElementById('yearSelect');
        const semesterSelect = document.getElementById('semesterSelect');
        const contentDiv = document.getElementById('assignment-content');
        const statusIndicator = document.getElementById('statusIndicator');
        const loadingOverlay = document.getElementById('loading-overlay');
        const summaryDiv = document.getElementById('workload-summary');

        let assignmentsData = {};
        let tomSelectInstances = {};
        
        const semestersByYear = JSON.parse('{{ semesters_by_year_json|safe }}');
        const currentSemesterId = {{ current_semester.id if current_semester else 'null' }};

        function showLoading(show) {
            loadingOverlay.classList.toggle('d-none', !show);
            loadingOverlay.classList.toggle('d-flex', show);
        }

        function updateStatus(text, level = 'primary', duration = 2000) {
            statusIndicator.innerHTML = `<span class="text-${level}">${text}</span>`;
            if (level === 'success' || level === 'info') {
                setTimeout(() => statusIndicator.innerHTML = '', duration);
            }
        }

        function populateSemesters(yearId) {
            const semesters = semestersByYear[yearId] || [];
            semesterSelect.innerHTML = '';
            semesters.forEach(sem => {
                const option = new Option(`ภาคเรียนที่ ${sem.term}`, sem.id);
                semesterSelect.add(option);
            });
            // Set selection
            if (semesters.some(s => s.id === currentSemesterId)) {
                semesterSelect.value = currentSemesterId;
            }
            loadAssignmentData();
        }
        
        async function loadAssignmentData() {
            clearTimeout(saveTimer); // Clear pending saves if semester changes
            showLoading(true);
            updateStatus('กำลังโหลดข้อมูล...', 'info');
            contentDiv.innerHTML = ''; // Clear previous tables
            const selectedSemesterId = semesterSelect.value;
            const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
            if (!csrfTokenInput){
                console.error("CSRF Token not found for load data");
                updateStatus('ข้อผิดพลาด: ไม่พบ CSRF Token', 'danger');
                showLoading(false);
                return;
            }
            const csrfToken = csrfTokenInput.value;


            if (!selectedSemesterId) {
                updateStatus('กรุณาเลือกภาคเรียน', 'warning');
                showLoading(false);
                return;
            }

            try {
                const response = await fetch(`/admin/api/assignments-data?semester_id=${selectedSemesterId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data && data.grades && data.teachers_by_group) {
                    loadedData = data; // Store globally FOR TEACHER LIST ACCESS ONLY
                    contentDiv.innerHTML = ''; // Clear previous content again just in case

                    if (data.grades.length === 0) {
                        contentDiv.innerHTML = '<p class="text-muted text-center mt-5">ไม่พบข้อมูลห้องเรียนหรือหลักสูตรสำหรับภาคเรียนนี้</p>';
                    } else {
                        // Render each grade level section
                        data.grades.forEach(grade => {
                            const gradeElement = renderGradeTable(grade); // Render table HTML
                            contentDiv.appendChild(gradeElement);
                            renderTomSelects(grade); // Initialize TomSelects for this grade AFTER table is in DOM
                        });
                    }
                    showLoading(false);
                    updateStatus('', 'info'); // Clear status
                } else {
                    throw new Error("Invalid data structure received from API.");
                }
            } catch (error) {
                console.error('Error loading assignment data:', error);
                contentDiv.innerHTML = `<p class="text-danger text-center mt-5">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</p>`;
                updateStatus('โหลดข้อมูลล้มเหลว', 'danger');
                showLoading(false);
            }
        }

        function renderUI() {
            if (!assignmentsData.grades || assignmentsData.grades.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info mt-3">ไม่พบข้อมูลระดับชั้นในระบบ</div>';
                return;
            }

            let tabsHtml = '<ul class="nav nav-tabs" id="gradeTabs" role="tablist">';
            let tabContentHtml = '<div class="tab-content" id="gradeTabsContent">';

            assignmentsData.grades.forEach((grade, index) => {
                const isActive = index === 0;
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive ? 'active' : ''}" id="tab-${grade.id}" data-bs-toggle="tab" data-bs-target="#content-${grade.id}" type="button" role="tab">${grade.name}</button>
                    </li>`;
                
                tabContentHtml += `
                    <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="content-${grade.id}" role="tabpanel">
                        <div class="card card-body border-top-0 rounded-bottom">
                            ${renderGradeTable(grade)}
                        </div>
                    </div>`;
            });

            tabsHtml += '</ul>';
            tabContentHtml += '</div>';
            contentDiv.innerHTML = tabsHtml + tabContentHtml;
            initializeTomSelects();
        }

        function renderGradeTable(grade) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-responsive mb-4'; // Add margin bottom

            let tableHtml = `<h4 class="mt-4 mb-3">ระดับชั้น ${grade.name}</h4>`;
            tableHtml += `<table class="table table-bordered table-hover align-middle assignment-table" id="gradeTable-${grade.id}">`;

            // Header Row: Subject + Classrooms with Program & Credits
            tableHtml += '<thead><tr class="table-light text-center">';
            tableHtml += '<th class="sticky-col">รายวิชา (หน่วยกิต)</th>'; // Make first column sticky
            grade.classrooms.forEach(c => {
                tableHtml += `<th>${c.name}<br><small class="text-muted fw-normal">${c.program_name} (${c.total_credits.toFixed(1)} นก.)</small></th>`;
            });
            tableHtml += '</tr></thead>';

            // Body Rows: One row per unique subject in this grade level
            tableHtml += '<tbody>';
            // 1. Get a unique, sorted list of all subjects across all programs for this grade
            const allSubjectsInGrade = {};
            if (grade.subjects_by_program) { // Check if subjects_by_program exists
                Object.values(grade.subjects_by_program).forEach(programSubjects => {
                    if(programSubjects){ // Check if programSubjects array exists
                        programSubjects.forEach(s => {
                            if (!allSubjectsInGrade[s.id]) {
                                allSubjectsInGrade[s.id] = s;
                            }
                        });
                    }
                });
            }
            const sortedSubjects = Object.values(allSubjectsInGrade).sort((a, b) => a.code.localeCompare(b.code));

            // 2. Iterate through the unique subjects to create rows
            sortedSubjects.forEach(subject => {
                tableHtml += `<tr><td class="sticky-col align-middle">${subject.code} - ${subject.name} (${subject.credit.toFixed(1)})</td>`; // Make first column sticky

                // 3. For each classroom column, check if this subject applies
                grade.classrooms.forEach(classroom => {
                    const classroomProgramId = classroom.program_id;
                    // Subject applies if the classroom has a program AND the subject is in that program's list for this grade
                    const subjectApplies = classroomProgramId &&
                                        grade.subjects_by_program && // Check existence
                                        grade.subjects_by_program[classroomProgramId] && // Check existence
                                        grade.subjects_by_program[classroomProgramId].some(s => s.id === subject.id);

                    if (subjectApplies) {
                        const selectId = `teacherSelect-${subject.id}-${classroom.id}`;
                        // Render the select, TomSelect will populate options and selected items later
                        tableHtml += `<td class="text-center align-middle">
                                        <select id="${selectId}" class="teacher-select"
                                                data-subject-id="${subject.id}"
                                                data-classroom-id="${classroom.id}"
                                                data-group-id="${subject.group_id}"
                                                multiple>
                                            </select>
                                    </td>`;
                    } else {
                        // Subject does not apply to this classroom's program, or classroom has no program
                        tableHtml += '<td class="text-center align-middle text-muted bg-light">-</td>';
                    }
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody>';

            tableHtml += '</table>';
            tableContainer.innerHTML = tableHtml;
            return tableContainer;
        }

        function renderTomSelects(gradeData) {
            if (!loadedData || !loadedData.teachers_by_group) return; // Ensure global teacher data is loaded

            const teacherOptions = {}; // Prepare options by group
            for (const groupId in loadedData.teachers_by_group) {
                teacherOptions[groupId] = loadedData.teachers_by_group[groupId].map(t => ({ value: t.id, text: t.name }));
            }

            gradeData.classrooms.forEach(classroom => {
                const classroomProgramId = classroom.program_id;
                // Skip classrooms without an assigned program, as they won't have applicable subjects based on V26 logic
                if (!classroomProgramId) return;

                // Get subjects specifically for this classroom's program and grade
                const subjectsForProgram = (gradeData.subjects_by_program && gradeData.subjects_by_program[classroomProgramId]) ? gradeData.subjects_by_program[classroomProgramId] : [];


                subjectsForProgram.forEach(subject => {
                    const selectId = `teacherSelect-${subject.id}-${classroom.id}`;
                    const selectElement = document.getElementById(selectId);
                    // If the element doesn't exist (e.g., table structure changed or subject didn't apply), skip
                    if (!selectElement) return;

                    const groupId = subject.group_id;
                    const options = teacherOptions[groupId] || []; // Get teachers for this subject's group
                    const assignmentKey = `${subject.id}-${classroom.id}`;
                    // Get selected teachers from the assignments specific to this grade
                    const selectedItems = (gradeData.assignments && gradeData.assignments[assignmentKey]) ? gradeData.assignments[assignmentKey] : [];


                    // Ensure previous TomSelect instance is destroyed before creating a new one
                    if (selectElement.tomselect) {
                        selectElement.tomselect.destroy();
                    }

                    // Initialize TomSelect for this specific subject-classroom cell
                    try {
                        new TomSelect(selectElement, {
                            options: options,
                            items: selectedItems,
                            placeholder: 'เลือกครูผู้สอน',
                            plugins: ['remove_button'],
                            create: false, // Don't allow creating new teachers here
                            maxItems: null, // Allow multiple teachers
                            onChange: function(value) { // Use regular function for 'this' context if needed
                                // 'this.items' contains the array of selected teacher IDs (strings)
                                scheduleSaveAssignment(subject.id, classroom.id, this.items.map(id => parseInt(id))); // Ensure IDs are numbers
                            }
                        });
                    } catch (e) {
                        console.error(`Failed to initialize TomSelect for ${selectId}:`, e);
                        // Optionally display an error message in the cell
                        selectElement.outerHTML = '<span class="text-danger small">Error loading teachers</span>';
                    }
                });
            });
        }

        function getTeacherOptions(groupId, selectedIds = []) {
            const teachers = assignmentsData.teachers_by_group[groupId] || [];
            if (teachers.length === 0) return '<option disabled>ไม่พบครูในกลุ่มสาระฯ</option>';
            return teachers.map(t => 
                `<option value="${t.id}" ${selectedIds.includes(t.id) ? 'selected' : ''}>${t.name}</option>`
            ).join('');
        }

        function initializeTomSelects() {
            Object.values(tomSelectInstances).forEach(ts => ts.destroy());
            tomSelectInstances = {};

            document.querySelectorAll('.teacher-select').forEach(el => {
                const instance = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    placeholder: 'เลือกครูผู้สอน...',
                    onChange: (value) => {
                        const teacherIds = Array.isArray(value) ? value.map(v => parseInt(v)) : (value ? [parseInt(value)] : []);
                        saveAssignment(
                            el.dataset.subjectId,
                            el.dataset.classroomId,
                            teacherIds
                        );
                    }
                });
                tomSelectInstances[el.id] = instance;
            });
        }
        
        async function saveAssignment(subjectId, classroomId, teacherIds) {
            updateStatus('กำลังบันทึก...', 'primary');
            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                // --- ส่วนที่แก้ไข: เปลี่ยนมาใช้ url_for เพื่อสร้าง URL ที่ถูกต้อง ---
                const saveUrl = "{{ url_for('admin.update_assignment') }}";
                const response = await fetch(saveUrl, {
                // -----------------------------------------------------------------
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({
                        semester_id: semesterSelect.value,
                        subject_id: parseInt(subjectId),
                        classroom_id: parseInt(classroomId),
                        teacher_ids: teacherIds
                    })
                });
                if (!response.ok) throw new Error('Save failed');
                const result = await response.json();
                
                // Update local data model to prevent full reload
                const gradeId = document.querySelector('.tab-pane.active').id.replace('content-', '');
                const grade = assignmentsData.grades.find(g => g.id == gradeId);
                const assignmentKey = `${subjectId}-${classroomId}`;
                if (result.status === 'deleted') {
                    delete grade.assignments[assignmentKey];
                } else {
                    grade.assignments[assignmentKey] = result.teacher_ids;
                }
                updateWorkloadSummary();
                updateStatus('บันทึกเรียบร้อย', 'success');
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('บันทึกไม่สำเร็จ', 'danger');
            }
        }

        function updateWorkloadSummary() {
            const workload = {}; 
            const allTeachers = Object.values(assignmentsData.teachers_by_group).flat();
            const allSubjects = assignmentsData.grades.flatMap(g => g.subjects);

            // Step 1: Iterate through all assignments to gather raw data
            assignmentsData.grades.forEach(grade => {
                grade.subjects.forEach(subject => {
                    grade.classrooms.forEach(classroom => {
                        const key = `${subject.id}-${classroom.id}`;
                        const teacherIds = grade.assignments[key] || [];
                        
                        teacherIds.forEach(teacherId => {
                            if (!workload[teacherId]) {
                                const teacher = allTeachers.find(t => t.id == teacherId);
                                workload[teacherId] = {
                                    name: teacher ? teacher.name : `Teacher ID: ${teacherId}`,
                                    uniqueSubjectIds: new Set(),
                                    rooms: 0,
                                    periods: 0
                                };
                            }
                            workload[teacherId].uniqueSubjectIds.add(subject.id);
                            workload[teacherId].rooms += 1;
                            workload[teacherId].periods += (subject.credit * 2); 
                        });
                    });
                });
            });

            // Step 2: Calculate total credits based on unique subjects
            Object.values(workload).forEach(teacherData => {
                let totalCredits = 0;
                teacherData.uniqueSubjectIds.forEach(subjectId => {
                    const subject = allSubjects.find(s => s.id === subjectId);
                    if (subject) {
                        totalCredits += subject.credit;
                    }
                });
                teacherData.credits = totalCredits;
            });
            
            renderWorkloadSummary(workload);
        }

        function renderWorkloadSummary(workload) {
            if (Object.keys(workload).length === 0) {
                summaryDiv.innerHTML = '';
                return;
            }

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart-line-fill"></i> สรุปภาระงานสอน</h5>
                    </div>
                    <div class="card-body">
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">`;

            // Sort teachers by name
            const sortedTeachers = Object.values(workload).sort((a, b) => a.name.localeCompare(b.name));

            sortedTeachers.forEach(teacher => {
                html += `
                    <div class="col">
                        <div class="card bg-light h-100">
                            <div class="card-body">
                                <h6 class="card-title">${teacher.name}</h6>
                                <ul class="list-unstyled mb-0 small">
                                    <li><strong>หน่วยกิต:</strong> ${teacher.credits.toFixed(1)}</li>
                                    <li><strong>จำนวนห้อง:</strong> ${teacher.rooms}</li>
                                    <li><strong>ภาระงาน:</strong> ${teacher.periods.toFixed(1)} คาบ/สัปดาห์</li>
                                </ul>
                            </div>
                        </div>
                    </div>`;
            });
            
            html += `   </div>
                    </div>
                </div>`;
            summaryDiv.innerHTML = html;
        }
                
        contentDiv.addEventListener('click', async function(e) {
            const btn = e.target.closest('.quick-assign-btn');
            if (!btn) return;

            const subjectId = btn.dataset.subjectId;
            const groupId = btn.dataset.groupId;
            const gradeId = btn.dataset.gradeId;
            
            const grade = assignmentsData.grades.find(g => g.id == gradeId);
            const teachers = assignmentsData.teachers_by_group[groupId] || [];
            if (teachers.length === 0) {
                Swal.fire('ไม่พบครู', 'ไม่พบครูที่สังกัดในกลุ่มสาระฯ นี้', 'warning');
                return;
            }
            const inputOptions = teachers.reduce((acc, t) => { acc[t.id] = t.name; return acc; }, {});

            // เปลี่ยนชื่อตัวแปรให้ชัดเจนขึ้นว่าเป็น ID ของครูคนเดียว
            const { value: selectedTeacherId } = await Swal.fire({
                title: 'เลือกครูผู้สอนสำหรับทุกห้อง',
                input: 'select',
                inputOptions: inputOptions,
                inputPlaceholder: 'เลือกครู',
                showCancelButton: true,
                confirmButtonText: 'มอบหมาย',
                footer: 'การดำเนินการนี้จะเขียนทับข้อมูลเดิมทั้งหมดของวิชานี้'
            });

            // --- จุดแก้ไขสำคัญ: ตรวจสอบว่า selectedTeacherId มีค่าและไม่ใช่สตริงว่าง ---
            if (selectedTeacherId && selectedTeacherId !== '') {
                showLoading(true);
                updateStatus('กำลังดำเนินการ...', 'primary');

                // แปลง ID ที่เป็น string ให้เป็น number แล้วใส่ใน array
                const teacherIdArray = [parseInt(selectedTeacherId)];

                const promises = grade.classrooms.map(c => saveAssignment(subjectId, c.id, teacherIdArray));
                
                try {
                    await Promise.all(promises);
                    updateStatus('มอบหมายด่วนสำเร็จ', 'info');
                    loadAssignmentData(); // Reload UI to reflect widespread changes
                } catch (error) {
                    updateStatus('เกิดข้อผิดพลาด', 'danger');
                    showLoading(false);
                }
            }
        });
        // Initial Load
        populateSemesters(yearSelect.value);
        
        yearSelect.addEventListener('change', () => populateSemesters(yearSelect.value));
        semesterSelect.addEventListener('change', loadAssignmentData);
    });
</script>
{% endblock %}