{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}
{% block sidebar %}
    {% include 'admin/_sidebar.html' %}
{% endblock %}

{% block main_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="bi bi-people"> {{ title }}</h2>
        <div>
            <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary me-2"><i class="bi bi-plus-lg"></i> เพิ่มครูใหม่</a>
            <a href="{{ url_for('admin.import_teachers') }}" class="btn btn-info"><i class="bi bi-upload"></i> นำเข้าข้อมูลครู</a>
        </div>
    </div>

    {# --- ฟอร์ม Filter (เหมือนเดิม) --- #}
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.list_users') }}" id="filter-form"> {# <-- [ใหม่] เพิ่ม ID ให้ฟอร์ม #}
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="nameFilter" class="form-label">ค้นหาตามชื่อ/Username</label>
                        <input type="text" class="form-control" id="nameFilter" name="name" value="{{ current_name_filter or '' }}">
                    </div>
                    <div class="col-md-6">
                        <label for="roleFilter" class="form-label">กรองตามบทบาท</label>
                        <select class="form-select" id="roleFilter" name="role_id">
                            <option value="">-- ทุกบทบาท --</option>
                            {% for role in all_roles %}
                            <option value="{{ role.id }}" {% if role.id == current_role_id %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {# --- [แก้ไข] ลบตารางและ Pagination เดิมออก --- #}
    {# --- ใส่ Container ว่างๆ นี้ไว้รอรับข้อมูล AJAX --- #}
    <div id="user-table-container">
        {# ตารางและ Pagination จาก _users_table.html จะถูกโหลดมาใส่ตรงนี้ #}
        {# (เราจะโหลดข้อมูลเริ่มต้นโดยใช้ JavaScript) #}
    </div>

{# --- [แก้ไข] แทนที่ JavaScript เดิมทั้งหมด --- #}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('nameFilter');
    const roleSelect = document.getElementById('roleFilter');
    const tableContainer = document.getElementById('user-table-container');
    const filterForm = document.getElementById('filter-form');
    let debounceTimeout;

    /**
     * ฟังก์ชันสำหรับดึงข้อมูลตารางใหม่ด้วย AJAX
     */
    async function fetchAndUpdateTable(url) {
        try {
            // 1. แสดงสถานะกำลังโหลด
            tableContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
            
            // 2. ส่ง Request ไปยัง URL (เช่น /admin/users?name=test)
            const response = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // <-- [สำคัญ] ส่ง Header นี้เพื่อให้ Backend รู้
                }
            });

            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            
            // 3. นำ HTML ที่ได้ (จากไฟล์ _users_table.html) มาใส่ใน Container
            const html = await response.text();
            tableContainer.innerHTML = html;
            
            // 4. [สำคัญ] อัปเดต URL ในบราวเซอร์ (โดยที่หน้าไม่รีโหลด)
            window.history.pushState({}, '', url);

        } catch (error) {
            console.error('Fetch error:', error);
            tableContainer.innerHTML = '<div class="alert alert-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
        }
    }

    /**
     * ฟังก์ชันสำหรับสร้าง URL และเรียก fetch
     */
    function applyFilters(page = 1) { // ค่าเริ่มต้นคือหน้า 1
        const nameValue = nameInput.value.trim();
        const roleValue = roleSelect.value;
        
        // ใช้ URL ปัจจุบันเป็นฐาน หรือใช้ action ของฟอร์ม
        const baseUrl = new URL(filterForm.action || window.location.href);
        
        baseUrl.searchParams.set('name', nameValue);
        baseUrl.searchParams.set('role_id', roleValue);
        baseUrl.searchParams.set('page', page); // ตั้งค่าหน้า

        fetchAndUpdateTable(baseUrl.toString());
    }

    // --- Event Listeners ---

    // 1. Listener สำหรับช่องค้นหาชื่อ (ทำงานหลังหยุดพิมพ์ 500ms)
    nameInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            applyFilters(1); // ค้นหาใหม่ ให้เริ่มที่หน้า 1
        }, 500);
    });

    // 2. Listener สำหรับ Dropdown บทบาท (ทำงานทันทีที่เลือก)
    roleSelect.addEventListener('change', () => {
        applyFilters(1); // เลือกใหม่ ให้เริ่มที่หน้า 1
    });

    // 3. [สำคัญ] Listener สำหรับ Pagination (Event Delegation)
    // เราต้องดักฟังที่ 'tableContainer' เพราะปุ่ม Pagination จะถูกโหลดมาใหม่เรื่อยๆ
    tableContainer.addEventListener('click', function(event) {
        const target = event.target;
        
        // ตรวจสอบว่าที่คลิกคือลิงก์ Pagination (<a> ที่มี class 'page-link')
        if (target.tagName === 'A' && target.classList.contains('page-link')) {
            event.preventDefault(); // ป้องกันการรีโหลดหน้า
            const url = target.getAttribute('href');
            if (url && url !== '#') {
                fetchAndUpdateTable(url); // เรียกโหลดข้อมูลตาม URL ของปุ่มที่กด
            }
        }
    });

    // --- Initial Load ---
    // โหลดตารางครั้งแรกเมื่อหน้าเว็บพร้อม
    // (ใช้ URL ปัจจุบัน ซึ่งอาจจะมี filter ค้างอยู่ ถ้าผู้ใช้กด F5)
    fetchAndUpdateTable(window.location.href);

});
</script>
{% endblock %}
{% endblock %}