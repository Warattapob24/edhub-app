{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}
{% block sidebar %}
    {% include 'admin/_sidebar.html' %}
{% endblock %}
{% block main_content %}
    {{ csrf_form.hidden_tag() }}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="bi bi-grid-3x3-gap"> {{ title }}</h2>
        <a href="{{ url_for('admin.add_classroom') }}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> เพิ่มห้องเรียนใหม่</a>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ชื่อห้องเรียน</th>
                            <th style="width: 25%;">สายการเรียน</th>
                            <th>ปีการศึกษา</th>
                            <th class="text-end">การกระทำ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# 1. วนลูปผ่าน Dictionary (key=ชื่อระดับชั้น, value=list ของห้องเรียน) #}
                        {% for grade_name, classrooms_in_grade in classrooms_by_grade.items() %}

                            {# 2. ตรวจสอบว่ามีห้องเรียนในระดับชั้นนี้หรือไม่ #}
                            {% if classrooms_in_grade %}

                                {# 3. แสดงแถว Header สำหรับระดับชั้น #}
                                <tr>
                                    {# ใช้ colspan=5 ให้ตรงกับจำนวนคอลัมน์จริง #}
                                    <td colspan="5" class="table-group-header bg-light fw-bold"><strong>{{ grade_name }}</strong></td>
                                </tr>

                                {# 4. วนลูปแสดงข้อมูลห้องเรียนแต่ละห้องในระดับชั้นนั้น #}
                                {% for classroom in classrooms_in_grade %}
                                <tr>
                                    <td>{{ classroom.name }}</td>
                                    <td>
                                        <select class="form-select form-select-sm program-select" data-classroom-id="{{ classroom.id }}">
                                            <option value="0" {% if not classroom.program_id %}selected{% endif %}>-- ยังไม่ได้กำหนด --</option>
                                            {% for program in all_programs %}
                                            <option value="{{ program.id }}" {% if classroom.program_id == program.id %}selected{% endif %}>
                                                {{ program.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="save-status small text-muted ms-2" id="status-{{ classroom.id }}"></span>
                                    </td>
                                    {# ลบ classroom.grade_level.name ออก เพราะเราแสดงเป็น Header ไปแล้ว #}
                                    {# <td>{{ classroom.grade_level.name }}</td> #}
                                    <td>{{ classroom.academic_year.year }}</td>
                                    <td class="text-end">
                                        <a href="{{ url_for('admin.assign_advisors', classroom_id=classroom.id) }}" class="btn btn-sm btn-info" title="มอบหมายครูที่ปรึกษา"><i class="bi bi-person-check-fill"></i></a>
                                        <a href="{{ url_for('admin.manage_enrollment', classroom_id=classroom.id) }}" class="btn btn-sm btn-secondary" title="จัดการนักเรียน"><i class="bi bi-people-fill"></i></a>
                                        <a href="{{ url_for('admin.edit_classroom', classroom_id=classroom.id) }}" class="btn btn-sm btn-warning" title="แก้ไข"><i class="bi bi-pencil-fill"></i></a>
                                        <form action="{{ url_for('admin.delete_classroom', classroom_id=classroom.id) }}" method="POST" class="d-inline" onsubmit="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?');">
                                            {{ csrf_form.hidden_tag() }} {# เพิ่ม CSRF Token สำหรับฟอร์มลบ #}
                                            <button type="submit" class="btn btn-sm btn-danger" title="ลบ"><i class="bi bi-trash-fill"></i></button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %} {# สิ้นสุด loop ของ classroom #}

                            {% endif %} {# สิ้นสุด if classrooms_in_grade #}

                        {# 5. จัดการกรณีที่ classrooms_by_grade ว่างเปล่า (ไม่มีข้อมูลเลย) #}
                        {% else %}
                        <tr>
                            {# ใช้ colspan=5 ให้ตรงกับจำนวนคอลัมน์จริง #}
                            <td colspan="5" class="text-center">ยังไม่มีข้อมูลห้องเรียนในระบบสำหรับปีการศึกษาปัจจุบัน</td>
                        </tr>
                        {% endfor %} {# สิ้นสุด loop ของ classrooms_by_grade #}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('admin.list_classrooms', page=pagination.prev_num) }}">ก่อนหน้า</a></li>
                {% else %}
                    <li class="page-item disabled"><a class="page-link" href="#">ก่อนหน้า</a></li>
                {% endif %}
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.list_classrooms', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                {% if pagination.has_next %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('admin.list_classrooms', page=pagination.next_num) }}">ถัดไป</a></li>
                {% else %}
                    <li class="page-item disabled"><a class="page-link" href="#">ถัดไป</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.program-select');
    const csrfToken = document.querySelector('input[name="csrf_token"]').value; // Assuming you have a CSRF token from FlaskForm

    selects.forEach(select => {
        select.addEventListener('change', async function() {
            const classroomId = this.dataset.classroomId;
            const selectedProgramId = this.value;
            const statusSpan = document.getElementById(`status-${classroomId}`);

            if (!statusSpan) return;

            statusSpan.textContent = 'กำลังบันทึก...';
            statusSpan.className = 'save-status small text-warning ms-2'; // Show saving state

            try {
                const response = await fetch(`/admin/api/classroom/${classroomId}/set-program`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // Send CSRF token in header
                    },
                    body: JSON.stringify({ program_id: selectedProgramId })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    statusSpan.textContent = '✔ บันทึกแล้ว';
                    statusSpan.className = 'save-status small text-success ms-2';
                    // Optional: Fade out success message after a few seconds
                    setTimeout(() => { 
                        if (statusSpan.textContent === '✔ บันทึกแล้ว') { // Check if still success
                           statusSpan.textContent = ''; 
                        }
                    }, 3000); 
                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาด');
                }
            } catch (error) {
                console.error('Error saving program:', error);
                statusSpan.textContent = '❌ บันทึกล้มเหลว';
                statusSpan.className = 'save-status small text-danger ms-2';
                 // Optional: Show more detailed error via alert or tooltip
                 // alert(`Error: ${error.message}`); 
            }
        });
    });
});
</script>    
{% endblock %}