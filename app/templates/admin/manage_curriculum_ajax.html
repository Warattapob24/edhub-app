{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}
{% block sidebar %}
    {% include 'admin/_sidebar.html' %}
{% endblock %}
{% block main_content %}
    <h2 class="bi bi-journal-check"> {{ title }}</h2>
    <p class="text-muted">เลือกภาคเรียน, ระดับชั้น และสายการเรียน (การเปลี่ยนแปลงจะถูกบันทึกอัตโนมัติ)</p>

    {# Form สำหรับเลือก Semester, GradeLevel, Program #}
    <div class="card mb-3">
        <div class="card-body">
            {{ form.hidden_tag() }} {# Includes CSRF token needed for POST #}
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <label class="form-label">ภาคเรียน:</label>
                    {{ form.semester(class="form-select", id="semesterSelect") }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">ระดับชั้น:</label>
                    {{ form.grade_level(class="form-select", id="gradeSelect") }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">สายการเรียน:</label>
                    {{ form.program(class="form-select", id="programSelect") }} {# <-- Dropdown ใหม่ #}
                </div>
                <div class="col-md-12 text-end mt-2">
                    <span id="statusIndicator" class="fw-bold"></span>
                </div>
            </div>
        </div>
    </div>

    {# Container สำหรับแสดง Checkbox รายวิชา #}
    <div id="subjectsContainer" class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                หลักสูตรสำหรับ: <strong id="gradeLevelName">-</strong> / <strong id="semesterName">-</strong> / <strong id="programName">-</strong> {# <-- เพิ่ม Program Name Span #}
            </h5>
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary rounded-pill fs-6 me-3" id="totalCreditsDisplay">หน่วยกิตรวม: กำลังโหลด...</span> {# <-- แสดงหน่วยกิตรวม #}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheck" onchange="toggleAll(this.checked)">
                    <label class="form-check-label" for="selectAllCheck">เลือก/ยกเลิกทั้งหมด</label>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="subjectsCheckboxList" class="border rounded p-3" style="min-height: 400px; overflow-y: scroll;">
                {# Checkboxes will be rendered here by JavaScript #}
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    // <<< ฟังก์ชัน Global Scope สำหรับ onchange >>>
    function toggleAll(checked) {
        if (document.readyState === "complete" || document.readyState === "interactive") {
            document.querySelectorAll('legend .form-check-input, .subject-checkbox').forEach(cb => cb.checked = checked);
            scheduleSaveChanges();
            updateGroupCheckboxes(); // Update group checkboxes when select all changes
        }
    }

    function toggleGroup(groupClass, checked) {
        if (document.readyState === "complete" || document.readyState === "interactive") {
            document.querySelectorAll('.' + groupClass).forEach(cb => cb.checked = checked);
            scheduleSaveChanges();
            updateSelectAllCheckboxState(); // Update select all checkbox when a group changes
        }
    }

    // Placeholder function, will be defined inside DOMContentLoaded
    let scheduleSaveChanges = () => { console.log("DOM not ready for saving."); };
    let updateSelectAllCheckboxState = () => {}; // Placeholder
    let updateGroupCheckboxes = () => {}; // Placeholder


    document.addEventListener('DOMContentLoaded', () => {
        // --- ตัวแปร Global ภายใน DOMContentLoaded ---
        const masterCurriculum = JSON.parse('{{ master_curriculum_json|safe }}');
        let allExistingCurriculum = JSON.parse('{{ all_existing_curriculum_json|safe }}');

        const semesterSelect = document.getElementById('semesterSelect');
        const gradeSelect = document.getElementById('gradeSelect');
        const programSelect = document.getElementById('programSelect'); // <-- เพิ่ม Program Select
        const subjectsCheckboxList = document.getElementById('subjectsCheckboxList');
        const statusIndicator = document.getElementById('statusIndicator');
        const gradeLevelNameSpan = document.getElementById('gradeLevelName');
        const semesterNameSpan = document.getElementById('semesterName');
        const programNameSpan = document.getElementById('programName'); // <-- เพิ่ม Program Name Span
        const totalCreditsDisplay = document.getElementById('totalCreditsDisplay');
        const selectAllCheckbox = document.getElementById('selectAllCheck');
        let saveTimer; // Timer for debouncing

        // --- ฟังก์ชัน Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- กำหนดค่าให้ scheduleSaveChanges (Debounced Save) ---
        scheduleSaveChanges = debounce(() => {
            statusIndicator.innerHTML = '<span class="text-warning">มีการเปลี่ยนแปลง...</span>'; // Indicate change detected
            saveTimer = setTimeout(autoSaveChanges, 1500); // Set timer for actual save
            updateSelectAllCheckboxState(); // Update select all state immediately on change
            updateGroupCheckboxes(); // Update group checkboxes immediately on change
            updateTotalCreditsDisplay(); // Update total credits immediately on change
        }, 300); // Debounce input changes slightly before showing "มีการเปลี่ยนแปลง..."


        // --- ฟังก์ชันบันทึกข้อมูลอัตโนมัติ (Async) ---
        async function autoSaveChanges() {
            clearTimeout(saveTimer); // Clear any pending save timer
            showLoading(true); // Show loading indicator (implement this function if needed)
            updateStatus('กำลังบันทึก...', 'primary');

            const selectedCheckboxes = subjectsCheckboxList.querySelectorAll('.subject-checkbox:checked');
            const selectedSubjectIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            const payload = {
                semester_id: semesterSelect.value,
                grade_level_id: gradeSelect.value,
                program_id: programSelect.value, // <-- เพิ่ม program_id
                subject_ids: selectedSubjectIds
            };

            const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
            if (!csrfTokenInput) {
                console.error('CSRF token input not found!');
                updateStatus('✗ ข้อผิดพลาด: ไม่พบ Token', 'danger');
                showLoading(false);
                return;
            }
            const csrfToken = csrfTokenInput.value;

            try {
                const response = await fetch("{{ url_for('admin.manage_curriculum') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // Send CSRF token in header
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    statusIndicator.innerHTML = '<span class="text-success">✔ บันทึกเรียบร้อย</span>';
                    // สร้าง Key ใหม่ โดยรวม programId
                    const existingKey = `${semesterSelect.value}-${gradeSelect.value}-${programSelect.value}`; // <-- Key ใหม่
                    // Update the local cache of existing curriculum
                    allExistingCurriculum[existingKey] = selectedSubjectIds;
                    // Note: updateTotalCreditsAfterSave is not needed here as updateTotalCreditsDisplay runs on scheduleSaveChanges
                } else {
                    throw new Error(result.message || `HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                statusIndicator.innerHTML = `<span class="text-danger">❌ บันทึกล้มเหลว: ${error.message}</span>`;
            } finally {
                showLoading(false); // Hide loading indicator
                // Clear status after a few seconds only if it's a success/fail message
                setTimeout(() => {
                    const currentStatus = statusIndicator.textContent || statusIndicator.innerText;
                     if (currentStatus.startsWith('✔') || currentStatus.startsWith('❌')) {
                        statusIndicator.innerHTML = ''; // Clear only success/fail, not "กำลังพิมพ์..."
                     }
                }, 5000);
            }
        }

        // --- ฟังก์ชันอัปเดต URL ---
        function updateUrl() {
            const semesterId = semesterSelect.value;
            const gradeId = gradeSelect.value;
            const programId = programSelect.value; // <-- เพิ่ม Program ID
            if (!semesterId || !gradeId || !programId) return; // Don't update URL if selects aren't valid yet

            const url = new URL(window.location);
            url.searchParams.set('semester', semesterId);
            url.searchParams.set('grade_level', gradeId);
            url.searchParams.set('program', programId); // <-- เพิ่ม Program Parameter
            window.history.pushState({}, '', url); // Use pushState to avoid page reload
        }

        // --- ฟังก์ชันอัปเดตการแสดงผล Checkbox และข้อมูล ---
        function updateDisplay() {
            const gradeId = gradeSelect.value;
            const semesterId = semesterSelect.value;
            const programId = programSelect.value; // <-- อ่านค่า programId

            // Clear previous save timer if selection changes
            clearTimeout(saveTimer);
            statusIndicator.innerHTML = ''; // Clear status immediately

            if (!gradeId || !semesterId || !programId) { // <-- เช็ค programId ด้วย
                subjectsCheckboxList.innerHTML = '<p class="text-muted text-center mt-5">กรุณาเลือกภาคเรียน, ระดับชั้น และสายการเรียน</p>';
                totalCreditsDisplay.textContent = 'หน่วยกิตรวม: -';
                gradeLevelNameSpan.textContent = '-';
                semesterNameSpan.textContent = '-';
                programNameSpan.textContent = '-'; // <-- เคลียร์ Program Name
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }

            // Update headers
            gradeLevelNameSpan.textContent = gradeSelect.options[gradeSelect.selectedIndex].text;
            const semesterOptionText = semesterSelect.options[semesterSelect.selectedIndex].text;
            semesterNameSpan.textContent = semesterOptionText.replace(/ปีการศึกษา\s*/, '');
            programNameSpan.textContent = programSelect.options[programSelect.selectedIndex].text; // <-- อัปเดต Program Name

            const subjectsForGrade = masterCurriculum[gradeId] || [];
            const existingKey = `${semesterId}-${gradeId}-${programId}`; // <-- Key ใหม่
            const existingSubjectIds = allExistingCurriculum[existingKey] || [];
            const groupedByType = subjectsForGrade.reduce((acc, subject) => {
                if (!acc[subject.type]) acc[subject.type] = [];
                acc[subject.type].push(subject);
                return acc;
            }, {});

            let html = '';
            let currentTotalCredits = 0;
            let anySubjectChecked = false;
            let allSubjectsRenderedCount = 0;

            if (subjectsForGrade.length === 0) {
                html = '<p class="text-muted text-center mt-5">ไม่พบรายวิชาที่ผูกกับระดับชั้นนี้ (กรุณาตรวจสอบในเมนู "จัดการรายวิชา")</p>';
            } else {
                let groupIndex = 0;
                for (const type in groupedByType) {
                    const groupIdentifier = `group-${groupIndex}`;
                    html += `<fieldset class="mb-3 border p-3 rounded-3"><legend class="fs-6 fw-bold"><div class="form-check"><input type="checkbox" class="form-check-input group-check" id="group-check-${groupIdentifier}" onchange="toggleGroup('${groupIdentifier}', this.checked)"><label class="form-check-label" for="group-check-${groupIdentifier}">ประเภท: ${type}</label></div></legend>`;
                    groupedByType[type].forEach(subject => {
                        const isChecked = existingSubjectIds.includes(subject.id);
                        html += `<div class="form-check ms-3"><input type="checkbox" name="subjects" value="${subject.id}" id="subject-${subject.id}" class="subject-checkbox form-check-input ${groupIdentifier}" onchange="scheduleSaveChanges()" ${isChecked ? 'checked' : ''} data-credit="${subject.credit}"><label class="form-check-label" for="subject-${subject.id}">${subject.code} - ${subject.name} (${subject.credit} หน่วยกิต)</label></div>`;
                        allSubjectsRenderedCount++;
                        if (isChecked) {
                            currentTotalCredits += parseFloat(subject.credit || 0);
                            anySubjectChecked = true;
                        }
                    });
                    html += `</fieldset>`;
                    groupIndex++;
                }
            }
            subjectsCheckboxList.innerHTML = html;
            totalCreditsDisplay.textContent = `หน่วยกิตรวม: ${currentTotalCredits.toFixed(1)}`;

            // Update states after rendering
            updateSelectAllCheckboxState();
            updateGroupCheckboxes();
        }

        // --- ฟังก์ชันอัปเดตหน่วยกิตรวม (เรียกใช้โดย scheduleSaveChanges) ---
        function updateTotalCreditsDisplay() {
            let newTotalCredits = 0;
            const checkedBoxes = document.querySelectorAll('.subject-checkbox:checked');
            checkedBoxes.forEach(box => {
                newTotalCredits += parseFloat(box.dataset.credit || 0);
            });
            totalCreditsDisplay.textContent = `หน่วยกิตรวม: ${newTotalCredits.toFixed(1)}`;
        }

        // --- ฟังก์ชันอัปเดตสถานะ Checkbox "เลือกทั้งหมด" ---
        updateSelectAllCheckboxState = () => {
             const allCheckboxes = document.querySelectorAll('.subject-checkbox');
             const checkedCheckboxes = document.querySelectorAll('.subject-checkbox:checked');
             const totalCount = allCheckboxes.length;
             const checkedCount = checkedCheckboxes.length;

             if (totalCount === 0) {
                 selectAllCheckbox.checked = false;
                 selectAllCheckbox.indeterminate = false;
             } else if (checkedCount === 0) {
                 selectAllCheckbox.checked = false;
                 selectAllCheckbox.indeterminate = false;
             } else if (checkedCount === totalCount) {
                 selectAllCheckbox.checked = true;
                 selectAllCheckbox.indeterminate = false;
             } else {
                 selectAllCheckbox.checked = false;
                 selectAllCheckbox.indeterminate = true;
             }
        };

        // --- ฟังก์ชันอัปเดตสถานะ Checkbox ของแต่ละกลุ่ม ---
         updateGroupCheckboxes = () => {
             const groupCheckboxes = document.querySelectorAll('.group-check');
             groupCheckboxes.forEach(groupCb => {
                 const groupId = groupCb.id.replace('group-check-', '');
                 const childCheckboxes = document.querySelectorAll(`.subject-checkbox.${groupId}`);
                 const checkedChildren = document.querySelectorAll(`.subject-checkbox.${groupId}:checked`);
                 const totalChildren = childCheckboxes.length;
                 const checkedCount = checkedChildren.length;

                 if (totalChildren === 0) {
                     groupCb.checked = false;
                     groupCb.indeterminate = false;
                 } else if (checkedCount === 0) {
                     groupCb.checked = false;
                     groupCb.indeterminate = false;
                 } else if (checkedCount === totalChildren) {
                     groupCb.checked = true;
                     groupCb.indeterminate = false;
                 } else {
                     groupCb.checked = false;
                     groupCb.indeterminate = true;
                 }
             });
         };

        // --- ฟังก์ชันแสดง/ซ่อน Loading (Placeholder) ---
        function showLoading(isLoading) {
            // Implement how you want to show loading, e.g., show/hide a spinner
            // console.log("Loading:", isLoading);
        }

        // --- ฟังก์ชันอัปเดต Status Indicator ---
        function updateStatus(message, type) {
             statusIndicator.innerHTML = `<span class="text-${type}">${message}</span>`;
        }


        // --- Event Listeners ---
        semesterSelect.addEventListener('change', () => { updateDisplay(); updateUrl(); });
        gradeSelect.addEventListener('change', () => { updateDisplay(); updateUrl(); });
        programSelect.addEventListener('change', () => { updateDisplay(); updateUrl(); }); // <-- เพิ่ม Listener

        // --- Initial Load ---
        updateDisplay();

    }); // End DOMContentLoaded
</script>
{% endblock %}