{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}

{% block sidebar %}
    {# ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å 'academic/_sidebar.html' ‡πÄ‡∏õ‡πá‡∏ô 'teacher/_sidebar.html' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô #}
    {% include 'teacher/_sidebar.html' %}
{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<style>
    .ts-control .item {
        background-color: #0d6efd;
        color: white;
    }

    #workspaceTabsContent {
        transition: opacity 0.15s ease-in-out;
    }

    #workspaceTabsContent.loading {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Style for the new unit filter */
    #unit-filter-list .list-group-item i {
        vertical-align: middle;
        margin-top: -2px;
    }

    #ungrouped-students-list {
        position: -webkit-sticky;
        /* For Safari browser compatibility */
        position: sticky;
        top: 1rem;
        /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠ */
    }
    .bg-danger-soft {
        background-color: rgba(220, 53, 69, 0.2) !important;
    }
    .bg-warning-soft {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }    
</style>
{% endblock %}


{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('teacher.dashboard') }}">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏π</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ plan.subject.name }}</li>
            </ol>
        </nav>
        <h2 class="bi bi-journals me-2"> {{ title }} <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {{ "%.1f"|format(plan.subject.credit) }} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</small></h2>
    <div class="btn-group ms-2">
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#planSettingsModal">
        <i class="bi bi-gear-fill"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    </button>

        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-download"></i> Export ‡πÅ‡∏ú‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="{{ url_for('teacher.export_lesson_plan_pdf', plan_id=plan.id) }}" target="_blank">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>Export PDF
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{{ url_for('teacher.export_lesson_plan_docx', plan_id=plan.id) }}">
                    <i class="bi bi-file-earmark-word text-primary me-2"></i>Export Word
                </a>
            </li>
        </ul>
    </div>    
</div>
</div>
{% if plan.status == '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h4>
        <p style="white-space: pre-wrap;">{{ plan.revision_notes or '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô' }}</p>
        <hr>
        <p class="mb-0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ "‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
    </div>
{% elif plan.status == '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏´‡∏ô.‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞)</strong> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
    </div>
{% elif plan.status == '‡πÄ‡∏™‡∏ô‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£' %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)</strong> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
    </div>
{% elif plan.status == '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£' %}
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ú‡∏≠.)</strong> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
    </div>
{% elif plan.status == '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' %}
    <div class="alert alert-success" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</strong> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    </div>
{% endif %}

<div class="row g-4">
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-collection-fill"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#unitFormModal" data-bs-action="add">
                    <i class="bi bi-plus-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢
                </button>
            </div>
            <div class="list-group list-group-flush" id="unitList" data-create-unit-url="{{ url_for('teacher.create_learning_unit', plan_id=plan.id) }}" data-plan-id="{{ plan.id }}" data-add-indicator-url="{{ url_for('teacher.add_custom_indicator') }}" data-groups-url="{{ url_for('teacher.manage_student_groups', plan_id=plan.id) }}">
                {% for unit in units %}
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-unit-id="{{ unit.id }}" data-delete-url="{{ url_for('teacher.delete_learning_unit', unit_id=unit.id) }}">
                    <span class="unit-title">{{ unit.title }}</span>
                    <button class="btn btn-sm btn-outline-danger delete-unit-btn border-0" title="‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ"><i class="bi bi-trash"></i></button>
                </a>
                {% else %}
                <div id="no-units-placeholder" class="list-group-item text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="workspaceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-content" type="button" role="tab">1. ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment-content" type="button" role="tab">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="gradebook-tab" data-bs-toggle="tab" data-bs-target="#gradebook-content" type="button" role="tab">3. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab">4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reflection-tab" data-bs-toggle="tab" data-bs-target="#reflection-content" type="button" role="tab">5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="workspaceTabsContent">
                    <div id="initial-message" class="text-center text-muted py-5">
                        <h4><i class="bi bi-arrow-left-circle"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                    </div>
                    <div class="tab-pane fade" id="plan-content" role="tabpanel" aria-labelledby="plan-tab"></div>
                    <div class="tab-pane fade" id="assessment-content" role="tabpanel" aria-labelledby="assessment-tab"></div>
                    <div class="tab-pane fade" id="gradebook-content" role="tabpanel" aria-labelledby="gradebook-tab"></div>
                    <div class="tab-pane fade" id="attendance-content" role="tabpanel" aria-labelledby="attendance-tab"></div>
                    <div class="tab-pane fade" id="reflection-content" role="tabpanel" aria-labelledby="reflection-tab"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<template id="gradebook-template">
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="gradebook-table">
            <thead class="table-light"></thead>
            <tbody id="gradebook-body"></tbody>
        </table>
    </div>
</template>
<div class="modal fade" id="unitFormModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unit-modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="unit-form">
                <div class="modal-body">
                    <input type="hidden" id="modal-unit-id" name="unit_id">
                    <div class="mb-3">
                        <label for="unit-title-input" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <input type="text" class="form-control" id="unit-title-input" name="title" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="selectTopicsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectTopicsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="selectTopicsModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="saveTopicSelectionBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="subUnitEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="subUnitEditForm">
                <div class="modal-body">
                    <input type="hidden" id="modal-subunit-id">
                    <div class="mb-3">
                        <label for="modal-subunit-title" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <input type="text" class="form-control" id="modal-subunit-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-activities" class="form-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <textarea class="form-control" id="modal-subunit-activities" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-indicators" class="form-label">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
                        <select id="modal-subunit-indicators" multiple></select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-graded-items" class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
                        <select id="modal-subunit-graded-items" multiple></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="groupManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="group-manager-loader">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
                <div class="row" id="group-manager-content">
                    <div class="col-md-4">
                        <h6>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°</h6>
                        <div id="ungrouped-students-list" class="list-group vh-75 overflow-auto border p-2" data-group-id="null">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="auto-generate-groups-btn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-sm btn-primary" id="add-new-group-btn"><i class="bi bi-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </div>
                        <div id="groups-container" class="vh-75 overflow-auto">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-groups-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="planSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                <hr>
                <div class="mb-3">
                    <label class="form-label"><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå:</strong></label>
                    <p class="fs-5 fw-bold text-primary">{{ (plan.subject.credit * 2)|round|int }} ‡∏Ñ‡∏≤‡∏ö / ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
                </div>
                <div class="mb-3">
                    <label for="constraint_arrangement" class="form-label"><strong>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏≤‡∏ö (Arrangement)</strong></label>
                    <select id="constraint_arrangement" class="form-select">
                        <option value="separate" {% if not constraints.get('period_arrangement') or constraints.get('period_arrangement') == 'separate' %}selected{% endif %}>‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô)</option>
                        <option value="consecutive" {% if constraints.get('period_arrangement') == 'consecutive' %}selected{% endif %}>‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≤‡∏ö‡∏Ñ‡∏π‡πà (‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="constraint_preference" class="form-label"><strong>‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤</strong></label>
                    <select id="constraint_preference" class="form-select">
                        <option value="any" {% if not constraints.get('time_preference') or constraints.get('time_preference') == 'any' %}selected{% endif %}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                        <option value="morning" {% if constraints.get('time_preference') == 'morning' %}selected{% endif %}>‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤)</option>
                        <option value="afternoon" {% if constraints.get('time_preference') == 'afternoon' %}selected{% endif %}>‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢)</option>
                    </select>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="room-select" class="form-label"><strong>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Room/Location)</strong></label>
                    <select id="room-select" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà..."></select>
                </div>
                <hr>
                <div>
                    <label for="manual-notes" class="form-label"><strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô)</strong></label>
                    <textarea id="manual-notes" class="form-control" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', '‡∏Ç‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå' ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <span id="settings-save-status" class="me-auto text-muted small"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button type="button" class="btn btn-primary" id="savePlanSettingsBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// =================================================================
//  EDHUB: COURSE WORKSPACE SCRIPT (VERSION 3.0 - RE-ARCHITECTED)
// =================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log("‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å course_workspace.html ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");

    // -------------------------------------------
    // 1. CORE STATE & SETUP
    // -------------------------------------------
    const unitList = document.getElementById('unitList');
    const workspaceTabs = document.getElementById('workspaceTabs');
    const workspaceTabsContent = document.getElementById('workspaceTabsContent');
    const planId = unitList.dataset.planId;
    const addIndicatorUrl = unitList.dataset.addIndicatorUrl;
    const csrfToken = '{{ csrf_token() }}';

    let state = {
        activeUnitId: null,
        activeUnitIndex: null,
        activeTabId: 'plan-tab', // Default to the first tab
        activeClassroomId: null
    };

    // Modals
    const subUnitEditModal = new bootstrap.Modal(document.getElementById('subUnitEditModal'));
    const unitFormModal = new bootstrap.Modal(document.getElementById('unitFormModal'));
    const selectionModal = new bootstrap.Modal(document.getElementById('selectTopicsModal'));
    const groupModal = new bootstrap.Modal(document.getElementById('groupManagementModal'));

    // TomSelect instances
    let tomSelect = null;
    let subUnitIndicatorsTomSelect = null;
    let subUnitGradedItemsTomSelect = null;
    let roomTomSelect = null;

    // Other variables
    let hourSaveDebounce, debounceTimeout, reflectionSaveDebounce;
    let targetMidRatio = 80, targetFinalRatio = 20, isTargetSetByUser = false;
    let unitHoursData = {};
    let allEnrollments = [], sortableInstances = [];

    // -------------------------------------------
    // 2. STATE PERSISTENCE
    // -------------------------------------------
    function saveState() {
        try {
            // Use the planId to namespace the state, preventing conflicts across plans
            localStorage.setItem(`workspaceState-${planId}`, JSON.stringify(state)); 
            console.log("State saved:", state);
        } catch (e) {
            console.error("Could not save state to localStorage:", e);
        }
    }

    function restoreState() {
        try {
            const savedState = JSON.parse(localStorage.getItem(`workspaceState-${planId}`));
            if (savedState) {
                state = savedState;
            }
            if (state.activeUnitId) {
                const unitLink = unitList.querySelector(`a[data-unit-id="${state.activeUnitId}"]`);
                if (unitLink) unitLink.classList.add('active');
            }
            console.log("State restored:", state);
        } catch (e) {
            console.error("Could not restore state from localStorage:", e);
        }
    }

    // -------------------------------------------
    // 3. CORE LOGIC & DYNAMIC CONTENT LOADING
    // -------------------------------------------
    function isUnitDependentTab(tabId) {
        // [FIXED] Gradebook is NOT unit dependent (it loads all data), 
        // but it filters by the selected unit (state.activeUnitId)
        return !['attendance-tab'].includes(tabId);
    }

    function setActiveUnit(unitId) {
        // unitId ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô string ‡∏´‡∏£‡∏∑‡∏≠ null
        const newUnitId = unitId ? String(unitId) : null;
        
        // 1. ‡∏ñ‡πâ‡∏≤ unit ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö unit ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà null ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        if (newUnitId && newUnitId === state.activeUnitId) return;
        
        // 2. ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (state.activeTabId === 'gradebook-tab') {
            filterGradebookColumns(newUnitId);
            setActiveUnitFilter(newUnitId);
            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
            state.activeUnitId = newUnitId;
            saveState();
            return;
        }

        // 4. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡πÅ‡∏•‡∏∞ UI ‡∏Ç‡∏≠‡∏á Sidebar
        state.activeUnitId = newUnitId;
        saveState(); 

        document.querySelectorAll('#unitList a').forEach(a => {
            a.classList.toggle('active', a.dataset.unitId === newUnitId);
        });

        // 5. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
        if (isUnitDependentTab(state.activeTabId)) {
            loadTabContent(state.activeTabId);
        }
    }

    async function loadTabContent(tabId) {
        const paneId = document.getElementById(tabId)?.dataset.bsTarget.substring(1);
        if (!paneId) return;

        const targetPane = document.getElementById(paneId);
        
        // [FIXED] Logic for when no unit is created yet
        if (tabId !== 'gradebook-tab' && tabId !== 'attendance-tab' && !state.activeUnitId) {
             const firstUnitLink = unitList.querySelector('a.list-group-item');
             if (firstUnitLink) {
                 // Try setting the first unit as active
                 return setActiveUnit(firstUnitLink.dataset.unitId);
             }
             // Display message if no units exist
             targetPane.innerHTML = `<div class="text-center text-muted py-5"><h4><i class="bi bi-collection"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô</h4></div>`;
             return;
        }
        
        const apiUrl = getApiUrlForTab(tabId, state.activeUnitId, planId);
        if (!targetPane || !apiUrl) return;

        document.getElementById('initial-message')?.remove();
        workspaceTabsContent.classList.add('loading');

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            targetPane.innerHTML = await response.text();

            const initializers = {
                'plan-tab':       () => initializeLessonPlanTab(state.activeUnitId),
                'assessment-tab': initializeAssessmentSetupTab,
                'gradebook-tab':  initializeGradebookTab,
                'attendance-tab': initializeAttendanceTab,
                'reflection-tab': initializeReflectionTab
            };
            if (initializers[tabId]) initializers[tabId]();

            // [CRITICAL FIX HOOK]: If we just loaded gradebook, make sure the filter runs.
            if (tabId === 'gradebook-tab' && state.activeUnitId) {
                 filterGradebookColumns(state.activeUnitId);
                 setActiveUnitFilter(state.activeUnitId);
            }

        } catch (error) {
            targetPane.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            workspaceTabsContent.classList.remove('loading');
        }
    }
    
    // Helper to get API URL
    function getApiUrlForTab(tabId, activeUnitId, planId) {
         const endpoints = {
             'plan-tab':       `/teacher/api/units/${activeUnitId}/plan`,
             'assessment-tab': `/teacher/api/units/${activeUnitId}/assessment-setup`,
             'gradebook-tab':  `/teacher/api/plan/${planId}/gradebook-ui`,
             'attendance-tab': `/teacher/api/plan/${planId}/attendance-overview`,
             'reflection-tab': `/teacher/api/units/${activeUnitId}/reflection-tab`
         };
         return endpoints[tabId];
    }


    // -------------------------------------------
    // 4. TAB-SPECIFIC INITIALIZERS & LOGIC
    // -------------------------------------------

    // --- 4.1. Lesson Plan Tab ---    
    function initializeLessonPlanTab(unitId) {
        // ... (Lesson Plan Tab initialization code remains the same) ...
        const hoursInput = workspaceTabsContent.querySelector('.learning-unit-hours-input');
        if (hoursInput) {
            // Update the central data store with the value loaded from the server
            unitHoursData[unitId] = parseInt(hoursInput.value, 10) || 0;
        }
        updateCumulativePeriods();

        const planForm = document.getElementById('lessonPlanForm');
        if (planForm) {
            planForm.action = `/teacher/api/units/${unitId}/plan/save`;
            planForm.method = 'POST';
            planForm.addEventListener('submit', handlePlanFormSubmit);
        }

        const selector = document.getElementById('indicator-selector');
        if (!selector) return;

        const initialOptionsJSON = selector.dataset.initialOptions || '[]';
        const initialOptions = JSON.parse(initialOptionsJSON);
        const initialItemIds = initialOptions.map(opt => opt.id);

        if (tomSelect) {
            tomSelect.destroy();
        }

        tomSelect = new TomSelect(selector, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            options: initialOptions,
            items: initialItemIds,
            create: function(input, callback) {
                console.log("create function triggered with input:", input); // Debug log

                Swal.fire({
                    title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà',
                    html: `
                        <input id="swal-indicator-code" class="swal2-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.3/9)">
                        <textarea id="swal-indicator-desc" class="swal2-textarea" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î">${input}</textarea>
                    `,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    showCancelButton: true,
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    focusConfirm: false,
                    preConfirm: () => {
                        const code = Swal.getPopup().querySelector('#swal-indicator-code').value;
                        const desc = Swal.getPopup().querySelector('#swal-indicator-desc').value;
                        if (!code || !desc) {
                            Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                        }
                        return {
                            code: code,
                            description: desc
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(addIndicatorUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ ...result.value,
                                    plan_id: planId
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log("API response:", data);
                                if (data.status === 'success' && data.indicator && data.indicator.id) {
                                    // On success, pass the complete new option object to the callback
                                    callback(data.indicator);
                                } else {
                                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ', 'error');
                                    // On failure, call callback without arguments to cancel creation
                                    callback();
                                }
                            });
                    } else {
                        // If user cancels the Swal modal, cancel the creation
                        callback();
                    }
                });
            },
            load: function(query, callback) {
                if (query.length < 2) return callback();
                fetch(`{{ url_for("teacher.search_indicators") }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(callback)
                    .catch(() => callback());
            },
            createFilter: input => input.length >= 3,
            render: {
                item: function(data, escape) {
                    return `<div>[${escape(data.standard_code || '')}] ${escape(data.indicator_code || '')}</div>`;
                },
                option: (data, escape) => `<div><strong>${escape(data.standard_code)} ${escape(data.indicator_code)}</strong>: <span class="text-muted">${escape(data.indicator_desc)}</span></div>`,
                option_create: (data, escape) => `<div class="create">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà: <strong>${escape(data.input)}</strong>&hellip;</div>`,
            },
            onInitialize: function() {
                renderSelectedIndicators(this);
            },
            onItemAdd: function() {
                this.setTextboxValue('');
                this.blur();
                renderSelectedIndicators(this);
            },
            onItemRemove: function() {
                renderSelectedIndicators(this);
            },
        });

        const saveDraftBtn = document.getElementById('save-draft-btn');
        if (saveDraftBtn && planForm) {
            saveDraftBtn.addEventListener('click', function() {
                const data = {
                    indicators: tomSelect ? tomSelect.getValue() : [],
                    core_concepts: planForm.querySelector('#core_concepts').value,
                    learning_objectives: planForm.querySelector('#learning_objectives').value,
                    learning_content: planForm.querySelector('#learning_content').value,
                    learning_activities: planForm.querySelector('#learning_activities').value,
                    media_resources: planForm.querySelector('#media_resources').value,
                    hours: planForm.querySelector('#hours').value
                };

                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                this.disabled = true;

                fetch(planForm.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                                showConfirmButton: false,
                                timer: 2000
                            });
                        } else {
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                    })
                    .finally(() => {
                        this.innerHTML = '<i class="bi bi-save-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á';
                        this.disabled = false;
                    });
            });
        }
    }

    // --- 4.2. Assessment Setup Tab ---
    function initializeAssessmentSetupTab() {
        // ... (Assessment Setup Tab initialization code remains the same) ...
        const assessmentContent = document.getElementById('assessment-content');
        if (!assessmentContent) {
             console.error("CRITICAL: Could not find #assessment-content element during initialization.");
             return; // Exit if the main container isn't found
        }
        console.log("Found assessmentContent during init:", assessmentContent); // Verify it's found

        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Accordion, Modal, Ratio) ...

        loadRatioTarget().then(() => {
            // Call updateSummaryPanel *after* loadRatioTarget finishes
            updateSummaryPanel(); // Ensure summary updates after ratio is loaded
        });

        // --- [REVISED] Attach event listeners with extra check ---
        // Ensure assessmentContent still exists before adding listeners
        if (assessmentContent) {
            console.log("Attaching event listeners to assessmentContent...");
            assessmentContent.addEventListener('change', function(event) {
                if (event.target.matches('.exam-score-switch') || event.target.matches('.exam-score-input')) {
                    handleExamScoreChange(event);
                }
            });
            assessmentContent.addEventListener('input', function(event) {
                 if (event.target.matches('.exam-score-input')) {
                     // Update summary immediately on input
                     updateSummaryPanel();
                     // handleExamScoreChange will be called on 'change' for saving
                 }
            });
        } else {
             console.error("CRITICAL: assessmentContent became null before attaching listeners.");
        }
        // --- [END REVISED] ---

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á input ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° switch ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        assessmentContent.querySelectorAll('.accordion-collapse').forEach(unitContainer => {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
             const unitId = unitContainer.id.replace('collapse-unit-', '');
             const midtermSwitch = unitContainer.querySelector('#midterm-switch-' + unitId);
             const finalSwitch = unitContainer.querySelector('#final-switch-' + unitId);
             const midtermInput = unitContainer.querySelector('.exam-score-input[data-exam-type="midterm"]');
             const finalInput = unitContainer.querySelector('.exam-score-input[data-exam-type="final"]');

             if (midtermSwitch && midtermInput) {
                 midtermInput.disabled = !midtermSwitch.checked;
             }
             if (finalSwitch && finalInput) {
                 finalInput.disabled = !finalSwitch.checked;
             }
        });
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Summary Panel ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô .then() ‡∏Ç‡∏≠‡∏á loadRatioTarget)
        // updateSummaryPanel(); // Moved up
        setupGradedItemModal();
    } // ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initializeAssessmentSetupTab

    // --- 4.3. Gradebook Tab (The *CORRECT* one) ---
    function initializeGradebookTab() {
        const classroomSelector = document.getElementById('classroom-selector');
        const manageGroupsBtn = document.getElementById('manage-groups-btn-workspace');
        const container = document.getElementById('gradebook-container');

        if (!classroomSelector) return;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏¢‡∏≤‡∏°" ‡∏Ñ‡∏≠‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Event Listener ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å Event ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        if (classroomSelector.dataset.eventsBound) {
            console.log("Event listeners for gradebook already bound. Skipping.");
            return;
        }
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤ "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß"
        classroomSelector.dataset.eventsBound = 'true';        

        if (manageGroupsBtn) {
            manageGroupsBtn.onclick = function() {
                openGroupManager();
            };
        }

        /**
         * üéØ [CORE LOGIC] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
         */
        const handleClassroomChange = () => {
            const newClassroomId = classroomSelector.value;
            
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
            //    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            if (state.activeClassroomId !== newClassroomId) {
                state.activeClassroomId = newClassroomId;
                saveState();
            }

            if (manageGroupsBtn) {
                manageGroupsBtn.disabled = !newClassroomId;
            }

            // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            if (newClassroomId) {
                // ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏™‡πà‡∏á "state.activeUnitId" (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Sidebar)
                // ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetchAndRenderGradebookTable ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠
                fetchAndRenderGradebookTable(classroomSelector); // Active unit ID is handled inside render
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        };

        // 3. ‡∏ú‡∏π‡∏Å Event Listener ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        classroomSelector.addEventListener('change', handleClassroomChange);

        // 4. [INITIALIZATION] ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        if (state.activeClassroomId && [...classroomSelector.options].some(opt => opt.value === state.activeClassroomId)) {
            classroomSelector.value = state.activeClassroomId;
        } else if (classroomSelector.options.length > 1) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...")
            classroomSelector.value = classroomSelector.options[1].value;
        }

        // 5. [INITIALIZATION] ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        handleClassroomChange();
    }

    // --- 4.4. Attendance Tab ---
    function initializeAttendanceTab() {
        // ... (Attendance Tab initialization code remains the same) ...
        const classroomSelector = document.getElementById('attendance-classroom-selector');
        const container = document.getElementById('attendance-overview-container');

        if (!classroomSelector) return;

        // **LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á**
        const handleClassroomChange = async () => {
            const newClassroomId = classroomSelector.value;
            if (state.activeClassroomId !== newClassroomId) {
                state.activeClassroomId = newClassroomId;
                saveState(); // <-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å State ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            }

            if (!newClassroomId) {
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>';
                return;
            }

            if(container) container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';

            try {
                const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
                const response = await fetch(`/teacher/api/course/${courseId}/attendance-data?classroom_id=${newClassroomId}`);
                
                // --- START OF RECOMMENDED CHANGE ---
                if (!response.ok) {
                    // ‡∏ñ‡πâ‡∏≤ response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 200 OK ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô JSON error
                    let errorData = null;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON error
                    }
                    
                    if (errorData && errorData.message) {
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏à‡∏≤‡∏Å API (‡πÄ‡∏ä‡πà‡∏ô "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
                        throw new Error(errorData.message);
                    } else {
                        // Error ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                        throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ (Status: ${response.status})`);
                    }
                }
                // --- END OF RECOMMENDED CHANGE ---

                const data = await response.json();
                renderAttendanceTable(data, container);

            } catch (error) {
                // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ 'error.message' ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Flask
                if(container) container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        };

        classroomSelector.addEventListener('change', handleClassroomChange);

        // **LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ State**
        if (state.activeClassroomId && [...classroomSelector.options].some(opt => opt.value === state.activeClassroomId)) {
            classroomSelector.value = state.activeClassroomId;
        } else if (classroomSelector.options.length > 1) {
            classroomSelector.value = classroomSelector.options[1].value;
        }

        // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        handleClassroomChange();

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        if (container) {        
        // Central Event Listener for Clicks
        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('attendance-badge')) {
                const badge = e.target;
                const group = badge.closest('.attendance-cell');
                const statuses = ['PRESENT', 'LATE', 'ABSENT', 'LEAVE'];

                const currentStatus = badge.dataset.status;
                const currentIndex = statuses.indexOf(currentStatus);
                const nextIndex = (currentIndex + 1) % statuses.length;
                const nextStatus = statuses[nextIndex];

                updateBadge(badge, nextStatus);

                const payload = {
                    student_id: group.dataset.studentId,
                    entry_id: group.dataset.entryId,
                    date: group.dataset.date,
                    status: nextStatus
                };

                fetch("{{ url_for('teacher.save_attendance') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify(payload)
                }).then(res => {
                    if (!res.ok) {
                        console.error("Failed to save attendance");
                        updateBadge(badge, currentStatus); // Revert on failure
                    }
                });
            }
        });
    }
}

    // --- 4.5. Reflection Tab ---
    function initializeReflectionTab() {
        // ... (Reflection Tab initialization code remains the same) ...
        const wrapper = document.getElementById('reflection-wrapper');
        if (!wrapper) return;

        const unitId = wrapper.dataset.unitId;
        const loader = wrapper.querySelector('#dashboard-loader');
        const dashboardContent = wrapper.querySelector('#dashboard-content');
        const loggingContainer = wrapper.querySelector('#logging-container');
        const statusIndicator = wrapper.querySelector('#save-status-indicator');
        let reflectionSaveDebounce;

        const loadDashboardAndLogs = async () => {
            try {
                const response = await fetch(`/teacher/api/units/${unitId}/performance-dashboard`);
                if (!response.ok) throw new Error('Could not fetch performance data.');
                const data = await response.json();

                renderDashboard(data.dashboard_data, data.unit_max_score);
                setupLoggingSystem(data.logs, data.dashboard_data);

                loader.classList.add('d-none');
                dashboardContent.classList.remove('d-none');
                loggingContainer.classList.remove('d-none');

            } catch (error) {
                console.error("Failed to load reflection tab data:", error);
                loader.innerHTML = '<p class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</p>';
            }
        };

        const renderDashboard = (dashboardData, unitMaxScore) => {
            const tbody = wrapper.querySelector('#dashboard-table-body');
            const tfoot = wrapper.querySelector('#dashboard-table-foot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            let totalStudents = 0,
                totalIncomplete = 0;
            let totalScoresSum = 0;
            let totalScoredStudents = 0;
            let totalDist = {
                excellent: 0,
                good: 0,
                fair: 0,
                improve: 0
            };

            dashboardData.forEach(room => {
                const studentsWithScores = room.student_count - room.incomplete;
                totalStudents += room.student_count;
                totalIncomplete += room.incomplete;
                totalScoresSum += (room.avg_score * studentsWithScores);
                totalScoredStudents += studentsWithScores;

                Object.keys(totalDist).forEach(key => totalDist[key] += room.distribution[key]);

                tbody.innerHTML += `
                    <tr>
                        <td class="text-start">${room.name}</td>
                        <td>${room.student_count}</td>
                        <td>${unitMaxScore}</td>
                        <td>${room.avg_score} (${unitMaxScore > 0 ? Math.round(room.avg_score / unitMaxScore * 100) : 0}%)</td>
                        <td>${room.sd}</td>
                        <td>${room.distribution.excellent}</td>
                        <td>${room.distribution.good}</td>
                        <td>${room.distribution.fair}</td>
                        <td>${room.distribution.improve}</td>
                        <td>${room.incomplete}</td>
                    </tr>
                `;
            });

            const overallAvg = totalScoredStudents > 0 ? (totalScoresSum / totalScoredStudents) : 0;
            tfoot.innerHTML = `
                <tr class="table-primary fw-bold">
                    <td>‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                    <td>${totalStudents}</td>
                    <td>${unitMaxScore}</td>
                    <td>${overallAvg.toFixed(2)} (${unitMaxScore > 0 ? Math.round(overallAvg / unitMaxScore * 100) : 0}%)</td>
                    <td>-</td>
                    <td>${totalDist.excellent}</td>
                    <td>${totalDist.good}</td>
                    <td>${totalDist.fair}</td>
                    <td>${totalDist.improve}</td>
                    <td>${totalIncomplete}</td>
                </tr>
            `;
        };

        const setupLoggingSystem = (logData, dashboardData) => {
            const overallForm = wrapper.querySelector('#overall-log-form');
            const navContainer = wrapper.querySelector('#per-room-log-nav');
            const contentContainer = wrapper.querySelector('#per-room-log-content');

            overallForm.querySelector('#log_content_overall').value = logData.overall.log_content;
            overallForm.querySelector('#problems_obstacles').value = logData.overall.problems_obstacles;
            overallForm.querySelector('#solutions').value = logData.overall.solutions;

            navContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            dashboardData.forEach((room, index) => {
                const roomLog = logData.per_room[room.id] || {
                    log_content: ''
                };
                navContainer.innerHTML += `
                    <button type="button" class="list-group-item list-group-item-action ${index === 0 ? 'active' : ''}" data-room-id="${room.id}">
                        ${room.name}
                    </button>`;
                contentContainer.innerHTML += `
                    <div class="per-room-log-pane ${index === 0 ? '' : 'd-none'}" id="log-pane-${room.id}">
                        <label for="log-room-${room.id}" class="form-label small text-muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.name}:</label>
                        <textarea class="form-control per-room-textarea" id="log-room-${room.id}" data-room-id="${room.id}" rows="4">${roomLog.log_content}</textarea>
                    </div>`;
            });

            overallForm.addEventListener('input', (e) => handleSave(e.target));

            navContainer.addEventListener('click', e => {
                if (e.target.matches('button')) {
                    navContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    contentContainer.querySelectorAll('.per-room-log-pane').forEach(pane => pane.classList.add('d-none'));
                    contentContainer.querySelector(`#log-pane-${e.target.dataset.roomId}`).classList.remove('d-none');
                }
            });

            contentContainer.addEventListener('input', e => {
                if (e.target.matches('.per-room-textarea')) {
                    handleSave(e.target);
                }
            });
        };

        const handleSave = (element) => {
            clearTimeout(reflectionSaveDebounce);
            statusIndicator.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...';

            reflectionSaveDebounce = setTimeout(async () => {
                statusIndicator.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                const isPerRoom = element.dataset.roomId;
                let payload = {};

                if (isPerRoom) {
                    payload = {
                        classroom_id: element.dataset.roomId,
                        log_content: element.value
                    };
                } else {
                    const overallForm = wrapper.querySelector('#overall-log-form');
                    payload = {
                        classroom_id: null,
                        log_content: overallForm.querySelector('#log_content_overall').value,
                        problems_obstacles: overallForm.querySelector('#problems_obstacles').value,
                        solutions: overallForm.querySelector('#solutions').value
                    }
                }

                try {
                    const response = await fetch(`/teacher/api/log/unit/${unitId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Save failed');

                    const now = new Date();
                    const timeString = now.toLocaleTimeString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    statusIndicator.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${timeString} ‡∏ô.`;

                } catch (error) {
                    statusIndicator.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!';
                    console.error("Save error:", error);
                }

            }, 1500);
        };

        loadDashboardAndLogs();
    }

    /**
     * [FINAL ROBUST VERSION with MutationObserver]
     * ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ MutationObserver
     * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏™‡∏°‡∏≠
     */
    async function fetchAndRenderGradebookTable(selector) {
        const classroomId = selector.value;
        const selectedOption = selector.options[selector.selectedIndex];
        const container = document.getElementById('gradebook-container');

        if (!classroomId) {
            container.innerHTML = `<div class="text-center p-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
            return;
        }
        const courseId = selectedOption.dataset.courseId;
        if (!courseId) {
            container.innerHTML = `<div class="alert alert-danger">Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Course ID</div>`;
            return;
        }

        try {
            container.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="spinner-border"></div></div>';
            const response = await fetch(`/teacher/api/course/${courseId}/gradebook-data?classroom_id=${classroomId}`);
            if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ');

            const data = await response.json();

            // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Unit ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
            const availableUnitIds = (data.units_data || []).map(u => String(u.unit_id));
            let chosenUnitId = null;
            if (state.activeUnitId && availableUnitIds.includes(String(state.activeUnitId))) {
                chosenUnitId = state.activeUnitId;
            } else if (availableUnitIds.length > 0) {
                // [FIXED] If no previous unit, or the previous unit is gone, select the first unit
                chosenUnitId = availableUnitIds[0];
                state.activeUnitId = chosenUnitId;
                saveState();
            } else {
                // If there are no units at all, the filter should show nothing.
                chosenUnitId = null;
                state.activeUnitId = null;
                saveState();
            }

            // 2. Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            renderGradebookTable(data, container, chosenUnitId);

            // 3. ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            if (chosenUnitId) {
                filterGradebookColumns(chosenUnitId);
                setActiveUnitFilter(chosenUnitId);
            }

        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }
    /**
     * [FINAL CORRECTED VERSION] Renders the gradebook table with the "Unit Summary"
     * column correctly placed at the END of each unit's item list.
     */
    function renderGradebookTable(data, container, unitIdToSelect) {
        if (!data.students || data.students.length === 0) {
            container.innerHTML = `<div class="text-center text-muted py-5"><h4><i class="bi bi-people"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</h4></div>`;
            return;
        }

        const template = document.getElementById('gradebook-template').content.cloneNode(true);
        const table = template.querySelector('#gradebook-table');
        table.dataset.courseId = data.course_id;
        table.dataset.grandMaxScore = data.grand_max_score || 100;
        table.dataset.summativeIds = JSON.stringify(data.summative_item_ids || []);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('#gradebook-body');

        // --- 1. BUILD HEADER (<thead>) ---
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th rowspan="2" class="align-middle text-center">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
        let subHeaderRowHtml = '';

        // Helper function to create toggle switches
        const createToggleSwitches = (itemId, groupToggle = true, allToggle = true) => `
        <div class="d-flex justify-content-center small mt-1">
            ${groupToggle ? `
            <div class="form-check form-switch form-check-inline me-2">
                <input class="form-check-input propagation-toggle group-toggle" type="checkbox" role="switch" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°" data-item-id="${itemId}" data-mode="group">
                <label class="form-check-label">‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
            </div>` : ''}
            ${allToggle ? `
            <div class="form-check form-switch form-check-inline">
                <input class="form-check-input propagation-toggle all-toggle" type="checkbox" role="switch" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" data-item-id="${itemId}" data-mode="all">
                <label class="form-check-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
            </div>` : ''}
        </div>
        `;

        // Step 1.1: Build Graded Items from 'units_data'
        data.units_data.forEach(unit => {
            if (!unit.items || unit.items.length === 0) return; // ‡πÉ‡∏ä‡πâ return ‡πÅ‡∏ó‡∏ô continue ‡πÉ‡∏ô forEach
            headerRow.innerHTML += `<th colspan="${unit.items.length + 1}" class="text-center unit-column unit-id-${unit.unit_id}">${unit.title}</th>`;

            unit.items.forEach(item => {
                let googleFormBtnHtml = '';
                if (item.google_form_id) {
                    // [MODIFIED] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß "Sync Score"
                    googleFormBtnHtml = `
                        <button class="btn btn-success btn-sm mt-1 btn-sync-google-form"
                                data-item-id="${item.id}"
                                data-form-type="item" 
                                title="‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Form Quiz">
                            <i class="bi bi-arrow-repeat"></i> Sync Score
                        </button>`;
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô "‡∏™‡∏£‡πâ‡∏≤‡∏á" (‡πÉ‡∏ä‡πâ item.id ‡∏ï‡∏£‡∏á ‡πÜ)
                    googleFormBtnHtml = `
                        <button class="btn btn-primary btn-sm mt-1 btn-create-google-form" 
                                data-item-id="${item.id}" 
                                title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Form Quiz ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ">
                            <i class="bi bi-google"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Form
                        </button>`;
                }
                subHeaderRowHtml += `<th class="text-nowrap text-center unit-column unit-id-${item.learning_unit_id}">
                                        ${item.name}<br><small class="text-muted">(${item.max_score || 0})</small>
                                        ${createToggleSwitches('g-' + item.id)}
                                        ${googleFormBtnHtml}
                                    </th>`;
            });
            subHeaderRowHtml += `<th class="text-nowrap text-center unit-column unit-id-${unit.unit_id} table-primary">‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>`;
        });

        // Step 1.2: Build Qualitative Assessment Section Header (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
        data.qualitative_assessment_data.forEach(template => {
            if (template && Array.isArray(template.main_topics)) {
                template.main_topics.forEach(mainTopic => {
                    // --- START FIX: Add defensive check ---
                    if (!mainTopic) return; // Skip if mainTopic is null or undefined
                    // --- END FIX ---
                    
                    const subTopics = mainTopic.selected_sub_topics;
                    const unitId = mainTopic.learning_unit_id;

                    if (subTopics && subTopics.length > 0) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏™‡∏£‡∏∏‡∏õ" ‡πÅ‡∏•‡∏∞ "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢" ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏° 2 ‡πÅ‡∏ñ‡∏ß
                        headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId} table-info">
                                                    ‡∏™‡∏£‡∏∏‡∏õ<br><small>${mainTopic.main_topic_name}</small>
                                                    ${createToggleSwitches('q-' + mainTopic.main_topic_id)}
                                                </th>`;
                        subTopics.forEach(sub => {
                            headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId}">
                                                        ${sub.name}
                                                    </th>`;
                        });
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏° 2 ‡πÅ‡∏ñ‡∏ß
                        headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId} table-info">
                                                    <small>${mainTopic.main_topic_name}</small>
                                                    ${createToggleSwitches('q-' + mainTopic.main_topic_id)}
                                                </th>`;
                    }
                });
            }
        });
        // Step 1.3: Build Exams & Final Summary Header (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
let finalColspan = 4;
        subHeaderRowHtml += `<th class="text-nowrap text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö</th>`;
        
        if (data.is_midterm_enabled) {
            finalColspan++;
            // --- [MODIFIED] Midterm Button Logic (Sync/Create) ---
            let midtermBtnHtml = '';
            if (data.midterm_google_form_id) {
                midtermBtnHtml = `<button class="btn btn-success btn-sm mt-1 btn-sync-google-form"
                                        data-course-id="${data.course_id}"
                                        data-form-type="exam"
                                        data-exam-type="midterm"
                                        title="‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Form Quiz">
                                    <i class="bi bi-arrow-repeat"></i> Sync Score
                                </button>`;
            } else {
                midtermBtnHtml = `<button class="btn btn-primary btn-sm mt-1 btn-create-exam-form" 
                                        data-exam-type="midterm" 
                                        data-course-id="${data.course_id}"
                                        title="‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form Quiz ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ">
                                    <i class="bi bi-google"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Form
                                </button>`;
            }
            
            subHeaderRowHtml += `<th class="text-nowrap text-center">
                                    ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (${data.total_midterm_max_score || 0}) 
                                    ${createToggleSwitches('midterm', false)}
                                    ${midtermBtnHtml} 
                                </th>`;
        }
        
        if (data.is_final_enabled) {
            finalColspan++;
            // --- [MODIFIED] Final Button Logic (Sync/Create) ---
            let finalBtnHtml = '';
            if (data.final_google_form_id) {
                finalBtnHtml = `<button class="btn btn-success btn-sm mt-1 btn-sync-google-form"
                                        data-course-id="${data.course_id}"
                                        data-form-type="exam"
                                        data-exam-type="final"
                                        title="‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Form Quiz">
                                    <i class="bi bi-arrow-repeat"></i> Sync Score
                                </button>`;
            } else {
                finalBtnHtml = `<button class="btn btn-primary btn-sm mt-1 btn-create-exam-form" 
                                      data-exam-type="final" 
                                      data-course-id="${data.course_id}"
                                      title="‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form Quiz ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ">
                                  <i class="bi bi-google"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Form
                              </button>`;
            }
            // --- [END MODIFIED] ---
            
            subHeaderRowHtml += `<th class="text-nowrap text-center">
                                    ‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (${data.total_final_max_score || 0}) 
                                    ${createToggleSwitches('final', false)}
                                    ${finalBtnHtml} 
                                </th>`;
        }
        headerRow.innerHTML += `<th colspan="${finalColspan}" class="text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>`;

        subHeaderRowHtml += `<th class="text-nowrap text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á</th><th class="text-nowrap text-center">‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (100)</th><th class="text-nowrap text-center">‡πÄ‡∏Å‡∏£‡∏î</th>`;

        thead.innerHTML = '';
        thead.appendChild(headerRow);
        const subHeader = document.createElement('tr');
        subHeader.innerHTML = subHeaderRowHtml;
        thead.appendChild(subHeader);

        // --- 2. BUILD BODY (<tbody>) in the same sequence as the header ---
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
        data.students.forEach(student => {
            const studentRow = document.createElement('tr');
            const nonActiveStatuses = ['‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', '‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å', '‡∏û‡πâ‡∏ô‡∏™‡∏†‡∏≤‡∏û', '‡πÅ‡∏Ç‡∏ß‡∏ô‡∏•‡∏≠‡∏¢', '‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'];
            if (nonActiveStatuses.includes(student.status)) {
                studentRow.classList.add('table-secondary', 'text-muted', 'text-decoration-line-through');
            }
            studentRow.dataset.studentId = student.id;
            studentRow.dataset.groupId = data.student_group_map[student.id] || '';
            studentRow.dataset.hasMs = student.has_ms_status;

            let groupIds = {};
            const groups = data.groups || [];
            for (const unitId in data.unit_group_map) {
                if (data.unit_group_map[unitId] && data.unit_group_map[unitId][student.id]) {
                    const group_name = data.unit_group_map[unitId][student.id];
                    const group = groups.find(g => g.name === group_name && g.learning_unit_id == unitId);
                    if (group) {
                        groupIds[unitId] = group.id;
                    }
                }
            }
            studentRow.dataset.groupId = data.student_group_map[student.id] || '';
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
            studentRow.dataset.groupIds = JSON.stringify(groupIds);                
            const studentNameClasses = student.has_active_warning ? 'text-nowrap student-cell text-danger fw-bold' : 'text-nowrap student-cell';
            const studentNameTitle = student.has_active_warning ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : '';
            let rowHtml = `<td class="${studentNameClasses}" title="${studentNameTitle}">${student.roll_number}. ${student.student_id} ${student.name_prefix || ''}${student.first_name} ${student.last_name}<span class="student-alerts-container">${renderAlerts(student.alerts)}</span></td>`;

            // This loop was missing. It iterates through each unit to create the score input cells for the student.
            data.units_data.forEach(unit => {
                if (!unit.items || unit.items.length === 0) return;
                const unitTotalMaxScore = unit.items.reduce((s, it) => s + (parseFloat(it.max_score) || 0), 0);
                unit.items.forEach(item => {
                    const scoreKey = `${student.id}-${item.id}`;
                    const score = (data.scores[scoreKey] && data.scores[scoreKey].score != null) ? data.scores[scoreKey].score : '';
                    let inputHtml = '';
                    const studentGroupId = (data.student_group_map && data.student_group_map[student.id]) ? data.student_group_map[student.id] : null;

                    if (item.is_group_assignment && studentGroupId) {
                        inputHtml = `<input type="number" class="form-control form-control-sm text-center score-input is-group-score" 
                                        data-item-id="g-${item.id}" 
                                        data-group-id="${studentGroupId}"
                                        data-unit-id="${item.learning_unit_id}"
                                        data-max-score="${item.max_score || 0}"
                                        value="${score}" max="${item.max_score || 0}" min="0">`;
                    } else {
                        inputHtml = `<input type="number" class="form-control form-control-sm text-center score-input" 
                                        data-item-id="g-${item.id}" value="${score}" 
                                        max="${item.max_score || 0}" min="0"
                                        data-unit-id="${item.learning_unit_id}"
                                        data-max-score="${item.max_score || 0}">`;
                    }
                    rowHtml += `<td class="unit-column unit-id-${item.learning_unit_id}">${inputHtml}</td>`;
                });
                rowHtml += `<td class="unit-column unit-id-${unit.unit_id}"><input type="number" class="form-control form-control-sm text-center unit-summary-input" data-unit-id="${unit.unit_id}" data-unit-total-max-score="${unitTotalMaxScore}" max="${unitTotalMaxScore}"></td>`;
            });

            data.qualitative_assessment_data.forEach(template => {
                const rubrics = template.rubrics;
                if (template && Array.isArray(template.main_topics)) {
                    template.main_topics.forEach(mainTopic => {
                        // --- START FIX: Add defensive check ---
                        if (!mainTopic) return; // Skip if mainTopic is null or undefined
                        // --- END FIX ---

                        const subTopics = mainTopic.selected_sub_topics;
                        const unitId = mainTopic.learning_unit_id;
                        let selectOptions = '<option value=""></option>';
                        if (rubrics) {
                            rubrics.forEach(rubric => {
                                selectOptions += `<option value="${rubric.value}">${rubric.label}</option>`;
                            });
                        }
                        if (subTopics && subTopics.length > 0) {
                            const summaryScoreKey = `${student.id}-q-${mainTopic.main_topic_id}`;
                            const summaryScore = data.scores[summaryScoreKey] ?.score ?? '';
                            rowHtml += `<td class="unit-column unit-id-${unitId}">
                                            <select class="form-select form-select-sm text-center qualitative-main-summary" 
                                                    data-main-id="q-${mainTopic.main_topic_id}" 
                                                    data-topic-id="q-${mainTopic.main_topic_id}"
                                                    data-initial-score="${summaryScore}">
                                                ${selectOptions}
                                            </select>
                                        </td>`;
                            subTopics.forEach(sub => {
                                const scoreKey = `${student.id}-q-${sub.id}`;
                                const score = (data.scores[scoreKey] && data.scores[scoreKey].score != null) ? data.scores[scoreKey].score : '';
                                rowHtml += `<td class="unit-column unit-id-${unitId}">
                                                <select class="form-select form-select-sm text-center qualitative-select" 
                                                        data-main-id="q-${mainTopic.main_topic_id}" 
                                                        data-topic-id="q-${sub.id}"
                                                        data-course-id="${data.course_id}" 
                                                        data-initial-score="${score}">
                                                    ${selectOptions}
                                                </select>
                                            </td>`;
                            });
                        } else {
                            const mainScoreKey = `${student.id}-q-${mainTopic.main_topic_id}`;
                            const mainScore = data.scores[mainScoreKey] ?.score ?? '';
                            rowHtml += `<td class="unit-column unit-id-${unitId}"><select class="form-select form-control-sm text-center qualitative-select" data-topic-id="q-${mainTopic.main_topic_id}" data-initial-score="${mainScore}">${selectOptions}</select></td>`;
                        }
                    });
                }
            });
            rowHtml += `<td><span class="collected-score-display fw-bold">0</span></td>`;
                if (data.is_midterm_enabled) {
                    rowHtml += `<td><input type="number" class="form-control form-control-sm text-center exam-input" data-exam-type="midterm" value="${student.midterm_score ?? ''}" max="${data.total_midterm_max_score || 0}"></td>`;
                }
                if (data.is_final_enabled) {
                    rowHtml += `<td><input type="number" class="form-control form-control-sm text-center exam-input" data-exam-type="final" value="${student.final_score ?? ''}" max="${data.total_final_max_score || 0}"></td>`;
                }
                rowHtml += `<td><span class="total-score-display fw-bold">0</span></td>
                            <td><span class="percentage-display fw-bold">0%</span></td>
                            <td><span class="grade-display fw-bold">-</span></td>`;
            studentRow.innerHTML = rowHtml;
            tbody.appendChild(studentRow);
            updateStudentRowTotals(studentRow);
        });

        container.innerHTML = '';
        container.appendChild(template);
        setupGradebookEventListeners(table, data);

        table.querySelectorAll('select[data-initial-score]').forEach(select => {
            const initialValue = select.dataset.initialScore;
            if (initialValue !== '') {
                select.value = initialValue;
            }
        });
        
        // [FIXED] Call filter function immediately
        if (unitIdToSelect) {
             filterGradebookColumns(unitIdToSelect);
        }
    }

    /**
     * [SIMPLIFIED] Attaches all necessary event listeners to the gradebook table.
     * The complex calculation logic is now handled by updateStudentRowTotals.
     */
    function setupGradebookEventListeners(table, data) {
        // --- START: Helper Functions (‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ---
        let saveDebounce;
        let isDistributing = false;

        const calculateMode = (arr) => {
            if (!arr || arr.length === 0) return '';
            const frequency = arr.reduce((acc, val) => {
                if (val !== '') {
                    acc[val] = (acc[val] || 0) + 1;
                }
                return acc;
            }, {});
            let maxFreq = 0, mode = '';
            for (const val in frequency) {
                if (frequency[val] > maxFreq) {
                    maxFreq = frequency[val];
                    mode = val;
                }
            }
            return mode;
        };

        // --- REPLACE WITH THIS DIAGNOSTIC VERSION ---
        const saveScoresBulk = (scoresData, endpointUrl) => {
            if (scoresData.length === 0) return;

            const table = document.getElementById('gradebook-table');
            const courseId = table ? table.dataset.courseId : null;
            if (!courseId) {
                console.error("CRITICAL: course_id not found on the gradebook table.");
                return;
            }

            const payload = {
                scores: scoresData,
                course_id: courseId
            };

            console.log("--- [DEBUG] Preparing to save bulk scores ---");
            console.log("Endpoint URL:", endpointUrl);
            console.log("Payload being sent:", JSON.stringify(payload, null, 2));

            fetch(endpointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log("--- [DEBUG] Received response from server ---");
                console.log("Response OK:", response.ok);
                console.log("Response Status:", response.status);
                console.log("Response Status Text:", response.statusText);
                
                if (!response.ok) {
                    // Try to get text first in case the error response is not JSON
                    return response.text().then(text => {
                        throw new Error(`Server responded with status ${response.status}. Body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("--- [DEBUG] Successfully parsed JSON response ---");
                console.log("Response Data:", data);
                if (data.status !== 'success') {
                    console.error('Save failed on server-side:', data.message);
                }
            })
            .catch(err => {
                console.error('--- [DEBUG] An error occurred in fetch/save process ---');
                console.error('Bulk save error:', err);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console (F12) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${err.message}`, 'error');
            });
        };

        const saveExamScore = (examData) => {
            // This function saves a single exam score.
            fetch("{{ url_for('teacher.save_enrollment_exam_score') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(examData)
            }).catch(err => console.error('Exam save error:', err));
        };
                    
        const handlePropagation = (input) => {
            const studentRow = input.closest('tr');
            if (!studentRow) {
                return;
            }

            const columnId = input.dataset.itemId || input.dataset.examType;
            if (!columnId) {
                console.log('Input is not a propagatable field. Performing single update.');
                
                // Run your original row total calculation.
                updateStudentRowTotals(studentRow);
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const studentId = studentRow.dataset.studentId;
                    const score = input.value === '' ? null : parseFloat(input.value);
                    if (input.dataset.itemId) {
                        const numericId = input.dataset.itemId.replace('g-', '');
                        saveScoresBulk([{ student_id: studentId, graded_item_id: numericId, score: score }], "{{ url_for('teacher.save_scores_bulk') }}");
                    } else if (input.dataset.examType) {
                        saveExamScore({ student_id: studentId, course_id: data.course_id, exam_type: input.dataset.examType, score: score });
                    }
                }, 800);
                return;
            }

            const groupSelector = `.propagation-toggle.group-toggle[data-item-id="${columnId}"]`;
            const allSelector = `.propagation-toggle.all-toggle[data-item-id="${columnId}"]`;
            
            const allToggle = table.querySelector(allSelector);
            const groupToggle = table.querySelector(groupSelector);

            if (!allToggle && !groupToggle) {
                return;
            }

            let activeToggle = null;
            if (allToggle?.checked) activeToggle = allToggle;
            else if (groupToggle?.checked) activeToggle = groupToggle;

            if (!activeToggle) {

                // 1. Update totals for the current row
                updateStudentRowTotals(studentRow);

                // 2. Debounce the save operation for the single input change
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const studentId = studentRow.dataset.studentId;
                    const score = input.value === '' ? null : parseFloat(input.value);

                    // 3. Check what kind of input it is and call the correct save function
                    if (input.dataset.itemId) {
                        const scoreData = {
                            student_id: studentId,
                            graded_item_id: input.dataset.itemId.replace('g-', ''), 
                            score: score
                        };
                        saveScoresBulk([scoreData], "{{ url_for('teacher.save_scores_bulk') }}");
                    } else if (input.dataset.examType) {
                        const examData = {
                            student_id: studentId,
                            course_id: data.course_id,
                            exam_type: input.dataset.examType,
                            score: score
                        };
                        saveExamScore(examData);
                    }
                }, 800); // 800ms delay to wait for more typing

                return; // Exit the function as no propagation is needed
            }
            // --- START: Full Propagation and Save Logic ---
            isDistributing = true;
            
            const newScore = input.value;
            let inputsToUpdate = [input];
            const mode = activeToggle.dataset.mode;

            let targetRows = [];
            if (mode === 'all') {
                targetRows = Array.from(table.querySelectorAll('tr[data-student-id]'));
            } else if (mode === 'group') {
                const sourceGroupId = studentRow.dataset.groupId;
                if (sourceGroupId) {
                    targetRows = Array.from(table.querySelectorAll(`tr[data-group-id="${sourceGroupId}"]`));
                }
            }

            if (targetRows.length > 0) {
                targetRows.forEach(row => {
                    if (row === studentRow) return; // Don't re-process the source row

                    const allInputsInRow = row.querySelectorAll('.score-input, .exam-input');
                    allInputsInRow.forEach(inputInRow => {
                        const currentInputColumnId = inputInRow.dataset.itemId || inputInRow.dataset.examType;
                        if (currentInputColumnId === columnId) {
                            inputInRow.value = newScore;
                            inputsToUpdate.push(inputInRow);
                        }
                    });
                });
            }
            
            // Update totals for all affected rows
            const uniqueInputs = [...new Set(inputsToUpdate)];
            uniqueInputs.forEach(i => updateStudentRowTotals(i.closest('tr')));

            // Debounce the save operation for all updated inputs
            clearTimeout(saveDebounce);
            saveDebounce = setTimeout(() => {
                const gradedItemsToSave = [];
                const examScoresToSave = [];

                uniqueInputs.forEach(i => {
                    const studentId = i.closest('tr').dataset.studentId;
                    const score = i.value === '' ? null : parseFloat(i.value);
                    if (i.dataset.itemId) {
                        gradedItemsToSave.push({ student_id: studentId, graded_item_id: i.dataset.itemId.replace('g-', ''), score: score });
                    } else if (i.dataset.examType) {
                        examScoresToSave.push({ student_id: studentId, course_id: data.course_id, exam_type: i.dataset.examType, score: score });
                    }
                });

                if (gradedItemsToSave.length > 0) {
                    saveScoresBulk(gradedItemsToSave, "{{ url_for('teacher.save_scores_bulk') }}");
                }
                examScoresToSave.forEach(examScore => {
                    saveExamScore(examScore);
                });
            }, 800);
            
            isDistributing = false;
        }
        
        const handleQualitativeChange = (changedSelect) => {
            if (isDistributing) return;
            isDistributing = true;

            const studentRow = changedSelect.closest('tr');
            if (!studentRow) { isDistributing = false; return; }

            // ID of the governing switch (always the main topic ID)
            const mainTopicIdForSwitch = changedSelect.dataset.mainId || changedSelect.dataset.topicId;
            
            // ID of the specific column that was changed (could be main or sub)
            const specificTopicId = changedSelect.dataset.topicId;

            if (!mainTopicIdForSwitch || !specificTopicId) {
                isDistributing = false;
                return;
            }

            const allToggle = table.querySelector(`.propagation-toggle.all-toggle[data-item-id="${mainTopicIdForSwitch}"]`);
            const groupToggle = table.querySelector(`.propagation-toggle.group-toggle[data-item-id="${mainTopicIdForSwitch}"]`);

            let activeToggle = null;
            if (allToggle && allToggle.checked) activeToggle = allToggle;
            else if (groupToggle && groupToggle.checked) activeToggle = groupToggle;

            let allModifiedSelects = [changedSelect];
            const newValue = changedSelect.value;
            
            if (changedSelect.classList.contains('qualitative-main-summary')) {
                studentRow.querySelectorAll(`.qualitative-select[data-main-id="${mainTopicIdForSwitch}"]`).forEach(subSelect => {
                    if (subSelect.value !== newValue) {
                        subSelect.value = newValue;
                        allModifiedSelects.push(subSelect);
                    }
                });
            }

            if (activeToggle) {
                let targetRows = [];
                const mode = activeToggle.dataset.mode;
                if (mode === 'all') {
                    targetRows = Array.from(table.querySelectorAll('tr[data-student-id]'));
                } else if (mode === 'group') {
                    const targetGroupId = studentRow.dataset.groupId;
                    if (targetGroupId) {
                        targetRows = Array.from(table.querySelectorAll(`tr[data-group-id="${targetGroupId}"]`));
                    }
                }

                const uniqueSelectsToPropagate = [...new Set(allModifiedSelects)];
                uniqueSelectsToPropagate.forEach(selectToPropagate => {
                    const currentTopicId = selectToPropagate.dataset.topicId;
                    const currentValue = selectToPropagate.value;
                    const selector = `.qualitative-select[data-topic-id="${currentTopicId}"], .qualitative-main-summary[data-topic-id="${currentTopicId}"]`;
                    
                    targetRows.forEach(row => {
                        if (row !== studentRow) {
                            const selectInRow = row.querySelector(selector);
                            if (selectInRow && selectInRow.value !== currentValue) {
                                selectInRow.value = currentValue;
                                allModifiedSelects.push(selectInRow);
                            }
                        }
                    });
                });
            }

            const uniqueRowsToUpdate = [...new Set(allModifiedSelects.map(sel => sel.closest('tr')))];
            uniqueRowsToUpdate.forEach(row => {
                const mainSummaryInRow = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainTopicIdForSwitch}"]`);
                if (mainSummaryInRow) {
                    const subSelectsInRow = Array.from(row.querySelectorAll(`.qualitative-select[data-main-id="${mainTopicIdForSwitch}"]`));
                    if (subSelectsInRow.length > 0) {
                        const newMode = calculateMode(subSelectsInRow.map(s => s.value));
                        if (mainSummaryInRow.value !== newMode) {
                            mainSummaryInRow.value = newMode;
                            allModifiedSelects.push(mainSummaryInRow);
                        }
                    }
                }
            });

            if (allModifiedSelects.length > 0) {
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const scoresToSave = [...new Set(allModifiedSelects)].map(sel => ({
                        student_id: sel.closest('tr')?.dataset.studentId,
                        topic_id: sel.dataset.topicId.replace('q-', ''),
                        score: sel.value === '' ? null : sel.value
                    })).filter(s => s.student_id && s.topic_id);
                    if (scoresToSave.length > 0) saveScoresBulk(scoresToSave, "{{ url_for('teacher.save_qualitative_scores_bulk') }}");
                }, 800);
            }
            
            isDistributing = false;
        };
        
        // --- [NEW] Event Listener for creating EXAM Google Forms ---
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-create-exam-form');
            if (!btn) return;

            e.preventDefault();
            const examType = btn.dataset.examType; // 'midterm' or 'final'
            const courseId = btn.dataset.courseId;
            const examName = (examType === 'midterm') ? '‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ' : '‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ';

            Swal.fire({
                title: `‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form?`,
                text: `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form Quiz ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${examName}" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, // [MODIFIED TEXT]
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> ‡∏™‡∏£‡πâ‡∏≤‡∏á...';
                    
                    fetch(`/teacher/api/course/${courseId}/create-google-form/${examType}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', // [MODIFIED TEXT]
                                icon: 'success',
                                confirmButtonText: '‡πÄ‡∏õ‡∏¥‡∏î Form (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö)',
                                showCancelButton: true,
                                cancelButtonText: '‡∏õ‡∏¥‡∏î'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.open(data.form_url, '_blank');
                                }
                            });
                            
                            // [MODIFIED] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô UI ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "Sync Score"
                            const newSyncBtnHtml = `<button class="btn btn-success btn-sm mt-1 btn-sync-google-form"
                                                            data-course-id="${data.course_id}"
                                                            data-form-type="exam"
                                                            data-exam-type="${examType}"
                                                            title="‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Form Quiz">
                                                        <i class="bi bi-arrow-repeat"></i> Sync Score
                                                    </button>`;
                            btn.outerHTML = newSyncBtnHtml; // Replace the button element
                        } else {
                            throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
                        }
                    })
                    .catch(error => {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', error.message, 'error');
                        btn.disabled = false;
                        btn.innerHTML = `<i class="bi bi-google"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Form`;
                    });
                }
            });
        });
        // --- [END NEW] ---

        // --- [EXISTING] Event Listener for creating GRADED ITEM Google Forms ---
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-create-google-form');
            if (!btn) return;

            e.preventDefault();
            const itemId = btn.dataset.itemId; // *** ‡πÉ‡∏ä‡πâ item.id ‡∏ï‡∏£‡∏á ‡πÜ ***
            const itemName = btn.closest('th').innerText.split('\n')[0]; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å <th>

            Swal.fire({
                title: `‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form?`,
                text: `‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Google Form Quiz ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${itemName}" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, // [MODIFIED TEXT]
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> ‡∏™‡∏£‡πâ‡∏≤‡∏á...';
                    
                    fetch(`/teacher/api/graded-item/${itemId}/create-google-form`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // ‡∏ñ‡πâ‡∏≤ response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 200 OK, ‡∏≠‡πà‡∏≤‡∏ô JSON error
                            return response.json().then(errData => {
                                throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', // [MODIFIED TEXT]
                                icon: 'success',
                                confirmButtonText: '‡πÄ‡∏õ‡∏¥‡∏î Form (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö)',
                                showCancelButton: true,
                                cancelButtonText: '‡∏õ‡∏¥‡∏î'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.open(data.form_url, '_blank');
                                }
                            });
                            
                            // [MODIFIED] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô UI ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "Sync Score"
                            const newSyncBtnHtml = `<button class="btn btn-success btn-sm mt-1 btn-sync-google-form"
                                                            data-item-id="${itemId}"
                                                            data-form-type="item" 
                                                            title="‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Form Quiz">
                                                        <i class="bi bi-arrow-repeat"></i> Sync Score
                                                    </button>`;
                            btn.outerHTML = newSyncBtnHtml; // Replace the button element

                        } else {
                            throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
                        }
                    })
                    .catch(error => {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', error.message, 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-google"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Form';
                    });
                }
            });
        });
        // --- [END EXISTING] ---


        // --- [NEW] Event Listener for SYNCING Google Form Scores (Item and Exam) ---
        table.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-sync-google-form');
            if (!btn) return;

            e.preventDefault();
            const formType = btn.dataset.formType; // 'item' or 'exam'
            let apiUrl = '';
            let syncMessage = '';

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Syncing...';
            
            if (formType === 'item') {
                const itemId = btn.dataset.itemId;
                apiUrl = `/teacher/api/sync-scores/item/${itemId}`;
                syncMessage = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
            } else if (formType === 'exam') {
                const courseId = btn.dataset.courseId;
                const examType = btn.dataset.examType; // 'midterm' or 'final'
                apiUrl = `/teacher/api/sync-scores/exam/${courseId}/${examType}`;
                syncMessage = (examType === 'midterm') ? '‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ' : '‡∏™‡∏≠‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ';
            }

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.message || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: `‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${syncMessage} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`,
                        text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ ${data.updated_count} ‡∏Ñ‡∏ô`,
                        showConfirmButton: false,
                        timer: 3000
                    });
                    
                    // Crucial: Re-render the affected table rows to show new scores.
                    fetchAndRenderGradebookTable(document.getElementById('classroom-selector'));

                } else {
                    throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏');
                }
            })
            .catch(error => {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = `<i class="bi bi-arrow-repeat"></i> Sync Score`;
            });
        });
        // --- [END NEW] ---

        table.addEventListener('change', e => {
            const target = e.target;

            if (target.matches('.unit-summary-input')) {
                const studentRow = target.closest('tr');
                if (!studentRow) return;

                const unitId = target.dataset.unitId;
                const newSummaryScore = parseFloat(target.value) || 0;
                const unitTotalMaxScore = parseFloat(target.dataset.unitTotalMaxScore) || 0;

                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå
                if (unitTotalMaxScore <= 0) return;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
                const ratio = newSummaryScore / unitTotalMaxScore;
                const scoreInputsInUnit = studentRow.querySelectorAll(`.score-input[data-unit-id="${unitId}"]`);
                
                // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏ß‡πâ
                let calculatedScores = [];
                let sumOfFlooredScores = 0;
                
                scoreInputsInUnit.forEach(input => {
                    const itemMaxScore = parseFloat(input.dataset.maxScore) || 0;
                    const idealScore = itemMaxScore * ratio;
                    const flooredScore = Math.floor(idealScore);
                    
                    calculatedScores.push({
                        input: input,
                        finalScore: flooredScore,
                        remainder: idealScore - flooredScore // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
                    });
                    sumOfFlooredScores += flooredScore;
                });

                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô
                let remainderToDistribute = newSummaryScore - sumOfFlooredScores;

                // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                calculatedScores.sort((a, b) => b.remainder - a.remainder);

                // 4. ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (‡∏ö‡∏ß‡∏Å 1) ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
                for (let i = 0; i < remainderToDistribute; i++) {
                    if (calculatedScores[i]) {
                        calculatedScores[i].finalScore++;
                    }
                }

                // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á input ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const itemsToSave = [];
                calculatedScores.forEach(calc => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                    const itemMaxScore = parseFloat(calc.input.dataset.maxScore) || 0;
                    if (calc.finalScore > itemMaxScore) {
                        calc.finalScore = itemMaxScore;
                    }

                    calc.input.value = calc.finalScore;
                    itemsToSave.push({
                        student_id: studentRow.dataset.studentId,
                        graded_item_id: calc.input.dataset.itemId.replace('g-', ''),
                        score: calc.finalScore
                    });
                });
                
                // ‡πÉ‡∏ä‡πâ Debounce ‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveScoresBulk ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (itemsToSave.length > 0) {
                    clearTimeout(saveDebounce);
                    saveDebounce = setTimeout(() => {
                        saveScoresBulk(itemsToSave, "{{ url_for('teacher.save_scores_bulk') }}");
                    }, 800);
                }
            }                
            else if (target.matches('.qualitative-select, .qualitative-main-summary')) {
                handleQualitativeChange(target);
            }
            // This part handles making the switches mutually exclusive. It's correct here.
            else if (target.classList.contains('propagation-toggle')) {
                const itemId = target.dataset.itemId;
                const mode = target.dataset.mode;
                const otherToggle = (mode === 'group')
                    ? table.querySelector(`.propagation-toggle.all-toggle[data-item-id="${itemId}"]`)
                    : table.querySelector(`.propagation-toggle.group-toggle[data-item-id="${itemId}"]`);
                
                if (target.checked && otherToggle) {
                    otherToggle.checked = false;
                }
            }
        });

        // The 'input' event fires on every keystroke. It's good for live UI updates.
        table.addEventListener('input', e => {
            const target = e.target;
            // We will ONLY use this for the live row total calculation.
            if (target.matches('.score-input, .exam-input')) {
                // Live UI update for totals
                updateStudentRowTotals(target.closest('tr'));
                // [THE FIX] Trigger the debounced save logic on every input
                handlePropagation(target); 
            }
        });
        // Initial calculation for all rows on load.
        table.querySelectorAll('tbody tr').forEach(row => updateStudentRowTotals(row));
    }

    function updateStudentRowTotals(rowElement) {
        // ... (updateStudentRowTotals logic remains the same) ...
        if (!rowElement) return;

        const table = rowElement.closest('table#gradebook-table');
        if (!table) return;

        // --- Part 1: Per-unit summary calculation (No changes here) ---
        rowElement.querySelectorAll('.unit-summary-input').forEach(summaryInput => {
            const unitId = summaryInput.dataset.unitId;
            let currentUnitSum = 0;
            rowElement.querySelectorAll(`.score-input[data-unit-id="${unitId}"]`).forEach(itemInput => {
                currentUnitSum += parseFloat(itemInput.value) || 0;
            });
            summaryInput.value = Number(currentUnitSum.toFixed(2));
        });

        // --- Part 2: REBUILT Grade Calculation Logic with MS > R > Score Hierarchy ---
        let finalGrade = '';
        let gradeClass = 'grade-display fw-bold';
        let hasIncompleteWork = false;

        // HIERARCHY 1: Check for "‡∏°‡∏™" status first
        const hasMsStatus = rowElement.dataset.hasMs === 'true';

        if (hasMsStatus) {
            finalGrade = '‡∏°‡∏™';
            gradeClass += ' text-danger';
        } else {
            // HIERARCHY 2: Check for "‡∏£" status
            // Step 2.1: Check for incomplete SUMMATIVE items
            const summativeIds = JSON.parse(table.dataset.summativeIds || '[]');
            if (summativeIds.length > 0) {
                rowElement.querySelectorAll('.score-input').forEach(input => {
                    const itemId = parseInt(input.dataset.itemId.replace('g-', ''));
                    if (summativeIds.includes(itemId) && input.value.trim() === '') {
                        hasIncompleteWork = true;
                    }
                });
            }

            // Step 2.2: Check for incomplete EXAM scores
            const midtermInput = rowElement.querySelector('.exam-input[data-exam-type="midterm"]');
            const finalInput = rowElement.querySelector('.exam-input[data-exam-type="final"]');
            
            if (midtermInput && midtermInput.value.trim() === '') hasIncompleteWork = true;
            if (finalInput && finalInput.value.trim() === '') hasIncompleteWork = true;

            if (hasIncompleteWork) {
                finalGrade = '‡∏£';
                gradeClass += ' text-danger';
            } else {
                // HIERARCHY 3: Calculate grade by score
                let collectedScore = 0;
                rowElement.querySelectorAll('.score-input').forEach(input => {
                    collectedScore += parseFloat(input.value) || 0;
                });
                const midtermScore = midtermInput ? (parseFloat(midtermInput.value) || 0) : 0;
                const finalScore = finalInput ? (parseFloat(finalInput.value) || 0) : 0;
                let overallTotalScore = collectedScore + midtermScore + finalScore;

                const grandMax = parseFloat(table.dataset.grandMaxScore) || 100;
                let percent = (grandMax > 0) ? (overallTotalScore / grandMax) * 100 : 0;

                // Update score displays
                rowElement.querySelector('.collected-score-display').textContent = collectedScore.toFixed(2).replace(/\.00$/, '');
                rowElement.querySelector('.total-score-display').textContent = overallTotalScore.toFixed(2).replace(/\.00$/, '');
                rowElement.querySelector('.percentage-display').textContent = `${percent.toFixed(0)}%`;
                
                function mapToGrade(p) {
                    if (p >= 80) return '4'; if (p >= 75) return '3.5'; if (p >= 70) return '3';
                    if (p >= 65) return '2.5'; if (p >= 60) return '2'; if (p >= 55) return '1.5';
                    if (p >= 50) return '1'; return '0';
                }
                const calculatedGrade = mapToGrade(percent);
                finalGrade = calculatedGrade;
                if (calculatedGrade === '0') gradeClass += ' text-danger';
            }
        }
        
        // --- Part 3: Update UI ---
        const gradeDisplay = rowElement.querySelector('.grade-display');
        if (gradeDisplay) {
            gradeDisplay.textContent = finalGrade;
            gradeDisplay.className = gradeClass;
        }
    }

    /**
     * Shows/hides gradebook columns based on the selected unit ID.
     * @param {string} unitId The ID of the unit to show.
     */
    function filterGradebookColumns(unitId) {
        const table = document.getElementById('gradebook-table');
        if (!table) return;

        // 1. Hide all unit-specific columns first
        table.querySelectorAll('.unit-column').forEach(col => {
            col.style.display = 'none';
        });
        
        // 2. Show ONLY columns for the selected unit
        if (unitId) {
            const selector = `.unit-id-${unitId}`;
            table.querySelectorAll(selector).forEach(col => {
                col.style.display = 'table-cell';
            });
        }
    }

    /**
     * Sets the visual 'active' state on the unit list menu.
     * Used by the gradebook filter.
     * @param {string} unitId The ID of the unit to highlight.
     */
    function setActiveUnitFilter(unitId) {
        // Update left sidebar visual state
        document.querySelectorAll('#unitList a').forEach(a => {
            a.classList.toggle('active', a.dataset.unitId === unitId);
        });
    }
    
    // -------------------------------------------
    // 5. MODAL & OTHER HELPER FUNCTIONS
    // -------------------------------------------
        
    // --- Unit CRUD Functions ---
    async function handleUnitCreate(e) {
        // ... (handleUnitCreate logic remains the same) ...
        e.preventDefault();
        const titleInput = this.querySelector('#unit-title-input');
        const title = titleInput ? titleInput.value.trim() : '';
        if (!title) {
            return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', 'error');
        }

        const createUrl = unitList.dataset.createUnitUrl;
        try {
            const response = await fetch(createUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ title: title })
            });

            const data = await response.json();

            if (data.status === 'success') {
                unitFormModal.hide();
                Swal.fire({ 
                    icon: 'success', 
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 
                    text: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 
                    timer: 1500, 
                    showConfirmButton: false 
                });

                const newUnitLink = document.createElement('a');
                newUnitLink.href = '#';
                newUnitLink.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                newUnitLink.dataset.unitId = data.unit.id;
                newUnitLink.dataset.deleteUrl = `/teacher/api/units/${data.unit.id}`;
                newUnitLink.innerHTML = `<span class="unit-title">${data.unit.title}</span><button class="btn btn-sm btn-outline-danger delete-unit-btn border-0" title="Delete Unit"><i class="bi bi-trash"></i></button>`;

                const placeholder = document.getElementById('no-units-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }

                unitList.appendChild(newUnitLink);
                unitHoursData[data.unit.id] = 0;
                setActiveUnit(data.unit.id.toString());
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ', 'error');
            }
        } catch (error) {
            Swal.fire('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ', 'error');
        }
    }

    function handleUnitDelete(unitLink) {
        // ... (handleUnitDelete logic remains the same) ...
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            text: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
        }).then(result => {
            if (result.isConfirmed) {
                fetch(unitLink.dataset.deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            const wasActive = unitLink.dataset.unitId === state.activeUnitId; // Use state.activeUnitId
                            unitLink.remove();
                            if (wasActive) {
                                state.activeUnitId = null; // Update state
                                saveState();
                                workspaceTabsContent.innerHTML = `<div id="initial-message" class="text-center text-muted py-5">
                                    <h4><i class="bi bi-arrow-left-circle"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h4>
                                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                                </div>`;
                            }
                            if (unitList.children.length === 0) {
                                unitList.innerHTML = '<div id="no-units-placeholder" class="list-group-item text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</div>';
                            }
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: '‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                                showConfirmButton: false,
                                timer: 2000
                            });
                        } else {
                            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.message, 'error');
                        }
                    });
            }
        });
    }

    // =================================================================
    //  GRADEBOOK SUMMARY TAB SPECIFIC FUNCTIONS
    // =================================================================

    async function loadAndRenderGradebookSummary(courseId, classroomId) {
        // ... (loadAndRenderGradebookSummary logic remains the same) ...
        const container = document.getElementById('gradebook-container');
        if (!container) return;
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';
        try {
            const url = `/teacher/api/course/${courseId}/gradebook-data?classroom_id=${classroomId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
            const data = await response.json();
            renderSummaryTable(data, container);
        } catch (error) {
            container.innerHTML = `<div class="text-center text-danger p-5"><strong>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${error.message}</div>`;
        }
    }

    function renderSummaryTable(data, container) {
        // ... (renderSummaryTable logic remains the same) ...
        if (!data.students || data.students.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>';
            return;
        }

        const max_midterm = data.total_midterm_max_score || 0;
        const max_final = data.total_final_max_score || 0;
        const grand_max = data.grand_max_score || 0;
        const collectedScores = {};
        data.students.forEach(s => {
            let total = 0;
            data.units_data.forEach(u => u.items.forEach(i => total += data.scores[`${s.id}-${i.id}`]?.score ?? 0));
            collectedScores[s.id] = total;
        });

        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0" id="grade-summary-table" data-grand-max="${grand_max}">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö</th>
                            <th class="text-center">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ (${max_midterm})</th><th class="text-center">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ (${max_final})</th>
                            <th class="text-center">‡∏£‡∏ß‡∏° (${grand_max})</th><th class="text-center">‡πÄ‡∏Å‡∏£‡∏î</th>
                        </tr>
                    </thead><tbody>`;
        data.students.forEach(s => {
            tableHtml += `
                <tr data-student-id="${s.id}">
                    <td class="text-center">${s.roll_number}</td><td>${s.first_name} ${s.last_name}</td>
                    <td class="text-center collected-score-cell">${collectedScores[s.id].toFixed(2).replace(/\.00$/, '')}</td>
                    <td class="p-1"><input type="number" class="form-control form-control-sm text-center score-input midterm-score-input" value="${s.midterm_score ?? ''}" max="${max_midterm}" min="0"></td>
                    <td class="p-1"><input type="number" class="form-control form-control-sm text-center score-input final-score-input" value="${s.final_score ?? ''}" max="${max_final}" min="0"></td>
                    <td class="text-center fw-bold total-score-cell">-</td><td class="text-center fw-bold grade-cell">-</td>
                </tr>`;
        });
        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
        container.querySelectorAll('tbody tr').forEach(row => recalculateSummaryRow(row));
    }

    function recalculateSummaryRow(row) {
        // ... (recalculateSummaryRow logic remains the same) ...
        const table = row.closest('table');
        if(!table) return;
        const grandMax = parseFloat(table.dataset.grandMax);
        const collected = parseFloat(row.querySelector('.collected-score-cell')?.textContent) || 0;
        const midterm = parseFloat(row.querySelector('.midterm-score-input')?.value) || 0;
        const final = parseFloat(row.querySelector('.final-score-input')?.value) || 0;
        const totalScore = collected + midterm + final;
        const percentage = (grandMax > 0) ? (totalScore / grandMax) * 100 : 0;

        let grade = '0';
        if (percentage >= 80) grade = '4'; else if (percentage >= 75) grade = '3.5';
        else if (percentage >= 70) grade = '3'; else if (percentage >= 65) grade = '2.5';
        else if (percentage >= 60) grade = '2'; else if (percentage >= 55) grade = '1.5';
        else if (percentage >= 50) grade = '1';

        row.querySelector('.total-score-cell').textContent = totalScore.toFixed(2).replace(/\.00$/, '');
        row.querySelector('.grade-cell').textContent = grade;
    }

    // =================================================================
    //  4. INITIALIZERS & HELPER FUNCTIONS
    // =================================================================

    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert Badges)
     * @param {object} alerts - ‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô { '‡∏ï‡∏¥‡∏î 0': '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á' }
     * @returns {string} - ‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏Ç‡∏≠‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
     */
    function renderAlerts(alerts) {
        // ... (renderAlerts logic remains the same) ...
        if (!alerts || Object.keys(alerts).length === 0) return '';

        let badgesHtml = '';
        for (const key in alerts) {
            const message = alerts[key];
            // --- NEW: Add condition for different badge color ---
            let badgeClass = 'bg-danger'; // Default to red for '0' and '‡∏£'
            if (key === '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô') {
                badgeClass = 'bg-info text-dark'; // Use blue for "Enter Scores"
            }
            badgesHtml += ` <span class="badge ${badgeClass} ms-1" title="${message}">${key}</span>`;
        }
        return badgesHtml;
    }

    // =======================================================
    // NEW GRADEBOOK ARCHITECTURE (FINAL)
    // =======================================================

    function createStudentElement(enrollment) {
        // ... (createStudentElement logic remains the same) ...
        return `<div class="list-group-item list-group-item-action p-2" data-id="${enrollment.id}">
                    <small>${enrollment.roll_number}. ${enrollment.name}</small>
                </div>`;
    }

    function initializeAllSortables() {
        // ... (initializeAllSortables logic remains the same) ...
        sortableInstances.forEach(s => s.destroy());
        sortableInstances = [];
        document.querySelectorAll('#groupManagementModal .list-group').forEach(list =>
            sortableInstances.push(new Sortable(list, {
                group: 'students',
                animation: 150,
                ghostClass: 'bg-primary-soft'
            }))
        );
    }

    // --- Core Functions ---
    function renderGroupManagerUI(groups = []) {
        // ... (renderGroupManagerUI logic remains the same) ...
        const ungroupedList = document.getElementById('ungrouped-students-list');
        const groupsContainer = document.getElementById('groups-container');
        ungroupedList.innerHTML = '';
        groupsContainer.innerHTML = '';

        const groupedIds = new Set(groups.flatMap(g => g.enrollments));

        allEnrollments.filter(en => !groupedIds.has(en.id))
            .forEach(en => ungroupedList.innerHTML += createStudentElement(en));

        groups.forEach(group => {
            let membersHtml = '';
            allEnrollments.filter(en => group.enrollments.includes(en.id))
                .forEach(member => membersHtml += createStudentElement(member));

            groupsContainer.insertAdjacentHTML(
                'beforeend',
                createGroupCard({ id: group.id, name: group.name }, membersHtml)
            );
        });

        initializeAllSortables();
    }

    async function saveGroups() {
        // ... (saveGroups logic remains the same) ...
        const saveBtn = document.getElementById('save-groups-btn');
        const classroomSelector = document.getElementById('classroom-selector');
        const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
        const planId = unitList.dataset.planId;

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;

        const payload = {
            groups: Array.from(document.querySelectorAll('#groups-container .group-card')).map(card => ({
                id: card.dataset.groupId.startsWith('new-') ? null : parseInt(card.dataset.groupId),
                name: card.querySelector('.group-name-input').value.trim(),
                members: Array.from(card.querySelectorAll('.list-group-item[data-id]')).map(item => parseInt(item.dataset.id))
            })).filter(g => g.name),
            course_id: courseId
        };

        try {
            const response = await fetch(`/teacher/api/plan/${planId}/groups`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Server error on save.');
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            groupModal.hide();
            // Reload gradebook to reflect new group assignments
            fetchAndRenderGradebookTable(classroomSelector); // Active unit ID is not needed here
        } catch (error) {
            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°';
        }
    }

    //--------------------------------------------------------
    // üß© ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    //--------------------------------------------------------
    function createGroupCard(group, membersHtml = '') {
        // ... (createGroupCard logic remains the same) ...
        return `
            <div class="card mb-3 group-card" data-group-id="${group.id}">
                <div class="card-header p-2 d-flex justify-content-between align-items-center">
                    <input type="text" class="form-control form-control-sm group-name-input" value="${group.name}">
                    <button class="btn btn-xs btn-outline-danger ms-2 delete-group-btn border-0">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body p-2 list-group group-dropzone" style="min-height: 50px;">
                    ${membersHtml}
                </div>
            </div>`;
    }

/**
     * [REVISED & CORRECTED]
     * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°
     * ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å Event ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠
     */
    function bindGroupManagerEvents() {
        // ... (bindGroupManagerEvents logic remains the same) ...
        const modalEl = document.getElementById('groupManagementModal');
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å Event ‡∏ã‡πâ‡∏≥ ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° 'data-events-bound' flag
        if (modalEl.dataset.eventsBound) {
            return;
        }
        modalEl.dataset.eventsBound = 'true'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ flag ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡∏Å Event ‡πÅ‡∏•‡πâ‡∏ß

        modalEl.addEventListener('click', async (e) => {
            const target = e.target;
            const groupsContainer = document.getElementById('groups-container');

            // ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            if (target.closest('#add-new-group-btn')) {
                const groupHtml = createGroupCard(
                    { id: `new-${Date.now()}`, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${groupsContainer.children.length + 1}` }, ''
                );
                groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
                initializeAllSortables();
            }
            // ü§ñ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            else if (target.closest('#auto-generate-groups-btn')) {
                const { value: numGroups } = await Swal.fire({
                    target: document.getElementById('groupManagementModal'), // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Swal ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
                    title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                    input: 'number',
                    inputLabel: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°?',
                    inputPlaceholder: '‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°',
                    showCancelButton: true,
                    confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    inputValidator: (value) => {
                        if (!value || value < 1) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
                    }
                });

                if (numGroups) {
                    const ungroupedStudents = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));
                    
                    // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    for (let i = ungroupedStudents.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [ungroupedStudents[i], ungroupedStudents[j]] = [ungroupedStudents[j], ungroupedStudents[i]];
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ
                    groupsContainer.innerHTML = '';
                    const newGroupElements = [];
                    for (let i = 1; i <= numGroups; i++) {
                        const groupId = `new-${Date.now()}-${i}`;
                        groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${i}` }, ''));
                        newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
                    }

                    // ‡πÅ‡∏à‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°
                    if (newGroupElements.length > 0) {
                        ungroupedStudents.forEach((studentNode, index) => {
                            newGroupElements[index % numGroups].appendChild(studentNode);
                        });
                    }
                    initializeAllSortables();
                }
            }
            // üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
            else if (target.closest('.delete-group-btn')) {
                const card = target.closest('.group-card');
                if (card) {
                    card.querySelectorAll('.list-group-item')
                        .forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                    card.remove();
                }
            }
            // üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
            else if (target.closest('#save-groups-btn')) {
                saveGroups();
            }
        });
    }


    /**
     * [REVISED & CORRECTED]
     * ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°, ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡∏Å Event
     */
    async function openGroupManager() {
        // ... (openGroupManager logic remains the same) ...
        const classroomSelector = document.getElementById('classroom-selector');
        if (!classroomSelector || !classroomSelector.value) {
            return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°', 'warning');
        }
        const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
        const planId = unitList.dataset.planId;

        const loader = document.getElementById('group-manager-loader');
        const content = document.getElementById('group-manager-content');
        loader.classList.remove('d-none');
        content.style.display = 'none';
        groupModal.show();

        try {
            const groupsUrl = `/teacher/api/plan/${planId}/groups?course_id=${courseId}`;
            const [enrollmentsRes, groupsRes] = await Promise.all([
                fetch(`/teacher/api/classrooms/${classroomSelector.value}/enrollments`),
                fetch(groupsUrl)
            ]);
            if (!enrollmentsRes.ok || !groupsRes.ok) throw new Error('Could not fetch initial data.');

            allEnrollments = await enrollmentsRes.json();
            const groups = await groupsRes.json();
            
            // 1. Render UI ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            renderGroupManagerUI(groups);

            loader.classList.add('d-none');
            content.style.display = 'flex';

            // 2. ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Sortable ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            initializeAllSortables();
            
            // 3. ‚úÖ‚úÖ‚úÖ [THE FIX] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡∏π‡∏Å Event Listener ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà!
            bindGroupManagerEvents();

        } catch (error) {
            console.error("Error opening group manager:", error);
            loader.innerHTML = `<div class="text-danger">${error.message}</div>`;
        }
    }

    /**
     * Auto-generates groups and distributes students.
     */
    async function autoGenerateGroups() {
        // ... (autoGenerateGroups logic remains the same) ...
        const {
            value: numGroups
        } = await Swal.fire({
            target: document.getElementById('groupManagementModal'),
            title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
            input: 'number',
            inputLabel: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°?',
            inputPlaceholder: '‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°',
            showCancelButton: true,
            confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            inputValidator: (value) => {
                if (!value || value < 1) {
                    return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'
                }
            }
        });

        if (numGroups) {
            const groupsContainer = document.getElementById('groups-container');
            // CORRECTED: Select students using the correct 'data-id' attribute
            const ungroupedStudents = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));

            groupsContainer.innerHTML = '';

            for (let i = ungroupedStudents.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [ungroupedStudents[i], ungroupedStudents[j]] = [ungroupedStudents[j], ungroupedStudents[i]];
            }

            const newGroupElements = [];
            for (let i = 1; i <= numGroups; i++) {
                const groupId = `new-${Date.now()}-${i}`;
                groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${i}` }, ''));
                newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
            }

            if (newGroupElements.length > 0) {
                ungroupedStudents.forEach((studentNode, index) => {
                    newGroupElements[index % numGroups].appendChild(studentNode);
                });
            }
            initializeAllSortables();
        }
    }

    /**
     * Handles changes for exam scores, syncs UI, saves data, and updates summary.
     */
    async function handleExamScoreChange(e) {
        // ... (handleExamScoreChange logic remains the same) ...
        // Find the parent elements for the specific unit being edited
        const unitContainer = e.target.closest('.accordion-collapse');
        if (!unitContainer) return;

        const unitId = unitContainer.id.replace('collapse-unit-', '');

        const midtermSwitch = unitContainer.querySelector('#midterm-switch-' + unitId);
        const finalSwitch = unitContainer.querySelector('#final-switch-' + unitId);
        const midtermInput = unitContainer.querySelector('.exam-score-input[data-exam-type="midterm"]');
        const finalInput = unitContainer.querySelector('.exam-score-input[data-exam-type="final"]');

        // Part 1: Sync UI state immediately
        // Sync UI state
        if (midtermSwitch && midtermInput) {
            midtermInput.disabled = !midtermSwitch.checked;
            if (!midtermSwitch.checked) midtermInput.value = '';
        }
        if (finalSwitch && finalInput) {
            finalInput.disabled = !finalSwitch.checked;
            if (!finalSwitch.checked) finalInput.value = '';
        }


        // Immediately update the summary panel for real-time feedback
        updateSummaryPanel();

        // Part 2: Construct payload and save to server (debounced)
        // Debounced save
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(async () => {
            const payload = {
                midterm_score: midtermSwitch.checked ? (parseFloat(midtermInput.value) || null) : null,
                final_score: finalSwitch.checked ? (parseFloat(finalInput.value) || null) : null
            };

            try {
                const response = await fetch(`/teacher/api/units/${unitId}/exam-scores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Server returned an error');

                const result = await response.json();
                if (result.status === 'success') {
                    // The existing code has a better popup, let's keep it.
                    // No need for a separate success popup here as the logic is handled 
                    // within the original handleExamScoreChange function in the provided HTML file.
                } else {
                    throw new Error(result.message || 'Application error');
                }
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ', 'error');
                console.error("Save Error:", error);
            }
        }, 500); // 500ms debounce
    }

    function renderSelectedIndicators(tomSelectInstance) {
        // ... (renderSelectedIndicators logic remains the same) ...
        const displayArea = document.getElementById('indicator-display-area');
        if (!displayArea) return;
        displayArea.innerHTML = '';

        const selectedItems = tomSelectInstance.items.map(id => tomSelectInstance.options[id]);

        const groupedByStandard = selectedItems.reduce((acc, option) => {
            if (!option || !option.standard_id) return acc;
            const stdId = option.standard_id;
            if (!acc[stdId]) {
                acc[stdId] = {
                    code: option.standard_code,
                    desc: option.standard_desc,
                    indicators: []
                };
            }
            acc[stdId].indicators.push({
                id: option.id,
                code: option.indicator_code,
                desc: option.indicator_desc
            });
            return acc;
        }, {});

        const sortedGroupKeys = Object.keys(groupedByStandard).sort((a, b) => {
            return groupedByStandard[a].code.localeCompare(groupedByStandard[b].code);
        });

        for (const stdId of sortedGroupKeys) {
            const group = groupedByStandard[stdId];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'indicator-group mt-3';

            const header = document.createElement('div');
            header.className = 'h6';
            header.innerHTML = `<i class="bi bi-bookmark-star-fill text-primary"></i> ${group.code} ${group.desc}`;
            groupDiv.appendChild(header);

            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';

            group.indicators.sort((a, b) => a.code.localeCompare(b.code));

            group.indicators.forEach(indicator => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center ps-4';

                const textSpan = document.createElement('span');
                textSpan.textContent = `${indicator.code} ${indicator.desc}`;
                listItem.appendChild(textSpan);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger border-0 flex-shrink-0 ms-2';
                removeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
                removeBtn.title = '‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ';
                removeBtn.onclick = () => tomSelectInstance.removeItem(indicator.id);

                listItem.appendChild(removeBtn);
                list.appendChild(listItem);
            });

            groupDiv.appendChild(list);
            displayArea.appendChild(groupDiv);
        }
    }

    function setupGradedItemModal() {
        // ... (setupGradedItemModal logic remains the same) ...
        const modalEl = document.getElementById('addAssessmentItemModal');
        if (!modalEl) {
             console.error("Modal #addAssessmentItemModal not found!");
             return;
        }
        const itemModal = bootstrap.Modal.getOrCreateInstance(modalEl); // Use getOrCreateInstance
        const itemForm = document.getElementById('addAssessmentItemForm');
        if (!itemForm) {
            console.error("Form #addAssessmentItemForm not found!");
            return;
        }

        // --- [REVISED] Use a flag to prevent multiple bindings ---
        if (modalEl.dataset.listenerAttached) {
            console.log("Listener already attached to #addAssessmentItemModal");
            return;
        }
        modalEl.dataset.listenerAttached = 'true';
        // --- End Revision ---

        modalEl.addEventListener('show.bs.modal', async function(event) {
            console.log("Modal show.bs.modal event triggered.");
            const button = event.relatedTarget;
            // Handle case where modal might be shown programmatically without a button
            const action = button ? button.dataset.action : 'add';
            console.log("Modal Action:", action);

            itemForm.reset(); // Reset form first
            this.querySelector('.modal-title').textContent = action === 'edit' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö';
            itemForm.dataset.action = action; // Set action on the form

            if (action === 'edit' && button) {
                const itemId = button.dataset.itemId;
                itemForm.dataset.itemId = itemId; // Store itemId on form
                console.log("Attempting to edit item ID:", itemId);

                try {
                    console.log(`Fetching data from: /teacher/api/graded-items/${itemId}`);
                    const response = await fetch(`/teacher/api/graded-items/${itemId}`);
                    console.log("Fetch response status:", response.status);

                    if (!response.ok) {
                         // Try to get error message from server if possible
                         let errorMsg = `Server responded with status ${response.status}`;
                         try {
                             const errorData = await response.json();
                             errorMsg = errorData.message || errorMsg;
                         } catch (jsonError) {
                              errorMsg += ` (${response.statusText})`;
                         }
                         console.error("Failed to fetch item data:", errorMsg);
                         Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ: ${errorMsg}`, 'error');
                         itemModal.hide(); // Hide modal if data fetch fails
                         return; // Stop if fetch failed
                    }

                    const data = await response.json();
                    console.log("Fetched item data:", data);

                    // Populate the form
                    Object.keys(data).forEach(key => {
                        // Find input/select by name attribute
                        const input = itemForm.querySelector(`[name="${key}"]`);
                        if (input) {
                            console.log(`Populating field [name="${key}"] with value:`, data[key]);
                            input.value = data[key]; // Set value
                        } else {
                            console.warn(`Input field with name '${key}' not found in the form.`);
                        }
                    });
                     console.log("Form population complete.");

                } catch (error) {
                    console.error("Error during fetch or form population:", error);
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`, 'error');
                    itemModal.hide(); // Hide modal on catch
                }
            } else { // Handle 'add' action or modal shown without button
                const unitId = button ? button.dataset.unitId : state.activeUnitId; // Fallback to active unit if no button
                console.log("Setting up modal for ADD action, unit ID:", unitId);
                itemForm.dataset.unitId = unitId;
                const unitIdInput = itemForm.querySelector('#modal-learningUnitId');
                if (unitIdInput) {
                    unitIdInput.value = unitId || '';
                } else {
                    console.warn("Hidden input #modal-learningUnitId not found.");
                }
                delete itemForm.dataset.itemId; // Ensure itemId is not set for add action
            }
        });

        // --- [REVISED] Attach submit listener only ONCE ---
        itemForm.addEventListener('submit', async function(e) {
             e.preventDefault();
             console.log("Form submitted. Action:", this.dataset.action);
             const action = this.dataset.action;
             const formData = new FormData(this);
             const data = Object.fromEntries(formData.entries());
             console.log("Form Data:", data);

             const method = action === 'edit' ? 'PUT' : 'POST';
             const url = action === 'edit' ?
                 `/teacher/api/graded-items/${this.dataset.itemId}` :
                 `/teacher/api/units/${this.dataset.unitId}/graded-items`; // Use unitId from dataset

             console.log(`Submitting to URL: ${url} with method: ${method}`);

             try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(data)
                });
                console.log("Submit response status:", response.status);

                const result = await response.json();
                console.log("Submit response data:", result);

                if (result.status === 'success') {
                    itemModal.hide();
                    Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: result.message, timer: 1500, showConfirmButton: false });
                    // Reload the current tab content to show changes
                    loadTabContent(state.activeTabId);
                    updateSummaryPanel(); // Update summary after successful save
                } else {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
                }
            } catch(error) {
                 console.error("Submit error:", error);
                 Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
            }
        });
        // --- End Revision ---
        // Assuming you have code like this to get the modal element:
        const subUnitModalEl = document.getElementById('subUnitModal'); 

        if (subUnitModalEl) { // Check if modal exists in this specific template
            subUnitModalEl.addEventListener('show.bs.modal', async (event) => {
                const button = event.relatedTarget; // Button that triggered the modal
                const subUnitId = button.dataset.subunitId; // Get ID from edit button

                // --- [NEW] Code to update Export Button links ---
                const exportPdfBtn = document.getElementById('exportSubUnitPdfBtn');
                const exportDocxBtn = document.getElementById('exportSubUnitDocxBtn');

                if (subUnitId) { // Only show buttons if editing an existing subunit (has ID)
                    const pdfUrl = `/teacher/subunit/${subUnitId}/export/pdf`; 
                    const docxUrl = `/teacher/subunit/${subUnitId}/export/docx`; 

                    exportPdfBtn.href = pdfUrl;
                    exportDocxBtn.href = docxUrl;
                    exportPdfBtn.style.display = 'inline-block'; // Show 
                    exportDocxBtn.style.display = 'inline-block'; // Show
                } else {
                    // Hide buttons when creating a new subunit (no ID yet)
                    exportPdfBtn.style.display = 'none';
                    exportDocxBtn.style.display = 'none';
                }
                // --- End New Code ---
            });
        } // End if (subUnitModalEl)        
    }

    function setupRatioTargetModal() {
        // ... (setupRatioTargetModal logic remains the same) ...
        const modalEl = document.getElementById('ratioTargetModal');
        if (!modalEl) return;
        const ratioModal = new bootstrap.Modal(modalEl);
        const saveBtn = modalEl.querySelector('#saveRatioTargetBtn');
        const deleteBtn = modalEl.querySelector('#deleteRatioTargetBtn');
        const midRatioInput = modalEl.querySelector('#target-mid-ratio');
        const finalRatioInput = modalEl.querySelector('#target-final-ratio');

        const syncInputs = (source, target) => {
            const sourceValue = Math.max(0, Math.min(100, parseInt(source.value) || 0));
            source.value = sourceValue;
            target.value = 100 - sourceValue;
        };
        midRatioInput.addEventListener('input', () => syncInputs(midRatioInput, finalRatioInput));
        finalRatioInput.addEventListener('input', () => syncInputs(finalRatioInput, midRatioInput));

        saveBtn.addEventListener('click', async () => {
            const midVal = parseInt(midRatioInput.value) || 0;
            const finalVal = parseInt(finalRatioInput.value) || 0;
            if (midVal + finalVal !== 100) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 100', 'error');

            const response = await fetch(`/teacher/api/plan/${planId}/ratio-target`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    mid_ratio: midVal,
                    final_ratio: finalVal
                })
            });

            if (response.ok) {
                targetMidRatio = midVal;
                targetFinalRatio = finalVal;
                isTargetSetByUser = true;
                ratioModal.hide();
                updateSummaryPanel();
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
            }
        });

        deleteBtn.addEventListener('click', async () => {
            const response = await fetch(`/teacher/api/plan/${planId}/ratio-target`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                isTargetSetByUser = false;
                targetMidRatio = 80;
                targetFinalRatio = 20;
                midRatioInput.value = 80;
                finalRatioInput.value = 20;
                ratioModal.hide();
                updateSummaryPanel();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    showConfirmButton: false,
                    timer: 2000
                });
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
            }
        });
    }

        // --- 3. Helper function to get badge style ---
        function getStatusBadge(status) {
            // ... (getStatusBadge logic remains the same) ...
            switch (status) {
                case 'PRESENT': return { text: '‚úî', class: 'bg-success' };
                case 'LATE':    return { text: '‡∏™', class: 'bg-warning text-dark' };
                case 'ABSENT':  return { text: '‡∏Ç', class: 'bg-danger' };
                case 'LEAVE':   return { text: '‡∏•', class: 'bg-info text-dark' };
                default:        return { text: '‚úî', class: 'bg-success' };
            }
        }

        // --- 4. Helper function to update a badge's appearance ---
        function updateBadge(badgeElement, newStatus) {
            // ... (updateBadge logic remains the same) ...
            const style = getStatusBadge(newStatus);
            badgeElement.dataset.status = newStatus;
            badgeElement.className = `badge rounded-pill fs-6 attendance-badge ${style.class}`;
            badgeElement.textContent = style.text;
        }

        // --- 5. Main Table Rendering Function (NEW) ---            
        function renderAttendanceTable(data, container) {
            // ... (renderAttendanceTable logic remains the same) ...
            if (!data.students || data.students.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
                return;
            }

            let tableHtml = '<div class="table-responsive"><table class="table table-bordered table-sm small">';
            
            // --- Build Header ---
            let headerRow1 = '<tr><th rowspan="2" class="align-middle" style="min-width: 150px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
            let headerRow2 = '<tr>';
            
            data.sessions.forEach((session, index) => {
                const sessionDate = new Date(session.date + 'T00:00:00'); // Ensure correct date parsing
                const formattedDate = sessionDate.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
                headerRow1 += `<th class="text-center">${index + 1}</th>`; // Period Number
                headerRow2 += `<th class="text-center text-nowrap">${formattedDate}</th>`; // Actual Date
            });
            headerRow1 += '</tr>';
            headerRow2 += '</tr>';
            tableHtml += `<thead class="table-light text-center align-middle sticky-top">${headerRow1}${headerRow2}</thead>`;

            // --- Build Body ---
            tableHtml += '<tbody>';
            data.students.forEach(student => {
                tableHtml += `<tr><td class="text-nowrap text-start sticky-left">${student.roll_number}. ${student.name}</td>`;
                data.sessions.forEach(session => {
                    const key = `${student.id}-${session.entry_id}-${session.date}`;
                    const status = data.attendance_data[key] || 'PRESENT';
                    const style = getStatusBadge(status);
                    // Determine cell-specific background color
                    let cellClass = '';
                    if (status === 'ABSENT') {
                        cellClass = 'bg-danger-soft'; // A softer red for the cell
                    } else if (status === 'LATE') {
                        cellClass = 'bg-warning-soft'; // A softer yellow
                    }
                    tableHtml += `<td class="text-center p-1 attendance-cell" 
                                    data-student-id="${student.id}" 
                                    data-entry-id="${session.entry_id}" 
                                    data-date="${session.date}">
                                    <span class="badge rounded-pill fs-6 attendance-badge ${style.class}" 
                                        data-status="${status}" 
                                        style="cursor: pointer; width: 35px;">
                                        ${style.text}
                                    </span>
                                </td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }
    
    function renderSubUnit(subUnit) {
        // ... (renderSubUnit logic remains the same) ...
        return `
        <div class="card mb-2" id="subunit-card-${subUnit.id}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title mb-1">
                            <span class="badge bg-primary me-2">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà ${subUnit.hour_sequence}</span>
                            <span class="subunit-title">${subUnit.title}</span>
                        </h6>
                        <p class="card-text text-muted small subunit-activities">${subUnit.activities || ''}</p>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary edit-subunit-btn" data-subunit-id="${subUnit.id}">
                            <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-subunit-btn" data-subunit-id="${subUnit.id}">
                            <i class="bi bi-trash"></i> ‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    async function handleAddSubUnit(button) {
        // ... (handleAddSubUnit logic remains the same) ...
        const unitId = button.dataset.unitId;
        const response = await fetch(`/teacher/api/units/${unitId}/sub_units`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        if (response.ok) {
            const newSubUnit = await response.json();
            document.getElementById('no-subunits-placeholder') ?.remove();
            document.getElementById('sub-units-list').insertAdjacentHTML('beforeend', renderSubUnit(newSubUnit));

            const list = document.getElementById('sub-units-list');
            const unitHours = parseInt(button.dataset.unitHours, 10);
            if (list.children.length >= unitHours) {
                button.disabled = true;
            }
        } else {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÑ‡∏î‡πâ', 'error');
        }
    }

    async function handleEditSubUnit(button) {
        // ... (handleEditSubUnit logic remains the same) ...
        const subUnitId = button.dataset.subunitId;

        const [subUnitResponse, gradedItemsResponse] = await Promise.all([
            fetch(`/teacher/api/sub_units/${subUnitId}`),
            fetch(`/teacher/api/units/${state.activeUnitId}/graded-items-for-selection`)
        ]);

        if (!subUnitResponse.ok || !gradedItemsResponse.ok) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ', 'error');
            return;
        }

        const data = await subUnitResponse.json();
        const gradedItemsOptions = await gradedItemsResponse.json();

        const modal = document.getElementById('subUnitEditModal');
        modal.querySelector('#modal-subunit-id').value = data.id;
        modal.querySelector('#modal-subunit-title').value = data.title;
        modal.querySelector('#modal-subunit-activities').value = data.activities;

        if (subUnitIndicatorsTomSelect) subUnitIndicatorsTomSelect.destroy();
        subUnitIndicatorsTomSelect = new TomSelect('#modal-subunit-indicators', {
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            options: tomSelect.options,
            items: data.indicator_ids
        });

        if (subUnitGradedItemsTomSelect) subUnitGradedItemsTomSelect.destroy();
        subUnitGradedItemsTomSelect = new TomSelect('#modal-subunit-graded-items', {
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            options: gradedItemsOptions,
            items: data.graded_item_ids
        });

        subUnitEditModal.show();
    }

    async function handleSubUnitFormSubmit(e) {
        // ... (handleSubUnitFormSubmit logic remains the same) ...
        e.preventDefault();
        const subUnitId = this.querySelector('#modal-subunit-id').value;
        const data = {
            title: this.querySelector('#modal-subunit-title').value,
            activities: this.querySelector('#modal-subunit-activities').value,
            indicator_ids: subUnitIndicatorsTomSelect.getValue(),
            graded_item_ids: subUnitGradedItemsTomSelect.getValue()
        };

        const response = await fetch(`/teacher/api/sub_units/${subUnitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            subUnitEditModal.hide();
            const card = document.getElementById(`subunit-card-${subUnitId}`);
            if (card) {
                card.querySelector('.subunit-title').textContent = data.title;
                card.querySelector('.subunit-activities').textContent = data.activities;
            }
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }

    function handleDeleteSubUnit(button) {
        // ... (handleDeleteSubUnit logic remains the same) ...
        const subUnitId = button.dataset.subunitId;
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏µ‡πâ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
        }).then(async result => {
            if (result.isConfirmed) {
                const response = await fetch(`/teacher/api/sub_units/${subUnitId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                if (response.ok) {
                    document.getElementById(`subunit-card-${subUnitId}`).remove();

                    const addBtn = document.getElementById('add-subunit-btn');
                    const list = document.getElementById('sub-units-list');
                    const unitHours = parseInt(addBtn.dataset.unitHours, 10);
                    if (list.children.length < unitHours) {
                        addBtn.disabled = false;
                    }
                    if (list.children.length === 0) {
                        list.innerHTML = '<p id="no-subunits-placeholder" class="text-muted fst-italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>';
                    }
                } else {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
                }
            }
        });
    }

    async function handlePlanFormSubmit(e) {
        // ... (handlePlanFormSubmit logic remains the same) ...
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form).entries());
        data.indicators = tomSelect ? tomSelect.getValue() : [];

        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!',
                text: result.message,
                timer: 1500,
                showConfirmButton: false
            });
            const unitLinkTitle = document.querySelector(`#unitList a[data-unit-id="${state.activeUnitId}"] .unit-title`);
            if (unitLinkTitle && result.new_title) {
                unitLinkTitle.textContent = result.new_title;
            }
        } else {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ', 'error');
        }
    }

    function handleGradedItemDelete(itemId) {
        // ... (handleGradedItemDelete logic remains the same) ...
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            text: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/teacher/api/graded-items/${itemId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            document.getElementById(`graded-item-${itemId}`) ?.remove();
                            updateSummaryPanel();
                            Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        } else {
                            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.message, 'error');
                        }
                    });
            }
        });
    }

    async function openTopicSelectionModal(button) {
        // ... (openTopicSelectionModal logic remains the same) ...
        const templateId = button.dataset.templateId;
        const modalEl = document.getElementById('selectTopicsModal');
        modalEl.querySelector('.modal-title').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${button.dataset.templateName}`;
        const modalBody = modalEl.querySelector('.modal-body');
        modalBody.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="spinner-border" role="status"></div></div>';

        const saveBtn = modalEl.querySelector('#saveTopicSelectionBtn');
        const saveHandler = async () => {
            const selectedIds = Array.from(modalEl.querySelectorAll('input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
            const response = await fetch(`/teacher/api/units/${state.activeUnitId}/assessment-items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    template_id: templateId,
                    topic_ids: selectedIds
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                selectionModal.hide();
                Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: result.message,
                        timer: 1500,
                        showConfirmButton: false
                    })
                    // After the success message closes, reload the assessment tab's content
                    // to show the newly saved topics.
                    .then(() => {
                        loadTabContent(state.activeTabId);
                    });
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        };
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.addEventListener('click', saveHandler);

        try {
            const [topicsResponse, selectedResponse] = await Promise.all([
                fetch(`/teacher/api/templates/${templateId}/topics-for-selection`),
                fetch(`/teacher/api/units/${state.activeUnitId}/selected-topics`)
            ]);

            if (!topicsResponse.ok) throw new Error('Could not load topic structure.');
            if (!selectedResponse.ok) throw new Error('Could not load selected topics.');

            const topicTree = await topicsResponse.json();
            const selectedData = await selectedResponse.json();
            const selectedIds = selectedData.selected_ids || [];

            modalBody.innerHTML = buildCheckboxTree(topicTree, selectedIds);
            setupCheckboxLogic(modalBody);
        } catch (error) {
            modalBody.innerHTML = '<div class="alert alert-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ: ${error.message}</div>';
            console.error(error);
        }
    }

    /**
     * NEW: Calculates and displays cumulative periods for ALL units.
     */
    function updateCumulativePeriods() {
        // ... (updateCumulativePeriods logic remains the same) ...
        let cumulativePeriods = 0;
        // Iterate through the unit list on the left to maintain correct order
        document.querySelectorAll('#unitList a').forEach(link => {
            const unitId = link.dataset.unitId;
            const periods = unitHoursData[unitId] || 0;

            const displaySpan = workspaceTabsContent.querySelector(`#cumulative-display-${unitId}`);
            if (displaySpan) { // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ span ‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà
                if (periods > 0) {
                    const startPeriod = cumulativePeriods + 1;
                    const endPeriod = cumulativePeriods + periods;
                    displaySpan.textContent = `(‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${startPeriod}-${endPeriod})`;
                    cumulativePeriods = endPeriod;
                } else {
                    displaySpan.textContent = '';
                }
            } else { // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö unit ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏â‡∏¢‡πÜ
                if (periods > 0) {
                    cumulativePeriods += periods;
                }
            }
        });
    }

    const saveQualitativeScoresBulk = (scoresData) => {
        // ... (saveQualitativeScoresBulk logic remains the same) ...
        const courseId = table.dataset.courseId;
        fetch('/teacher/api/qualitative-score/save-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    scores: scoresData,
                    course_id: courseId
                })
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(result => {
                if (result.status !== 'success') console.error('Qualitative bulk save failed:', result.message);
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Alert ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
            })
            .catch(err => console.error('Qualitative bulk save error:', err));
    };

    const saveExamScoresBulk = (scoresData) => {
        // ... (saveExamScoresBulk logic remains the same) ...
        const courseId = table.dataset.courseId;
        fetch('/teacher/api/enrollments/save-exam-score-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    scores: scoresData,
                    course_id: courseId
                })
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(result => {
                if (result.status !== 'success') console.error('Exam bulk save failed:', result.message);
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ Alert
            })
            .catch(err => console.error('Exam bulk save error:', err));
    };

    // --- 3. Main Event Listeners (‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà) ---
    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢"
     * @param {HTMLElement} mainSelect - Dropdown ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
     * @param {string} scope - ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ('table' ‡∏´‡∏£‡∏∑‡∏≠ 'row')
     * @returns {Array} - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ elements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
     */
    const propagateMainToSubs = (mainSelect, scope) => {
        // ... (propagateMainToSubs logic remains the same) ...
        const mainId = mainSelect.dataset.topicId;
        const newValue = mainSelect.value;
        const changes = [mainSelect];
        const rows = (scope === 'table') ? Array.from(table.querySelectorAll('tr[data-student-id]')) : [mainSelect.closest('tr')];

        rows.forEach(row => {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown "‡∏™‡∏£‡∏∏‡∏õ" ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ (‡∏Å‡∏£‡∏ì‡∏µ scope='table')
            const summaryInRow = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainId}"]`);
            if (summaryInRow && summaryInRow.value !== newValue) {
                summaryInRow.value = newValue;
                changes.push(summaryInRow);
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown "‡∏¢‡πà‡∏≠‡∏¢" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            row.querySelectorAll(`.qualitative-select[data-main-id="${mainId}"]`).forEach(sub => {
                if (sub.value !== newValue) {
                    sub.value = newValue;
                    changes.push(sub);
                }
            });
        });
        return [...new Set(changes)]; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
    };
    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà" ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢"
     * @param {HTMLElement} subSelect - Dropdown ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
     * @param {string} scope - ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ('table' ‡∏´‡∏£‡∏∑‡∏≠ 'row')
     * @returns {Array} - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ elements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
     */
    const recalculateMainFromSubs = (subSelect, scope) => {
        // ... (recalculateMainFromSubs logic remains the same) ...
        const mainId = subSelect.dataset.mainId;
        const changes = [subSelect];
        const rows = (scope === 'table') ? Array.from(table.querySelectorAll('tr[data-student-id]')) : [subSelect.closest('tr')];

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢" ‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô
        if (scope === 'table') {
            const topicId = subSelect.dataset.topicId;
            const newValue = subSelect.value;
            rows.forEach(row => {
                const otherSub = row.querySelector(`.qualitative-select[data-topic-id="${topicId}"]`);
                if (otherSub && otherSub !== subSelect && otherSub.value !== newValue) {
                    otherSub.value = newValue;
                    changes.push(otherSub);
                }
            });
        }

        // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì "‡∏™‡∏£‡∏∏‡∏õ" ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô scope
        rows.forEach(row => {
            const summary = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainId}"]`);
            const subs = Array.from(row.querySelectorAll(`.qualitative-select[data-main-id="${mainId}"]`));
            const scores = subs.map(s => s.value).filter(v => v !== '');

            if (summary && scores.length > 0) {
                const frequency = scores.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});
                const mode = Object.keys(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b);
                if (summary.value !== mode) {
                    summary.value = mode;
                    changes.push(summary);
                }
            } else if (summary && summary.value !== '') {
                summary.value = '';
                changes.push(summary);
            }
        });
        return [...new Set(changes)]; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
    };

    // --- UI UPDATE & CALCULATION FUNCTIONS ---

    async function loadRatioTarget() {
        // ... (loadRatioTarget logic remains the same) ...
        try {
            const resp = await fetch(`/teacher/api/plan/${planId}/ratio-target`);
            if (resp.ok) {
                const data = await resp.json();
                if (data && data.mid_ratio != null && data.final_ratio != null) {
                    targetMidRatio = parseInt(data.mid_ratio);
                    targetFinalRatio = parseInt(data.final_ratio);
                    isTargetSetByUser = true;
                    // --- [FIX] Add Null Checks ---
                    const midRatioInput = document.querySelector('#ratioTargetModal #target-mid-ratio');
                    const finalRatioInput = document.querySelector('#ratioTargetModal #target-final-ratio');
                    if (midRatioInput) midRatioInput.value = targetMidRatio;
                    if (finalRatioInput) finalRatioInput.value = targetFinalRatio;
                    // --- End Fix ---
                } else {
                    isTargetSetByUser = false;
                }
            } else { // Handle case where fetch itself fails but doesn't throw network error
                 console.warn('Could not load ratio target, server responded:', resp.status);
                 isTargetSetByUser = false;
            }
        } catch (err) {
            // --- [FIX] Log error correctly ---
            console.error('Could not load ratio target', err); // Changed warn to error
            isTargetSetByUser = false;
        }
    }

    /**
     * [FINAL VERSION 2.0] Calculates and updates the "Intelligent Score Summary Panel".
     * - Correctly defines Mid-Period vs Final-Period scores.
     * - Changes the "Difference" calculation to show "points needed to reach the 80:20 target".
     * - Uses clearer colors for the difference display (Warning/Danger).
     */
    function updateSummaryPanel() {
        // ... (updateSummaryPanel logic remains the same) ...
        // --- [REVISED] Get assessmentContent element *inside* the function ---
        const container = document.getElementById('assessment-content');
        if (!container) {
            console.warn("updateSummaryPanel called but #assessment-content not found.");
            return; // Exit if container doesn't exist when function is called
        }
        // --- End Revision ---

        // --- Part 1: Calculate scores ---
        const totalCollectedScore = Array.from(container.querySelectorAll('.score-value')).reduce((sum, el) => sum + (parseFloat(el.textContent) || 0), 0);
        const totalMidtermScore = Array.from(container.querySelectorAll('.exam-score-input[data-exam-type="midterm"]:not(:disabled)')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
        const totalFinalScore = Array.from(container.querySelectorAll('.exam-score-input[data-exam-type="final"]:not(:disabled)')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
        const actualMidPeriodScore = totalCollectedScore + totalMidtermScore;
        const actualFinalPeriodScore = totalFinalScore;
        const grandTotalScore = actualMidPeriodScore + actualFinalPeriodScore;

        // --- Part 2: Handle UI Visibility ---
        let anyMidtermEnabled = container.querySelector('.exam-score-switch[id^="midterm-"]:checked');
        let anyFinalEnabled = container.querySelector('.exam-score-switch[id^="final-"]:checked');
        const midtermRow = document.getElementById('summary-midterm-row');
        const finalRow = document.getElementById('summary-final-row');
        const ratioContainer = document.getElementById('ratio-summary-container');
        // --- [FIX] Add Null Checks for Visibility ---
        if (midtermRow) midtermRow.style.display = anyMidtermEnabled ? 'block' : 'none';
        if (finalRow) finalRow.style.display = anyFinalEnabled ? 'block' : 'none';
        if (ratioContainer) ratioContainer.style.display = (anyMidtermEnabled || anyFinalEnabled) ? 'flex' : 'none';
        // --- End Fix ---

        // --- Part 3: Update Score Displays ---
        // --- [FIX] Add Null Checks for Score Displays ---
        const summaryCollectedEl = document.getElementById('summary-collected-score');
        const summaryMidtermEl = document.getElementById('summary-midterm-score');
        const summaryFinalEl = document.getElementById('summary-final-score');
        const summaryTotalEl = document.getElementById('summary-total-score');
        if (summaryCollectedEl) summaryCollectedEl.textContent = totalCollectedScore;
        if (summaryMidtermEl) summaryMidtermEl.textContent = totalMidtermScore;
        if (summaryFinalEl) summaryFinalEl.textContent = totalFinalScore;
        if (summaryTotalEl) summaryTotalEl.textContent = grandTotalScore;
        // --- End Fix ---

        // --- Part 4: Ratio and Difference Calculation ---
        const actualRatioDisplay = document.getElementById('actual-ratio-display');
        const targetRatioCol = document.getElementById('target-ratio-col');
        const diffRatioCol = document.getElementById('diff-ratio-col');
        const targetRatioDisplay = document.getElementById('target-ratio-display');
        const diffRatioDisplay = document.getElementById('diff-ratio-display');

        // --- [FIX] Add Null Checks for Ratio Elements ---
        if (actualRatioDisplay) {
            if (grandTotalScore > 0) {
                const actualMidRatio = Math.round((actualMidPeriodScore / grandTotalScore) * 100);
                const actualFinalRatio = 100 - actualMidRatio;
                actualRatioDisplay.textContent = `${actualMidRatio} : ${actualFinalRatio}`;
            } else {
                actualRatioDisplay.textContent = '-- : --';
            }
        }

        if (isTargetSetByUser && targetRatioCol && diffRatioCol && targetRatioDisplay && diffRatioDisplay) {
            targetRatioCol.style.display = 'block';
            diffRatioCol.style.display = 'block';
            targetRatioDisplay.textContent = `${targetMidRatio} : ${targetFinalRatio}`;
            if (actualFinalPeriodScore > 0 && targetFinalRatio > 0) {
                const idealMidPeriodScore = (actualFinalPeriodScore * targetMidRatio) / targetFinalRatio;
                const pointsNeeded = idealMidPeriodScore - actualMidPeriodScore;
                if (pointsNeeded < 0.01 && pointsNeeded > -0.01) diffRatioDisplay.innerHTML = `<span class="text-success">‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>`;
                else if (pointsNeeded < 0) diffRatioDisplay.innerHTML = `<span class="text-danger">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(pointsNeeded).toFixed(2).replace(/\.00$/, '')} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>`;
                else diffRatioDisplay.innerHTML = `<span class="text-warning fw-bold">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏≤‡∏î ${pointsNeeded.toFixed(2).replace(/\.00$/, '')} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>`;
            } else {
                diffRatioDisplay.innerHTML = '<span>‡∏£‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</span>';
            }
        } else if (targetRatioCol && diffRatioCol) { // Ensure these exist before hiding
            targetRatioCol.style.display = 'none';
            diffRatioCol.style.display = 'none';
        }
        // --- End Fix ---
    }

    function buildCheckboxTree(nodes, selectedIds, isSublevel = false) {
        // ... (buildCheckboxTree logic remains the same) ...
        let html = `<ul class="${isSublevel ? 'list-unstyled ps-4' : 'list-unstyled'}">`;
        nodes.forEach(node => {
            const isChecked = selectedIds.includes(node.id);
            html += `<li class="form-check my-1">
                            <input class="form-check-input" type="checkbox" value="${node.id}" id="topic-${node.id}" ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="topic-${node.id}">${node.name}</label>
                            ${node.children?.length > 0 ? buildCheckboxTree(node.children, selectedIds, true) : ''}
                            </li>`;
        });
        return html + '</ul>';
    }

    function setupCheckboxLogic(container) {
        // ... (setupCheckboxLogic logic remains the same) ...
        container.addEventListener('change', e => {
            if (e.target.type !== 'checkbox') return;
            const checkbox = e.target;
            const isChecked = checkbox.checked;
            const listItem = checkbox.closest('li.form-check');

            // Check/uncheck all children
            listItem.querySelectorAll('input[type="checkbox"]').forEach(child => child.checked = isChecked);

            // Update parents
            let parentLi = listItem.parentElement.closest('li.form-check');
            while (parentLi) {
                const parentCheckbox = parentLi.querySelector('input[type="checkbox"]');
                const siblings = parentLi.querySelectorAll('ul > li > input[type="checkbox"]');
                const anySiblingChecked = Array.from(siblings).some(cb => cb.checked);
                parentCheckbox.checked = anySiblingChecked; // Parent is checked if any child is checked
                parentLi = parentLi.parentElement.closest('li.form-check');
            }
        });
    }

    /**
     * Calculates the mode (most frequent value) from an array of values.
     * @param {Array<string>} arr The array of scores/values.
     * @returns {string} The most frequent value, or an empty string if none.
     */
    function calculateMode(arr) {
        // ... (calculateMode logic remains the same) ...
        if (!arr || arr.length === 0) return '';
        const frequency = arr.reduce((acc, val) => {
            if (val !== '') { // Only count non-empty values
                acc[val] = (acc[val] || 0) + 1;
            }
            return acc;
        }, {});

        let maxFreq = 0;
        let mode = '';
        for (const val in frequency) {
            if (frequency[val] > maxFreq) {
                maxFreq = frequency[val];
                mode = val;
            }
        }
        return mode;
    }
    const saveSettingsBtn = document.getElementById('savePlanSettingsBtn');

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö kh·ªüi t·ªï TomSelect ---
    function initializeRoomSelector() {
        // ... (initializeRoomSelector logic remains the same) ...
        const roomSelector = document.getElementById('room-select');
        if (!roomSelector) return;

        if (roomTomSelect) {
            roomTomSelect.destroy();
        }

        roomTomSelect = new TomSelect(roomSelector, {
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            create: true,
            load: function(query, callback) {
                const url = `{{ url_for('teacher.search_rooms') }}?q=${encodeURIComponent(query)}&plan_id=${planId}`;
                fetch(url)
                    .then(response => response.json())
                    .then(callback)
                    .catch(() => callback());
            },
            create: function(input, callback) {
                Swal.fire({
                    title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                    target: document.getElementById('planSettingsModal'), // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ SweetAlert2 ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Modal ‡∏ô‡∏µ‡πâ
                    html: `
                        <input id="swal-room-name" class="swal2-input" value="${input}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á">
                        <input id="swal-room-capacity" type="number" class="swal2-input" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (‡∏Ñ‡∏ô)">
                        <input id="swal-room-type" class="swal2-input" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£)">
                        <textarea id="swal-room-notes" class="swal2-textarea" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î)"></textarea>
                    `,
                    confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                    showCancelButton: true,
                    focusConfirm: false, // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Enter
                    stopKeydownPropagation: false, // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SweetAlert2 ‡∏ö‡∏•‡πá‡∏≠‡∏Å Event ‡∏Ç‡∏≠‡∏á Modal ‡∏´‡∏•‡∏±‡∏Å
                    preConfirm: () => {
                        return {
                            name: document.getElementById('swal-room-name').value,
                            capacity: document.getElementById('swal-room-capacity').value || null,
                            room_type: document.getElementById('swal-room-type').value, // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ
                            notes: document.getElementById('swal-room-notes').value
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch("{{ url_for('teacher.create_room_on_the_fly') }}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify(result.value)
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    callback(data.room); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ TomSelect
                                } else {
                                    Swal.fire({
                                        target: document.getElementById('planSettingsModal'), // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ alert ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô modal ‡∏î‡πâ‡∏ß‡∏¢
                                        title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                                        text: data.message,
                                        icon: 'error'
                                    });
                                    callback();
                                }
                            });
                    } else {
                        callback(); // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á
                    }
                });
            },
            render: {
                option: function(data, escape) {
                    return `<div>
                                <strong>${escape(data.name)}</strong>
                                ${data.capacity ? `<small class="text-muted ms-2">(‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏: ${data.capacity} ‡∏Ñ‡∏ô)</small>` : ''}
                            </div>`;
                },
                item: function(data, escape) {
                    return `<div>${escape(data.name)}</div>`;
                }
            }
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        roomTomSelect.load('');
    }

    // --- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏≠‡∏ô Modal ‡πÄ‡∏õ‡∏¥‡∏î ---
    document.getElementById('planSettingsModal').addEventListener('show.bs.modal', function() {
        // ... (planSettingsModal show.bs.modal logic remains the same) ...
        initializeRoomSelector();

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
        fetch(`{{ url_for('teacher.get_plan_constraints', plan_id=plan.id) }}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('constraint_arrangement').value = data.period_arrangement || 'separate';
                document.getElementById('constraint_preference').value = data.time_preference || 'any';
                // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô textarea
                document.getElementById('manual-notes').value = data.manual_notes || '';
                
                if (data.room_id && roomTomSelect) {
                    console.log(`Setting roomTomSelect value to: ${data.room_id}`); // Optional debug log
                    roomTomSelect.setValue(data.room_id, true); // Use setValue with 'true' to prevent triggering 'change' event
                } else {
                    console.log("No room_id found in data or roomTomSelect not ready."); // Optional debug log
                    if(roomTomSelect) {
                        roomTomSelect.clear(); // Clear selection if no room_id is returned
                    }
                }
            });
    });
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Event Listener ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Save
    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', function() {
            // ... (saveSettingsBtn click logic remains the same) ...
            const statusEl = document.getElementById('settings-save-status');
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            this.disabled = true;

            // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å field ‡πÉ‡∏ô Modal
            const constraintsPayload = {
                'period_arrangement': document.getElementById('constraint_arrangement').value,
                'time_preference': document.getElementById('constraint_preference').value,
                'manual_notes': document.getElementById('manual-notes').value // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            };

            const roomPayload = {
                'room_id': roomTomSelect ? roomTomSelect.getValue() : null
            };

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Promise ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            const saveConstraints = fetch("{{ url_for('teacher.save_plan_constraints', plan_id=plan.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(constraintsPayload)
            });

            const saveRoom = fetch("{{ url_for('teacher.assign_room_to_plan_courses', plan_id=plan.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(roomPayload)
            });

            // 3. ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•
            Promise.all([saveConstraints, saveRoom])
                .then(async ([constraintsRes, roomRes]) => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const constraintsData = await constraintsRes.json();
                    const roomData = await roomRes.json();

                    if (constraintsRes.ok && roomRes.ok) {
                        statusEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!';
                        setTimeout(() => {
                            statusEl.textContent = '';
                            const modal = bootstrap.Modal.getInstance(document.getElementById('planSettingsModal'));
                            modal.hide();
                        }, 1500);
                    } else {
                        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô
                        const errorMsg = [constraintsData.message, roomData.message].filter(Boolean).join('; ');
                        statusEl.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMsg || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`;
                    }
                })
                .catch(err => {
                    statusEl.textContent = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!';
                    console.error(err);
                })
                .finally(() => {
                    this.disabled = false;
                });
        });
    }
    // -------------------------------------------
    // 6. CENTRALIZED EVENT LISTENERS
    // -------------------------------------------
    unitList.addEventListener('click', (e) => {
        const unitLink = e.target.closest('a.list-group-item');
        const deleteBtn = e.target.closest('.delete-unit-btn');

        if (deleteBtn && unitLink) {
            e.preventDefault();
            e.stopPropagation();
            handleUnitDelete(unitLink); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        } else if (unitLink) {
            e.preventDefault();
            setActiveUnit(unitLink.dataset.unitId);
        }
    });

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Event Listener ‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    // ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    // ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    workspaceTabs.addEventListener('show.bs.tab', (event) => {
        const newTabId = event.target.id;
        
        // 1. [FIXED] Save the tab state immediately
        if (state.activeTabId !== newTabId) {
             state.activeTabId = newTabId;
             saveState();
        }

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (event.relatedTarget.id !== newTabId) { // Check if the target is different from the previous one
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
            Promise.resolve(loadTabContent(newTabId)).then(() => {
                // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                if (newTabId === 'gradebook-tab' || newTabId === 'attendance-tab') {
                    const selectorId = newTabId === 'gradebook-tab' ? 'classroom-selector' : 'attendance-classroom-selector';
                    const selector = document.getElementById(selectorId);

                    if (selector && state.activeClassroomId && [...selector.options].some(opt => opt.value === state.activeClassroomId)) {
                        if (selector.value !== state.activeClassroomId) {
                            selector.value = state.activeClassroomId;
                            selector.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });
        }
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô if ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        // ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Render ‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞ Filter ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    document.addEventListener('shown.bs.tab', function(event) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ó‡πá‡∏ö "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (event.target.getAttribute('href') === '#assessment-content') {
            console.log('Assessment tab shown, calling update functions.');
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            loadRatioTarget().then(updateSummaryPanel);
        }
        
        // [FIXED] ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á Gradebook ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (event.target.getAttribute('href') === '#gradebook-content') {
            console.log('Gradebook tab shown, applying unit filter.');
            if (state.activeUnitId) {
                 filterGradebookColumns(state.activeUnitId);
                 setActiveUnitFilter(state.activeUnitId); // Ensure sidebar is highlighted
            }
        }
    });    

    workspaceTabsContent.addEventListener('click', (e) => {
        // ... (workspaceTabsContent click logic remains the same) ...
        const deleteItemBtn = e.target.closest('.delete-graded-item-btn');
        if (deleteItemBtn) handleGradedItemDelete(deleteItemBtn.dataset.itemId);
        
        const selectTopicsBtn = e.target.closest('.select-topics-btn');
        if (selectTopicsBtn) openTopicSelectionModal(selectTopicsBtn);

        const addSubUnitBtn = e.target.closest('#add-subunit-btn');
        if(addSubUnitBtn) handleAddSubUnit(addSubUnitBtn);

        const editSubUnitBtn = e.target.closest('.edit-subunit-btn');
        if(editSubUnitBtn) handleEditSubUnit(editSubUnitBtn);
        
        const deleteSubUnitBtn = e.target.closest('.delete-subunit-btn');
        if(deleteSubUnitBtn) handleDeleteSubUnit(deleteSubUnitBtn);
    });

    workspaceTabsContent.addEventListener('change', function(event) {
        const target = event.target;
        // --- GRADEBOOK SUMMARY TAB: Classroom Selector Change ---
        if (target && target.id === 'classroom-selector') {
            const selector = target;
            const selectedOption = selector.options[selector.selectedIndex];
            const classroomId = selector.value;
            const courseId = selectedOption.dataset.courseId;
            const manageGroupsBtn = document.getElementById('manage-groups-btn-workspace'); // ‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

            state.activeClassroomId = classroomId;
            saveState();

            if (classroomId && courseId) {
                if(manageGroupsBtn) manageGroupsBtn.disabled = false;
                // *** THE CRITICAL FIX IS HERE ***
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
                fetchAndRenderGradebookTable(selector); // Call the main gradebook render
            } else {
                if(manageGroupsBtn) manageGroupsBtn.disabled = true;
                const container = document.getElementById('gradebook-container');
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }
        // --- Gradebook Table: Exam/Score Inputs Change (Handled by input event and debounce in setupGradebookEventListeners) ---
    });

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ---
    workspaceTabsContent.addEventListener('input', e => {
        // ... (workspaceTabsContent input event logic remains the same) ...
        if (e.target.classList.contains('learning-unit-hours-input')) {
            const unitId = e.target.dataset.unitId;
            const periods = parseInt(e.target.value, 10) || 0;

            // Update our central data store
            unitHoursData[unitId] = periods;

            // Recalculate for all units
            updateCumulativePeriods();

            // Debounced save logic (no changes here)
            clearTimeout(hourSaveDebounce);
            hourSaveDebounce = setTimeout(() => {
                fetch(`/teacher/api/units/${unitId}/hours`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            hours: periods
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else {
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error');
                        }
                    });
            }, 200);
        }
    });

    // This button might be loaded dynamically, so we handle it via delegation on a static parent
    document.body.addEventListener('click', function(event) {
        // ... (submit-for-review-btn logic remains the same) ...
        // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Å‡πá‡∏ï‡∏≤‡∏°
        if (event.target.id === 'submit-for-review-btn') {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô?',
                text: "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{{ url_for('teacher.submit_plan_for_review', plan_id=plan.id) }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', data.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                    });
                }
            });
        }
    });

    // Add listeners for forms and modals that are always in the DOM
    document.getElementById('unit-form').addEventListener('submit', handleUnitCreate);
    document.getElementById('subUnitEditForm').addEventListener('submit', handleSubUnitFormSubmit);
    document.getElementById('planSettingsModal')?.addEventListener('show.bs.modal', initializeRoomSelector);
    document.querySelectorAll('#unitList a').forEach(link => {
        unitHoursData[link.dataset.unitId] = 0;
    });

    // 4. Unit Creation Form
    document.getElementById('unitFormModal').addEventListener('show.bs.modal', (event) => {
        // ... (unitFormModal show.bs.modal logic remains the same) ...
        const button = event.relatedTarget;
        if (button && button.dataset.bsAction === 'add') {
            const modal = event.currentTarget;
            modal.querySelector('.modal-title').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà';
            modal.querySelector('form').reset();
            modal.querySelector('#modal-unit-id').value = '';
        }
    });

    document.getElementById('groupManagementModal').addEventListener('click', async (e) => {
        // ... (groupManagementModal click logic remains the same) ...
        const target = e.target;
        const groupsContainer = document.getElementById('groups-container');

        // üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
        if (target.closest('#save-groups-btn')) {
            saveGroups();
        }

        // ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        else if (target.closest('#add-new-group-btn')) {
            const groupHtml = createGroupCard(
                { id: `new-${Date.now()}`, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${groupsContainer.children.length + 1}` },
                ''
            );
            groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
            initializeAllSortables();
        }

        // üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
        else if (target.closest('.delete-group-btn')) {
            const card = target.closest('.group-card');
            if (card) {
                card.querySelectorAll('.list-group-item')
                    .forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                card.remove();
            }
        }

        // ü§ñ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        else if (target.closest('#auto-generate-groups-btn')) {
            const { value: numGroups } = await Swal.fire({
                target: document.getElementById('groupManagementModal'),
                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                input: 'number',
                inputLabel: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°?',
                inputPlaceholder: '‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°',
                showCancelButton: true,
                confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    if (!value || value < 1) {
                        return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
                    }
                }
            });

            if (numGroups) {
                // ‡∏î‡∏∂‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                const students = Array.from(
                    document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]')
                );

                // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                for (let i = students.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [students[i], students[j]] = [students[j], students[i]];
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                groupsContainer.innerHTML = '';
                const newGroupElements = [];
                for (let i = 1; i <= numGroups; i++) {
                    const groupId = `new-${Date.now()}-${i}`;
                    groupsContainer.insertAdjacentHTML(
                        'beforeend',
                        createGroupCard({ id: groupId, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${i}` }, '')
                    );
                    newGroupElements.push(groupsContainer.querySelector(
                        `[data-group-id="${groupId}"] .group-dropzone`
                    ));
                }

                // ‡πÅ‡∏à‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                if (newGroupElements.length > 0) {
                    students.forEach((studentNode, index) => {
                        newGroupElements[index % numGroups].appendChild(studentNode);
                    });
                }

                initializeAllSortables();
            }
        }
    });

// -------------------------------------------
    // 7. INITIALIZATION ON PAGE LOAD (REVISED v2 - Fix ReferenceError)
    // -------------------------------------------
    function initializeWorkspace() {
        console.log("Initializing workspace...");
        // Step 1: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ State ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        restoreState();
        console.log("Restored state:", state);

        // Step 2: ‡∏´‡∏≤ Tab Button ‡πÅ‡∏•‡∏∞ Content Pane ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞ Active
        const activeTabButtonId = state.activeTabId || 'plan-tab';
        // --- [FIX] Declare activeTabEl and targetPaneEl *before* the if/else block ---
        let activeTabEl = null;
        let targetPaneEl = null;

        activeTabEl = document.getElementById(activeTabButtonId); // Try to get the element based on saved state

        if (activeTabEl && activeTabEl.dataset.bsTarget) {
            targetPaneEl = document.querySelector(activeTabEl.dataset.bsTarget);
        } else {
             // Fallback: If the saved tab ID doesn't exist, use the first tab
             console.log(`Tab ID '${activeTabButtonId}' not found or invalid, falling back to first tab.`);
             const firstTabButton = document.querySelector('#workspaceTabs .nav-link');
             if (firstTabButton && firstTabButton.dataset.bsTarget) {
                  activeTabEl = firstTabButton; // Assign the fallback tab button
                  targetPaneEl = document.querySelector(firstTabButton.dataset.bsTarget);
                  state.activeTabId = activeTabEl.id; // Update state with the fallback tab ID
                  saveState();
             }
        }
        console.log("Initial Active Tab Button:", activeTabEl);
        console.log("Initial Target Pane:", targetPaneEl);

        // Step 3: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡πÉ‡∏´‡πâ Tab Button ‡πÅ‡∏•‡∏∞ Pane ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£ Active
        document.querySelectorAll('#workspaceTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#workspaceTabsContent .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        if (activeTabEl) {
             activeTabEl.classList.add('active');
             activeTabEl.setAttribute('aria-selected', 'true');
        }
        if (targetPaneEl) {
             targetPaneEl.classList.add('show', 'active');
             console.log("Set pane to active:", targetPaneEl.id);
        } else {
             console.warn("Could not find target pane to make active initially.");
             const initialMsg = document.getElementById('initial-message');
             if(initialMsg) initialMsg.style.display = 'block';
        }

        // Step 4: ‡∏´‡∏≤ Unit ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î
        let unitLinkToLoad = unitList.querySelector(`a[data-unit-id="${state.activeUnitId}"]`);
        if (!unitLinkToLoad) {
            const firstUnitLink = unitList.querySelector('a.list-group-item');
            if (firstUnitLink) {
                unitLinkToLoad = firstUnitLink;
                state.activeUnitId = firstUnitLink.dataset.unitId;
                // No need to saveState() here, setActiveUnit will do it if needed
            }
        }
        console.log("Unit to load:", unitLinkToLoad ? unitLinkToLoad.dataset.unitId : "None");

        // Step 5: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Unit, ‡πÉ‡∏´‡πâ setActiveUnit ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞ active ‡πÄ‡∏™‡∏°‡∏≠
        // ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å setActiveUnit(unitId) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadTabContent
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (‡πÇ‡∏´‡∏•‡∏î unit ‡∏Å‡πà‡∏≠‡∏ô, ‡πÇ‡∏´‡∏•‡∏î tab ‡∏ã‡πâ‡∏≥)
        
        if (unitLinkToLoad) {
            // Highlight the unit immediately
            unitLinkToLoad.classList.add('active');
        }

        console.log("Explicitly loading content for tab:", state.activeTabId);
        loadTabContent(state.activeTabId).then(() => {
            // After tab content loaded, if it's unit dependent, ensure active unit is set
            if (unitLinkToLoad && isUnitDependentTab(state.activeTabId)) {
                // This ensures the content is loaded, and a secondary check updates state/filter if needed
                setActiveUnit(unitLinkToLoad.dataset.unitId); 
            }
        });
    }

    // --- FINAL INITIALIZATION CALL ---
    // Ensure all other functions are defined above this point
    initializeWorkspace();
    
});
</script>
{% endblock %}