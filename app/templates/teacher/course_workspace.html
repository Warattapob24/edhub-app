{% extends "base.html" %}
{% block title %}EdHub {{ title }}{% endblock %}

{% block sidebar %}
    {# หมายเหตุ: แก้ไขจาก 'academic/_sidebar.html' เป็น 'teacher/_sidebar.html' เพื่อให้สอดคล้องกับโครงสร้างปัจจุบัน #}
    {% include 'teacher/_sidebar.html' %}
{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<style>
    .ts-control .item {
        background-color: #0d6efd;
        color: white;
    }

    #workspaceTabsContent {
        transition: opacity 0.15s ease-in-out;
    }

    #workspaceTabsContent.loading {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Style for the new unit filter */
    #unit-filter-list .list-group-item i {
        vertical-align: middle;
        margin-top: -2px;
    }

    #ungrouped-students-list {
        position: -webkit-sticky;
        /* For Safari browser compatibility */
        position: sticky;
        top: 1rem;
        /* ระยะห่างจากขอบบนเมื่อเริ่มเลื่อนจอ */
    }
    .bg-danger-soft {
        background-color: rgba(220, 53, 69, 0.2) !important;
    }
    .bg-warning-soft {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }    
</style>
{% endblock %}


{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('teacher.dashboard') }}">หน้าหลักครู</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ plan.subject.name }}</li>
            </ol>
        </nav>
        <h2 class="bi bi-journals me-2"> {{ title }} <small>จำนวน {{ "%.1f"|format(plan.subject.credit) }} หน่วยกิต</small></h2>
    <div class="btn-group ms-2">
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#planSettingsModal">
        <i class="bi bi-gear-fill"></i> ตั้งค่าภาพรวมและเงื่อนไข
    </button>

        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-download"></i> Export แผนทั้งหมด
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="{{ url_for('teacher.export_lesson_plan_pdf', plan_id=plan.id) }}" target="_blank">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>Export PDF
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{{ url_for('teacher.export_lesson_plan_docx', plan_id=plan.id) }}">
                    <i class="bi bi-file-earmark-word text-primary me-2"></i>Export Word
                </a>
            </li>
        </ul>
    </div>    
</div>
</div>
{% if plan.status == 'ต้องการการแก้ไข' and plan.revision_notes %}
<div class="alert alert-danger" role="alert">
    <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>ข้อเสนอแนะจากผู้ตรวจสอบ</h4>
    <p style="white-space: pre-wrap;">{{ plan.revision_notes }}</p>
    <hr>
    <p class="mb-0">กรุณาแก้ไขแผนการสอนตามข้อเสนอแนะและทำการ "ส่งเพื่อรับการตรวจสอบ" อีกครั้ง</p>
</div>

{% elif plan.status == 'รอการตรวจสอบ' %}
<div class="alert alert-info" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i><strong>สถานะ: รอการตรวจสอบ</strong> แผนการสอนนี้ถูกส่งไปให้หัวหน้ากลุ่มสาระฯ เรียบร้อยแล้ว และไม่สามารถแก้ไขได้ในขณะนี้
</div>
{% endif %}

<div class="row g-4">
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-collection-fill"></i> หน่วยการเรียนรู้</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#unitFormModal" data-bs-action="add">
                    <i class="bi bi-plus-lg"></i> เพิ่มหน่วย
                </button>
            </div>
            <div class="list-group list-group-flush" id="unitList" data-create-unit-url="{{ url_for('teacher.create_learning_unit', plan_id=plan.id) }}" data-plan-id="{{ plan.id }}" data-add-indicator-url="{{ url_for('teacher.add_custom_indicator') }}" data-groups-url="{{ url_for('teacher.manage_student_groups', plan_id=plan.id) }}">
                {% for unit in units %}
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-unit-id="{{ unit.id }}" data-delete-url="{{ url_for('teacher.delete_learning_unit', unit_id=unit.id) }}">
                    <span class="unit-title">{{ unit.title }}</span>
                    <button class="btn btn-sm btn-outline-danger delete-unit-btn border-0" title="ลบหน่วยการเรียนรู้"><i class="bi bi-trash"></i></button>
                </a>
                {% else %}
                <div id="no-units-placeholder" class="list-group-item text-muted text-center">ยังไม่มีหน่วยการเรียนรู้</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="workspaceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-content" type="button" role="tab">1. แผนการจัดการเรียนรู้</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment-content" type="button" role="tab">2. ตั้งค่าการประเมิน</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="gradebook-tab" data-bs-toggle="tab" data-bs-target="#gradebook-content" type="button" role="tab">3. ตารางบันทึกผล</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab">4. บันทึกเวลาเรียน</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reflection-tab" data-bs-toggle="tab" data-bs-target="#reflection-content" type="button" role="tab">5. บันทึกหลังสอน</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="workspaceTabsContent">
                    <div id="initial-message" class="text-center text-muted py-5">
                        <h4><i class="bi bi-arrow-left-circle"></i> กรุณาเลือกหน่วยการเรียนรู้</h4>
                        <p>เลือกหน่วยการเรียนรู้จากเมนูด้านซ้ายเพื่อเริ่มทำงาน</p>
                    </div>
                    <div class="tab-pane fade" id="plan-content" role="tabpanel" aria-labelledby="plan-tab"></div>
                    <div class="tab-pane fade" id="assessment-content" role="tabpanel" aria-labelledby="assessment-tab"></div>
                    <div class="tab-pane fade" id="gradebook-content" role="tabpanel" aria-labelledby="gradebook-tab"></div>
                    <div class="tab-pane fade" id="attendance-content" role="tabpanel" aria-labelledby="attendance-tab"></div>
                    <div class="tab-pane fade" id="reflection-content" role="tabpanel" aria-labelledby="reflection-tab"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<template id="gradebook-template">
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="gradebook-table">
            <thead class="table-light"></thead>
            <tbody id="gradebook-body"></tbody>
        </table>
    </div>
</template>
<div class="modal fade" id="unitFormModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unit-modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="unit-form">
                <div class="modal-body">
                    <input type="hidden" id="modal-unit-id" name="unit_id">
                    <div class="mb-3">
                        <label for="unit-title-input" class="form-label">ชื่อหน่วยการเรียนรู้</label>
                        <input type="text" class="form-control" id="unit-title-input" name="title" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="submit" class="btn btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="selectTopicsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectTopicsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="selectTopicsModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" id="saveTopicSelectionBtn">บันทึกการเลือก</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="subUnitEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">แก้ไขแผนการสอนรายชั่วโมง</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="subUnitEditForm">
                <div class="modal-body">
                    <input type="hidden" id="modal-subunit-id">
                    <div class="mb-3">
                        <label for="modal-subunit-title" class="form-label">ชื่อหัวข้อ/กิจกรรม</label>
                        <input type="text" class="form-control" id="modal-subunit-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-activities" class="form-label">กิจกรรมการเรียนรู้</label>
                        <textarea class="form-control" id="modal-subunit-activities" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-indicators" class="form-label">ตัวชี้วัดที่เกี่ยวข้อง</label>
                        <select id="modal-subunit-indicators" multiple></select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-subunit-graded-items" class="form-label">รายการคะแนนเก็บที่ใช้</label>
                        <select id="modal-subunit-graded-items" multiple></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="groupManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">จัดการกลุ่มนักเรียน</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="group-manager-loader">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    กำลังโหลดข้อมูล...
                </div>
                <div class="row" id="group-manager-content">
                    <div class="col-md-4">
                        <h6>นักเรียนที่ยังไม่มีกลุ่ม</h6>
                        <div id="ungrouped-students-list" class="list-group vh-75 overflow-auto border p-2" data-group-id="null">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>กลุ่มในห้องเรียนนี้</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="auto-generate-groups-btn">สร้างกลุ่มอัตโนมัติ</button>
                                <button class="btn btn-sm btn-primary" id="add-new-group-btn"><i class="bi bi-plus-circle"></i> สร้างกลุ่มใหม่</button>
                            </div>
                        </div>
                        <div id="groups-container" class="vh-75 overflow-auto">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" id="save-groups-btn">บันทึกการจัดกลุ่ม</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="planSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ตั้งค่าภาพรวมและเงื่อนไขตารางสอน</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">ข้อมูลในส่วนนี้จะถูกใช้เป็นเงื่อนไขเบื้องต้นสำหรับระบบจัดตารางสอนอัตโนมัติ</p>
                <hr>
                <div class="mb-3">
                    <label class="form-label"><strong>จำนวนคาบต่อสัปดาห์:</strong></label>
                    <p class="fs-5 fw-bold text-primary">{{ (plan.subject.credit * 2)|round|int }} คาบ / สัปดาห์</p>
                </div>
                <div class="mb-3">
                    <label for="constraint_arrangement" class="form-label"><strong>รูปแบบการจัดคาบ (Arrangement)</strong></label>
                    <select id="constraint_arrangement" class="form-select">
                        <option value="separate" {% if not constraints.get('period_arrangement') or constraints.get('period_arrangement') == 'separate' %}selected{% endif %}>สอนแบบคาบเดี่ยว (แยกวัน)</option>
                        <option value="consecutive" {% if constraints.get('period_arrangement') == 'consecutive' %}selected{% endif %}>สอนแบบคาบคู่ (ต่อเนื่อง)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="constraint_preference" class="form-label"><strong>ธรรมชาติของวิชา</strong></label>
                    <select id="constraint_preference" class="form-select">
                        <option value="any" {% if not constraints.get('time_preference') or constraints.get('time_preference') == 'any' %}selected{% endif %}>ไม่มีเงื่อนไขพิเศษ</option>
                        <option value="morning" {% if constraints.get('time_preference') == 'morning' %}selected{% endif %}>เน้นความคิด/คำนวณ (แนะนำช่วงเช้า)</option>
                        <option value="afternoon" {% if constraints.get('time_preference') == 'afternoon' %}selected{% endif %}>เน้นปฏิบัติ/กิจกรรม (แนะนำช่วงบ่าย)</option>
                    </select>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="room-select" class="form-label"><strong>ห้องเรียน/สถานที่ (Room/Location)</strong></label>
                    <select id="room-select" placeholder="ค้นหาหรือพิมพ์เพื่อสร้างห้องใหม่..."></select>
                </div>
                <hr>
                <div>
                    <label for="manual-notes" class="form-label"><strong>บันทึกส่วนตัว (สำหรับผู้จัดตารางสอน)</strong></label>
                    <textarea id="manual-notes" class="form-control" rows="3" placeholder="เช่น 'วิชานี้ต้องสอนวันศุกร์เท่านั้น', 'ขอห้องที่มีโปรเจคเตอร์' ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <span id="settings-save-status" class="me-auto text-muted small"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                <button type="button" class="btn btn-primary" id="savePlanSettingsBtn">บันทึกการตั้งค่า</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// =================================================================
//  EDHUB: COURSE WORKSPACE SCRIPT (VERSION 3.0 - RE-ARCHITECTED)
// =================================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log("ชุดคำสั่งหลัก course_workspace.html เริ่มทำงาน");

    // -------------------------------------------
    // 1. CORE STATE & SETUP
    // -------------------------------------------
    const unitList = document.getElementById('unitList');
    const workspaceTabs = document.getElementById('workspaceTabs');
    const workspaceTabsContent = document.getElementById('workspaceTabsContent');
    const planId = unitList.dataset.planId;
    const addIndicatorUrl = unitList.dataset.addIndicatorUrl;
    const csrfToken = '{{ csrf_token() }}';

    let state = {
        activeUnitId: null,
        activeUnitIndex: null,
        activeTabId: 'plan-tab', // Default to the first tab
        activeClassroomId: null
    };

    // Modals
    const subUnitEditModal = new bootstrap.Modal(document.getElementById('subUnitEditModal'));
    const unitFormModal = new bootstrap.Modal(document.getElementById('unitFormModal'));
    const selectionModal = new bootstrap.Modal(document.getElementById('selectTopicsModal'));
    const groupModal = new bootstrap.Modal(document.getElementById('groupManagementModal'));

    // TomSelect instances
    let tomSelect = null;
    let subUnitIndicatorsTomSelect = null;
    let subUnitGradedItemsTomSelect = null;
    let roomTomSelect = null;

    // Other variables
    let hourSaveDebounce, debounceTimeout, reflectionSaveDebounce;
    let targetMidRatio = 80, targetFinalRatio = 20, isTargetSetByUser = false;
    let unitHoursData = {};
    let allEnrollments = [], sortableInstances = [];

    // -------------------------------------------
    // 2. STATE PERSISTENCE
    // -------------------------------------------
    function saveState() {
        try {
            localStorage.setItem(`workspaceState-${planId}`, JSON.stringify(state));
        } catch (e) {
            console.error("Could not save state to localStorage:", e);
        }
    }

    function restoreState() {
        try {
            const savedState = JSON.parse(localStorage.getItem(`workspaceState-${planId}`));
            if (savedState) {
                state = savedState;
            }
            if (state.activeUnitId) {
                const unitLink = unitList.querySelector(`a[data-unit-id="${state.activeUnitId}"]`);
                if (unitLink) unitLink.classList.add('active');
            }
        } catch (e) {
            console.error("Could not restore state from localStorage:", e);
        }
    }

    // -------------------------------------------
    // 3. CORE LOGIC & DYNAMIC CONTENT LOADING
    // -------------------------------------------
    function isUnitDependentTab(tabId) {
        return !['attendance-tab', 'gradebook-tab'].includes(tabId);
    }

    function setActiveUnit(unitId) {
        if (!unitId || unitId === state.activeUnitId) return;

        // 1. อัปเดต State หลักทันทีที่ผู้ใช้เลือกหน่วย
        state.activeUnitId = unitId;
        saveState();

        // 2. อัปเดต UI ของ Sidebar ให้แสดงผลว่าหน่วยไหนถูกเลือก
        document.querySelectorAll('#unitList a').forEach(a => {
            a.classList.toggle('active', a.dataset.unitId === unitId);
        });

        // 3. ตรวจสอบว่าแท็บปัจจุบันต้องใช้ข้อมูลหน่วยหรือไม่
        if (isUnitDependentTab(state.activeTabId)) {
            // ถ้าใช่, โหลดเนื้อหาของแท็บนั้นใหม่สำหรับหน่วยที่เพิ่งเลือก
            loadTabContent(state.activeTabId);
        } else if (state.activeTabId === 'gradebook-tab') {
            // ✅ [CRITICAL FIX] ถ้ากำลังดูตารางคะแนนอยู่ ให้กรองคอลัมน์ทันที
            // ไม่ต้องโหลดข้อมูลใหม่ทั้งหมด แค่ซ่อน/แสดงคอลัมน์ให้ตรงกับหน่วยที่เลือก
            filterGradebookColumns(unitId);
            setActiveUnitFilter(unitId); // ทำให้ปุ่ม filter ด้านบน (ถ้ามี) แสดงผลตรงกัน
        }
    }

    async function loadTabContent(tabId) {
        const paneId = document.getElementById(tabId)?.dataset.bsTarget.substring(1);
        if (!paneId) return;

        const targetPane = document.getElementById(paneId);
        if (isUnitDependentTab(tabId) && !state.activeUnitId) {
            const firstUnitLink = unitList.querySelector('a.list-group-item');
            if (firstUnitLink) {
                return setActiveUnit(firstUnitLink.dataset.unitId);
            }
            targetPane.innerHTML = `<div class="text-center text-muted py-5"><h4><i class="bi bi-collection"></i> กรุณาสร้างหน่วยการเรียนรู้ก่อน</h4></div>`;
            return;
        }

        const tabEndpoints = {
            'plan-tab':       `/teacher/api/units/${state.activeUnitId}/plan`,
            'assessment-tab': `/teacher/api/units/${state.activeUnitId}/assessment-setup`,
            'gradebook-tab':  `/teacher/api/plan/${planId}/gradebook-ui`,
            'attendance-tab': `/teacher/api/plan/${planId}/attendance-overview`,
            'reflection-tab': `/teacher/api/units/${state.activeUnitId}/reflection-tab`
        };

        const apiUrl = tabEndpoints[tabId];
        if (!targetPane || !apiUrl) return;

        document.getElementById('initial-message')?.remove();
        workspaceTabsContent.classList.add('loading');

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            targetPane.innerHTML = await response.text();

            const initializers = {
                'plan-tab':       () => initializeLessonPlanTab(state.activeUnitId),
                'assessment-tab': initializeAssessmentSetupTab,
                'gradebook-tab':  initializeGradebookTab,
                'attendance-tab': initializeAttendanceTab,
                'reflection-tab': initializeReflectionTab
            };
            if (initializers[tabId]) initializers[tabId]();

        } catch (error) {
            targetPane.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            workspaceTabsContent.classList.remove('loading');
        }
    }

    // -------------------------------------------
    // 4. TAB-SPECIFIC INITIALIZERS & LOGIC
    // -------------------------------------------

    // --- 4.1. Lesson Plan Tab ---    
    function initializeLessonPlanTab(unitId) {
        const hoursInput = workspaceTabsContent.querySelector('.learning-unit-hours-input');
        if (hoursInput) {
            // Update the central data store with the value loaded from the server
            unitHoursData[unitId] = parseInt(hoursInput.value, 10) || 0;
        }
        updateCumulativePeriods();

        const planForm = document.getElementById('lessonPlanForm');
        if (planForm) {
            planForm.action = `/teacher/api/units/${unitId}/plan/save`;
            planForm.method = 'POST';
            planForm.addEventListener('submit', handlePlanFormSubmit);
        }

        const selector = document.getElementById('indicator-selector');
        if (!selector) return;

        const initialOptionsJSON = selector.dataset.initialOptions || '[]';
        const initialOptions = JSON.parse(initialOptionsJSON);
        const initialItemIds = initialOptions.map(opt => opt.id);

        if (tomSelect) {
            tomSelect.destroy();
        }

        tomSelect = new TomSelect(selector, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            options: initialOptions,
            items: initialItemIds,
            create: function(input, callback) {
                console.log("create function triggered with input:", input); // Debug log

                Swal.fire({
                    title: 'สร้างตัวชี้วัดใหม่',
                    html: `
                        <input id="swal-indicator-code" class="swal2-input" placeholder="รหัสตัวชี้วัด (เช่น ม.3/9)">
                        <textarea id="swal-indicator-desc" class="swal2-textarea" placeholder="รายละเอียดตัวชี้วัด">${input}</textarea>
                    `,
                    confirmButtonText: 'บันทึก',
                    showCancelButton: true,
                    cancelButtonText: 'ยกเลิก',
                    focusConfirm: false,
                    preConfirm: () => {
                        const code = Swal.getPopup().querySelector('#swal-indicator-code').value;
                        const desc = Swal.getPopup().querySelector('#swal-indicator-desc').value;
                        if (!code || !desc) {
                            Swal.showValidationMessage(`กรุณากรอกข้อมูลให้ครบถ้วน`);
                        }
                        return {
                            code: code,
                            description: desc
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(addIndicatorUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({ ...result.value,
                                    plan_id: planId
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log("API response:", data);
                                if (data.status === 'success' && data.indicator && data.indicator.id) {
                                    // On success, pass the complete new option object to the callback
                                    callback(data.indicator);
                                } else {
                                    Swal.fire('เกิดข้อผิดพลาด!', data.message || 'ไม่สามารถสร้างตัวชี้วัดได้', 'error');
                                    // On failure, call callback without arguments to cancel creation
                                    callback();
                                }
                            });
                    } else {
                        // If user cancels the Swal modal, cancel the creation
                        callback();
                    }
                });
            },
            load: function(query, callback) {
                if (query.length < 2) return callback();
                fetch(`{{ url_for("teacher.search_indicators") }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(callback)
                    .catch(() => callback());
            },
            createFilter: input => input.length >= 3,
            render: {
                item: function(data, escape) {
                    return `<div>[${escape(data.standard_code || '')}] ${escape(data.indicator_code || '')}</div>`;
                },
                option: (data, escape) => `<div><strong>${escape(data.standard_code)} ${escape(data.indicator_code)}</strong>: <span class="text-muted">${escape(data.indicator_desc)}</span></div>`,
                option_create: (data, escape) => `<div class="create">เพิ่มตัวชี้วัดใหม่: <strong>${escape(data.input)}</strong>&hellip;</div>`,
            },
            onInitialize: function() {
                renderSelectedIndicators(this);
            },
            onItemAdd: function() {
                this.setTextboxValue('');
                this.blur();
                renderSelectedIndicators(this);
            },
            onItemRemove: function() {
                renderSelectedIndicators(this);
            },
        });

        const saveDraftBtn = document.getElementById('save-draft-btn');
        if (saveDraftBtn && planForm) {
            saveDraftBtn.addEventListener('click', function() {
                const data = {
                    indicators: tomSelect ? tomSelect.getValue() : [],
                    core_concepts: planForm.querySelector('#core_concepts').value,
                    learning_objectives: planForm.querySelector('#learning_objectives').value,
                    learning_content: planForm.querySelector('#learning_content').value,
                    learning_activities: planForm.querySelector('#learning_activities').value,
                    media_resources: planForm.querySelector('#media_resources').value,
                    hours: planForm.querySelector('#hours').value
                };

                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...';
                this.disabled = true;

                fetch(planForm.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'บันทึกฉบับร่างเรียบร้อย',
                                showConfirmButton: false,
                                timer: 2000
                            });
                        } else {
                            Swal.fire('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกได้', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        Swal.fire('ผิดพลาด!', 'การเชื่อมต่อล้มเหลว', 'error');
                    })
                    .finally(() => {
                        this.innerHTML = '<i class="bi bi-save-fill"></i> บันทึกฉบับร่าง';
                        this.disabled = false;
                    });
            });
        }
    }

    // --- 4.2. Assessment Setup Tab ---
    function initializeAssessmentSetupTab() {
        const assessmentContent = document.getElementById('assessment-content');
        if (!assessmentContent) {
             console.error("CRITICAL: Could not find #assessment-content element during initialization.");
             return; // Exit if the main container isn't found
        }
        console.log("Found assessmentContent during init:", assessmentContent); // Verify it's found

        // ... (โค้ดเดิมเกี่ยวกับการจัดการ Accordion, Modal, Ratio) ...

        loadRatioTarget().then(() => {
            // Call updateSummaryPanel *after* loadRatioTarget finishes
            updateSummaryPanel(); // Ensure summary updates after ratio is loaded
        });

        // --- [REVISED] Attach event listeners with extra check ---
        // Ensure assessmentContent still exists before adding listeners
        if (assessmentContent) {
            console.log("Attaching event listeners to assessmentContent...");
            assessmentContent.addEventListener('change', function(event) {
                if (event.target.matches('.exam-score-switch') || event.target.matches('.exam-score-input')) {
                    handleExamScoreChange(event);
                }
            });
            assessmentContent.addEventListener('input', function(event) {
                 if (event.target.matches('.exam-score-input')) {
                     // Update summary immediately on input
                     updateSummaryPanel();
                     // handleExamScoreChange will be called on 'change' for saving
                 }
            });
        } else {
             console.error("CRITICAL: assessmentContent became null before attaching listeners.");
        }
        // --- [END REVISED] ---

        // ทำให้แน่ใจว่าค่าเริ่มต้นของ input ถูกต้องตาม switch ตอนโหลดครั้งแรก
        assessmentContent.querySelectorAll('.accordion-collapse').forEach(unitContainer => {
            // ... (โค้ดส่วนนี้เหมือนเดิม) ...
             const unitId = unitContainer.id.replace('collapse-unit-', '');
             const midtermSwitch = unitContainer.querySelector('#midterm-switch-' + unitId);
             const finalSwitch = unitContainer.querySelector('#final-switch-' + unitId);
             const midtermInput = unitContainer.querySelector('.exam-score-input[data-exam-type="midterm"]');
             const finalInput = unitContainer.querySelector('.exam-score-input[data-exam-type="final"]');

             if (midtermSwitch && midtermInput) {
                 midtermInput.disabled = !midtermSwitch.checked;
             }
             if (finalSwitch && finalInput) {
                 finalInput.disabled = !finalSwitch.checked;
             }
        });
        // คำนวณ Summary Panel ครั้งแรก (ย้ายไปอยู่ใน .then() ของ loadRatioTarget)
        // updateSummaryPanel(); // Moved up
        setupGradedItemModal();
    } // สิ้นสุดฟังก์ชัน initializeAssessmentSetupTab

    // --- 4.3. Gradebook Tab (The *CORRECT* one) ---
    function initializeGradebookTab() {
        const classroomSelector = document.getElementById('classroom-selector');
        const manageGroupsBtn = document.getElementById('manage-groups-btn-workspace');
        const container = document.getElementById('gradebook-container');

        if (!classroomSelector) return;

        // เพิ่ม "ยาม" คอยตรวจสอบ: ถ้าเคยติดตั้ง Event Listener ไปแล้ว ให้หยุดทำงานทันที
        // เพื่อป้องกันการผูก Event ซ้ำซ้อน
        if (classroomSelector.dataset.eventsBound) {
            console.log("Event listeners for gradebook already bound. Skipping.");
            return;
        }
        // ถ้ายังไม่เคยติดตั้ง ให้ติดป้ายกำกับไว้ว่า "ติดตั้งแล้ว"
        classroomSelector.dataset.eventsBound = 'true';        

        if (manageGroupsBtn) {
            manageGroupsBtn.onclick = function() {
                openGroupManager();
            };
        }

        /**
         * 🎯 [CORE LOGIC] ฟังก์ชันนี้จะทำงานทุกครั้งที่มีการเปลี่ยนห้องเรียน
         */
        const handleClassroomChange = () => {
            const newClassroomId = classroomSelector.value;
            
            // 1. อัปเดต state ของห้องเรียนที่เลือก และบันทึกลง localStorage
            //    เพื่อให้จำห้องเรียนล่าสุดไว้ได้เมื่อกลับมาที่หน้านี้อีกครั้ง
            if (state.activeClassroomId !== newClassroomId) {
                state.activeClassroomId = newClassroomId;
                saveState();
            }

            if (manageGroupsBtn) {
                manageGroupsBtn.disabled = !newClassroomId;
            }

            // 2. ถ้ามีการเลือกห้องเรียน ให้เรียกโหลดตารางคะแนน
            if (newClassroomId) {
                // โดยจะส่ง "state.activeUnitId" (หน่วยที่เลือกไว้ล่าสุดจาก Sidebar)
                // ไปให้ฟังก์ชัน fetchAndRenderGradebookTable ด้วยเสมอ
                fetchAndRenderGradebookTable(classroomSelector, state.activeUnitId);
            } else {
                // ถ้าไม่ได้เลือกห้องเรียน ให้แสดงข้อความว่าง
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</div>';
            }
        };

        // 3. ผูก Event Listener เข้ากับ Dropdown เลือกห้องเรียน
        classroomSelector.addEventListener('change', handleClassroomChange);

        // 4. [INITIALIZATION] คืนค่าห้องเรียนที่เคยเลือกไว้ตอนโหลดหน้าครั้งแรก
        if (state.activeClassroomId && [...classroomSelector.options].some(opt => opt.value === state.activeClassroomId)) {
            classroomSelector.value = state.activeClassroomId;
        } else if (classroomSelector.options.length > 1) {
            // ถ้าไม่เคยเลือกมาก่อน ให้เลือกห้องเรียนแรกในลิสต์ (ที่ไม่ใช่ "กรุณาเลือก...")
            classroomSelector.value = classroomSelector.options[1].value;
        }

        // 5. [INITIALIZATION] สั่งให้ฟังก์ชันทำงานครั้งแรกเพื่อโหลดข้อมูลเริ่มต้น
        handleClassroomChange();
    }

    // --- 4.4. Attendance Tab ---
    function initializeAttendanceTab() {
        const classroomSelector = document.getElementById('attendance-classroom-selector');
        const container = document.getElementById('attendance-overview-container');

        if (!classroomSelector) return;

        // **LOGIC ใหม่: ฟังก์ชันสำหรับจัดการการเปลี่ยนแปลง**
        const handleClassroomChange = async () => {
            const newClassroomId = classroomSelector.value;
            if (state.activeClassroomId !== newClassroomId) {
                state.activeClassroomId = newClassroomId;
                saveState(); // <-- บันทึก State ทันทีที่เปลี่ยน
            }

            if (!newClassroomId) {
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">กรุณาเลือกห้องเรียน</div>';
                return;
            }

            if(container) container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';

            try {
                const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
                const response = await fetch(`/teacher/api/course/${courseId}/attendance-data?classroom_id=${newClassroomId}`);
                
                // --- START OF RECOMMENDED CHANGE ---
                if (!response.ok) {
                    // ถ้า response ไม่ใช่ 200 OK ให้ลองอ่าน JSON error
                    let errorData = null;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        // ไม่ใช่ JSON error
                    }
                    
                    if (errorData && errorData.message) {
                        // ถ้ามีข้อความ error จาก API (เช่น "ยังไม่ได้ตั้งค่าวันเริ่มภาคเรียน")
                        throw new Error(errorData.message);
                    } else {
                        // Error ทั่วไป
                        throw new Error(`ไม่สามารถโหลดข้อมูลได้ (Status: ${response.status})`);
                    }
                }
                // --- END OF RECOMMENDED CHANGE ---

                const data = await response.json();
                renderAttendanceTable(data, container);

            } catch (error) {
                // ตอนนี้ 'error.message' จะแสดงข้อความที่ส่งมาจาก Flask
                if(container) container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        };

        classroomSelector.addEventListener('change', handleClassroomChange);

        // **LOGIC ใหม่: การคืนค่า State**
        if (state.activeClassroomId && [...classroomSelector.options].some(opt => opt.value === state.activeClassroomId)) {
            classroomSelector.value = state.activeClassroomId;
        } else if (classroomSelector.options.length > 1) {
            classroomSelector.value = classroomSelector.options[1].value;
        }

        // สั่งให้ทำงานครั้งแรกเพื่อโหลดข้อมูล
        handleClassroomChange();

        // เพิ่ม Listener สำหรับการคลิกเปลี่ยนสถานะ (โค้ดส่วนนี้ของท่านถูกต้องอยู่แล้ว)
        if (container) {        
        // Central Event Listener for Clicks
        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('attendance-badge')) {
                const badge = e.target;
                const group = badge.closest('.attendance-cell');
                const statuses = ['PRESENT', 'LATE', 'ABSENT', 'LEAVE'];

                const currentStatus = badge.dataset.status;
                const currentIndex = statuses.indexOf(currentStatus);
                const nextIndex = (currentIndex + 1) % statuses.length;
                const nextStatus = statuses[nextIndex];

                updateBadge(badge, nextStatus);

                const payload = {
                    student_id: group.dataset.studentId,
                    entry_id: group.dataset.entryId,
                    date: group.dataset.date,
                    status: nextStatus
                };

                fetch("{{ url_for('teacher.save_attendance') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify(payload)
                }).then(res => {
                    if (!res.ok) {
                        console.error("Failed to save attendance");
                        updateBadge(badge, currentStatus); // Revert on failure
                    }
                });
            }
        });
    }
}

    // --- 4.5. Reflection Tab ---
    function initializeReflectionTab() {
        const wrapper = document.getElementById('reflection-wrapper');
        if (!wrapper) return;

        const unitId = wrapper.dataset.unitId;
        const loader = wrapper.querySelector('#dashboard-loader');
        const dashboardContent = wrapper.querySelector('#dashboard-content');
        const loggingContainer = wrapper.querySelector('#logging-container');
        const statusIndicator = wrapper.querySelector('#save-status-indicator');
        let reflectionSaveDebounce;

        const loadDashboardAndLogs = async () => {
            try {
                const response = await fetch(`/teacher/api/units/${unitId}/performance-dashboard`);
                if (!response.ok) throw new Error('Could not fetch performance data.');
                const data = await response.json();

                renderDashboard(data.dashboard_data, data.unit_max_score);
                setupLoggingSystem(data.logs, data.dashboard_data);

                loader.classList.add('d-none');
                dashboardContent.classList.remove('d-none');
                loggingContainer.classList.remove('d-none');

            } catch (error) {
                console.error("Failed to load reflection tab data:", error);
                loader.innerHTML = '<p class="text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูลแดชบอร์ด</p>';
            }
        };

        const renderDashboard = (dashboardData, unitMaxScore) => {
            const tbody = wrapper.querySelector('#dashboard-table-body');
            const tfoot = wrapper.querySelector('#dashboard-table-foot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            let totalStudents = 0,
                totalIncomplete = 0;
            let totalScoresSum = 0;
            let totalScoredStudents = 0;
            let totalDist = {
                excellent: 0,
                good: 0,
                fair: 0,
                improve: 0
            };

            dashboardData.forEach(room => {
                const studentsWithScores = room.student_count - room.incomplete;
                totalStudents += room.student_count;
                totalIncomplete += room.incomplete;
                totalScoresSum += (room.avg_score * studentsWithScores);
                totalScoredStudents += studentsWithScores;

                Object.keys(totalDist).forEach(key => totalDist[key] += room.distribution[key]);

                tbody.innerHTML += `
                    <tr>
                        <td class="text-start">${room.name}</td>
                        <td>${room.student_count}</td>
                        <td>${unitMaxScore}</td>
                        <td>${room.avg_score} (${unitMaxScore > 0 ? Math.round(room.avg_score / unitMaxScore * 100) : 0}%)</td>
                        <td>${room.sd}</td>
                        <td>${room.distribution.excellent}</td>
                        <td>${room.distribution.good}</td>
                        <td>${room.distribution.fair}</td>
                        <td>${room.distribution.improve}</td>
                        <td>${room.incomplete}</td>
                    </tr>
                `;
            });

            const overallAvg = totalScoredStudents > 0 ? (totalScoresSum / totalScoredStudents) : 0;
            tfoot.innerHTML = `
                <tr class="table-primary fw-bold">
                    <td>สรุปทั้งหมด</td>
                    <td>${totalStudents}</td>
                    <td>${unitMaxScore}</td>
                    <td>${overallAvg.toFixed(2)} (${unitMaxScore > 0 ? Math.round(overallAvg / unitMaxScore * 100) : 0}%)</td>
                    <td>-</td>
                    <td>${totalDist.excellent}</td>
                    <td>${totalDist.good}</td>
                    <td>${totalDist.fair}</td>
                    <td>${totalDist.improve}</td>
                    <td>${totalIncomplete}</td>
                </tr>
            `;
        };

        const setupLoggingSystem = (logData, dashboardData) => {
            const overallForm = wrapper.querySelector('#overall-log-form');
            const navContainer = wrapper.querySelector('#per-room-log-nav');
            const contentContainer = wrapper.querySelector('#per-room-log-content');

            overallForm.querySelector('#log_content_overall').value = logData.overall.log_content;
            overallForm.querySelector('#problems_obstacles').value = logData.overall.problems_obstacles;
            overallForm.querySelector('#solutions').value = logData.overall.solutions;

            navContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            dashboardData.forEach((room, index) => {
                const roomLog = logData.per_room[room.id] || {
                    log_content: ''
                };
                navContainer.innerHTML += `
                    <button type="button" class="list-group-item list-group-item-action ${index === 0 ? 'active' : ''}" data-room-id="${room.id}">
                        ${room.name}
                    </button>`;
                contentContainer.innerHTML += `
                    <div class="per-room-log-pane ${index === 0 ? '' : 'd-none'}" id="log-pane-${room.id}">
                        <label for="log-room-${room.id}" class="form-label small text-muted">บันทึกสำหรับห้อง ${room.name}:</label>
                        <textarea class="form-control per-room-textarea" id="log-room-${room.id}" data-room-id="${room.id}" rows="4">${roomLog.log_content}</textarea>
                    </div>`;
            });

            overallForm.addEventListener('input', (e) => handleSave(e.target));

            navContainer.addEventListener('click', e => {
                if (e.target.matches('button')) {
                    navContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    contentContainer.querySelectorAll('.per-room-log-pane').forEach(pane => pane.classList.add('d-none'));
                    contentContainer.querySelector(`#log-pane-${e.target.dataset.roomId}`).classList.remove('d-none');
                }
            });

            contentContainer.addEventListener('input', e => {
                if (e.target.matches('.per-room-textarea')) {
                    handleSave(e.target);
                }
            });
        };

        const handleSave = (element) => {
            clearTimeout(reflectionSaveDebounce);
            statusIndicator.textContent = 'กำลังพิมพ์...';

            reflectionSaveDebounce = setTimeout(async () => {
                statusIndicator.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>กำลังบันทึก...';

                const isPerRoom = element.dataset.roomId;
                let payload = {};

                if (isPerRoom) {
                    payload = {
                        classroom_id: element.dataset.roomId,
                        log_content: element.value
                    };
                } else {
                    const overallForm = wrapper.querySelector('#overall-log-form');
                    payload = {
                        classroom_id: null,
                        log_content: overallForm.querySelector('#log_content_overall').value,
                        problems_obstacles: overallForm.querySelector('#problems_obstacles').value,
                        solutions: overallForm.querySelector('#solutions').value
                    }
                }

                try {
                    const response = await fetch(`/teacher/api/log/unit/${unitId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Save failed');

                    const now = new Date();
                    const timeString = now.toLocaleTimeString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    statusIndicator.textContent = `บันทึกฉบับร่างล่าสุดเมื่อ ${timeString} น.`;

                } catch (error) {
                    statusIndicator.textContent = 'เกิดข้อผิดพลาดในการบันทึก!';
                    console.error("Save error:", error);
                }

            }, 1500);
        };

        loadDashboardAndLogs();
    }

/**
     * [FINAL ROBUST VERSION with MutationObserver]
     * แก้ปัญหาคอลัมน์กระพริบแล้วหาย โดยใช้ MutationObserver
     * เพื่อให้แน่ใจว่าการกรองคอลัมน์ของเราเป็นคำสั่งสุดท้ายเสมอ
     */
    async function fetchAndRenderGradebookTable(selector) {
        const classroomId = selector.value;
        const selectedOption = selector.options[selector.selectedIndex];
        const container = document.getElementById('gradebook-container');

        if (!classroomId) {
            container.innerHTML = `<div class="text-center p-5 text-muted">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</div>`;
            return;
        }
        const courseId = selectedOption.dataset.courseId;
        if (!courseId) {
            container.innerHTML = `<div class="alert alert-danger">Error: ไม่พบ Course ID</div>`;
            return;
        }

        try {
            container.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="spinner-border"></div></div>';
            const response = await fetch(`/teacher/api/course/${courseId}/gradebook-data?classroom_id=${classroomId}`);
            if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลคะแนนได้');

            const data = await response.json();

            // 1. เลือก Unit ที่จะแสดงผลอย่างชาญฉลาด (โค้ดเดิมที่ถูกต้องแล้ว)
            const availableUnitIds = (data.units_data || []).map(u => String(u.unit_id));
            let chosenUnitId = null;
            if (state.activeUnitId && availableUnitIds.includes(String(state.activeUnitId))) {
                chosenUnitId = state.activeUnitId;
            } else if (availableUnitIds.length > 0) {
                chosenUnitId = availableUnitIds[0];
                state.activeUnitId = chosenUnitId;
                saveState();
            } else {
                chosenUnitId = 'all';
                state.activeUnitId = null;
                saveState();
            }

            // 2. Render ตารางทั้งหมด
            renderGradebookTable(data, container, chosenUnitId);

            // 3. สั่งกรองคอลัมน์ครั้งแรกทันที (เพื่อให้แสดงผลเร็วที่สุด)
            filterGradebookColumns(chosenUnitId);
            setActiveUnitFilter(chosenUnitId);

        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }
    /**
     * [FINAL CORRECTED VERSION] Renders the gradebook table with the "Unit Summary"
     * column correctly placed at the END of each unit's item list.
     */
    function renderGradebookTable(data, container, unitIdToSelect) {
        if (!data.students || data.students.length === 0) {
            container.innerHTML = `<div class="text-center text-muted py-5"><h4><i class="bi bi-people"></i> ไม่มีข้อมูลนักเรียนในห้องเรียนนี้</h4></div>`;
            return;
        }

        const template = document.getElementById('gradebook-template').content.cloneNode(true);
        const table = template.querySelector('#gradebook-table');
        table.dataset.courseId = data.course_id;
        table.dataset.grandMaxScore = data.grand_max_score || 100;
        table.dataset.summativeIds = JSON.stringify(data.summative_item_ids || []);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('#gradebook-body');

        // --- 1. BUILD HEADER (<thead>) ---
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th rowspan="2" class="align-middle text-center">นักเรียน</th>';
        let subHeaderRowHtml = '';

        // Helper function to create toggle switches
        const createToggleSwitches = (itemId, groupToggle = true, allToggle = true) => `
        <div class="d-flex justify-content-center small mt-1">
            ${groupToggle ? `
            <div class="form-check form-switch form-check-inline me-2">
                <input class="form-check-input propagation-toggle group-toggle" type="checkbox" role="switch" title="เปิด/ปิดการให้คะแนนแบบกลุ่ม" data-item-id="${itemId}" data-mode="group">
                <label class="form-check-label">กลุ่ม</label>
            </div>` : ''}
            ${allToggle ? `
            <div class="form-check form-switch form-check-inline">
                <input class="form-check-input propagation-toggle all-toggle" type="checkbox" role="switch" title="เปิด/ปิดการให้คะแนนทั้งหมด" data-item-id="${itemId}" data-mode="all">
                <label class="form-check-label">ทั้งหมด</label>
            </div>` : ''}
        </div>
        `;

        // Step 1.1: Build Graded Items from 'units_data'
        data.units_data.forEach(unit => {
            if (!unit.items || unit.items.length === 0) return; // ใช้ return แทน continue ใน forEach
            headerRow.innerHTML += `<th colspan="${unit.items.length + 1}" class="text-center unit-column unit-id-${unit.unit_id}">${unit.title}</th>`;

            unit.items.forEach(item => {
                subHeaderRowHtml += `<th class="text-nowrap text-center unit-column unit-id-${item.learning_unit_id}">
                                        ${item.name}<br><small class="text-muted">(${item.max_score || 0})</small>
                                        ${createToggleSwitches('g-' + item.id)}
                                    </th>`;
            });
            subHeaderRowHtml += `<th class="text-nowrap text-center unit-column unit-id-${unit.unit_id} table-primary">สรุปหน่วย</th>`;
        });

        // Step 1.2: Build Qualitative Assessment Section Header (ฉบับปรับปรุง)
        data.qualitative_assessment_data.forEach(template => {
            if (template && Array.isArray(template.main_topics)) {
                template.main_topics.forEach(mainTopic => {
                    // --- START FIX: Add defensive check ---
                    if (!mainTopic) return; // Skip if mainTopic is null or undefined
                    // --- END FIX ---
                    
                    const subTopics = mainTopic.selected_sub_topics;
                    const unitId = mainTopic.learning_unit_id;

                    if (subTopics && subTopics.length > 0) {
                        // กรณีมีหัวข้อย่อย: สร้างคอลัมน์ "สรุป" และ "หัวข้อย่อย" ให้สูงเต็ม 2 แถว
                        headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId} table-info">
                                                    สรุป<br><small>${mainTopic.main_topic_name}</small>
                                                    ${createToggleSwitches('q-' + mainTopic.main_topic_id)}
                                                </th>`;
                        subTopics.forEach(sub => {
                            headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId}">
                                                        ${sub.name}
                                                    </th>`;
                        });
                    } else {
                        // กรณีไม่มีหัวข้อย่อย: สร้างแค่คอลัมน์เดียวให้สูงเต็ม 2 แถว
                        headerRow.innerHTML += `<th rowspan="2" class="text-nowrap align-middle text-center unit-column unit-id-${unitId} table-info">
                                                    <small>${mainTopic.main_topic_name}</small>
                                                    ${createToggleSwitches('q-' + mainTopic.main_topic_id)}
                                                </th>`;
                    }
                });
            }
        });
        // Step 1.3: Build Exams & Final Summary Header (คงเดิม)
        let finalColspan = 4;
        if (data.is_midterm_enabled) finalColspan++;
        if (data.is_final_enabled) finalColspan++;
        headerRow.innerHTML += `<th colspan="${finalColspan}" class="text-center">สรุปผลการเรียน</th>`;

        subHeaderRowHtml += `<th class="text-nowrap text-center">คะแนนเก็บ</th>`;
        if (data.is_midterm_enabled) {
            subHeaderRowHtml += `<th class="text-nowrap text-center">กลางภาค (${data.total_midterm_max_score || 0}) ${createToggleSwitches('midterm', false)}</th>`;
        }
        if (data.is_final_enabled) {
            subHeaderRowHtml += `<th class="text-nowrap text-center">ปลายภาค (${data.total_final_max_score || 0}) ${createToggleSwitches('final', false)}</th>`;
        }
        subHeaderRowHtml += `<th class="text-nowrap text-center">คะแนนจริง</th><th class="text-nowrap text-center">รวมคะแนน (100)</th><th class="text-nowrap text-center">เกรด</th>`;

        thead.innerHTML = '';
        thead.appendChild(headerRow);
        const subHeader = document.createElement('tr');
        subHeader.innerHTML = subHeaderRowHtml;
        thead.appendChild(subHeader);

        // --- 2. BUILD BODY (<tbody>) in the same sequence as the header ---
        // (ส่วนนี้ทั้งหมดคงไว้เหมือนเดิม ไม่มีการเปลี่ยนแปลง)
        data.students.forEach(student => {
            const studentRow = document.createElement('tr');
            const nonActiveStatuses = ['ลาออก', 'ย้ายออก', 'พ้นสภาพ', 'แขวนลอย', 'พักการเรียน'];
            if (nonActiveStatuses.includes(student.status)) {
                studentRow.classList.add('table-secondary', 'text-muted', 'text-decoration-line-through');
            }
            studentRow.dataset.studentId = student.id;
            studentRow.dataset.groupId = data.student_group_map[student.id] || '';
            studentRow.dataset.hasMs = student.has_ms_status;

            let groupIds = {};
            const groups = data.groups || [];
            for (const unitId in data.unit_group_map) {
                if (data.unit_group_map[unitId] && data.unit_group_map[unitId][student.id]) {
                    const group_name = data.unit_group_map[unitId][student.id];
                    const group = groups.find(g => g.name === group_name && g.learning_unit_id == unitId);
                    if (group) {
                        groupIds[unitId] = group.id;
                    }
                }
            }
            studentRow.dataset.groupId = data.student_group_map[student.id] || '';
            // เพิ่มบรรทัดนี้เพื่อเก็บข้อมูลกลุ่มของทุกหน่วยในรูปแบบ JSON
            studentRow.dataset.groupIds = JSON.stringify(groupIds);                
            const studentNameClasses = student.has_active_warning ? 'text-nowrap student-cell text-danger fw-bold' : 'text-nowrap student-cell';
            const studentNameTitle = student.has_active_warning ? 'นักเรียนคนนี้มีสถานะเฝ้าระวังการขาดเรียน' : '';
            let rowHtml = `<td class="${studentNameClasses}" title="${studentNameTitle}">${student.roll_number}. ${student.student_id} ${student.name_prefix || ''}${student.first_name} ${student.last_name}<span class="student-alerts-container">${renderAlerts(student.alerts)}</span></td>`;

            // This loop was missing. It iterates through each unit to create the score input cells for the student.
            data.units_data.forEach(unit => {
                if (!unit.items || unit.items.length === 0) return;
                const unitTotalMaxScore = unit.items.reduce((s, it) => s + (parseFloat(it.max_score) || 0), 0);
                unit.items.forEach(item => {
                    const scoreKey = `${student.id}-${item.id}`;
                    const score = (data.scores[scoreKey] && data.scores[scoreKey].score != null) ? data.scores[scoreKey].score : '';
                    let inputHtml = '';
                    const studentGroupId = (data.student_group_map && data.student_group_map[student.id]) ? data.student_group_map[student.id] : null;

                    if (item.is_group_assignment && studentGroupId) {
                        inputHtml = `<input type="number" class="form-control form-control-sm text-center score-input is-group-score" 
                                        data-item-id="g-${item.id}" 
                                        data-group-id="${studentGroupId}"
                                        data-unit-id="${item.learning_unit_id}"
                                        data-max-score="${item.max_score || 0}"
                                        value="${score}" max="${item.max_score || 0}" min="0">`;
                    } else {
                        inputHtml = `<input type="number" class="form-control form-control-sm text-center score-input" 
                                        data-item-id="g-${item.id}" value="${score}" 
                                        max="${item.max_score || 0}" min="0"
                                        data-unit-id="${item.learning_unit_id}"
                                        data-max-score="${item.max_score || 0}">`;
                    }
                    rowHtml += `<td class="unit-column unit-id-${item.learning_unit_id}">${inputHtml}</td>`;
                });
                rowHtml += `<td class="unit-column unit-id-${unit.unit_id}"><input type="number" class="form-control form-control-sm text-center unit-summary-input" data-unit-id="${unit.unit_id}" data-unit-total-max-score="${unitTotalMaxScore}" max="${unitTotalMaxScore}"></td>`;
            });

            data.qualitative_assessment_data.forEach(template => {
                const rubrics = template.rubrics;
                if (template && Array.isArray(template.main_topics)) {
                    template.main_topics.forEach(mainTopic => {
                        // --- START FIX: Add defensive check ---
                        if (!mainTopic) return; // Skip if mainTopic is null or undefined
                        // --- END FIX ---

                        const subTopics = mainTopic.selected_sub_topics;
                        const unitId = mainTopic.learning_unit_id;
                        let selectOptions = '<option value=""></option>';
                        if (rubrics) {
                            rubrics.forEach(rubric => {
                                selectOptions += `<option value="${rubric.value}">${rubric.label}</option>`;
                            });
                        }
                        if (subTopics && subTopics.length > 0) {
                            const summaryScoreKey = `${student.id}-q-${mainTopic.main_topic_id}`;
                            const summaryScore = data.scores[summaryScoreKey] ?.score ?? '';
                            rowHtml += `<td class="unit-column unit-id-${unitId}">
                                            <select class="form-select form-select-sm text-center qualitative-main-summary" 
                                                    data-main-id="q-${mainTopic.main_topic_id}" 
                                                    data-topic-id="q-${mainTopic.main_topic_id}"
                                                    data-initial-score="${summaryScore}">
                                                ${selectOptions}
                                            </select>
                                        </td>`;
                            subTopics.forEach(sub => {
                                const scoreKey = `${student.id}-q-${sub.id}`;
                                const score = (data.scores[scoreKey] && data.scores[scoreKey].score != null) ? data.scores[scoreKey].score : '';
                                rowHtml += `<td class="unit-column unit-id-${unitId}">
                                                <select class="form-select form-select-sm text-center qualitative-select" 
                                                        data-main-id="q-${mainTopic.main_topic_id}" 
                                                        data-topic-id="q-${sub.id}"
                                                        data-course-id="${data.course_id}" 
                                                        data-initial-score="${score}">
                                                    ${selectOptions}
                                                </select>
                                            </td>`;
                            });
                        } else {
                            const mainScoreKey = `${student.id}-q-${mainTopic.main_topic_id}`;
                            const mainScore = data.scores[mainScoreKey] ?.score ?? '';
                            rowHtml += `<td class="unit-column unit-id-${unitId}"><select class="form-select form-control-sm text-center qualitative-select" data-topic-id="q-${mainTopic.main_topic_id}" data-initial-score="${mainScore}">${selectOptions}</select></td>`;
                        }
                    });
                }
            });
            rowHtml += `<td><span class="collected-score-display fw-bold">0</span></td>`;
                if (data.is_midterm_enabled) {
                    rowHtml += `<td><input type="number" class="form-control form-control-sm text-center exam-input" data-exam-type="midterm" value="${student.midterm_score ?? ''}" max="${data.total_midterm_max_score || 0}"></td>`;
                }
                if (data.is_final_enabled) {
                    rowHtml += `<td><input type="number" class="form-control form-control-sm text-center exam-input" data-exam-type="final" value="${student.final_score ?? ''}" max="${data.total_final_max_score || 0}"></td>`;
                }
                rowHtml += `<td><span class="total-score-display fw-bold">0</span></td>
                            <td><span class="percentage-display fw-bold">0%</span></td>
                            <td><span class="grade-display fw-bold">-</span></td>`;
            studentRow.innerHTML = rowHtml;
            tbody.appendChild(studentRow);
            updateStudentRowTotals(studentRow);
        });

        container.innerHTML = '';
        container.appendChild(template);
        setupGradebookEventListeners(table, data);

        table.querySelectorAll('select[data-initial-score]').forEach(select => {
            const initialValue = select.dataset.initialScore;
            if (initialValue !== '') {
                select.value = initialValue;
            }
        });

        const firstUnitId = data.units_data.length > 0 ? data.units_data[0].unit_id : null;

        const idToShow = String(unitIdToSelect || firstUnitId || '');
        if (idToShow) {
            setTimeout(() => {
                filterGradebookColumns(idToShow);
                setActiveUnitFilter(idToShow);
            }, 0);
        }
    }

    /**
     * [SIMPLIFIED] Attaches all necessary event listeners to the gradebook table.
     * The complex calculation logic is now handled by updateStudentRowTotals.
     */
    function setupGradebookEventListeners(table, data) {
        // --- START: Helper Functions (อยู่ข้างในนี้ทั้งหมด) ---
        let saveDebounce;
        let isDistributing = false;

        const calculateMode = (arr) => {
            if (!arr || arr.length === 0) return '';
            const frequency = arr.reduce((acc, val) => {
                if (val !== '') {
                    acc[val] = (acc[val] || 0) + 1;
                }
                return acc;
            }, {});
            let maxFreq = 0, mode = '';
            for (const val in frequency) {
                if (frequency[val] > maxFreq) {
                    maxFreq = frequency[val];
                    mode = val;
                }
            }
            return mode;
        };

        // --- REPLACE WITH THIS DIAGNOSTIC VERSION ---
        const saveScoresBulk = (scoresData, endpointUrl) => {
            if (scoresData.length === 0) return;

            const table = document.getElementById('gradebook-table');
            const courseId = table ? table.dataset.courseId : null;
            if (!courseId) {
                console.error("CRITICAL: course_id not found on the gradebook table.");
                return;
            }

            const payload = {
                scores: scoresData,
                course_id: courseId
            };

            console.log("--- [DEBUG] Preparing to save bulk scores ---");
            console.log("Endpoint URL:", endpointUrl);
            console.log("Payload being sent:", JSON.stringify(payload, null, 2));

            fetch(endpointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log("--- [DEBUG] Received response from server ---");
                console.log("Response OK:", response.ok);
                console.log("Response Status:", response.status);
                console.log("Response Status Text:", response.statusText);
                
                if (!response.ok) {
                    // Try to get text first in case the error response is not JSON
                    return response.text().then(text => {
                        throw new Error(`Server responded with status ${response.status}. Body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("--- [DEBUG] Successfully parsed JSON response ---");
                console.log("Response Data:", data);
                if (data.status !== 'success') {
                    console.error('Save failed on server-side:', data.message);
                }
            })
            .catch(err => {
                console.error('--- [DEBUG] An error occurred in fetch/save process ---');
                console.error('Bulk save error:', err);
                Swal.fire('เกิดข้อผิดพลาดในการบันทึก', `กรุณาตรวจสอบ Console (F12) สำหรับรายละเอียด: ${err.message}`, 'error');
            });
        };

        const saveExamScore = (examData) => {
            // This function saves a single exam score.
            fetch("{{ url_for('teacher.save_enrollment_exam_score') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(examData)
            }).catch(err => console.error('Exam save error:', err));
        };
                    
        const handlePropagation = (input) => {
            const studentRow = input.closest('tr');
            if (!studentRow) {
                return;
            }

            const columnId = input.dataset.itemId || input.dataset.examType;
            if (!columnId) {
                console.log('Input is not a propagatable field. Performing single update.');
                
                // Run your original row total calculation.
                updateStudentRowTotals(studentRow);
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const studentId = studentRow.dataset.studentId;
                    const score = input.value === '' ? null : parseFloat(input.value);
                    if (input.dataset.itemId) {
                        const numericId = input.dataset.itemId.replace('g-', '');
                        saveScoresBulk([{ student_id: studentId, graded_item_id: numericId, score: score }], "{{ url_for('teacher.save_scores_bulk') }}");
                    } else if (input.dataset.examType) {
                        saveExamScore({ student_id: studentId, course_id: data.course_id, exam_type: input.dataset.examType, score: score });
                    }
                }, 800);
                return;
            }

            const groupSelector = `.propagation-toggle.group-toggle[data-item-id="${columnId}"]`;
            const allSelector = `.propagation-toggle.all-toggle[data-item-id="${columnId}"]`;
            
            const allToggle = table.querySelector(allSelector);
            const groupToggle = table.querySelector(groupSelector);

            if (!allToggle && !groupToggle) {
                return;
            }

            let activeToggle = null;
            if (allToggle?.checked) activeToggle = allToggle;
            else if (groupToggle?.checked) activeToggle = groupToggle;

            if (!activeToggle) {

                // 1. Update totals for the current row
                updateStudentRowTotals(studentRow);

                // 2. Debounce the save operation for the single input change
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const studentId = studentRow.dataset.studentId;
                    const score = input.value === '' ? null : parseFloat(input.value);

                    // 3. Check what kind of input it is and call the correct save function
                    if (input.dataset.itemId) {
                        const scoreData = {
                            student_id: studentId,
                            graded_item_id: input.dataset.itemId.replace('g-', ''), 
                            score: score
                        };
                        saveScoresBulk([scoreData], "{{ url_for('teacher.save_scores_bulk') }}");
                    } else if (input.dataset.examType) {
                        const examData = {
                            student_id: studentId,
                            course_id: data.course_id,
                            exam_type: input.dataset.examType,
                            score: score
                        };
                        saveExamScore(examData);
                    }
                }, 800); // 800ms delay to wait for more typing

                return; // Exit the function as no propagation is needed
            }
            // --- START: Full Propagation and Save Logic ---
            isDistributing = true;
            
            const newScore = input.value;
            let inputsToUpdate = [input];
            const mode = activeToggle.dataset.mode;

            let targetRows = [];
            if (mode === 'all') {
                targetRows = Array.from(table.querySelectorAll('tr[data-student-id]'));
            } else if (mode === 'group') {
                const sourceGroupId = studentRow.dataset.groupId;
                if (sourceGroupId) {
                    targetRows = Array.from(table.querySelectorAll(`tr[data-group-id="${sourceGroupId}"]`));
                }
            }

            if (targetRows.length > 0) {
                targetRows.forEach(row => {
                    if (row === studentRow) return; // Don't re-process the source row

                    const allInputsInRow = row.querySelectorAll('.score-input, .exam-input');
                    allInputsInRow.forEach(inputInRow => {
                        const currentInputColumnId = inputInRow.dataset.itemId || inputInRow.dataset.examType;
                        if (currentInputColumnId === columnId) {
                            inputInRow.value = newScore;
                            inputsToUpdate.push(inputInRow);
                        }
                    });
                });
            }
            
            // Update totals for all affected rows
            const uniqueInputs = [...new Set(inputsToUpdate)];
            uniqueInputs.forEach(i => updateStudentRowTotals(i.closest('tr')));

            // Debounce the save operation for all updated inputs
            clearTimeout(saveDebounce);
            saveDebounce = setTimeout(() => {
                const gradedItemsToSave = [];
                const examScoresToSave = [];

                uniqueInputs.forEach(i => {
                    const studentId = i.closest('tr').dataset.studentId;
                    const score = i.value === '' ? null : parseFloat(i.value);
                    if (i.dataset.itemId) {
                        gradedItemsToSave.push({ student_id: studentId, graded_item_id: i.dataset.itemId.replace('g-', ''), score: score });
                    } else if (i.dataset.examType) {
                        examScoresToSave.push({ student_id: studentId, course_id: data.course_id, exam_type: i.dataset.examType, score: score });
                    }
                });

                if (gradedItemsToSave.length > 0) {
                    saveScoresBulk(gradedItemsToSave, "{{ url_for('teacher.save_scores_bulk') }}");
                }
                examScoresToSave.forEach(examScore => {
                    saveExamScore(examScore);
                });
            }, 800);
            
            isDistributing = false;
        }
        
        const handleQualitativeChange = (changedSelect) => {
            if (isDistributing) return;
            isDistributing = true;

            const studentRow = changedSelect.closest('tr');
            if (!studentRow) { isDistributing = false; return; }

            // ID of the governing switch (always the main topic ID)
            const mainTopicIdForSwitch = changedSelect.dataset.mainId || changedSelect.dataset.topicId;
            
            // ID of the specific column that was changed (could be main or sub)
            const specificTopicId = changedSelect.dataset.topicId;

            if (!mainTopicIdForSwitch || !specificTopicId) {
                isDistributing = false;
                return;
            }

            const allToggle = table.querySelector(`.propagation-toggle.all-toggle[data-item-id="${mainTopicIdForSwitch}"]`);
            const groupToggle = table.querySelector(`.propagation-toggle.group-toggle[data-item-id="${mainTopicIdForSwitch}"]`);

            let activeToggle = null;
            if (allToggle && allToggle.checked) activeToggle = allToggle;
            else if (groupToggle && groupToggle.checked) activeToggle = groupToggle;

            let allModifiedSelects = [changedSelect];
            const newValue = changedSelect.value;
            
            if (changedSelect.classList.contains('qualitative-main-summary')) {
                studentRow.querySelectorAll(`.qualitative-select[data-main-id="${mainTopicIdForSwitch}"]`).forEach(subSelect => {
                    if (subSelect.value !== newValue) {
                        subSelect.value = newValue;
                        allModifiedSelects.push(subSelect);
                    }
                });
            }

            if (activeToggle) {
                let targetRows = [];
                const mode = activeToggle.dataset.mode;
                if (mode === 'all') {
                    targetRows = Array.from(table.querySelectorAll('tr[data-student-id]'));
                } else if (mode === 'group') {
                    const targetGroupId = studentRow.dataset.groupId;
                    if (targetGroupId) {
                        targetRows = Array.from(table.querySelectorAll(`tr[data-group-id="${targetGroupId}"]`));
                    }
                }

                const uniqueSelectsToPropagate = [...new Set(allModifiedSelects)];
                uniqueSelectsToPropagate.forEach(selectToPropagate => {
                    const currentTopicId = selectToPropagate.dataset.topicId;
                    const currentValue = selectToPropagate.value;
                    const selector = `.qualitative-select[data-topic-id="${currentTopicId}"], .qualitative-main-summary[data-topic-id="${currentTopicId}"]`;
                    
                    targetRows.forEach(row => {
                        if (row !== studentRow) {
                            const selectInRow = row.querySelector(selector);
                            if (selectInRow && selectInRow.value !== currentValue) {
                                selectInRow.value = currentValue;
                                allModifiedSelects.push(selectInRow);
                            }
                        }
                    });
                });
            }

            const uniqueRowsToUpdate = [...new Set(allModifiedSelects.map(sel => sel.closest('tr')))];
            uniqueRowsToUpdate.forEach(row => {
                const mainSummaryInRow = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainTopicIdForSwitch}"]`);
                if (mainSummaryInRow) {
                    const subSelectsInRow = Array.from(row.querySelectorAll(`.qualitative-select[data-main-id="${mainTopicIdForSwitch}"]`));
                    if (subSelectsInRow.length > 0) {
                        const newMode = calculateMode(subSelectsInRow.map(s => s.value));
                        if (mainSummaryInRow.value !== newMode) {
                            mainSummaryInRow.value = newMode;
                            allModifiedSelects.push(mainSummaryInRow);
                        }
                    }
                }
            });

            if (allModifiedSelects.length > 0) {
                clearTimeout(saveDebounce);
                saveDebounce = setTimeout(() => {
                    const scoresToSave = [...new Set(allModifiedSelects)].map(sel => ({
                        student_id: sel.closest('tr')?.dataset.studentId,
                        topic_id: sel.dataset.topicId.replace('q-', ''),
                        score: sel.value === '' ? null : sel.value
                    })).filter(s => s.student_id && s.topic_id);
                    if (scoresToSave.length > 0) saveScoresBulk(scoresToSave, "{{ url_for('teacher.save_qualitative_scores_bulk') }}");
                }, 800);
            }
            
            isDistributing = false;
        };
        
        table.addEventListener('change', e => {
            const target = e.target;

            if (target.matches('.unit-summary-input')) {
                const studentRow = target.closest('tr');
                if (!studentRow) return;

                const unitId = target.dataset.unitId;
                const newSummaryScore = parseFloat(target.value) || 0;
                const unitTotalMaxScore = parseFloat(target.dataset.unitTotalMaxScore) || 0;

                // ป้องกันการหารด้วยศูนย์
                if (unitTotalMaxScore <= 0) return;

                // คำนวณสัดส่วนที่ต้องกระจาย
                const ratio = newSummaryScore / unitTotalMaxScore;
                const scoreInputsInUnit = studentRow.querySelectorAll(`.score-input[data-unit-id="${unitId}"]`);
                
                // 1. คำนวณคะแนนเบื้องต้นและเก็บเศษทศนิยมไว้
                let calculatedScores = [];
                let sumOfFlooredScores = 0;
                
                scoreInputsInUnit.forEach(input => {
                    const itemMaxScore = parseFloat(input.dataset.maxScore) || 0;
                    const idealScore = itemMaxScore * ratio;
                    const flooredScore = Math.floor(idealScore);
                    
                    calculatedScores.push({
                        input: input,
                        finalScore: flooredScore,
                        remainder: idealScore - flooredScore // เก็บเศษทศนิยม
                    });
                    sumOfFlooredScores += flooredScore;
                });

                // 2. คำนวณหาผลต่างที่ต้องนำไปปันส่วน
                let remainderToDistribute = newSummaryScore - sumOfFlooredScores;

                // 3. เรียงลำดับรายการตามเศษทศนิยมจากมากไปน้อย
                calculatedScores.sort((a, b) => b.remainder - a.remainder);

                // 4. กระจายผลต่าง (บวก 1) ให้กับรายการที่มีเศษทศนิยมมากที่สุดก่อน
                for (let i = 0; i < remainderToDistribute; i++) {
                    if (calculatedScores[i]) {
                        calculatedScores[i].finalScore++;
                    }
                }

                // 5. อัปเดตค่าในช่อง input และรวบรวมข้อมูลเพื่อบันทึก
                const itemsToSave = [];
                calculatedScores.forEach(calc => {
                    // ตรวจสอบว่าคะแนนที่คำนวณได้ไม่เกินคะแนนเต็มของรายการนั้นๆ
                    const itemMaxScore = parseFloat(calc.input.dataset.maxScore) || 0;
                    if (calc.finalScore > itemMaxScore) {
                        calc.finalScore = itemMaxScore;
                    }

                    calc.input.value = calc.finalScore;
                    itemsToSave.push({
                        student_id: studentRow.dataset.studentId,
                        graded_item_id: calc.input.dataset.itemId.replace('g-', ''),
                        score: calc.finalScore
                    });
                });
                
                // ใช้ Debounce และฟังก์ชัน saveScoresBulk ที่มีอยู่แล้วเพื่อบันทึกข้อมูล
                if (itemsToSave.length > 0) {
                    clearTimeout(saveDebounce);
                    saveDebounce = setTimeout(() => {
                        saveScoresBulk(itemsToSave, "{{ url_for('teacher.save_scores_bulk') }}");
                    }, 800);
                }
            }                
            else if (target.matches('.qualitative-select, .qualitative-main-summary')) {
                handleQualitativeChange(target);
            }
            // This part handles making the switches mutually exclusive. It's correct here.
            else if (target.classList.contains('propagation-toggle')) {
                const itemId = target.dataset.itemId;
                const mode = target.dataset.mode;
                const otherToggle = (mode === 'group')
                    ? table.querySelector(`.propagation-toggle.all-toggle[data-item-id="${itemId}"]`)
                    : table.querySelector(`.propagation-toggle.group-toggle[data-item-id="${itemId}"]`);
                
                if (target.checked && otherToggle) {
                    otherToggle.checked = false;
                }
            }
        });

        // The 'input' event fires on every keystroke. It's good for live UI updates.
        table.addEventListener('input', e => {
            const target = e.target;
            // We will ONLY use this for the live row total calculation.
            if (target.matches('.score-input, .exam-input')) {
                // Live UI update for totals
                updateStudentRowTotals(target.closest('tr'));
                // [THE FIX] Trigger the debounced save logic on every input
                handlePropagation(target); 
            }
        });
        // Initial calculation for all rows on load.
        table.querySelectorAll('tbody tr').forEach(row => updateStudentRowTotals(row));
    }

    function updateStudentRowTotals(rowElement) {
        if (!rowElement) return;

        const table = rowElement.closest('table#gradebook-table');
        if (!table) return;

        // --- Part 1: Per-unit summary calculation (No changes here) ---
        rowElement.querySelectorAll('.unit-summary-input').forEach(summaryInput => {
            const unitId = summaryInput.dataset.unitId;
            let currentUnitSum = 0;
            rowElement.querySelectorAll(`.score-input[data-unit-id="${unitId}"]`).forEach(itemInput => {
                currentUnitSum += parseFloat(itemInput.value) || 0;
            });
            summaryInput.value = Number(currentUnitSum.toFixed(2));
        });

        // --- Part 2: REBUILT Grade Calculation Logic with MS > R > Score Hierarchy ---
        let finalGrade = '';
        let gradeClass = 'grade-display fw-bold';
        let hasIncompleteWork = false;

        // HIERARCHY 1: Check for "มส" status first
        const hasMsStatus = rowElement.dataset.hasMs === 'true';

        if (hasMsStatus) {
            finalGrade = 'มส';
            gradeClass += ' text-danger';
        } else {
            // HIERARCHY 2: Check for "ร" status
            // Step 2.1: Check for incomplete SUMMATIVE items
            const summativeIds = JSON.parse(table.dataset.summativeIds || '[]');
            if (summativeIds.length > 0) {
                rowElement.querySelectorAll('.score-input').forEach(input => {
                    const itemId = parseInt(input.dataset.itemId.replace('g-', ''));
                    if (summativeIds.includes(itemId) && input.value.trim() === '') {
                        hasIncompleteWork = true;
                    }
                });
            }

            // Step 2.2: Check for incomplete EXAM scores
            const midtermInput = rowElement.querySelector('.exam-input[data-exam-type="midterm"]');
            const finalInput = rowElement.querySelector('.exam-input[data-exam-type="final"]');
            
            if (midtermInput && midtermInput.value.trim() === '') hasIncompleteWork = true;
            if (finalInput && finalInput.value.trim() === '') hasIncompleteWork = true;

            if (hasIncompleteWork) {
                finalGrade = 'ร';
                gradeClass += ' text-danger';
            } else {
                // HIERARCHY 3: Calculate grade by score
                let collectedScore = 0;
                rowElement.querySelectorAll('.score-input').forEach(input => {
                    collectedScore += parseFloat(input.value) || 0;
                });
                const midtermScore = midtermInput ? (parseFloat(midtermInput.value) || 0) : 0;
                const finalScore = finalInput ? (parseFloat(finalInput.value) || 0) : 0;
                let overallTotalScore = collectedScore + midtermScore + finalScore;

                const grandMax = parseFloat(table.dataset.grandMaxScore) || 100;
                let percent = (grandMax > 0) ? (overallTotalScore / grandMax) * 100 : 0;

                // Update score displays
                rowElement.querySelector('.collected-score-display').textContent = collectedScore.toFixed(2).replace(/\.00$/, '');
                rowElement.querySelector('.total-score-display').textContent = overallTotalScore.toFixed(2).replace(/\.00$/, '');
                rowElement.querySelector('.percentage-display').textContent = `${percent.toFixed(0)}%`;
                
                function mapToGrade(p) {
                    if (p >= 80) return '4'; if (p >= 75) return '3.5'; if (p >= 70) return '3';
                    if (p >= 65) return '2.5'; if (p >= 60) return '2'; if (p >= 55) return '1.5';
                    if (p >= 50) return '1'; return '0';
                }
                const calculatedGrade = mapToGrade(percent);
                finalGrade = calculatedGrade;
                if (calculatedGrade === '0') gradeClass += ' text-danger';
            }
        }
        
        // --- Part 3: Update UI ---
        const gradeDisplay = rowElement.querySelector('.grade-display');
        if (gradeDisplay) {
            gradeDisplay.textContent = finalGrade;
            gradeDisplay.className = gradeClass;
        }
    }

    /**
     * Shows/hides gradebook columns based on the selected unit ID.
     * @param {string} unitId The ID of the unit to show.
     */
    function filterGradebookColumns(unitId) {
        const table = document.getElementById('gradebook-table');
        if (!table) return;

        // ซ่อนทุกคอลัมน์ก่อน
        table.querySelectorAll('.unit-column').forEach(col => {
            col.style.display = 'none';
        });

        // แสดงเฉพาะหน่วยที่เลือก
        const selector = `.unit-id-${unitId}`;
        table.querySelectorAll(selector).forEach(col => {
            col.style.display = 'table-cell';
        });
    }

    /**
     * Sets the visual 'active' state on the unit list menu.
     * Used by the gradebook filter.
     * @param {string} unitId The ID of the unit to highlight.
     */
    function setActiveUnitFilter(unitId) {
        // Update left sidebar visual state
        document.querySelectorAll('#unitList a').forEach(a => {
            a.classList.toggle('active', a.dataset.unitId === unitId);
        });
    }
    
    // -------------------------------------------
    // 5. MODAL & OTHER HELPER FUNCTIONS
    // -------------------------------------------
        
    // --- Unit CRUD Functions ---
    async function handleUnitCreate(e) {
        e.preventDefault();
        const titleInput = this.querySelector('#unit-title-input');
        const title = titleInput ? titleInput.value.trim() : '';
        if (!title) {
            return Swal.fire('ข้อผิดพลาด', 'ชื่อหน่วยการเรียนรู้ห้ามว่างเปล่า', 'error');
        }

        const createUrl = unitList.dataset.createUnitUrl;
        try {
            const response = await fetch(createUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ title: title })
            });

            const data = await response.json();

            if (data.status === 'success') {
                unitFormModal.hide();
                Swal.fire({ 
                    icon: 'success', 
                    title: 'สำเร็จ!', 
                    text: 'สร้างหน่วยใหม่เรียบร้อย', 
                    timer: 1500, 
                    showConfirmButton: false 
                });

                const newUnitLink = document.createElement('a');
                newUnitLink.href = '#';
                newUnitLink.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                newUnitLink.dataset.unitId = data.unit.id;
                newUnitLink.dataset.deleteUrl = `/teacher/api/units/${data.unit.id}`;
                newUnitLink.innerHTML = `<span class="unit-title">${data.unit.title}</span><button class="btn btn-sm btn-outline-danger delete-unit-btn border-0" title="Delete Unit"><i class="bi bi-trash"></i></button>`;

                const placeholder = document.getElementById('no-units-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }

                unitList.appendChild(newUnitLink);
                unitHoursData[data.unit.id] = 0;
                setActiveUnit(data.unit.id.toString());
            } else {
                Swal.fire('เกิดข้อผิดพลาด', data.message || 'ไม่สามารถสร้างหน่วยได้', 'error');
            }
        } catch (error) {
            Swal.fire('การเชื่อมต่อล้มเหลว', 'ไม่สามารถสร้างหน่วยได้', 'error');
        }
    }

    function handleUnitDelete(unitLink) {
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณแน่ใจหรือไม่ว่าต้องการลบหน่วยนี้?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ใช่, ลบเลย'
        }).then(result => {
            if (result.isConfirmed) {
                fetch(unitLink.dataset.deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            const wasActive = unitLink.dataset.unitId === activeUnitId;
                            unitLink.remove();
                            if (wasActive) {
                                activeUnitId = null;
                                workspaceTabsContent.innerHTML = `<div id="initial-message" class="text-center text-muted py-5">
                                    <h4><i class="bi bi-arrow-left-circle"></i> Please select a learning unit</h4>
                                    <p>Select a unit from the menu on the left to get started.</p>
                                </div>`;
                            }
                            if (unitList.children.length === 0) {
                                unitList.innerHTML = '<div id="no-units-placeholder" class="list-group-item text-muted text-center">ยังไม่มีหน่วยการเรียนรู้</div>';
                            }
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'ลบหน่วยแล้ว',
                                showConfirmButton: false,
                                timer: 2000
                            });
                        } else {
                            Swal.fire('ผิดพลาด!', data.message, 'error');
                        }
                    });
            }
        });
    }

    // =================================================================
    //  GRADEBOOK SUMMARY TAB SPECIFIC FUNCTIONS
    // =================================================================

    async function loadAndRenderGradebookSummary(courseId, classroomId) {
        const container = document.getElementById('gradebook-container');
        if (!container) return;
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">กำลังโหลด...</p></div>';
        try {
            const url = `/teacher/api/course/${courseId}/gradebook-data?classroom_id=${classroomId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
            const data = await response.json();
            renderSummaryTable(data, container);
        } catch (error) {
            container.innerHTML = `<div class="text-center text-danger p-5"><strong>เกิดข้อผิดพลาด:</strong> ${error.message}</div>`;
        }
    }

    function renderSummaryTable(data, container) {
        if (!data.students || data.students.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-muted">ไม่พบข้อมูลนักเรียน</div>';
            return;
        }

        const max_midterm = data.total_midterm_max_score || 0;
        const max_final = data.total_final_max_score || 0;
        const grand_max = data.grand_max_score || 0;
        const collectedScores = {};
        data.students.forEach(s => {
            let total = 0;
            data.units_data.forEach(u => u.items.forEach(i => total += data.scores[`${s.id}-${i.id}`]?.score ?? 0));
            collectedScores[s.id] = total;
        });

        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0" id="grade-summary-table" data-grand-max="${grand_max}">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">เลขที่</th><th>ชื่อ-สกุล</th><th class="text-center">คะแนนเก็บ</th>
                            <th class="text-center">กลางภาค (${max_midterm})</th><th class="text-center">ปลายภาค (${max_final})</th>
                            <th class="text-center">รวม (${grand_max})</th><th class="text-center">เกรด</th>
                        </tr>
                    </thead><tbody>`;
        data.students.forEach(s => {
            tableHtml += `
                <tr data-student-id="${s.id}">
                    <td class="text-center">${s.roll_number}</td><td>${s.first_name} ${s.last_name}</td>
                    <td class="text-center collected-score-cell">${collectedScores[s.id].toFixed(2).replace(/\.00$/, '')}</td>
                    <td class="p-1"><input type="number" class="form-control form-control-sm text-center score-input midterm-score-input" value="${s.midterm_score ?? ''}" max="${max_midterm}" min="0"></td>
                    <td class="p-1"><input type="number" class="form-control form-control-sm text-center score-input final-score-input" value="${s.final_score ?? ''}" max="${max_final}" min="0"></td>
                    <td class="text-center fw-bold total-score-cell">-</td><td class="text-center fw-bold grade-cell">-</td>
                </tr>`;
        });
        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
        container.querySelectorAll('tbody tr').forEach(row => recalculateSummaryRow(row));
    }

    function recalculateSummaryRow(row) {
        const table = row.closest('table');
        if(!table) return;
        const grandMax = parseFloat(table.dataset.grandMax);
        const collected = parseFloat(row.querySelector('.collected-score-cell')?.textContent) || 0;
        const midterm = parseFloat(row.querySelector('.midterm-score-input')?.value) || 0;
        const final = parseFloat(row.querySelector('.final-score-input')?.value) || 0;
        const totalScore = collected + midterm + final;
        const percentage = (grandMax > 0) ? (totalScore / grandMax) * 100 : 0;

        let grade = '0';
        if (percentage >= 80) grade = '4'; else if (percentage >= 75) grade = '3.5';
        else if (percentage >= 70) grade = '3'; else if (percentage >= 65) grade = '2.5';
        else if (percentage >= 60) grade = '2'; else if (percentage >= 55) grade = '1.5';
        else if (percentage >= 50) grade = '1';

        row.querySelector('.total-score-cell').textContent = totalScore.toFixed(2).replace(/\.00$/, '');
        row.querySelector('.grade-cell').textContent = grade;
    }

    // =================================================================
    //  4. INITIALIZERS & HELPER FUNCTIONS
    // =================================================================

    /**
     * สร้าง HTML สำหรับแสดงป้ายแจ้งเตือน (Alert Badges)
     * @param {object} alerts - อ็อบเจกต์การแจ้งเตือน เช่น { 'ติด 0': 'คะแนนไม่ถึงครึ่ง' }
     * @returns {string} - โค้ด HTML ของป้ายแจ้งเตือน
     */
    function renderAlerts(alerts) {
        if (!alerts || Object.keys(alerts).length === 0) return '';

        let badgesHtml = '';
        for (const key in alerts) {
            const message = alerts[key];
            // --- NEW: Add condition for different badge color ---
            let badgeClass = 'bg-danger'; // Default to red for '0' and 'ร'
            if (key === 'กรอกคะแนน') {
                badgeClass = 'bg-info text-dark'; // Use blue for "Enter Scores"
            }
            badgesHtml += ` <span class="badge ${badgeClass} ms-1" title="${message}">${key}</span>`;
        }
        return badgesHtml;
    }

    // =======================================================
    // NEW GRADEBOOK ARCHITECTURE (FINAL)
    // =======================================================

    function createStudentElement(enrollment) {
        return `<div class="list-group-item list-group-item-action p-2" data-id="${enrollment.id}">
                    <small>${enrollment.roll_number}. ${enrollment.name}</small>
                </div>`;
    }

    function initializeAllSortables() {
        sortableInstances.forEach(s => s.destroy());
        sortableInstances = [];
        document.querySelectorAll('#groupManagementModal .list-group').forEach(list =>
            sortableInstances.push(new Sortable(list, {
                group: 'students',
                animation: 150,
                ghostClass: 'bg-primary-soft'
            }))
        );
    }

    // --- Core Functions ---
    function renderGroupManagerUI(groups = []) {
        const ungroupedList = document.getElementById('ungrouped-students-list');
        const groupsContainer = document.getElementById('groups-container');
        ungroupedList.innerHTML = '';
        groupsContainer.innerHTML = '';

        const groupedIds = new Set(groups.flatMap(g => g.enrollments));

        allEnrollments.filter(en => !groupedIds.has(en.id))
            .forEach(en => ungroupedList.innerHTML += createStudentElement(en));

        groups.forEach(group => {
            let membersHtml = '';
            allEnrollments.filter(en => group.enrollments.includes(en.id))
                .forEach(member => membersHtml += createStudentElement(member));

            groupsContainer.insertAdjacentHTML(
                'beforeend',
                createGroupCard({ id: group.id, name: group.name }, membersHtml)
            );
        });

        initializeAllSortables();
    }

    async function saveGroups() {
        const saveBtn = document.getElementById('save-groups-btn');
        const classroomSelector = document.getElementById('classroom-selector');
        const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
        const planId = unitList.dataset.planId;

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> กำลังบันทึก...`;

        const payload = {
            groups: Array.from(document.querySelectorAll('#groups-container .group-card')).map(card => ({
                id: card.dataset.groupId.startsWith('new-') ? null : parseInt(card.dataset.groupId),
                name: card.querySelector('.group-name-input').value.trim(),
                members: Array.from(card.querySelectorAll('.list-group-item[data-id]')).map(item => parseInt(item.dataset.id))
            })).filter(g => g.name),
            course_id: courseId
        };

        try {
            const response = await fetch(`/teacher/api/plan/${planId}/groups`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Server error on save.');
            Swal.fire('สำเร็จ!', 'บันทึกการจัดกลุ่มเรียบร้อยแล้ว', 'success');
            groupModal.hide();
            // Reload gradebook to reflect new group assignments
            fetchAndRenderGradebookTable(classroomSelector, state.activeUnitId);
        } catch (error) {
            Swal.fire('ผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'บันทึกการจัดกลุ่ม';
        }
    }

    //--------------------------------------------------------
    // 🧩 ฟังก์ชันสร้างกล่องกลุ่มหลัก (คงไว้เพียงตัวเดียว)
    //--------------------------------------------------------
    function createGroupCard(group, membersHtml = '') {
        return `
            <div class="card mb-3 group-card" data-group-id="${group.id}">
                <div class="card-header p-2 d-flex justify-content-between align-items-center">
                    <input type="text" class="form-control form-control-sm group-name-input" value="${group.name}">
                    <button class="btn btn-xs btn-outline-danger ms-2 delete-group-btn border-0">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <!-- ใช้ class group-dropzone ให้เหมือนกันทุกจุด -->
                <div class="card-body p-2 list-group group-dropzone" style="min-height: 50px;">
                    ${membersHtml}
                </div>
            </div>`;
    }

/**
     * [REVISED & CORRECTED]
     * จัดการการผูก Event Listener สำหรับปุ่มต่างๆ ภายใน Modal จัดการกลุ่ม
     * ป้องกันการผูก Event ซ้ำซ้อน และรับประกันว่าปุ่มจะทำงานได้เสมอ
     */
    function bindGroupManagerEvents() {
        const modalEl = document.getElementById('groupManagementModal');
        // ป้องกันการผูก Event ซ้ำ โดยการเพิ่ม 'data-events-bound' flag
        if (modalEl.dataset.eventsBound) {
            return;
        }
        modalEl.dataset.eventsBound = 'true'; // ตั้งค่า flag ว่าผูก Event แล้ว

        modalEl.addEventListener('click', async (e) => {
            const target = e.target;
            const groupsContainer = document.getElementById('groups-container');

            // ➕ สร้างกลุ่มใหม่
            if (target.closest('#add-new-group-btn')) {
                const groupHtml = createGroupCard(
                    { id: `new-${Date.now()}`, name: `กลุ่มที่ ${groupsContainer.children.length + 1}` }, ''
                );
                groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
                initializeAllSortables();
            }
            // 🤖 สร้างกลุ่มอัตโนมัติ
            else if (target.closest('#auto-generate-groups-btn')) {
                const { value: numGroups } = await Swal.fire({
                    target: document.getElementById('groupManagementModal'), // ทำให้ Swal แสดงใน Modal
                    title: 'สร้างกลุ่มอัตโนมัติ',
                    input: 'number',
                    inputLabel: 'คุณต้องการสร้างกี่กลุ่ม?',
                    inputPlaceholder: 'ใส่จำนวนกลุ่ม',
                    showCancelButton: true,
                    confirmButtonText: 'สร้างกลุ่ม',
                    cancelButtonText: 'ยกเลิก',
                    inputValidator: (value) => {
                        if (!value || value < 1) return 'กรุณาใส่จำนวนกลุ่มที่ถูกต้อง!';
                    }
                });

                if (numGroups) {
                    const ungroupedStudents = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));
                    
                    // สุ่มลำดับนักเรียน
                    for (let i = ungroupedStudents.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [ungroupedStudents[i], ungroupedStudents[j]] = [ungroupedStudents[j], ungroupedStudents[i]];
                    }

                    // สร้างกล่องกลุ่มเปล่าๆ
                    groupsContainer.innerHTML = '';
                    const newGroupElements = [];
                    for (let i = 1; i <= numGroups; i++) {
                        const groupId = `new-${Date.now()}-${i}`;
                        groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `กลุ่มที่ ${i}` }, ''));
                        newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
                    }

                    // แจกนักเรียนเข้ากลุ่ม
                    if (newGroupElements.length > 0) {
                        ungroupedStudents.forEach((studentNode, index) => {
                            newGroupElements[index % numGroups].appendChild(studentNode);
                        });
                    }
                    initializeAllSortables();
                }
            }
            // 🗑️ ลบกลุ่ม
            else if (target.closest('.delete-group-btn')) {
                const card = target.closest('.group-card');
                if (card) {
                    card.querySelectorAll('.list-group-item')
                        .forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                    card.remove();
                }
            }
            // 💾 บันทึกการจัดกลุ่ม
            else if (target.closest('#save-groups-btn')) {
                saveGroups();
            }
        });
    }


    /**
     * [REVISED & CORRECTED]
     * เปิด Modal จัดการกลุ่ม, โหลดข้อมูล, และเรียกใช้ฟังก์ชันผูก Event
     */
    async function openGroupManager() {
        const classroomSelector = document.getElementById('classroom-selector');
        if (!classroomSelector || !classroomSelector.value) {
            return Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกห้องเรียนก่อนจัดการกลุ่ม', 'warning');
        }
        const courseId = classroomSelector.options[classroomSelector.selectedIndex].dataset.courseId;
        const planId = unitList.dataset.planId;

        const loader = document.getElementById('group-manager-loader');
        const content = document.getElementById('group-manager-content');
        loader.classList.remove('d-none');
        content.style.display = 'none';
        groupModal.show();

        try {
            const groupsUrl = `/teacher/api/plan/${planId}/groups?course_id=${courseId}`;
            const [enrollmentsRes, groupsRes] = await Promise.all([
                fetch(`/teacher/api/classrooms/${classroomSelector.value}/enrollments`),
                fetch(groupsUrl)
            ]);
            if (!enrollmentsRes.ok || !groupsRes.ok) throw new Error('Could not fetch initial data.');

            allEnrollments = await enrollmentsRes.json();
            const groups = await groupsRes.json();
            
            // 1. Render UI ก่อนเสมอ
            renderGroupManagerUI(groups);

            loader.classList.add('d-none');
            content.style.display = 'flex';

            // 2. ทำให้ Sortable ทำงาน
            initializeAllSortables();
            
            // 3. ✅✅✅ [THE FIX] เรียกผูก Event Listener ที่นี่!
            bindGroupManagerEvents();

        } catch (error) {
            console.error("Error opening group manager:", error);
            loader.innerHTML = `<div class="text-danger">${error.message}</div>`;
        }
    }

    /**
     * Auto-generates groups and distributes students.
     */
    async function autoGenerateGroups() {
        const {
            value: numGroups
        } = await Swal.fire({
            target: document.getElementById('groupManagementModal'),
            title: 'สร้างกลุ่มอัตโนมัติ',
            input: 'number',
            inputLabel: 'คุณต้องการสร้างกี่กลุ่ม?',
            inputPlaceholder: 'ใส่จำนวนกลุ่ม',
            showCancelButton: true,
            confirmButtonText: 'สร้างกลุ่ม',
            cancelButtonText: 'ยกเลิก',
            inputValidator: (value) => {
                if (!value || value < 1) {
                    return 'กรุณาใส่จำนวนกลุ่มที่ถูกต้อง!'
                }
            }
        });

        if (numGroups) {
            const groupsContainer = document.getElementById('groups-container');
            // CORRECTED: Select students using the correct 'data-id' attribute
            const ungroupedStudents = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));

            groupsContainer.innerHTML = '';

            for (let i = ungroupedStudents.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [ungroupedStudents[i], ungroupedStudents[j]] = [ungroupedStudents[j], ungroupedStudents[i]];
            }

            const newGroupElements = [];
            for (let i = 1; i <= numGroups; i++) {
                const groupId = `new-${Date.now()}-${i}`;
                groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `กลุ่มที่ ${i}` }, ''));
                newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
            }

            if (newGroupElements.length > 0) {
                ungroupedStudents.forEach((studentNode, index) => {
                    newGroupElements[index % numGroups].appendChild(studentNode);
                });
            }
            initializeAllSortables();
        }
    }

    /**
     * Handles changes for exam scores, syncs UI, saves data, and updates summary.
     */
    async function handleExamScoreChange(e) {
        // Find the parent elements for the specific unit being edited
        const unitContainer = e.target.closest('.accordion-collapse');
        if (!unitContainer) return;

        const unitId = unitContainer.id.replace('collapse-unit-', '');

        const midtermSwitch = unitContainer.querySelector('#midterm-switch-' + unitId);
        const finalSwitch = unitContainer.querySelector('#final-switch-' + unitId);
        const midtermInput = unitContainer.querySelector('.exam-score-input[data-exam-type="midterm"]');
        const finalInput = unitContainer.querySelector('.exam-score-input[data-exam-type="final"]');

        // Part 1: Sync UI state immediately
        // Sync UI state
        if (midtermSwitch && midtermInput) {
            midtermInput.disabled = !midtermSwitch.checked;
            if (!midtermSwitch.checked) midtermInput.value = '';
        }
        if (finalSwitch && finalInput) {
            finalInput.disabled = !finalSwitch.checked;
            if (!finalSwitch.checked) finalInput.value = '';
        }


        // Immediately update the summary panel for real-time feedback
        updateSummaryPanel();

        // Part 2: Construct payload and save to server (debounced)
        // Debounced save
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(async () => {
            const payload = {
                midterm_score: midtermSwitch.checked ? (parseFloat(midtermInput.value) || null) : null,
                final_score: finalSwitch.checked ? (parseFloat(finalInput.value) || null) : null
            };

            try {
                const response = await fetch(`/teacher/api/units/${unitId}/exam-scores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Server returned an error');

                const result = await response.json();
                if (result.status === 'success') {
                    // The existing code has a better popup, let's keep it.
                    // No need for a separate success popup here as the logic is handled 
                    // within the original handleExamScoreChange function in the provided HTML file.
                } else {
                    throw new Error(result.message || 'Application error');
                }
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกคะแนนสอบได้', 'error');
                console.error("Save Error:", error);
            }
        }, 500); // 500ms debounce
    }

    function renderSelectedIndicators(tomSelectInstance) {
        const displayArea = document.getElementById('indicator-display-area');
        if (!displayArea) return;
        displayArea.innerHTML = '';

        const selectedItems = tomSelectInstance.items.map(id => tomSelectInstance.options[id]);

        const groupedByStandard = selectedItems.reduce((acc, option) => {
            if (!option || !option.standard_id) return acc;
            const stdId = option.standard_id;
            if (!acc[stdId]) {
                acc[stdId] = {
                    code: option.standard_code,
                    desc: option.standard_desc,
                    indicators: []
                };
            }
            acc[stdId].indicators.push({
                id: option.id,
                code: option.indicator_code,
                desc: option.indicator_desc
            });
            return acc;
        }, {});

        const sortedGroupKeys = Object.keys(groupedByStandard).sort((a, b) => {
            return groupedByStandard[a].code.localeCompare(groupedByStandard[b].code);
        });

        for (const stdId of sortedGroupKeys) {
            const group = groupedByStandard[stdId];
            const groupDiv = document.createElement('div');
            groupDiv.className = 'indicator-group mt-3';

            const header = document.createElement('div');
            header.className = 'h6';
            header.innerHTML = `<i class="bi bi-bookmark-star-fill text-primary"></i> ${group.code} ${group.desc}`;
            groupDiv.appendChild(header);

            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';

            group.indicators.sort((a, b) => a.code.localeCompare(b.code));

            group.indicators.forEach(indicator => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center ps-4';

                const textSpan = document.createElement('span');
                textSpan.textContent = `${indicator.code} ${indicator.desc}`;
                listItem.appendChild(textSpan);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger border-0 flex-shrink-0 ms-2';
                removeBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
                removeBtn.title = 'ลบตัวชี้วัดนี้';
                removeBtn.onclick = () => tomSelectInstance.removeItem(indicator.id);

                listItem.appendChild(removeBtn);
                list.appendChild(listItem);
            });

            groupDiv.appendChild(list);
            displayArea.appendChild(groupDiv);
        }
    }

    function setupGradedItemModal() {
        const modalEl = document.getElementById('addAssessmentItemModal');
        if (!modalEl) {
             console.error("Modal #addAssessmentItemModal not found!");
             return;
        }
        const itemModal = bootstrap.Modal.getOrCreateInstance(modalEl); // Use getOrCreateInstance
        const itemForm = document.getElementById('addAssessmentItemForm');
        if (!itemForm) {
            console.error("Form #addAssessmentItemForm not found!");
            return;
        }

        // --- [REVISED] Use a flag to prevent multiple bindings ---
        if (modalEl.dataset.listenerAttached) {
            console.log("Listener already attached to #addAssessmentItemModal");
            return;
        }
        modalEl.dataset.listenerAttached = 'true';
        // --- End Revision ---

        modalEl.addEventListener('show.bs.modal', async function(event) {
            console.log("Modal show.bs.modal event triggered.");
            const button = event.relatedTarget;
            // Handle case where modal might be shown programmatically without a button
            const action = button ? button.dataset.action : 'add';
            console.log("Modal Action:", action);

            itemForm.reset(); // Reset form first
            this.querySelector('.modal-title').textContent = action === 'edit' ? 'แก้ไขรายการคะแนนเก็บ' : 'เพิ่มรายการคะแนนเก็บ';
            itemForm.dataset.action = action; // Set action on the form

            if (action === 'edit' && button) {
                const itemId = button.dataset.itemId;
                itemForm.dataset.itemId = itemId; // Store itemId on form
                console.log("Attempting to edit item ID:", itemId);

                try {
                    console.log(`Fetching data from: /teacher/api/graded-items/${itemId}`);
                    const response = await fetch(`/teacher/api/graded-items/${itemId}`);
                    console.log("Fetch response status:", response.status);

                    if (!response.ok) {
                         // Try to get error message from server if possible
                         let errorMsg = `Server responded with status ${response.status}`;
                         try {
                             const errorData = await response.json();
                             errorMsg = errorData.message || errorMsg;
                         } catch (jsonError) {
                              errorMsg += ` (${response.statusText})`;
                         }
                         console.error("Failed to fetch item data:", errorMsg);
                         Swal.fire('ผิดพลาด!', `ไม่สามารถโหลดข้อมูลรายการเดิมได้: ${errorMsg}`, 'error');
                         itemModal.hide(); // Hide modal if data fetch fails
                         return; // Stop if fetch failed
                    }

                    const data = await response.json();
                    console.log("Fetched item data:", data);

                    // Populate the form
                    Object.keys(data).forEach(key => {
                        // Find input/select by name attribute
                        const input = itemForm.querySelector(`[name="${key}"]`);
                        if (input) {
                            console.log(`Populating field [name="${key}"] with value:`, data[key]);
                            input.value = data[key]; // Set value
                        } else {
                            console.warn(`Input field with name '${key}' not found in the form.`);
                        }
                    });
                     console.log("Form population complete.");

                } catch (error) {
                    console.error("Error during fetch or form population:", error);
                    Swal.fire('ผิดพลาด!', `เกิดข้อผิดพลาดขณะโหลดข้อมูล: ${error.message}`, 'error');
                    itemModal.hide(); // Hide modal on catch
                }
            } else { // Handle 'add' action or modal shown without button
                const unitId = button ? button.dataset.unitId : state.activeUnitId; // Fallback to active unit if no button
                console.log("Setting up modal for ADD action, unit ID:", unitId);
                itemForm.dataset.unitId = unitId;
                const unitIdInput = itemForm.querySelector('#modal-learningUnitId');
                if (unitIdInput) {
                    unitIdInput.value = unitId || '';
                } else {
                    console.warn("Hidden input #modal-learningUnitId not found.");
                }
                delete itemForm.dataset.itemId; // Ensure itemId is not set for add action
            }
        });

        // --- [REVISED] Attach submit listener only ONCE ---
        itemForm.addEventListener('submit', async function(e) {
             e.preventDefault();
             console.log("Form submitted. Action:", this.dataset.action);
             const action = this.dataset.action;
             const formData = new FormData(this);
             const data = Object.fromEntries(formData.entries());
             console.log("Form Data:", data);

             const method = action === 'edit' ? 'PUT' : 'POST';
             const url = action === 'edit' ?
                 `/teacher/api/graded-items/${this.dataset.itemId}` :
                 `/teacher/api/units/${this.dataset.unitId}/graded-items`; // Use unitId from dataset

             console.log(`Submitting to URL: ${url} with method: ${method}`);

             try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(data)
                });
                console.log("Submit response status:", response.status);

                const result = await response.json();
                console.log("Submit response data:", result);

                if (result.status === 'success') {
                    itemModal.hide();
                    Swal.fire({ icon: 'success', title: 'สำเร็จ!', text: result.message, timer: 1500, showConfirmButton: false });
                    // Reload the current tab content to show changes
                    loadTabContent(state.activeTabId);
                    updateSummaryPanel(); // Update summary after successful save
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกรายการได้', 'error');
                }
            } catch(error) {
                 console.error("Submit error:", error);
                 Swal.fire('ผิดพลาด!', `การเชื่อมต่อล้มเหลว: ${error.message}`, 'error');
            }
        });
        // --- End Revision ---
        // Assuming you have code like this to get the modal element:
        const subUnitModalEl = document.getElementById('subUnitModal'); 

        if (subUnitModalEl) { // Check if modal exists in this specific template
            subUnitModalEl.addEventListener('show.bs.modal', async (event) => {
                const button = event.relatedTarget; // Button that triggered the modal
                const subUnitId = button.dataset.subunitId; // Get ID from edit button

                // --- [NEW] Code to update Export Button links ---
                const exportPdfBtn = document.getElementById('exportSubUnitPdfBtn');
                const exportDocxBtn = document.getElementById('exportSubUnitDocxBtn');

                if (subUnitId) { // Only show buttons if editing an existing subunit (has ID)
                    const pdfUrl = `/teacher/subunit/${subUnitId}/export/pdf`; 
                    const docxUrl = `/teacher/subunit/${subUnitId}/export/docx`; 

                    exportPdfBtn.href = pdfUrl;
                    exportDocxBtn.href = docxUrl;
                    exportPdfBtn.style.display = 'inline-block'; // Show 
                    exportDocxBtn.style.display = 'inline-block'; // Show
                } else {
                    // Hide buttons when creating a new subunit (no ID yet)
                    exportPdfBtn.style.display = 'none';
                    exportDocxBtn.style.display = 'none';
                }
                // --- End New Code ---
            });
        } // End if (subUnitModalEl)        
    }

    function setupRatioTargetModal() {
        const modalEl = document.getElementById('ratioTargetModal');
        if (!modalEl) return;
        const ratioModal = new bootstrap.Modal(modalEl);
        const saveBtn = modalEl.querySelector('#saveRatioTargetBtn');
        const deleteBtn = modalEl.querySelector('#deleteRatioTargetBtn');
        const midRatioInput = modalEl.querySelector('#target-mid-ratio');
        const finalRatioInput = modalEl.querySelector('#target-final-ratio');

        const syncInputs = (source, target) => {
            const sourceValue = Math.max(0, Math.min(100, parseInt(source.value) || 0));
            source.value = sourceValue;
            target.value = 100 - sourceValue;
        };
        midRatioInput.addEventListener('input', () => syncInputs(midRatioInput, finalRatioInput));
        finalRatioInput.addEventListener('input', () => syncInputs(finalRatioInput, midRatioInput));

        saveBtn.addEventListener('click', async () => {
            const midVal = parseInt(midRatioInput.value) || 0;
            const finalVal = parseInt(finalRatioInput.value) || 0;
            if (midVal + finalVal !== 100) return Swal.fire('ข้อผิดพลาด', 'ผลรวมของสัดส่วนต้องเป็น 100', 'error');

            const response = await fetch(`/teacher/api/plan/${planId}/ratio-target`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    mid_ratio: midVal,
                    final_ratio: finalVal
                })
            });

            if (response.ok) {
                targetMidRatio = midVal;
                targetFinalRatio = finalVal;
                isTargetSetByUser = true;
                ratioModal.hide();
                updateSummaryPanel();
            } else {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกสัดส่วนเป้าหมายได้', 'error');
            }
        });

        deleteBtn.addEventListener('click', async () => {
            const response = await fetch(`/teacher/api/plan/${planId}/ratio-target`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                isTargetSetByUser = false;
                targetMidRatio = 80;
                targetFinalRatio = 20;
                midRatioInput.value = 80;
                finalRatioInput.value = 20;
                ratioModal.hide();
                updateSummaryPanel();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'ล้างค่าเป้าหมายแล้ว',
                    showConfirmButton: false,
                    timer: 2000
                });
            } else {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถล้างค่าเป้าหมายได้', 'error');
            }
        });
    }

        // --- 3. Helper function to get badge style ---
        function getStatusBadge(status) {
            switch (status) {
                case 'PRESENT': return { text: '✔', class: 'bg-success' };
                case 'LATE':    return { text: 'ส', class: 'bg-warning text-dark' };
                case 'ABSENT':  return { text: 'ข', class: 'bg-danger' };
                case 'LEAVE':   return { text: 'ล', class: 'bg-info text-dark' };
                default:        return { text: '✔', class: 'bg-success' };
            }
        }

        // --- 4. Helper function to update a badge's appearance ---
        function updateBadge(badgeElement, newStatus) {
            const style = getStatusBadge(newStatus);
            badgeElement.dataset.status = newStatus;
            badgeElement.className = `badge rounded-pill fs-6 attendance-badge ${style.class}`;
            badgeElement.textContent = style.text;
        }

        // --- 5. Main Table Rendering Function (NEW) ---            
        function renderAttendanceTable(data, container) {
            if (!data.students || data.students.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">ไม่พบข้อมูลนักเรียน</p>';
                return;
            }

            let tableHtml = '<div class="table-responsive"><table class="table table-bordered table-sm small">';
            
            // --- Build Header ---
            let headerRow1 = '<tr><th rowspan="2" class="align-middle" style="min-width: 150px;">ชื่อ-สกุล</th>';
            let headerRow2 = '<tr>';
            
            data.sessions.forEach((session, index) => {
                const sessionDate = new Date(session.date + 'T00:00:00'); // Ensure correct date parsing
                const formattedDate = sessionDate.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
                headerRow1 += `<th class="text-center">${index + 1}</th>`; // Period Number
                headerRow2 += `<th class="text-center text-nowrap">${formattedDate}</th>`; // Actual Date
            });
            headerRow1 += '</tr>';
            headerRow2 += '</tr>';
            tableHtml += `<thead class="table-light text-center align-middle sticky-top">${headerRow1}${headerRow2}</thead>`;

            // --- Build Body ---
            tableHtml += '<tbody>';
            data.students.forEach(student => {
                tableHtml += `<tr><td class="text-nowrap text-start sticky-left">${student.roll_number}. ${student.name}</td>`;
                data.sessions.forEach(session => {
                    const key = `${student.id}-${session.entry_id}-${session.date}`;
                    const status = data.attendance_data[key] || 'PRESENT';
                    const style = getStatusBadge(status);
                    // Determine cell-specific background color
                    let cellClass = '';
                    if (status === 'ABSENT') {
                        cellClass = 'bg-danger-soft'; // A softer red for the cell
                    } else if (status === 'LATE') {
                        cellClass = 'bg-warning-soft'; // A softer yellow
                    }
                    tableHtml += `<td class="text-center p-1 attendance-cell" 
                                    data-student-id="${student.id}" 
                                    data-entry-id="${session.entry_id}" 
                                    data-date="${session.date}">
                                    <span class="badge rounded-pill fs-6 attendance-badge ${style.class}" 
                                        data-status="${status}" 
                                        style="cursor: pointer; width: 35px;">
                                        ${style.text}
                                    </span>
                                </td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }
    
    function renderSubUnit(subUnit) {
        return `
        <div class="card mb-2" id="subunit-card-${subUnit.id}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title mb-1">
                            <span class="badge bg-primary me-2">ชั่วโมงที่ ${subUnit.hour_sequence}</span>
                            <span class="subunit-title">${subUnit.title}</span>
                        </h6>
                        <p class="card-text text-muted small subunit-activities">${subUnit.activities || ''}</p>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary edit-subunit-btn" data-subunit-id="${subUnit.id}">
                            <i class="bi bi-pencil"></i> แก้ไข
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-subunit-btn" data-subunit-id="${subUnit.id}">
                            <i class="bi bi-trash"></i> ลบ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    async function handleAddSubUnit(button) {
        const unitId = button.dataset.unitId;
        const response = await fetch(`/teacher/api/units/${unitId}/sub_units`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        if (response.ok) {
            const newSubUnit = await response.json();
            document.getElementById('no-subunits-placeholder') ?.remove();
            document.getElementById('sub-units-list').insertAdjacentHTML('beforeend', renderSubUnit(newSubUnit));

            const list = document.getElementById('sub-units-list');
            const unitHours = parseInt(button.dataset.unitHours, 10);
            if (list.children.length >= unitHours) {
                button.disabled = true;
            }
        } else {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเพิ่มแผนรายชั่วโมงได้', 'error');
        }
    }

    async function handleEditSubUnit(button) {
        const subUnitId = button.dataset.subunitId;

        const [subUnitResponse, gradedItemsResponse] = await Promise.all([
            fetch(`/teacher/api/sub_units/${subUnitId}`),
            fetch(`/teacher/api/units/${state.activeUnitId}/graded-items-for-selection`)
        ]);

        if (!subUnitResponse.ok || !gradedItemsResponse.ok) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลสำหรับแก้ไขได้', 'error');
            return;
        }

        const data = await subUnitResponse.json();
        const gradedItemsOptions = await gradedItemsResponse.json();

        const modal = document.getElementById('subUnitEditModal');
        modal.querySelector('#modal-subunit-id').value = data.id;
        modal.querySelector('#modal-subunit-title').value = data.title;
        modal.querySelector('#modal-subunit-activities').value = data.activities;

        if (subUnitIndicatorsTomSelect) subUnitIndicatorsTomSelect.destroy();
        subUnitIndicatorsTomSelect = new TomSelect('#modal-subunit-indicators', {
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            options: tomSelect.options,
            items: data.indicator_ids
        });

        if (subUnitGradedItemsTomSelect) subUnitGradedItemsTomSelect.destroy();
        subUnitGradedItemsTomSelect = new TomSelect('#modal-subunit-graded-items', {
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            options: gradedItemsOptions,
            items: data.graded_item_ids
        });

        subUnitEditModal.show();
    }

    async function handleSubUnitFormSubmit(e) {
        e.preventDefault();
        const subUnitId = this.querySelector('#modal-subunit-id').value;
        const data = {
            title: this.querySelector('#modal-subunit-title').value,
            activities: this.querySelector('#modal-subunit-activities').value,
            indicator_ids: subUnitIndicatorsTomSelect.getValue(),
            graded_item_ids: subUnitGradedItemsTomSelect.getValue()
        };

        const response = await fetch(`/teacher/api/sub_units/${subUnitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            subUnitEditModal.hide();
            const card = document.getElementById(`subunit-card-${subUnitId}`);
            if (card) {
                card.querySelector('.subunit-title').textContent = data.title;
                card.querySelector('.subunit-activities').textContent = data.activities;
            }
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'บันทึกสำเร็จ',
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
        }
    }

    function handleDeleteSubUnit(button) {
        const subUnitId = button.dataset.subunitId;
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณแน่ใจหรือไม่ว่าต้องการลบแผนรายชั่วโมงนี้?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ใช่, ลบเลย'
        }).then(async result => {
            if (result.isConfirmed) {
                const response = await fetch(`/teacher/api/sub_units/${subUnitId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                if (response.ok) {
                    document.getElementById(`subunit-card-${subUnitId}`).remove();

                    const addBtn = document.getElementById('add-subunit-btn');
                    const list = document.getElementById('sub-units-list');
                    const unitHours = parseInt(addBtn.dataset.unitHours, 10);
                    if (list.children.length < unitHours) {
                        addBtn.disabled = false;
                    }
                    if (list.children.length === 0) {
                        list.innerHTML = '<p id="no-subunits-placeholder" class="text-muted fst-italic">ยังไม่มีแผนการสอนรายชั่วโมง</p>';
                    }
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบได้', 'error');
                }
            }
        });
    }

    async function handlePlanFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form).entries());
        data.indicators = tomSelect ? tomSelect.getValue() : [];

        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: 'บันทึกแล้ว!',
                text: result.message,
                timer: 1500,
                showConfirmButton: false
            });
            const unitLinkTitle = document.querySelector(`#unitList a[data-unit-id="${state.activeUnitId}"] .unit-title`);
            if (unitLinkTitle && result.new_title) {
                unitLinkTitle.textContent = result.new_title;
            }
        } else {
            Swal.fire('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกแผนได้', 'error');
        }
    }

    function handleGradedItemDelete(itemId) {
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ใช่, ลบเลย'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/teacher/api/graded-items/${itemId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    }).then(response => response.json()).then(data => {
                        if (data.status === 'success') {
                            document.getElementById(`graded-item-${itemId}`) ?.remove();
                            updateSummaryPanel();
                            Swal.fire('ลบแล้ว!', 'รายการถูกลบออกแล้ว', 'success');
                        } else {
                            Swal.fire('ผิดพลาด!', data.message, 'error');
                        }
                    });
            }
        });
    }

    async function openTopicSelectionModal(button) {
        const templateId = button.dataset.templateId;
        const modalEl = document.getElementById('selectTopicsModal');
        modalEl.querySelector('.modal-title').textContent = `เลือกหัวข้อ: ${button.dataset.templateName}`;
        const modalBody = modalEl.querySelector('.modal-body');
        modalBody.innerHTML = '<div class="d-flex justify-content-center p-5"><div class="spinner-border" role="status"></div></div>';

        const saveBtn = modalEl.querySelector('#saveTopicSelectionBtn');
        const saveHandler = async () => {
            const selectedIds = Array.from(modalEl.querySelectorAll('input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
            const response = await fetch(`/teacher/api/units/${activeUnitId}/assessment-items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    template_id: templateId,
                    topic_ids: selectedIds
                })
            });
            const result = await response.json();
            if (result.status === 'success') {
                selectionModal.hide();
                Swal.fire({
                        icon: 'success',
                        title: 'สำเร็จ',
                        text: result.message,
                        timer: 1500,
                        showConfirmButton: false
                    })
                    // After the success message closes, reload the assessment tab's content
                    // to show the newly saved topics.
                    .then(() => {
                        loadTabContent(state.activeTabId);
                    });
            } else {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกการตั้งค่าได้', 'error');
            }
        };
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.addEventListener('click', saveHandler);

        try {
            const [topicsResponse, selectedResponse] = await Promise.all([
                fetch(`/teacher/api/templates/${templateId}/topics-for-selection`),
                fetch(`/teacher/api/units/${activeUnitId}/selected-topics`)
            ]);

            if (!topicsResponse.ok) throw new Error('Could not load topic structure.');
            if (!selectedResponse.ok) throw new Error('Could not load selected topics.');

            const topicTree = await topicsResponse.json();
            const selectedData = await selectedResponse.json();
            const selectedIds = selectedData.selected_ids || [];

            modalBody.innerHTML = buildCheckboxTree(topicTree, selectedIds);
            setupCheckboxLogic(modalBody);
        } catch (error) {
            modalBody.innerHTML = '<div class="alert alert-danger">ไม่สามารถโหลดหัวข้อได้: ${error.message}</div>';
            console.error(error);
        }
    }

    /**
     * NEW: Calculates and displays cumulative periods for ALL units.
     */
    function updateCumulativePeriods() {
        let cumulativePeriods = 0;
        // Iterate through the unit list on the left to maintain correct order
        document.querySelectorAll('#unitList a').forEach(link => {
            const unitId = link.dataset.unitId;
            const periods = unitHoursData[unitId] || 0;

            const displaySpan = workspaceTabsContent.querySelector(`#cumulative-display-${unitId}`);
            if (displaySpan) { // อัปเดตเฉพาะ span ที่มองเห็นอยู่
                if (periods > 0) {
                    const startPeriod = cumulativePeriods + 1;
                    const endPeriod = cumulativePeriods + periods;
                    displaySpan.textContent = `(คาบที่ ${startPeriod}-${endPeriod})`;
                    cumulativePeriods = endPeriod;
                } else {
                    displaySpan.textContent = '';
                }
            } else { // สำหรับ unit ที่ไม่ได้แสดงผล ให้บวกค่าไปเฉยๆ
                if (periods > 0) {
                    cumulativePeriods += periods;
                }
            }
        });
    }

    const saveQualitativeScoresBulk = (scoresData) => {
        const courseId = table.dataset.courseId;
        fetch('/teacher/api/qualitative-score/save-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    scores: scoresData,
                    course_id: courseId
                })
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(result => {
                if (result.status !== 'success') console.error('Qualitative bulk save failed:', result.message);
                // ไม่ต้องทำอะไรต่อ เพราะไม่มี Alert หรือการคำนวณที่ซับซ้อน
            })
            .catch(err => console.error('Qualitative bulk save error:', err));
    };

    const saveExamScoresBulk = (scoresData) => {
        const courseId = table.dataset.courseId;
        fetch('/teacher/api/enrollments/save-exam-score-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    scores: scoresData,
                    course_id: courseId
                })
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(result => {
                if (result.status !== 'success') console.error('Exam bulk save failed:', result.message);
                // ไม่ต้องทำอะไรต่อ เพราะคะแนนสอบไม่มี Alert
            })
            .catch(err => console.error('Exam bulk save error:', err));
    };

    // --- 3. Main Event Listeners (ที่จัดระเบียบใหม่) ---
    /**
     * ฟังก์ชันย่อยที่ 1: กระจายค่าจาก "หัวข้อใหญ่" ไปยัง "หัวข้อย่อย"
     * @param {HTMLElement} mainSelect - Dropdown ของหัวข้อใหญ่ที่ถูกเปลี่ยน
     * @param {string} scope - ขอบเขตการทำงาน ('table' หรือ 'row')
     * @returns {Array} - รายการ elements ทั้งหมดที่มีการเปลี่ยนแปลง
     */
    const propagateMainToSubs = (mainSelect, scope) => {
        const mainId = mainSelect.dataset.topicId;
        const newValue = mainSelect.value;
        const changes = [mainSelect];
        const rows = (scope === 'table') ? Array.from(table.querySelectorAll('tr[data-student-id]')) : [mainSelect.closest('tr')];

        rows.forEach(row => {
            // อัปเดต Dropdown "สรุป" ของแถวนี้ (กรณี scope='table')
            const summaryInRow = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainId}"]`);
            if (summaryInRow && summaryInRow.value !== newValue) {
                summaryInRow.value = newValue;
                changes.push(summaryInRow);
            }

            // อัปเดต Dropdown "ย่อย" ทั้งหมดที่เกี่ยวข้อง
            row.querySelectorAll(`.qualitative-select[data-main-id="${mainId}"]`).forEach(sub => {
                if (sub.value !== newValue) {
                    sub.value = newValue;
                    changes.push(sub);
                }
            });
        });
        return [...new Set(changes)]; // คืนค่าแบบไม่ซ้ำ
    };
    /**
     * ฟังก์ชันย่อยที่ 2: คำนวณ "หัวข้อใหญ่" ใหม่จาก "หัวข้อย่อย"
     * @param {HTMLElement} subSelect - Dropdown ของหัวข้อย่อยที่ถูกเปลี่ยน
     * @param {string} scope - ขอบเขตการทำงาน ('table' หรือ 'row')
     * @returns {Array} - รายการ elements ทั้งหมดที่มีการเปลี่ยนแปลง
     */
    const recalculateMainFromSubs = (subSelect, scope) => {
        const mainId = subSelect.dataset.mainId;
        const changes = [subSelect];
        const rows = (scope === 'table') ? Array.from(table.querySelectorAll('tr[data-student-id]')) : [subSelect.closest('tr')];

        // ถ้าเป็นโหมด "ทั้งหมด" ให้กระจายค่าของ "หัวข้อย่อย" ไปทุกแถวก่อน
        if (scope === 'table') {
            const topicId = subSelect.dataset.topicId;
            const newValue = subSelect.value;
            rows.forEach(row => {
                const otherSub = row.querySelector(`.qualitative-select[data-topic-id="${topicId}"]`);
                if (otherSub && otherSub !== subSelect && otherSub.value !== newValue) {
                    otherSub.value = newValue;
                    changes.push(otherSub);
                }
            });
        }

        // จากนั้น คำนวณ "สรุป" ใหม่สำหรับทุกแถวใน scope
        rows.forEach(row => {
            const summary = row.querySelector(`.qualitative-main-summary[data-topic-id="${mainId}"]`);
            const subs = Array.from(row.querySelectorAll(`.qualitative-select[data-main-id="${mainId}"]`));
            const scores = subs.map(s => s.value).filter(v => v !== '');

            if (summary && scores.length > 0) {
                const frequency = scores.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});
                const mode = Object.keys(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b);
                if (summary.value !== mode) {
                    summary.value = mode;
                    changes.push(summary);
                }
            } else if (summary && summary.value !== '') {
                summary.value = '';
                changes.push(summary);
            }
        });
        return [...new Set(changes)]; // คืนค่าแบบไม่ซ้ำ
    };

    // --- UI UPDATE & CALCULATION FUNCTIONS ---

    async function loadRatioTarget() {
        try {
            const resp = await fetch(`/teacher/api/plan/${planId}/ratio-target`);
            if (resp.ok) {
                const data = await resp.json();
                if (data && data.mid_ratio != null && data.final_ratio != null) {
                    targetMidRatio = parseInt(data.mid_ratio);
                    targetFinalRatio = parseInt(data.final_ratio);
                    isTargetSetByUser = true;
                    // --- [FIX] Add Null Checks ---
                    const midRatioInput = document.querySelector('#ratioTargetModal #target-mid-ratio');
                    const finalRatioInput = document.querySelector('#ratioTargetModal #target-final-ratio');
                    if (midRatioInput) midRatioInput.value = targetMidRatio;
                    if (finalRatioInput) finalRatioInput.value = targetFinalRatio;
                    // --- End Fix ---
                } else {
                    isTargetSetByUser = false;
                }
            } else { // Handle case where fetch itself fails but doesn't throw network error
                 console.warn('Could not load ratio target, server responded:', resp.status);
                 isTargetSetByUser = false;
            }
        } catch (err) {
            // --- [FIX] Log error correctly ---
            console.error('Could not load ratio target', err); // Changed warn to error
            isTargetSetByUser = false;
        }
    }

    /**
     * [FINAL VERSION 2.0] Calculates and updates the "Intelligent Score Summary Panel".
     * - Correctly defines Mid-Period vs Final-Period scores.
     * - Changes the "Difference" calculation to show "points needed to reach the 80:20 target".
     * - Uses clearer colors for the difference display (Warning/Danger).
     */
    function updateSummaryPanel() {
        // --- [REVISED] Get assessmentContent element *inside* the function ---
        const container = document.getElementById('assessment-content');
        if (!container) {
            console.warn("updateSummaryPanel called but #assessment-content not found.");
            return; // Exit if container doesn't exist when function is called
        }
        // --- End Revision ---

        // --- Part 1: Calculate scores ---
        const totalCollectedScore = Array.from(container.querySelectorAll('.score-value')).reduce((sum, el) => sum + (parseFloat(el.textContent) || 0), 0);
        const totalMidtermScore = Array.from(container.querySelectorAll('.exam-score-input[data-exam-type="midterm"]:not(:disabled)')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
        const totalFinalScore = Array.from(container.querySelectorAll('.exam-score-input[data-exam-type="final"]:not(:disabled)')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
        const actualMidPeriodScore = totalCollectedScore + totalMidtermScore;
        const actualFinalPeriodScore = totalFinalScore;
        const grandTotalScore = actualMidPeriodScore + actualFinalPeriodScore;

        // --- Part 2: Handle UI Visibility ---
        let anyMidtermEnabled = container.querySelector('.exam-score-switch[id^="midterm-"]:checked');
        let anyFinalEnabled = container.querySelector('.exam-score-switch[id^="final-"]:checked');
        const midtermRow = document.getElementById('summary-midterm-row');
        const finalRow = document.getElementById('summary-final-row');
        const ratioContainer = document.getElementById('ratio-summary-container');
        // --- [FIX] Add Null Checks for Visibility ---
        if (midtermRow) midtermRow.style.display = anyMidtermEnabled ? 'block' : 'none';
        if (finalRow) finalRow.style.display = anyFinalEnabled ? 'block' : 'none';
        if (ratioContainer) ratioContainer.style.display = (anyMidtermEnabled || anyFinalEnabled) ? 'flex' : 'none';
        // --- End Fix ---

        // --- Part 3: Update Score Displays ---
        // --- [FIX] Add Null Checks for Score Displays ---
        const summaryCollectedEl = document.getElementById('summary-collected-score');
        const summaryMidtermEl = document.getElementById('summary-midterm-score');
        const summaryFinalEl = document.getElementById('summary-final-score');
        const summaryTotalEl = document.getElementById('summary-total-score');
        if (summaryCollectedEl) summaryCollectedEl.textContent = totalCollectedScore;
        if (summaryMidtermEl) summaryMidtermEl.textContent = totalMidtermScore;
        if (summaryFinalEl) summaryFinalEl.textContent = totalFinalScore;
        if (summaryTotalEl) summaryTotalEl.textContent = grandTotalScore;
        // --- End Fix ---

        // --- Part 4: Ratio and Difference Calculation ---
        const actualRatioDisplay = document.getElementById('actual-ratio-display');
        const targetRatioCol = document.getElementById('target-ratio-col');
        const diffRatioCol = document.getElementById('diff-ratio-col');
        const targetRatioDisplay = document.getElementById('target-ratio-display');
        const diffRatioDisplay = document.getElementById('diff-ratio-display');

        // --- [FIX] Add Null Checks for Ratio Elements ---
        if (actualRatioDisplay) {
            if (grandTotalScore > 0) {
                const actualMidRatio = Math.round((actualMidPeriodScore / grandTotalScore) * 100);
                const actualFinalRatio = 100 - actualMidRatio;
                actualRatioDisplay.textContent = `${actualMidRatio} : ${actualFinalRatio}`;
            } else {
                actualRatioDisplay.textContent = '-- : --';
            }
        }

        if (isTargetSetByUser && targetRatioCol && diffRatioCol && targetRatioDisplay && diffRatioDisplay) {
            targetRatioCol.style.display = 'block';
            diffRatioCol.style.display = 'block';
            targetRatioDisplay.textContent = `${targetMidRatio} : ${targetFinalRatio}`;
            if (actualFinalPeriodScore > 0 && targetFinalRatio > 0) {
                const idealMidPeriodScore = (actualFinalPeriodScore * targetMidRatio) / targetFinalRatio;
                const pointsNeeded = idealMidPeriodScore - actualMidPeriodScore;
                if (pointsNeeded < 0.01 && pointsNeeded > -0.01) diffRatioDisplay.innerHTML = `<span class="text-success">ตรงตามเป้าหมาย</span>`;
                else if (pointsNeeded < 0) diffRatioDisplay.innerHTML = `<span class="text-danger">ระหว่างภาคเกิน ${Math.abs(pointsNeeded).toFixed(2).replace(/\.00$/, '')} คะแนน</span>`;
                else diffRatioDisplay.innerHTML = `<span class="text-warning fw-bold">ระหว่างภาคขาด ${pointsNeeded.toFixed(2).replace(/\.00$/, '')} คะแนน</span>`;
            } else {
                diffRatioDisplay.innerHTML = '<span>รอคะแนนปลายภาค</span>';
            }
        } else if (targetRatioCol && diffRatioCol) { // Ensure these exist before hiding
            targetRatioCol.style.display = 'none';
            diffRatioCol.style.display = 'none';
        }
        // --- End Fix ---
    }

    function buildCheckboxTree(nodes, selectedIds, isSublevel = false) {
        let html = `<ul class="${isSublevel ? 'list-unstyled ps-4' : 'list-unstyled'}">`;
        nodes.forEach(node => {
            const isChecked = selectedIds.includes(node.id);
            html += `<li class="form-check my-1">
                            <input class="form-check-input" type="checkbox" value="${node.id}" id="topic-${node.id}" ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="topic-${node.id}">${node.name}</label>
                            ${node.children?.length > 0 ? buildCheckboxTree(node.children, selectedIds, true) : ''}
                            </li>`;
        });
        return html + '</ul>';
    }

    function setupCheckboxLogic(container) {
        container.addEventListener('change', e => {
            if (e.target.type !== 'checkbox') return;
            const checkbox = e.target;
            const isChecked = checkbox.checked;
            const listItem = checkbox.closest('li.form-check');

            // Check/uncheck all children
            listItem.querySelectorAll('input[type="checkbox"]').forEach(child => child.checked = isChecked);

            // Update parents
            let parentLi = listItem.parentElement.closest('li.form-check');
            while (parentLi) {
                const parentCheckbox = parentLi.querySelector('input[type="checkbox"]');
                const siblings = parentLi.querySelectorAll('ul > li > input[type="checkbox"]');
                const anySiblingChecked = Array.from(siblings).some(cb => cb.checked);
                parentCheckbox.checked = anySiblingChecked; // Parent is checked if any child is checked
                parentLi = parentLi.parentElement.closest('li.form-check');
            }
        });
    }

    /**
     * Calculates the mode (most frequent value) from an array of values.
     * @param {Array<string>} arr The array of scores/values.
     * @returns {string} The most frequent value, or an empty string if none.
     */
    function calculateMode(arr) {
        if (!arr || arr.length === 0) return '';
        const frequency = arr.reduce((acc, val) => {
            if (val !== '') { // Only count non-empty values
                acc[val] = (acc[val] || 0) + 1;
            }
            return acc;
        }, {});

        let maxFreq = 0;
        let mode = '';
        for (const val in frequency) {
            if (frequency[val] > maxFreq) {
                maxFreq = frequency[val];
                mode = val;
            }
        }
        return mode;
    }
    const saveSettingsBtn = document.getElementById('savePlanSettingsBtn');

    // --- เพิ่มฟังก์ชันสำหรับ khởi tạo TomSelect ---
    function initializeRoomSelector() {
        const roomSelector = document.getElementById('room-select');
        if (!roomSelector) return;

        if (roomTomSelect) {
            roomTomSelect.destroy();
        }

        roomTomSelect = new TomSelect(roomSelector, {
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            create: true,
            load: function(query, callback) {
                const url = `{{ url_for('teacher.search_rooms') }}?q=${encodeURIComponent(query)}&plan_id=${planId}`;
                fetch(url)
                    .then(response => response.json())
                    .then(callback)
                    .catch(() => callback());
            },
            create: function(input, callback) {
                Swal.fire({
                    title: 'สร้างห้องใหม่',
                    target: document.getElementById('planSettingsModal'), // สั่งให้ SweetAlert2 แสดงผลใน Modal นี้
                    html: `
                        <input id="swal-room-name" class="swal2-input" value="${input}" placeholder="ชื่อห้อง">
                        <input id="swal-room-capacity" type="number" class="swal2-input" placeholder="ความจุ (คน)">
                        <input id="swal-room-type" class="swal2-input" placeholder="ประเภทห้อง (เช่น ห้องเรียน, ห้องปฏิบัติการ)">
                        <textarea id="swal-room-notes" class="swal2-textarea" placeholder="หมายเหตุ (เช่น อุปกรณ์ชำรุด)"></textarea>
                    `,
                    confirmButtonText: 'สร้างและเลือก',
                    showCancelButton: true,
                    focusConfirm: false, // ป้องกันการปิด modal เมื่อกด Enter
                    stopKeydownPropagation: false, // ป้องกัน SweetAlert2 บล็อก Event ของ Modal หลัก
                    preConfirm: () => {
                        return {
                            name: document.getElementById('swal-room-name').value,
                            capacity: document.getElementById('swal-room-capacity').value || null,
                            room_type: document.getElementById('swal-room-type').value, // <-- เพิ่ม field นี้
                            notes: document.getElementById('swal-room-notes').value
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch("{{ url_for('teacher.create_room_on_the_fly') }}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify(result.value)
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    callback(data.room); // ส่งข้อมูลห้องใหม่กลับไปให้ TomSelect
                                } else {
                                    Swal.fire({
                                        target: document.getElementById('planSettingsModal'), // ทำให้ alert แสดงใน modal ด้วย
                                        title: 'ผิดพลาด!',
                                        text: data.message,
                                        icon: 'error'
                                    });
                                    callback();
                                }
                            });
                    } else {
                        callback(); // ยกเลิกการสร้าง
                    }
                });
            },
            render: {
                option: function(data, escape) {
                    return `<div>
                                <strong>${escape(data.name)}</strong>
                                ${data.capacity ? `<small class="text-muted ms-2">(ความจุ: ${data.capacity} คน)</small>` : ''}
                            </div>`;
                },
                item: function(data, escape) {
                    return `<div>${escape(data.name)}</div>`;
                }
            }
        });

        // โหลดข้อมูลเริ่มต้น
        roomTomSelect.load('');
    }

    // --- เรียกใช้ฟังก์ชันตอน Modal เปิด ---
    document.getElementById('planSettingsModal').addEventListener('show.bs.modal', function() {
        initializeRoomSelector();

        // ดึงข้อมูลเงื่อนไขและบันทึกมาแสดง
        fetch(`{{ url_for('teacher.get_plan_constraints', plan_id=plan.id) }}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('constraint_arrangement').value = data.period_arrangement || 'separate';
                document.getElementById('constraint_preference').value = data.time_preference || 'any';
                // นำข้อมูลบันทึกมาใส่ใน textarea
                document.getElementById('manual-notes').value = data.manual_notes || '';
                
                if (data.room_id && roomTomSelect) {
                    console.log(`Setting roomTomSelect value to: ${data.room_id}`); // Optional debug log
                    roomTomSelect.setValue(data.room_id, true); // Use setValue with 'true' to prevent triggering 'change' event
                } else {
                    console.log("No room_id found in data or roomTomSelect not ready."); // Optional debug log
                    if(roomTomSelect) {
                        roomTomSelect.clear(); // Clear selection if no room_id is returned
                    }
                }
            });
    });
    // อัปเดต Event Listener ของปุ่ม Save
    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', function() {
            const statusEl = document.getElementById('settings-save-status');
            statusEl.textContent = 'กำลังบันทึก...';
            this.disabled = true;

            // 1. รวบรวมข้อมูลจากทุก field ใน Modal
            const constraintsPayload = {
                'period_arrangement': document.getElementById('constraint_arrangement').value,
                'time_preference': document.getElementById('constraint_preference').value,
                'manual_notes': document.getElementById('manual-notes').value // <-- เพิ่มข้อมูลบันทึก
            };

            const roomPayload = {
                'room_id': roomTomSelect ? roomTomSelect.getValue() : null
            };

            // 2. สร้าง Promise สำหรับส่งข้อมูลแต่ละส่วนไปที่ API ของตัวเอง
            const saveConstraints = fetch("{{ url_for('teacher.save_plan_constraints', plan_id=plan.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(constraintsPayload)
            });

            const saveRoom = fetch("{{ url_for('teacher.assign_room_to_plan_courses', plan_id=plan.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(roomPayload)
            });

            // 3. รอให้การบันทึกทั้งสองส่วนเสร็จสิ้น แล้วจึงแจ้งผล
            Promise.all([saveConstraints, saveRoom])
                .then(async ([constraintsRes, roomRes]) => {
                    // ตรวจสอบว่า response ทั้งสองอันสำเร็จหรือไม่
                    const constraintsData = await constraintsRes.json();
                    const roomData = await roomRes.json();

                    if (constraintsRes.ok && roomRes.ok) {
                        statusEl.textContent = 'บันทึกเรียบร้อย!';
                        setTimeout(() => {
                            statusEl.textContent = '';
                            const modal = bootstrap.Modal.getInstance(document.getElementById('planSettingsModal'));
                            modal.hide();
                        }, 1500);
                    } else {
                        // รวมข้อความ Error (ถ้ามี) จากทั้งสองส่วน
                        const errorMsg = [constraintsData.message, roomData.message].filter(Boolean).join('; ');
                        statusEl.textContent = `เกิดข้อผิดพลาด: ${errorMsg || 'ไม่ทราบสาเหตุ'}`;
                    }
                })
                .catch(err => {
                    statusEl.textContent = 'การเชื่อมต่อล้มเหลว!';
                    console.error(err);
                })
                .finally(() => {
                    this.disabled = false;
                });
        });
    }
    // -------------------------------------------
    // 6. CENTRALIZED EVENT LISTENERS
    // -------------------------------------------
    unitList.addEventListener('click', (e) => {
        const unitLink = e.target.closest('a.list-group-item');
        const deleteBtn = e.target.closest('.delete-unit-btn');

        if (deleteBtn && unitLink) {
            e.preventDefault();
            e.stopPropagation();
            handleUnitDelete(unitLink); // เรียกใช้ฟังก์ชันลบของท่าน (ตรวจสอบว่าชื่อฟังก์ชันถูกต้อง)
        } else if (unitLink) {
            e.preventDefault();
            setActiveUnit(unitLink.dataset.unitId);
        }
    });

    // แก้ไข Event Listener การสลับแท็บให้ฉลาดขึ้น
    // โดยจะโหลดเนื้อหาใหม่ต่อเมื่อผู้ใช้ "สลับไปยังแท็บอื่น" เท่านั้น
    // จะไม่โหลดซ้ำเมื่อคลิกที่แท็บเดิมที่เปิดอยู่แล้ว
    workspaceTabs.addEventListener('show.bs.tab', (event) => {
        const newTabId = event.target.id;

        // ตรวจสอบว่าแท็บที่กำลังจะแสดง เป็นแท็บใหม่ที่ไม่ใช่แท็บเดิมหรือไม่
        if (state.activeTabId !== newTabId) {
            // ถ้าเป็นแท็บใหม่จริงๆ ให้ทำการอัปเดต State และโหลดเนื้อหา
            state.activeTabId = newTabId;
            saveState();

            // เรียกโหลดเนื้อหาของแท็บใหม่
            Promise.resolve(loadTabContent(newTabId)).then(() => {
                // ส่วนนี้คือ Logic การคืนค่าห้องเรียนที่เลือกไว้ (ถูกต้องอยู่แล้ว)
                if (newTabId === 'gradebook-tab' || newTabId === 'attendance-tab') {
                    const selectorId = newTabId === 'gradebook-tab' ? 'classroom-selector' : 'attendance-classroom-selector';
                    const selector = document.getElementById(selectorId);

                    if (selector && state.activeClassroomId && [...selector.options].some(opt => opt.value === state.activeClassroomId)) {
                        if (selector.value !== state.activeClassroomId) {
                            selector.value = state.activeClassroomId;
                            selector.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });
        }
        // ถ้าผู้ใช้คลิกที่แท็บเดิมที่เปิดอยู่แล้ว โค้ดใน if นี้จะไม่ทำงาน
        // จึงไม่มีการ Render ซ้ำ และ Filter ของเราจะไม่หายไป
    });

    // เพิ่ม Event Listener นี้เข้าไป
    document.addEventListener('shown.bs.tab', function(event) {
        // ตรวจสอบว่าแท็บที่เพิ่งแสดงคือแท็บ "ตั้งค่าการประเมิน" หรือไม่
        if (event.target.getAttribute('href') === '#assessment-content') {
            console.log('Assessment tab shown, calling update functions.');
            // เมื่อ DOM พร้อมแล้ว จึงค่อยเรียกฟังก์ชันคำนวณ
            loadRatioTarget().then(updateSummaryPanel);
        }
    });    

    workspaceTabsContent.addEventListener('click', (e) => {
        
        const deleteItemBtn = e.target.closest('.delete-graded-item-btn');
        if (deleteItemBtn) handleGradedItemDelete(deleteItemBtn.dataset.itemId);
        
        const selectTopicsBtn = e.target.closest('.select-topics-btn');
        if (selectTopicsBtn) openTopicSelectionModal(selectTopicsBtn);

        const addSubUnitBtn = e.target.closest('#add-subunit-btn');
        if(addSubUnitBtn) handleAddSubUnit(addSubUnitBtn);

        const editSubUnitBtn = e.target.closest('.edit-subunit-btn');
        if(editSubUnitBtn) handleEditSubUnit(editSubUnitBtn);
        
        const deleteSubUnitBtn = e.target.closest('.delete-subunit-btn');
        if(deleteSubUnitBtn) handleDeleteSubUnit(deleteSubUnitBtn);
    });

    workspaceTabsContent.addEventListener('change', function(event) {
        const target = event.target;
        // --- GRADEBOOK SUMMARY TAB: Classroom Selector Change ---
        if (target && target.id === 'classroom-selector') {
            const selector = target;
            const selectedOption = selector.options[selector.selectedIndex];
            const classroomId = selector.value;
            const courseId = selectedOption.dataset.courseId;
            const manageGroupsBtn = document.getElementById('manage-groups-btn-workspace'); // ใช้ ID ใหม่ที่ถูกต้อง

            state.activeClassroomId = classroomId;
            saveState();

            if (classroomId && courseId) {
                if(manageGroupsBtn) manageGroupsBtn.disabled = false;
                // *** THE CRITICAL FIX IS HERE ***
                // เรียกใช้ฟังก์ชันที่ถูกต้องสำหรับหน้านี้
                loadAndRenderGradebookSummary(courseId, classroomId);
            } else {
                if(manageGroupsBtn) manageGroupsBtn.disabled = true;
                const container = document.getElementById('gradebook-container');
                if(container) container.innerHTML = '<div class="text-center p-5 text-muted">กรุณาเลือกห้องเรียนเพื่อแสดงข้อมูล</div>';
            }
        }
    });

    // --- เพิ่ม Event Listener สำหรับการกรอกชั่วโมง ---
    workspaceTabsContent.addEventListener('input', e => {
        if (e.target.classList.contains('learning-unit-hours-input')) {
            const unitId = e.target.dataset.unitId;
            const periods = parseInt(e.target.value, 10) || 0;

            // Update our central data store
            unitHoursData[unitId] = periods;

            // Recalculate for all units
            updateCumulativePeriods();

            // Debounced save logic (no changes here)
            clearTimeout(hourSaveDebounce);
            hourSaveDebounce = setTimeout(() => {
                fetch(`/teacher/api/units/${unitId}/hours`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            hours: periods
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'บันทึกคาบเรียนแล้ว',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else {
                            Swal.fire('เกิดข้อผิดพลาด', data.message, 'error');
                        }
                    });
            }, 200);
        }
    });

    // This button might be loaded dynamically, so we handle it via delegation on a static parent
    document.body.addEventListener('click', function(event) {
        // ดักจับการคลิกปุ่ม "ส่งเพื่อรับการตรวจสอบ" ไม่ว่ามันจะถูกโหลดมาเมื่อไหร่ก็ตาม
        if (event.target.id === 'submit-for-review-btn') {
            Swal.fire({
                title: 'ยืนยันการส่งแผนการสอน?',
                text: "หลังจากส่งแล้ว ท่านจะไม่สามารถแก้ไขได้จนกว่าจะได้รับการตรวจสอบ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ใช่, ยืนยันการส่ง',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{{ url_for('teacher.submit_plan_for_review', plan_id=plan.id) }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire('สำเร็จ!', data.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('เกิดข้อผิดพลาด!', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                    });
                }
            });
        }
    });

    // Add listeners for forms and modals that are always in the DOM
    document.getElementById('unit-form').addEventListener('submit', handleUnitCreate);
    document.getElementById('subUnitEditForm').addEventListener('submit', handleSubUnitFormSubmit);
    document.getElementById('planSettingsModal')?.addEventListener('show.bs.modal', initializeRoomSelector);
    document.querySelectorAll('#unitList a').forEach(link => {
        unitHoursData[link.dataset.unitId] = 0;
    });

    // 4. Unit Creation Form
    document.getElementById('unitFormModal').addEventListener('show.bs.modal', (event) => {
        const button = event.relatedTarget;
        if (button && button.dataset.bsAction === 'add') {
            const modal = event.currentTarget;
            modal.querySelector('.modal-title').textContent = 'สร้างหน่วยการเรียนรู้ใหม่';
            modal.querySelector('form').reset();
            modal.querySelector('#modal-unit-id').value = '';
        }
    });

    document.getElementById('groupManagementModal').addEventListener('click', async (e) => {
        const target = e.target;
        const groupsContainer = document.getElementById('groups-container');

        // 💾 บันทึกการจัดกลุ่ม
        if (target.closest('#save-groups-btn')) {
            saveGroups();
        }

        // ➕ เพิ่มกลุ่มใหม่
        else if (target.closest('#add-new-group-btn')) {
            const groupHtml = createGroupCard(
                { id: `new-${Date.now()}`, name: `กลุ่มที่ ${groupsContainer.children.length + 1}` },
                ''
            );
            groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
            initializeAllSortables();
        }

        // 🗑️ ลบกลุ่ม
        else if (target.closest('.delete-group-btn')) {
            const card = target.closest('.group-card');
            if (card) {
                card.querySelectorAll('.list-group-item')
                    .forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                card.remove();
            }
        }

        // 🤖 สร้างกลุ่มอัตโนมัติ
        else if (target.closest('#auto-generate-groups-btn')) {
            const { value: numGroups } = await Swal.fire({
                target: document.getElementById('groupManagementModal'),
                title: 'สร้างกลุ่มอัตโนมัติ',
                input: 'number',
                inputLabel: 'คุณต้องการสร้างกี่กลุ่ม?',
                inputPlaceholder: 'ใส่จำนวนกลุ่ม',
                showCancelButton: true,
                confirmButtonText: 'สร้างกลุ่ม',
                cancelButtonText: 'ยกเลิก',
                inputValidator: (value) => {
                    if (!value || value < 1) {
                        return 'กรุณาใส่จำนวนกลุ่มที่ถูกต้อง!';
                    }
                }
            });

            if (numGroups) {
                // ดึงนักเรียนทั้งหมดที่ยังไม่อยู่ในกลุ่ม
                const students = Array.from(
                    document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]')
                );

                // สุ่มลำดับนักเรียน
                for (let i = students.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [students[i], students[j]] = [students[j], students[i]];
                }

                // สร้างกลุ่มใหม่
                groupsContainer.innerHTML = '';
                const newGroupElements = [];
                for (let i = 1; i <= numGroups; i++) {
                    const groupId = `new-${Date.now()}-${i}`;
                    groupsContainer.insertAdjacentHTML(
                        'beforeend',
                        createGroupCard({ id: groupId, name: `กลุ่มที่ ${i}` }, '')
                    );
                    newGroupElements.push(groupsContainer.querySelector(
                        `[data-group-id="${groupId}"] .group-dropzone`
                    ));
                }

                // แจกนักเรียนลงกลุ่ม
                if (newGroupElements.length > 0) {
                    students.forEach((studentNode, index) => {
                        newGroupElements[index % numGroups].appendChild(studentNode);
                    });
                }

                initializeAllSortables();
            }
        }
    });

// -------------------------------------------
    // 7. INITIALIZATION ON PAGE LOAD (REVISED v2 - Fix ReferenceError)
    // -------------------------------------------
    function initializeWorkspace() {
        console.log("Initializing workspace...");
        // Step 1: คืนค่า State ล่าสุด
        restoreState();
        console.log("Restored state:", state);

        // Step 2: หา Tab Button และ Content Pane ที่ควรจะ Active
        const activeTabButtonId = state.activeTabId || 'plan-tab';
        // --- [FIX] Declare activeTabEl and targetPaneEl *before* the if/else block ---
        let activeTabEl = null;
        let targetPaneEl = null;

        activeTabEl = document.getElementById(activeTabButtonId); // Try to get the element based on saved state

        if (activeTabEl && activeTabEl.dataset.bsTarget) {
            targetPaneEl = document.querySelector(activeTabEl.dataset.bsTarget);
        } else {
             // Fallback: If the saved tab ID doesn't exist, use the first tab
             console.log(`Tab ID '${activeTabButtonId}' not found or invalid, falling back to first tab.`);
             const firstTabButton = document.querySelector('#workspaceTabs .nav-link');
             if (firstTabButton && firstTabButton.dataset.bsTarget) {
                  activeTabEl = firstTabButton; // Assign the fallback tab button
                  targetPaneEl = document.querySelector(firstTabButton.dataset.bsTarget);
                  state.activeTabId = activeTabEl.id; // Update state with the fallback tab ID
                  saveState();
             }
        }
        console.log("Initial Active Tab Button:", activeTabEl);
        console.log("Initial Target Pane:", targetPaneEl);

        // Step 3: กำหนด Class ให้ Tab Button และ Pane ที่ควร Active
        document.querySelectorAll('#workspaceTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#workspaceTabsContent .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        if (activeTabEl) {
             activeTabEl.classList.add('active');
             activeTabEl.setAttribute('aria-selected', 'true');
        }
        if (targetPaneEl) {
             targetPaneEl.classList.add('show', 'active');
             console.log("Set pane to active:", targetPaneEl.id);
        } else {
             console.warn("Could not find target pane to make active initially.");
             const initialMsg = document.getElementById('initial-message');
             if(initialMsg) initialMsg.style.display = 'block';
        }

        // Step 4: หา Unit ที่จะโหลด
        let unitLinkToLoad = unitList.querySelector(`a[data-unit-id="${state.activeUnitId}"]`);
        if (!unitLinkToLoad) {
            const firstUnitLink = unitList.querySelector('a.list-group-item');
            if (firstUnitLink) {
                unitLinkToLoad = firstUnitLink;
                state.activeUnitId = firstUnitLink.dataset.unitId;
                // No need to saveState() here, setActiveUnit will do it if needed
            }
        }
        console.log("Unit to load:", unitLinkToLoad ? unitLinkToLoad.dataset.unitId : "None");

        // Step 5: ถ้ามี Unit, ให้ setActiveUnit และโหลดเนื้อหา
        if (unitLinkToLoad) {
             setActiveUnit(unitLinkToLoad.dataset.unitId); // Set the active unit FIRST
             // Then explicitly load the content for the tab we just made active
             console.log("Explicitly loading content for tab:", state.activeTabId);
             loadTabContent(state.activeTabId);
        } else {
            console.log("No units found, loading content for:", state.activeTabId);
            loadTabContent(state.activeTabId); // Load even if no unit
        }
    }

    // --- FINAL INITIALIZATION CALL ---
    // Ensure all other functions are defined above this point
    initializeWorkspace();
    restoreState();
    
    // Load the content for the restored or default tab
    const activeTabEl = document.getElementById(state.activeTabId) || document.querySelector('#workspaceTabs .nav-link');
    if (activeTabEl) {
        new bootstrap.Tab(activeTabEl).show();
    }
    
});
</script>
{% endblock %}