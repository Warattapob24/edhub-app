{% extends "mobile_base.html" %}
{% block title %}Mobile Hub - {{ entry.course.subject.name }}{% endblock %}

{% block styles %}
    {{ super() }}
    <style>
        :root {
            --status-present: #d1e7dd;
            --status-absent: #f8d7da;
            --status-late: #fff3cd;
            --status-leave: #e2e3e5;
            --status-border-present: #a3cfbb;
            --status-border-absent: #f1b0b7;
            --status-border-late: #ffe69c;
            --status-border-leave: #adb5bd;
        }
        
        /* 1. Container & Tabs */
        .mobile-entry-container {
            padding-top: 56px; /* Space for fixed navbar */
            padding-bottom: 56px; /* Space for fixed summary bar */
        }
        .nav-tabs .nav-link {
            border-radius: 0;
            font-weight: 500;
            color: var(--bs-gray-600);
            padding: 0.8rem 0.5rem;
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
            border-bottom: 3px solid var(--bs-primary) !important;
            background-color: var(--bs-gray-100);
        }
        .tab-pane {
            background-color: #f8f9fa;
            padding: 1rem;
            min-height: 70vh; 
        }

        /* 2. Attendance Tab */
        #attendanceGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        .student-card {
            border: 2px solid var(--status-border-present);
            background-color: var(--status-present);
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .student-card:active {
            transform: scale(0.95);
        }
        .student-card .student-roll {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }
        .student-card .student-name {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em; /* 2 lines height */
            margin-bottom: 0.25rem;
            color: #444;
        }
        .student-card .status-badge {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 1.25rem;
            font-weight: 700;
            opacity: 0.7;
        }
        /* Status Colors */
        .student-card[data-status="PRESENT"] { background-color: var(--status-present); border-color: var(--status-border-present); }
        .student-card[data-status="ABSENT"] { background-color: var(--status-absent); border-color: var(--status-border-absent); }
        .student-card[data-status="LATE"] { background-color: var(--status-late); border-color: var(--status-border-late); }
        .student-card[data-status="LEAVE"] { background-color: var(--status-leave); border-color: var(--status-border-leave); }

        /* Summary Bar */
        #attendanceSummaryBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bs-dark);
            color: white;
            padding: 0.5rem 0.75rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1020;
            border-top: 1px solid var(--bs-gray-700);
        }
        #attendanceSummaryBar .summary-item {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
        }
        #attendanceSummaryBar .summary-count {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* 3. Scoring Tab */
        #scoringGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        .score-card {
            border: 1px solid var(--bs-gray-300);
            background-color: #fff; 
            border-radius: 0.375rem; 
            padding: 0.5rem;
            text-align: center;
        }
        .score-card .student-name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            height: 2.4em; /* 2 lines */
            overflow: hidden;
        }
        .score-input {
            width: 100%;
            text-align: center;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
        }
        .score-input.is-invalid {
            color: var(--bs-danger);
            border-color: var(--bs-danger);
        }
        .score-input.is-valid {
            color: var(--bs-success);
            border-color: var(--bs-success);
        }

        /* 4. Assessment Tab [RE-ARCHITECTED] */
        #assessmentGrid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 0.75rem; /* üëà [FIX] ‡πÄ‡∏û‡∏¥‡πà‡∏° gap ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î */
        }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1 ‡∏Ñ‡∏ô */
        .assessment-student-card {
            background-color: #fff;
            border: 1px solid var(--bs-gray-300);
            border-radius: 0.375rem;
            padding: 0.75rem;
        }
        
        .assessment-student-card .student-info {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .assessment-student-card .student-info .roll-number {
            font-weight: 700;
            font-size: 1rem;
            color: var(--bs-primary);
        }

        /* ‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡πà‡∏≠‡∏¢) */
        .assessment-topic-row {
            margin-bottom: 0.5rem;
        }
        
        /* üëà [NEW] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å */
        .assessment-topic-row.main-topic .topic-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* üëà [NEW] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ */
        .assessment-topic-row.sub-topic {
            padding-left: 1.25rem; /* ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ */
            border-left: 3px solid #e0e0e0;
            margin-left: 4px;
        }
        .assessment-topic-row.sub-topic .topic-label {
            font-size: 0.85rem;
            color: #333;
        }

        .assessment-topic-row .topic-label {
            display: block;
            margin-bottom: 0.25rem;
        }

        .assessment-topic-row .qual-button-group {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.25rem; 
        }
        
        .assessment-topic-row .qual-button-group .btn {
            flex-basis: 60px; 
            flex-grow: 1; 
            border-radius: 0.375rem !important; 
            font-size: 0.8rem; 
            padding: 0.5rem 0.25rem; 
        }
        /* [END RE-ARCHITECTED] */


        /* 5. Group Management Modal */
        #ungrouped-students-list {
            position: -webkit-sticky;
            position: sticky;
            top: 1rem;
            max-height: 40vh; 
            overflow-y: auto;
        }
        #groups-container {
            max-height: 70vh; 
            overflow-y: auto;
        }
    </style>
{% endblock %}

{% block main_content %}
<div id="mobileEntryContainer" 
     class="mobile-entry-container"
     data-entry-id="{{ entry.id }}"
     data-course-id="{{ entry.course.id }}"
     data-date-iso="{{ date_iso }}"
     data-classroom-id="{{ classroom_id_js }}" 
     data-plan-id="{{ lesson_plan.id if lesson_plan else '' }}"
     data-csrf-token="{{ csrf_token() }}">

    {# --- Top Navbar --- #}
    <nav class="navbar navbar-light bg-light fixed-top border-bottom shadow-sm p-2">
        <div class="container-fluid">
            <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">‡∏Å‡∏•‡∏±‡∏ö</span>
            </a>
            <div class="flex-grow-1">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-book-fill"></i> {{ entry.course.subject.name }} 
                </h6>
                <small class="text-muted">
                    <i class="bi bi-people-fill"></i> {{ entry.course.classroom.name }} | 
                    <i class="bi bi-clock"></i> ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà {{ entry.slot.period_number }} |
                    <i class="bi bi-calendar-check"></i> {{ attendance_date.strftime('%d/%m/%Y') }}
                </small>
            </div>
            
            {% if lesson_plan %}
            <button class="btn btn-sm btn-outline-primary ms-2" 
                    id="mobile-manage-groups-btn"
                    data-bs-toggle="modal" 
                    data-bs-target="#groupManagementModal">
                <i class="bi bi-people-fill"></i>
            </button>
            {% endif %}

            {# Loading Spinner #}
            <div class="spinner-border spinner-border-sm text-primary ms-2" role="status" id="globalSpinner" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </nav>

    {# --- Nav Tabs --- #}
    <ul class="nav nav-tabs nav-fill sticky-top bg-white" id="mainTabs" role="tablist" style="top: 56px; z-index: 1025;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab" aria-controls="attendance" aria-selected="true">
                <i class="bi bi-check2-circle-fill"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoring" type="button" role="tab" aria-controls="scoring" aria-selected="false">
                <i class="bi bi-pencil-square"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button" role="tab" aria-controls="assessment" aria-selected="false">
                <i class="bi bi-clipboard2-data-fill"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•
            </button>
        </li>
    </ul>

    {# --- Tab Content --- #}
    <div class="tab-content" id="mainTabContent">
        
        {# --- 1. Attendance Tab --- #}
        <div class="tab-pane fade show active" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
            <p class="text-muted small text-center mb-3">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏°‡∏≤ -> ‡∏Ç‡∏≤‡∏î -> ‡∏•‡∏≤ -> ‡∏™‡∏≤‡∏¢)</p>
            <div id="attendanceGrid">
                {# Student cards will be rendered here by JS #}
            </div>
        </div>

        {# --- 2. Scoring Tab --- #}
        <div class="tab-pane fade" id="scoring" role="tabpanel" aria-labelledby="scoring-tab">
            <div class="mb-3"> 
                <label for="gradedItemSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <select class="form-select" id="gradedItemSelect">
                    <option value="" selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                    {% for item in graded_items %}
                    <option value="{{ item.id }}">{{ item.name }} ({{ item.max_score }} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="d-flex justify-content-center small mb-3">
                <div class="form-check form-switch form-check-inline me-3">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="score-group-toggle" data-mode="group">
                    <label class="form-check-label" for="score-group-toggle">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                </div>
                <div class="form-check form-switch form-check-inline">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="score-all-toggle" data-mode="all">
                    <label class="form-check-label" for="score-all-toggle">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
            </div>
            
            <div id="scoringGrid">
                <p class="text-muted text-center mt-4" id="scoring-placeholder">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
            </div>
        </div>

        {# --- 3. Assessment Tab [RE-ARCHITECTED] --- #}
        <div class="tab-pane fade" id="assessment" role="tabpanel" aria-labelledby="assessment-tab">
            
            <div class="mb-3">
                <label for="qual-template-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</label>
                <select class="form-select" id="qual-template-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                    </select>
            </div>

            <div class="d-flex justify-content-center small mb-3">
                <div class="form-check form-switch form-check-inline me-3">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="qual-group-toggle" data-mode="group">
                    <label class="form-check-label" for="qual-group-toggle">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                </div>
                <div class="form-check form-switch form-check-inline">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="qual-all-toggle" data-mode="all">
                    <label class="form-check-label" for="qual-all-toggle">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
            </div>

            <div id="assessmentGrid">
                </div>
            
            <div id="qualitative-placeholder" class="text-center text-muted p-4 mt-4" style="display: block;">
                <i class="bi bi-clipboard-check" style="font-size: 3rem;"></i>
                <p class="mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
            </div>
        </div>

    </div>
</div>

{# --- Attendance Summary Bar (Fixed Bottom) --- #}
<div id="attendanceSummaryBar">
    <div class="summary-item" style="color: var(--status-present);">
        ‡∏°‡∏≤
        <span class="summary-count" id="summaryPresent">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-absent);">
        ‡∏Ç‡∏≤‡∏î
        <span class="summary-count" id="summaryAbsent">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-late);">
        ‡∏™‡∏≤‡∏¢
        <span class="summary-count" id="summaryLate">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-leave);">
        ‡∏•‡∏≤
        <span class="summary-count" id="summaryLeave">0</span>
    </div>
    <div class="summary-item text-white">
        ‡∏£‡∏ß‡∏°
        <span class="summary-count" id="summaryTotal">0</span>
    </div>
</div>

<div class="modal fade" id="groupManagementModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen"> 
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="group-manager-loader">
                    <div class="spinner-border spinner-border-sm me-2"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
                <div id="group-manager-content" style="display: none;" class="d-flex flex-column h-100">
                    <div class="mb-3"> 
                        <h6>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°</h6>
                        <div id="ungrouped-students-list" class="list-group border p-2"></div>
                    </div>
                    <div class="flex-grow-1"> 
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="auto-generate-groups-btn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-sm btn-primary" id="add-new-group-btn"><i class="bi bi-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </div>
                        <div id="groups-container"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-groups-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Global State & Constants ---
        const container = document.getElementById('mobileEntryContainer');
        const ENTRY_ID = container.dataset.entryId;
        const COURSE_ID = container.dataset.courseId;
        const DATE_ISO = container.dataset.dateIso;
        const CSRF_TOKEN = container.dataset.csrfToken;
        const SPINNER = document.getElementById('globalSpinner');
        
        const CLASSROOM_ID = container.dataset.classroomId;
        const PLAN_ID = container.dataset.planId;
        let groupModal; 
        if (document.getElementById('groupManagementModal')) {
             groupModal = new bootstrap.Modal(document.getElementById('groupManagementModal'));
        }
        let allEnrollments = [];
        let sortableInstances = [];

        // Status cycle
        const STATUS_CYCLE = ['PRESENT', 'ABSENT', 'LEAVE', 'LATE'];
        const STATUS_ICONS = {
            'PRESENT': '', 'ABSENT': '‡∏Ç‡∏≤‡∏î', 'LATE': '‡∏™‡∏≤‡∏¢', 'LEAVE': '‡∏•‡∏≤'
        };

        // Data Models
        const STUDENTS = [
            {% for e in enrollments %}
            { id: {{ e.student.id }}, roll: {{ e.roll_number or 'null' }}, name: "{{ e.student.first_name }} {{ e.student.last_name | truncate(15) }}", status: "{{ attendance_records.get(e.student.id, 'PRESENT') }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        const SCORES = {
            {% for key, value in scores.items() %}
            "{{ key }}": {{ value }}{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        const GRADED_ITEMS = {
            {% for item in graded_items %}
            "{{ item.id }}": { id: {{ item.id }}, name: "{{ item.name }}", max_score: {{ item.max_score }} }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        
        // ASSESSMENT DATA
        // üëà [FIX] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ ASSESSMENT_DATA (‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å qualitative_assessment_data_json) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        const ASSESSMENT_DATA = JSON.parse('{{ qualitative_assessment_data_json|safe }}');
        // üëà [FIX] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ASSESSMENT_TOPICS (assessment_topics_json) ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        // const ASSESSMENT_TOPICS = JSON.parse('{{ assessment_topics_json|safe }}'); 
        const SUGGESTED_UNIT_ID = {{ suggested_unit_id or 'null' }};
        const STUDENT_GROUP_MAP = JSON.parse('{{ student_group_map_json|safe }}');


        // UI Elements
        const attendanceGrid = document.getElementById('attendanceGrid');
        const summaryPresent = document.getElementById('summaryPresent');
        const summaryAbsent = document.getElementById('summaryAbsent');
        const summaryLate = document.getElementById('summaryLate');
        const summaryLeave = document.getElementById('summaryLeave');
        const summaryTotal = document.getElementById('summaryTotal');
        
        const gradedItemSelect = document.getElementById('gradedItemSelect');
        const scoringGrid = document.getElementById('scoringGrid');
        const scoringPlaceholder = document.getElementById('scoring-placeholder');
        
        const scoreGroupToggle = document.getElementById('score-group-toggle');
        const scoreAllToggle = document.getElementById('score-all-toggle');
        let isScoreDistributing = false;
        let scoreSaveDebounce;
        
        // ASSESSMENT UI ELEMENTS [RE-ARCHITECTED]
        const qualTemplateSelect = document.getElementById('qual-template-select'); // üëà [FIX] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID
        const assessmentGrid = document.getElementById('assessmentGrid');
        const qualPlaceholder = document.getElementById('qualitative-placeholder');
        const qualGroupToggle = document.getElementById('qual-group-toggle');
        const qualAllToggle = document.getElementById('qual-all-toggle');
        let isQualDistributing = false; 
        let qualSaveDebounce; 

        // --- Helper: Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Helper: API Save ---
        async function saveApi(endpoint, payload) {
            SPINNER.style.display = 'block';
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Server error');
                }
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'API returned an error');
                }
                return result;

            } catch (error) {
                console.error(`Save error at ${endpoint}:`, error);
                return { status: 'error', message: error.message }; 
            } finally {
                SPINNER.style.display = 'none';
            }
        }

        
        // ===================================
        // --- 2. ATTENDANCE MODULE ---
        // ===================================
        
        function renderStudentCards() {
            attendanceGrid.innerHTML = '';
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.dataset.studentId = student.id;
                card.dataset.status = student.status;
                const statusIcon = STATUS_ICONS[student.status];
                card.innerHTML = `
                    <div class="student-roll">${student.roll || '-'}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="status-badge">${statusIcon}</div>
                `;
                card.addEventListener('click', () => cycleAttendanceStatus(card, student.id));
                attendanceGrid.appendChild(card);
            });
            updateAttendanceSummary();
        }

        function cycleAttendanceStatus(card, studentId) {
            const currentStatus = card.dataset.status;
            const currentIndex = STATUS_CYCLE.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % STATUS_CYCLE.length;
            const newStatus = STATUS_CYCLE[nextIndex];
            card.dataset.status = newStatus;
            card.querySelector('.status-badge').textContent = STATUS_ICONS[newStatus];
            const student = STUDENTS.find(s => s.id === studentId);
            student.status = newStatus;
            updateAttendanceSummary();
            saveAttendance(studentId, newStatus, card);
        }
        
        async function saveAttendance(studentId, newStatus, card) {
            const payload = {
                student_id: studentId,
                entry_id: ENTRY_ID,
                date: DATE_ISO,
                status: newStatus
            };
            // üëà [FIX] ‡πÉ‡∏ä‡πâ API ‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≤‡∏Å V28.2)
            const result = await saveApi("{{ url_for('teacher.api_set_attendance_status') }}", payload);
            if (!result || result.status !== 'success') {
                console.error("Failed to save attendance");
            }
        }

        function updateAttendanceSummary() {
            let present = 0, absent = 0, late = 0, leave = 0;
            STUDENTS.forEach(student => {
                switch(student.status) {
                    case 'PRESENT': present++; break;
                    case 'ABSENT': absent++; break;
                    case 'LATE': late++; break;
                    case 'LEAVE': leave++; break;
                }
            });
            summaryPresent.textContent = present;
            summaryAbsent.textContent = absent;
            summaryLate.textContent = late;
            summaryLeave.textContent = leave;
            summaryTotal.textContent = STUDENTS.length;
        }

        // ===================================
        // --- 3. SCORING MODULE ---
        // ===================================

        function initScoring() {
            gradedItemSelect.addEventListener('change', () => {
                const selectedItemId = gradedItemSelect.value;
                if (selectedItemId) {
                    scoringPlaceholder.style.display = 'none';
                    renderScoreCards(selectedItemId);
                } else {
                    scoringGrid.innerHTML = '';
                    scoringPlaceholder.style.display = 'block';
                }
            });
            
            scoreGroupToggle.addEventListener('change', handleScoreToggleChange);
            scoreAllToggle.addEventListener('change', handleScoreToggleChange);

            scoringGrid.addEventListener('input', (e) => {
                if (e.target.classList.contains('score-input')) {
                    handleScoreChange(e.target);
                }
            });
        }
        
        function renderScoreCards(itemId) {
            const item = GRADED_ITEMS[itemId];
            if (!item) return;
            
            scoringGrid.innerHTML = ''; 
            
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'score-card';
                card.dataset.studentId = student.id; 
                card.dataset.groupId = STUDENT_GROUP_MAP[student.id] || ''; 
                
                const scoreKey = `${student.id}-${item.id}`;
                const currentScore = SCORES[scoreKey] !== undefined ? SCORES[scoreKey] : '';

                card.innerHTML = `
                    <div class="student-name">(${student.roll || '-'}) ${student.name}</div>
                    <input type="number" 
                           class="form-control score-input" 
                           value="${currentScore}" 
                           min="0" 
                           max="${item.max_score}" 
                           step="0.25"
                           placeholder="-"
                           data-item-id="${item.id}"
                           data-max-score="${item.max_score}">
                `;
                
                scoringGrid.appendChild(card);
            });
        }

        function handleScoreToggleChange(e) {
            if (!e.target.checked) return; 
            const mode = e.target.dataset.mode;
            if (mode === 'group') {
                scoreAllToggle.checked = false;
            } else if (mode === 'all') {
                scoreGroupToggle.checked = false;
            }
        }

        function handleScoreChange(inputElement) {
            if (isScoreDistributing) return;
            isScoreDistributing = true;

            const card = inputElement.closest('.score-card');
            const clickedStudentId = card.dataset.studentId;
            const clickedGroupId = card.dataset.groupId;
            const itemId = inputElement.dataset.itemId;
            const newScoreValue = inputElement.value;
            const maxScore = parseFloat(inputElement.dataset.maxScore);

            let scoreForSave = newScoreValue;
            if (scoreForSave === '') {
                scoreForSave = null; 
                inputElement.classList.remove('is-invalid', 'is-valid');
            } else {
                scoreForSave = parseFloat(scoreForSave);
                if (isNaN(scoreForSave) || scoreForSave < 0) {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                    isScoreDistributing = false;
                    return; 
                } else if (scoreForSave > maxScore) {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                } else {
                    inputElement.classList.add('is-valid');
                    inputElement.classList.remove('is-invalid');
                }
            }
            
            let targetCards = [];
            if (scoreAllToggle.checked) {
                targetCards = Array.from(scoringGrid.querySelectorAll('.score-card'));
            } else if (scoreGroupToggle.checked && clickedGroupId) {
                targetCards = Array.from(scoringGrid.querySelectorAll(`.score-card[data-group-id="${clickedGroupId}"]`));
            } else {
                targetCards = [card];
            }

            let scoresToSave = [];

            targetCards.forEach(targetCard => {
                const studentId = targetCard.dataset.studentId;
                const input = targetCard.querySelector(`.score-input[data-item-id="${itemId}"]`);
                
                if (input && input !== inputElement) {
                    input.value = newScoreValue; 
                    input.className = inputElement.className; 
                }

                const scoreKey = `${studentId}-${itemId}`;
                SCORES[scoreKey] = scoreForSave;

                scoresToSave.push({
                    student_id: parseInt(studentId),
                    graded_item_id: parseInt(itemId),
                    score: scoreForSave
                });
            });

            saveScoresBulk(scoresToSave);
            
            isScoreDistributing = false;
        }
        
        function saveScoresBulk(scoresPayload) {
            clearTimeout(scoreSaveDebounce);
            scoreSaveDebounce = setTimeout(async () => {
                const payload = {
                    scores: scoresPayload,
                    course_id: COURSE_ID
                };
                const result = await saveApi("{{ url_for('teacher.save_scores_bulk') }}", payload);
                if (!result || result.status !== 'success') {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            }, 800);
        }

        // ===================================
        // --- 4. ASSESSMENT MODULE [RE-ARCHITECTED] ---
        // ===================================

        function initAssessment() {
            // 1. Populate Dropdown with TEMPLATES
            populateTemplateDropdown(); // üëà [FIX] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
            
            // 2. Add Listeners
            qualTemplateSelect.addEventListener('change', renderAssessmentGrid); // üëà [FIX] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ID
            
            qualGroupToggle.addEventListener('change', handleQualToggleChange);
            qualAllToggle.addEventListener('change', handleQualToggleChange);
            
            assessmentGrid.addEventListener('click', handleRubricClick);
        }
        
        function populateTemplateDropdown() {
            // üëà [FIX] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            // ‡∏ß‡∏ô Loop ‡∏à‡∏≤‡∏Å ASSESSMENT_DATA.templates ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Template ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!ASSESSMENT_DATA || !ASSESSMENT_DATA.templates || ASSESSMENT_DATA.templates.length === 0) {
                qualTemplateSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ --</option>';
                qualTemplateSelect.disabled = true;
                return;
            }

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á <option> ‡∏à‡∏≤‡∏Å Templates
            ASSESSMENT_DATA.templates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = template.id; // ‡πÉ‡∏ä‡πâ template.id ‡πÄ‡∏õ‡πá‡∏ô value
                option.textContent = template.name; // ‡πÉ‡∏ä‡πâ template.name ‡πÄ‡∏õ‡πá‡∏ô Text
                qualTemplateSelect.appendChild(option);
            });

            // 3. Auto-select (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ template) ‡πÅ‡∏•‡∏∞ Render Grid
            if (ASSESSMENT_DATA.templates.length > 0) {
                qualTemplateSelect.value = ASSESSMENT_DATA.templates[0].id; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                renderAssessmentGrid(); // ‡∏™‡∏±‡πà‡∏á Render Grid ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
        }
        
        function renderAssessmentGrid() {
            // üëà [FIX] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const selectedTemplateId = parseInt(qualTemplateSelect.value);
            
            if (!selectedTemplateId) {
                assessmentGrid.innerHTML = '';
                qualPlaceholder.style.display = 'block';
                return;
            }
            
            qualPlaceholder.style.display = 'none';
            assessmentGrid.innerHTML = '';
            
            // 1. Find the selected Template object
            const template = ASSESSMENT_DATA.templates.find(t => t.id === selectedTemplateId);
            if (!template || !template.topics || template.topics.length === 0) {
                assessmentGrid.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô Template ‡∏ô‡∏µ‡πâ</p>';
                return;
            }
            
            // 2. Loop through STUDENTS and render cards
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'assessment-student-card'; // üëà [FIX] Class ‡πÉ‡∏´‡∏°‡πà
                card.dataset.studentId = student.id;
                card.dataset.groupId = STUDENT_GROUP_MAP[student.id] || '';
                
                let topicsHtml = '';
                
                // 3. Recursive function to render topics/sub-topics
                function renderTopic(topic) {
                    let subTopicsHtml = '';
                    // 3.1 Render children first (Recursive call)
                    if (topic.children && topic.children.length > 0) {
                        topic.children.forEach(subTopic => {
                            subTopicsHtml += renderTopic(subTopic); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢
                        });
                    }
                    
                    // 3.2 Get Rubrics and current score for *this* topic
                    const rubrics = template.rubrics; // Rubrics ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Template
                    const scoreKey = `${student.id}-${topic.id}`;
                    const currentScore = ASSESSMENT_DATA.existing_scores[scoreKey];
                    
                    let buttonsHtml = '';
                    rubrics.forEach(rubric => {
                        const isActive = (currentScore === rubric.value);
                        buttonsHtml += `
                            <button type"button" 
                                    class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-primary'}" 
                                    data-value="${rubric.value}">
                                ${rubric.label}
                            </button>
                        `;
                    });

                    // 3.3 Check if this is a main topic or sub-topic
                    const isSubTopic = topic.children.length === 0; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ Sub-topic
                    const topicClass = isSubTopic ? 'sub-topic' : 'main-topic';
                    const parentTopicId = !isSubTopic ? topic.id : (findParentTopicId(template.topics, topic.id) || '');

                    // 3.4 Create the HTML for this topic row
                    let rowHtml = `
                        <div class="assessment-topic-row ${topicClass}" data-parent-topic-id="${parentTopicId}">
                            <span class="topic-label">${isSubTopic ? '‚Äî ' : ''}${topic.name}</span>
                            <div class="btn-group btn-group-sm w-100 qual-button-group" 
                                 role="group" 
                                 data-topic-id="${topic.id}"
                                 ${isSubTopic ? `data-is-sub-topic="true"` : `data-is-main-topic="true"`}>
                                ${buttonsHtml}
                            </div>
                        </div>
                    `;
                    
                    return rowHtml + subTopicsHtml; // Return this topic + its children
                }
                
                // 4. Start rendering from the top-level topics in the template
                template.topics.forEach(mainTopic => {
                    topicsHtml += renderTopic(mainTopic);
                });

                // 5. Populate the student card
                card.innerHTML = `
                    <div class="student-info">
                        <span class="roll-number">(${student.roll || '-'})</span>
                        ${student.name}
                    </div>
                    <div class="topics-container">
                        ${topicsHtml}
                    </div>
                `;
                assessmentGrid.appendChild(card);
            });
        }
        
        // üëà [FIX] Helper (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
        function findParentTopicId(topics, childId) {
            for (const topic of topics) {
                if (topic.children && topic.children.some(child => child.id === childId)) {
                    return topic.id;
                }
                const foundInChild = findParentTopicId(topic.children || [], childId);
                if (foundInChild) return foundInChild;
            }
            return null;
        }

        // üëà [FIX] Helper (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
        function calculateMode(numbers) {
            // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ null/undefined ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà
            const counts = numbers.reduce((acc, value) => {
                if (value !== null && value !== undefined) {
                    acc[value] = (acc[value] || 0) + 1;
                }
                return acc;
            }, {});

            // 2. ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            let maxFreq = 0;
            let mode = null;
            for (const [value, freq] of Object.entries(counts)) {
                if (freq > maxFreq) {
                    maxFreq = freq;
                    mode = parseFloat(value); // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                }
            }
            return mode;
        }

        function handleQualToggleChange(e) {
            if (!e.target.checked) return; 
            const mode = e.target.dataset.mode;
            if (mode === 'group') {
                qualAllToggle.checked = false; 
            } else if (mode === 'all') {
                qualGroupToggle.checked = false; 
            }
        }
        
        function handleRubricClick(e) {
            // üëà [FIX] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à)
            const button = e.target.closest('.qual-button-group button');
            if (!button || isQualDistributing) return;
            
            isQualDistributing = true;
            
            const buttonGroup = button.closest('.qual-button-group');
            const studentCard = button.closest('.assessment-student-card'); // üëà [FIX]
            
            const topicId = parseInt(buttonGroup.dataset.topicId);
            const clickedStudentId = parseInt(studentCard.dataset.studentId);
            const clickedGroupId = studentCard.dataset.groupId;
            
            const isMainTopic = buttonGroup.dataset.isMainTopic === 'true';
            const isSubTopic = buttonGroup.dataset.isSubTopic === 'true';
            const parentTopicId = parseInt(buttonGroup.closest('.assessment-topic-row').dataset.parentTopicId);

            let newValue;
            
            // 1. X√°c ƒë·ªãnh‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà (newValue)
            if (button.classList.contains('btn-primary')) {
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏° = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                newValue = null; 
            } else {
                newValue = parseFloat(button.dataset.value);
            }
            
            let scoresToSave = []; // Payload ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ API
            
            // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß, ‡∏Å‡∏•‡∏∏‡πà‡∏°, ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
            let targetStudentCards = [];
            if (qualAllToggle.checked) {
                targetStudentCards = Array.from(assessmentGrid.querySelectorAll('.assessment-student-card'));
            } else if (qualGroupToggle.checked && clickedGroupId) {
                targetStudentCards = Array.from(assessmentGrid.querySelectorAll(`.assessment-student-card[data-group-id="${clickedGroupId}"]`));
            } else {
                targetStudentCards = [studentCard]; // ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            }

            // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            targetStudentCards.forEach(card => {
                const studentId = parseInt(card.dataset.studentId);

                // 4. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Top-Down (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å)
                if (isMainTopic) {
                    // 4.1 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
                    updateButtonGroupUI(card, topicId, newValue);
                    scoresToSave.push({ student_id: studentId, topic_id: topicId, score: newValue });

                    // 4.2 ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    const subTopicRows = card.querySelectorAll(`.assessment-topic-row[data-parent-topic-id="${topicId}"]`);
                    subTopicRows.forEach(row => {
                        const subTopicGroup = row.querySelector('.qual-button-group');
                        const subTopicId = parseInt(subTopicGroup.dataset.topicId);
                        updateButtonGroupUI(card, subTopicId, newValue); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                        scoresToSave.push({ student_id: studentId, topic_id: subTopicId, score: newValue }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Payload
                    });
                }
                
                // 5. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Bottom-Up (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢)
                if (isSubTopic) {
                    // 5.1 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                    updateButtonGroupUI(card, topicId, newValue);
                    scoresToSave.push({ student_id: studentId, topic_id: topicId, score: newValue });
                    
                    // 5.2 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì "‡∏ê‡∏≤‡∏ô‡∏ô‡∏¥‡∏¢‡∏°" (Mode)
                    const subTopicRows = card.querySelectorAll(`.assessment-topic-row[data-parent-topic-id="${parentTopicId}"]`);
                    let subTopicValues = [];
                    subTopicRows.forEach(row => {
                        const subTopicGroup = row.querySelector('.qual-button-group');
                        subTopicValues.push(getButtonGroupValue(subTopicGroup));
                    });
                    
                    const modeValue = calculateMode(subTopicValues);
                    
                    // 5.3 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏•‡∏∞ Payload ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
                    updateButtonGroupUI(card, parentTopicId, modeValue);
                    scoresToSave.push({ student_id: studentId, topic_id: parentTopicId, score: modeValue });
                }
            });

            // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            saveQualitativeScore(scoresToSave);
            
            isQualDistributing = false;
        }
        
        // üëà [FIX] Helper (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
        function updateButtonGroupUI(studentCard, topicId, newValue) {
            const buttonGroup = studentCard.querySelector(`.qual-button-group[data-topic-id="${topicId}"]`);
            if (!buttonGroup) return;

            buttonGroup.querySelectorAll('button').forEach(btn => {
                const isActive = (parseFloat(btn.dataset.value) === newValue);
                btn.classList.toggle('btn-primary', isActive);
                btn.classList.toggle('btn-outline-primary', !isActive);
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Model ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            const studentId = studentCard.dataset.studentId;
            const scoreKey = `${studentId}-${topicId}`;
            if (newValue === null) {
                delete ASSESSMENT_DATA.existing_scores[scoreKey];
            } else {
                ASSESSMENT_DATA.existing_scores[scoreKey] = newValue;
            }
        }
        
        // üëà [FIX] Helper (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
        function getButtonGroupValue(buttonGroup) {
            const activeButton = buttonGroup.querySelector('button.btn-primary');
            if (activeButton) {
                return parseFloat(activeButton.dataset.value);
            }
            return null;
        }


        function saveQualitativeScore(scoresPayload) {
            // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Model ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô)
            
            // 1. ‡∏Å‡∏£‡∏≠‡∏á Payload ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏Å -> ‡πÑ‡∏î‡πâ 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            const uniqueScores = new Map();
            scoresPayload.forEach(item => {
                const key = `${item.student_id}-${item.topic_id}`;
                uniqueScores.set(key, item); // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏∞‡∏ä‡∏ô‡∏∞
            });
            const finalPayload = Array.from(uniqueScores.values());

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Model ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ó‡∏≥‡πÉ‡∏ô updateButtonGroupUI ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
            finalPayload.forEach(item => {
                const scoreKey = `${item.student_id}-${item.topic_id}`;
                if (item.score === null) {
                    delete ASSESSMENT_DATA.existing_scores[scoreKey];
                } else {
                    ASSESSMENT_DATA.existing_scores[scoreKey] = item.score;
                }
            });

            // 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Debounced)
            clearTimeout(qualSaveDebounce);
            qualSaveDebounce = setTimeout(async () => {
                const payload = {
                    scores: finalPayload, // üëà [FIX] ‡∏™‡πà‡∏á Payload ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                    course_id: COURSE_ID
                };
                // üëà [FIX] ‡πÉ‡∏ä‡πâ API ‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≤‡∏Å V28.2)
                const result = await saveApi("{{ url_for('teacher.save_qualitative_scores_bulk') }}", payload);
                if (!result || result.status !== 'success') {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            }, 800); 
        }

        // ===================================
        // --- 5. GROUP MANAGEMENT ---
        // ===================================
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)

        function createStudentElement(enrollment) {
            return `<div class="list-group-item list-group-item-action p-2" data-id="${enrollment.id}">
                        <small>${enrollment.roll_number}. ${enrollment.name}</small>
                    </div>`;
        }

        function createGroupCard(group, membersHtml = '') {
            return `
                <div class="card mb-3 group-card" data-group-id="${group.id}">
                    <div class="card-header p-2 d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm group-name-input" value="${group.name}">
                        <button class="btn btn-xs btn-outline-danger ms-2 delete-group-btn border-0">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body p-2 list-group group-dropzone" style="min-height: 50px;">
                        ${membersHtml}
                    </div>
                </div>`;
        }
        
        function renderGroupManagerUI(groups = []) {
            const ungroupedList = document.getElementById('ungrouped-students-list');
            const groupsContainer = document.getElementById('groups-container');
            ungroupedList.innerHTML = '';
            groupsContainer.innerHTML = '';
            const groupedIds = new Set(groups.flatMap(g => g.enrollments));
            allEnrollments.filter(en => !groupedIds.has(en.id))
                .forEach(en => ungroupedList.innerHTML += createStudentElement(en));
            groups.forEach(group => {
                let membersHtml = '';
                allEnrollments.filter(en => group.enrollments.includes(en.id))
                    .forEach(member => membersHtml += createStudentElement(member));
                groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: group.id, name: group.name }, membersHtml));
            });
            initializeAllSortables();
        }
        
        async function saveGroups() {
            const saveBtn = document.getElementById('save-groups-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
            
            const payload = {
                groups: Array.from(document.querySelectorAll('#groups-container .group-card')).map(card => ({
                    id: card.dataset.groupId.startsWith('new-') ? null : parseInt(card.dataset.groupId),
                    name: card.querySelector('.group-name-input').value.trim(),
                    members: Array.from(card.querySelectorAll('.list-group-item[data-id]')).map(item => parseInt(item.dataset.id))
                })).filter(g => g.name),
                course_id: COURSE_ID 
            };
            
            try {
                const response = await fetch(`/teacher/api/plan/${PLAN_ID}/groups`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Server error on save.');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                groupModal.hide();
                
                payload.groups.forEach((group, index) => {
                    const groupId = group.id || `temp-id-${index}`; 
                    group.members.forEach(enrollmentId => {
                        const enrollment = allEnrollments.find(en => en.id === enrollmentId);
                        if(enrollment) {
                           STUDENT_GROUP_MAP[enrollment.student_id] = groupId;
                        }
                    });
                });
                
                const allGroupedStudentIds = new Set(
                    payload.groups.flatMap(g => g.members.map(enId => {
                        const en = allEnrollments.find(e => e.id === enId);
                        return en ? en.student_id : null;
                    }))
                );
                
                STUDENTS.forEach(student => {
                    if (!allGroupedStudentIds.has(student.id)) {
                        delete STUDENT_GROUP_MAP[student.id];
                    }
                });
                
                if (gradedItemSelect.value) renderScoreCards(gradedItemSelect.value);
                if (qualTemplateSelect.value) renderAssessmentGrid(); // üëà [FIX]

            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°';
            }
        }
        
        function initializeAllSortables() {
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];
            document.querySelectorAll('#groupManagementModal .list-group').forEach(list =>
                sortableInstances.push(new Sortable(list, {
                    group: 'students',
                    animation: 150,
                    ghostClass: 'bg-primary-soft'
                }))
            );
        }
        
        async function openGroupManager() {
            if (!PLAN_ID) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'error');
            
            const loader = document.getElementById('group-manager-loader');
            const content = document.getElementById('group-manager-content');
            loader.classList.remove('d-none');
            content.style.display = 'none';
            
            try {
                const groupsUrl = `/teacher/api/plan/${PLAN_ID}/groups?course_id=${COURSE_ID}`; 
                const enrollmentsUrl = `{{ url_for('teacher.get_enrollments_for_classroom', classroom_id=0) }}`.replace('0', CLASSROOM_ID);
                
                const [enrollmentsRes, groupsRes] = await Promise.all([
                    fetch(enrollmentsUrl),
                    fetch(groupsUrl)
                ]);
                
                if (!enrollmentsRes.ok || !groupsRes.ok) throw new Error('Could not fetch initial data.');
                allEnrollments = await enrollmentsRes.json();
                const groups = await groupsRes.json();
                
                renderGroupManagerUI(groups);
                loader.classList.add('d-none');
                content.style.display = 'flex'; 
                initializeAllSortables();
            } catch (error) {
                loader.innerHTML = `<div class="text-danger">${error.message}</div>`;
            }
        }

        // ===================================
        // --- 6. INITIALIZATION ---
        // ===================================
        
        function init() {
            // Tab 1: Attendance
            renderStudentCards();
            
            // Tab 2: Scoring
            initScoring();
            
            // Tab 3: Assessment
            initAssessment(); // üëà [FIX] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà re-architect ‡πÅ‡∏•‡πâ‡∏ß
            
            // Group Management Listeners
            const mobileManageGroupsBtn = document.getElementById('mobile-manage-groups-btn');
            if (mobileManageGroupsBtn) {
                 document.getElementById('groupManagementModal').addEventListener('show.bs.modal', openGroupManager);
            }

            document.getElementById('groupManagementModal').addEventListener('click', async (e) => {
                const target = e.target;
                const groupsContainer = document.getElementById('groups-container');
                if (target.closest('#save-groups-btn')) {
                    saveGroups();
                } else if (target.closest('#add-new-group-btn')) {
                    const groupHtml = createGroupCard({ id: `new-${Date.now()}`, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${groupsContainer.children.length + 1}` }, '');
                    groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
                    initializeAllSortables();
                } else if (target.closest('.delete-group-btn')) {
                    const card = target.closest('.group-card');
                    if (card) {
                        card.querySelectorAll('.list-group-item[data-id]').forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                        card.remove();
                    }
                } else if (target.closest('#auto-generate-groups-btn')) {
                    const { value: numGroups } = await Swal.fire({
                        target: document.getElementById('groupManagementModal'),
                        title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                        input: 'number',
                        inputLabel: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°?',
                        showCancelButton: true,
                        inputValidator: (v) => { if (!v || v < 1) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'; }
                    });
                    if (numGroups) {
                        const students = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));
                        for (let i = students.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [students[i], students[j]] = [students[j], students[i]];
                        }
                        groupsContainer.innerHTML = '';
                        const newGroupElements = [];
                        for (let i = 1; i <= numGroups; i++) {
                            const groupId = `new-${Date.now()}-${i}`;
                            groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${i}` }, ''));
                            newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
                        }
                        if (newGroupElements.length > 0) {
                            students.forEach((studentNode, index) => {
                                newGroupElements[index % numGroups].appendChild(studentNode);
                            });
                        }
                        initializeAllSortables();
                    }
                }
            });
        }
        
        init();

    }); // End DOMContentLoaded
</script>
{% endblock %}