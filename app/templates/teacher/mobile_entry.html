{% extends "mobile_base.html" %}
{% block title %}Mobile Hub - {{ entry.course.subject.name }}{% endblock %}

{% block styles %}
    {{ super() }}
    <style>
        :root {
            --status-present: #d1e7dd;
            --status-absent: #f8d7da;
            --status-late: #fff3cd;
            --status-leave: #e2e3e5;
            --status-border-present: #a3cfbb;
            --status-border-absent: #f1b0b7;
            --status-border-late: #ffe69c;
            --status-border-leave: #adb5bd;
        }
        
        /* 1. Container & Tabs */
        .mobile-entry-container {
            padding-top: 56px; /* Space for fixed navbar */
            padding-bottom: 56px; /* Space for fixed summary bar */
        }
        .nav-tabs .nav-link {
            border-radius: 0;
            font-weight: 500;
            color: var(--bs-gray-600);
            padding: 0.8rem 0.5rem;
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
            border-bottom: 3px solid var(--bs-primary) !important;
            background-color: var(--bs-gray-100);
        }
        .tab-pane {
            background-color: #f8f9fa;
            padding: 1rem;
            min-height: 70vh; 
        }

        /* 2. Attendance Tab */
        #attendanceGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        .student-card {
            border: 2px solid var(--status-border-present);
            background-color: var(--status-present);
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .student-card:active {
            transform: scale(0.95);
        }
        .student-card .student-roll {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }
        .student-card .student-name {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.5em; /* 2 lines height */
            margin-bottom: 0.25rem;
            color: #444;
        }
        .student-card .status-badge {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 1.25rem;
            font-weight: 700;
            opacity: 0.7;
        }
        /* Status Colors */
        .student-card[data-status="PRESENT"] { background-color: var(--status-present); border-color: var(--status-border-present); }
        .student-card[data-status="ABSENT"] { background-color: var(--status-absent); border-color: var(--status-border-absent); }
        .student-card[data-status="LATE"] { background-color: var(--status-late); border-color: var(--status-border-late); }
        .student-card[data-status="LEAVE"] { background-color: var(--status-leave); border-color: var(--status-border-leave); }

        /* Summary Bar */
        #attendanceSummaryBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bs-dark);
            color: white;
            padding: 0.5rem 0.75rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1020;
            border-top: 1px solid var(--bs-gray-700);
        }
        #attendanceSummaryBar .summary-item {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
        }
        #attendanceSummaryBar .summary-count {
            display: block;
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* 3. Scoring Tab */
        #scoringGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        .score-card {
            border: 1px solid var(--bs-gray-300);
            background-color: #fff; 
            border-radius: 0.375rem; 
            padding: 0.5rem;
            text-align: center;
        }
        .score-card .student-name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            height: 2.4em; /* 2 lines */
            overflow: hidden;
        }
        .score-input {
            width: 100%;
            text-align: center;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
        }
        .score-input.is-invalid {
            color: var(--bs-danger);
            border-color: var(--bs-danger);
        }
        .score-input.is-valid {
            color: var(--bs-success);
            border-color: var(--bs-success);
        }

        /* 4. Assessment Tab */
        #assessmentGrid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 0.5rem;
        }
        
        .assessment-card {
            background-color: #fff;
            border: 1px solid var(--bs-gray-300);
            border-radius: 0.375rem;
            padding: 0.75rem;
            display: flex; 
            align-items: center;
            gap: 0.75rem;
        }
        
        .assessment-card .student-info {
            flex-basis: 100px;
            flex-shrink: 0;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .assessment-card .student-info .roll-number {
            font-weight: 700;
            font-size: 1rem;
            color: var(--bs-primary);
        }

        .assessment-card .qual-button-group {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap; 
            gap: 0.25rem; 
            justify-content: flex-end; 
        }
        
        .assessment-card .qual-button-group .btn {
            flex-basis: 60px; 
            flex-grow: 1; 
            border-radius: 0.375rem !important; 
            font-size: 0.8rem; 
            padding: 0.5rem 0.25rem; 
        }

        /* 5. Group Management Modal */
        #ungrouped-students-list {
            position: -webkit-sticky;
            position: sticky;
            top: 1rem;
            max-height: 40vh; /* üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            overflow-y: auto;
        }
        #groups-container {
            max-height: 70vh; /* üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            overflow-y: auto;
        }
    </style>
{% endblock %}

{% block main_content %}
<div id="mobileEntryContainer" 
     class="mobile-entry-container"
     data-entry-id="{{ entry.id }}"
     data-course-id="{{ entry.course.id }}"
     data-date-iso="{{ date_iso }}"
     data-classroom-id="{{ classroom_id_js }}" {# üëà [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3] #}
     data-plan-id="{{ lesson_plan.id if lesson_plan else '' }}"> {# üëà [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3] #}

    {# --- Top Navbar --- #}
    <nav class="navbar navbar-light bg-light fixed-top border-bottom shadow-sm p-2">
        <div class="container-fluid">
            <a href="{{ url_for('teacher.dashboard') }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">‡∏Å‡∏•‡∏±‡∏ö</span>
            </a>
            <div class="flex-grow-1">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-book-fill"></i> {{ entry.course.subject.name }} 
                </h6>
                <small class="text-muted">
                    <i class="bi bi-people-fill"></i> {{ entry.course.classroom.name }} | 
                    <i class="bi bi-clock"></i> ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà {{ entry.slot.period_number }} |
                    <i class="bi bi-calendar-check"></i> {{ attendance_date.strftime('%d/%m/%Y') }}
                </small>
            </div>
            
            {% if lesson_plan %}
            <button class="btn btn-sm btn-outline-primary ms-2" 
                    id="mobile-manage-groups-btn"
                    data-bs-toggle="modal" 
                    data-bs-target="#groupManagementModal">
                <i class="bi bi-people-fill"></i>
            </button>
            {% endif %}

            {# Loading Spinner #}
            <div class="spinner-border spinner-border-sm text-primary ms-2" role="status" id="globalSpinner" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </nav>

    {# --- Nav Tabs --- #}
    <ul class="nav nav-tabs nav-fill sticky-top bg-white" id="mainTabs" role="tablist" style="top: 56px; z-index: 1025;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab" aria-controls="attendance" aria-selected="true">
                <i class="bi bi-check2-circle-fill"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoring" type="button" role="tab" aria-controls="scoring" aria-selected="false">
                <i class="bi bi-pencil-square"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button" role="tab" aria-controls="assessment" aria-selected="false">
                <i class="bi bi-clipboard2-data-fill"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•
            </button>
        </li>
    </ul>

    {# --- Tab Content --- #}
    <div class="tab-content" id="mainTabContent">
        
        {# --- 1. Attendance Tab --- #}
        <div class="tab-pane fade show active" id="attendance" role="tabpanel" aria-labelledby="attendance-tab">
            <p class="text-muted small text-center mb-3">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏°‡∏≤ -> ‡∏Ç‡∏≤‡∏î -> ‡∏•‡∏≤ -> ‡∏™‡∏≤‡∏¢)</p>
            <div id="attendanceGrid">
                {# Student cards will be rendered here by JS #}
            </div>
        </div>

        {# --- 2. Scoring Tab --- #}
        <div class="tab-pane fade" id="scoring" role="tabpanel" aria-labelledby="scoring-tab">
            <div class="mb-3"> 
                <label for="gradedItemSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <select class="form-select" id="gradedItemSelect">
                    <option value="" selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                    {% for item in graded_items %}
                    <option value="{{ item.id }}">{{ item.name }} ({{ item.max_score }} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="d-flex justify-content-center small mb-3">
                <div class="form-check form-switch form-check-inline me-3">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="score-group-toggle" data-mode="group">
                    <label class="form-check-label" for="score-group-toggle">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                </div>
                <div class="form-check form-switch form-check-inline">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="score-all-toggle" data-mode="all">
                    <label class="form-check-label" for="score-all-toggle">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
            </div>
            
            <div id="scoringGrid">
                <p class="text-muted text-center mt-4" id="scoring-placeholder">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
            </div>
        </div>

        {# --- 3. Assessment Tab [REBUILT] --- #}
        <div class="tab-pane fade" id="assessment" role="tabpanel" aria-labelledby="assessment-tab">
            
            <div class="mb-3">
                <label for="qual-topic-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</label>
                <select class="form-select" id="qual-topic-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                    </select>
            </div>

            <div class="d-flex justify-content-center small mb-3">
                <div class="form-check form-switch form-check-inline me-3">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="qual-group-toggle" data-mode="group">
                    <label class="form-check-label" for="qual-group-toggle">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                </div>
                <div class="form-check form-switch form-check-inline">
                    <input class="form-check-input propagation-toggle" type="checkbox" role="switch" id="qual-all-toggle" data-mode="all">
                    <label class="form-check-label" for="qual-all-toggle">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
            </div>

            <div id="assessmentGrid">
                </div>
            
            <div id="qualitative-placeholder" class="text-center text-muted p-4 mt-4" style="display: block;">
                <i class="bi bi-clipboard-check" style="font-size: 3rem;"></i>
                <p class="mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
            </div>
        </div>

    </div>
</div>

{# --- Attendance Summary Bar (Fixed Bottom) --- #}
<div id="attendanceSummaryBar">
    <div class="summary-item" style="color: var(--status-present);">
        ‡∏°‡∏≤
        <span class="summary-count" id="summaryPresent">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-absent);">
        ‡∏Ç‡∏≤‡∏î
        <span class="summary-count" id="summaryAbsent">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-late);">
        ‡∏™‡∏≤‡∏¢
        <span class="summary-count" id="summaryLate">0</span>
    </div>
    <div class="summary-item" style="color: var(--status-leave);">
        ‡∏•‡∏≤
        <span class="summary-count" id="summaryLeave">0</span>
    </div>
    <div class="summary-item text-white">
        ‡∏£‡∏ß‡∏°
        <span class="summary-count" id="summaryTotal">0</span>
    </div>
</div>

<div class="modal fade" id="groupManagementModal" tabindex="-1">
    {# üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô modal-xl ‡πÄ‡∏õ‡πá‡∏ô modal-fullscreen #}
    <div class="modal-dialog modal-fullscreen"> 
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="group-manager-loader">
                    <div class="spinner-border spinner-border-sm me-2"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
                {# üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô row ‡πÄ‡∏õ‡πá‡∏ô d-flex flex-column #}
                <div id="group-manager-content" style="display: none;" class="d-flex flex-column h-100">
                    <div class="mb-3"> {# üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏´‡πà‡∏≠ col-md-4 ‡πÄ‡∏î‡∏¥‡∏° #}
                        <h6>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°</h6>
                        <div id="ungrouped-students-list" class="list-group border p-2"></div>
                    </div>
                    <div class="flex-grow-1"> {# üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏´‡πà‡∏≠ col-md-8 ‡πÄ‡∏î‡∏¥‡∏° #}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="auto-generate-groups-btn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-sm btn-primary" id="add-new-group-btn"><i class="bi bi-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </div>
                        <div id="groups-container"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-groups-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Global State & Constants ---
        const container = document.getElementById('mobileEntryContainer');
        const ENTRY_ID = container.dataset.entryId;
        const COURSE_ID = container.dataset.courseId;
        const DATE_ISO = container.dataset.dateIso;
        const CSRF_TOKEN = "{{ csrf_token() }}";
        const SPINNER = document.getElementById('globalSpinner');
        
        // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3] Add new globals
        const CLASSROOM_ID = container.dataset.classroomId;
        const PLAN_ID = container.dataset.planId;
        let groupModal; // üëà [‡πÉ‡∏´‡∏°‡πà]
        if (document.getElementById('groupManagementModal')) {
             groupModal = new bootstrap.Modal(document.getElementById('groupManagementModal'));
        }
        let allEnrollments = [];
        let sortableInstances = [];

        // Status cycle
        const STATUS_CYCLE = ['PRESENT', 'ABSENT', 'LEAVE', 'LATE'];
        const STATUS_ICONS = {
            'PRESENT': '', 'ABSENT': '‡∏Ç‡∏≤‡∏î', 'LATE': '‡∏™‡∏≤‡∏¢', 'LEAVE': '‡∏•‡∏≤'
        };

        // Data Models
        const STUDENTS = [
            {% for e in enrollments %}
            { id: {{ e.student.id }}, roll: {{ e.roll_number or 'null' }}, name: "{{ e.student.first_name }} {{ e.student.last_name | truncate(15) }}", status: "{{ attendance_records.get(e.student.id, 'PRESENT') }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        const SCORES = {
            {% for key, value in scores.items() %}
            "{{ key }}": {{ value }}{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        const GRADED_ITEMS = {
            {% for item in graded_items %}
            "{{ item.id }}": { id: {{ item.id }}, name: "{{ item.name }}", max_score: {{ item.max_score }} }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        
        // ASSESSMENT DATA
        const ASSESSMENT_TOPICS = JSON.parse('{{ assessment_topics_json|safe }}');
        const ASSESSMENT_DATA = JSON.parse('{{ qualitative_assessment_data_json|safe }}');
        const SUGGESTED_UNIT_ID = {{ suggested_unit_id or 'null' }};
        const STUDENT_GROUP_MAP = JSON.parse('{{ student_group_map_json|safe }}');


        // UI Elements
        const attendanceGrid = document.getElementById('attendanceGrid');
        const summaryPresent = document.getElementById('summaryPresent');
        const summaryAbsent = document.getElementById('summaryAbsent');
        const summaryLate = document.getElementById('summaryLate');
        const summaryLeave = document.getElementById('summaryLeave');
        const summaryTotal = document.getElementById('summaryTotal');
        
        const gradedItemSelect = document.getElementById('gradedItemSelect');
        const scoringGrid = document.getElementById('scoringGrid');
        const scoringPlaceholder = document.getElementById('scoring-placeholder'); // üëà [‡πÉ‡∏´‡∏°‡πà]
        
        // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2] Scoring Toggles
        const scoreGroupToggle = document.getElementById('score-group-toggle');
        const scoreAllToggle = document.getElementById('score-all-toggle');
        let isScoreDistributing = false;
        let scoreSaveDebounce;
        
        // ASSESSMENT UI ELEMENTS
        const qualTopicSelect = document.getElementById('qual-topic-select');
        const assessmentGrid = document.getElementById('assessmentGrid');
        const qualPlaceholder = document.getElementById('qualitative-placeholder');
        const qualGroupToggle = document.getElementById('qual-group-toggle');
        const qualAllToggle = document.getElementById('qual-all-toggle');
        let isQualDistributing = false; 
        let qualSaveDebounce; 

        // --- Helper: Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Helper: API Save ---
        async function saveApi(endpoint, payload) {
            SPINNER.style.display = 'block';
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Server error');
                }
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'API returned an error');
                }
                return result;

            } catch (error) {
                console.error(`Save error at ${endpoint}:`, error);
                // Return the error object for handling
                return { status: 'error', message: error.message }; 
            } finally {
                SPINNER.style.display = 'none';
            }
        }

        
        // ===================================
        // --- 2. ATTENDANCE MODULE ---
        // ===================================
        
        function renderStudentCards() {
            // ... (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            attendanceGrid.innerHTML = '';
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.dataset.studentId = student.id;
                card.dataset.status = student.status;
                const statusIcon = STATUS_ICONS[student.status];
                card.innerHTML = `
                    <div class="student-roll">${student.roll || '-'}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="status-badge">${statusIcon}</div>
                `;
                card.addEventListener('click', () => cycleAttendanceStatus(card, student.id));
                attendanceGrid.appendChild(card);
            });
            updateAttendanceSummary();
        }

        function cycleAttendanceStatus(card, studentId) {
            // ... (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            const currentStatus = card.dataset.status;
            const currentIndex = STATUS_CYCLE.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % STATUS_CYCLE.length;
            const newStatus = STATUS_CYCLE[nextIndex];
            card.dataset.status = newStatus;
            card.querySelector('.status-badge').textContent = STATUS_ICONS[newStatus];
            const student = STUDENTS.find(s => s.id === studentId);
            student.status = newStatus;
            updateAttendanceSummary();
            saveAttendance(studentId, newStatus, card);
        }
        
        async function saveAttendance(studentId, newStatus, card) {
            // ... (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            const payload = {
                student_id: studentId,
                entry_id: ENTRY_ID,
                date: DATE_ISO,
                status: newStatus
            };
            const result = await saveApi("{{ url_for('teacher.api_set_attendance_status') }}", payload);
            if (!result || result.status !== 'success') {
                console.error("Failed to save attendance");
                // Optional: Show an error icon on the card
            }
        }

        function updateAttendanceSummary() {
            // ... (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            let present = 0, absent = 0, late = 0, leave = 0;
            STUDENTS.forEach(student => {
                switch(student.status) {
                    case 'PRESENT': present++; break;
                    case 'ABSENT': absent++; break;
                    case 'LATE': late++; break;
                    case 'LEAVE': leave++; break;
                }
            });
            summaryPresent.textContent = present;
            summaryAbsent.textContent = absent;
            summaryLate.textContent = late;
            summaryLeave.textContent = leave;
            summaryTotal.textContent = STUDENTS.length;
        }

        // ===================================
        // --- 3. SCORING MODULE [REBUILT] ---
        // ===================================

        function initScoring() {
            // 1. Listen for dropdown change
            gradedItemSelect.addEventListener('change', () => {
                const selectedItemId = gradedItemSelect.value;
                if (selectedItemId) {
                    scoringPlaceholder.style.display = 'none';
                    renderScoreCards(selectedItemId);
                } else {
                    scoringGrid.innerHTML = '';
                    scoringPlaceholder.style.display = 'block';
                }
            });
            
            // 2. Listen for toggle changes [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2]
            scoreGroupToggle.addEventListener('change', handleScoreToggleChange);
            scoreAllToggle.addEventListener('change', handleScoreToggleChange);

            // 3. Listen for input changes (delegation) [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2]
            scoringGrid.addEventListener('input', (e) => {
                if (e.target.classList.contains('score-input')) {
                    handleScoreChange(e.target);
                }
            });
        }
        
        function renderScoreCards(itemId) {
            const item = GRADED_ITEMS[itemId];
            if (!item) return;
            
            scoringGrid.innerHTML = ''; // Clear grid
            
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'score-card';
                card.dataset.studentId = student.id; // üëà [‡πÉ‡∏´‡∏°‡πà]
                card.dataset.groupId = STUDENT_GROUP_MAP[student.id] || ''; // üëà [‡πÉ‡∏´‡∏°‡πà]
                
                const scoreKey = `${student.id}-${item.id}`;
                const currentScore = SCORES[scoreKey] !== undefined ? SCORES[scoreKey] : '';

                card.innerHTML = `
                    <div class="student-name">(${student.roll || '-'}) ${student.name}</div>
                    <input type="number" 
                           class="form-control score-input" 
                           value="${currentScore}" 
                           min="0" 
                           max="${item.max_score}" 
                           step="0.25"
                           placeholder="-"
                           data-item-id="${item.id}"
                           data-max-score="${item.max_score}">
                `;
                
                scoringGrid.appendChild(card);
            });
        }

        // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2] New Handler
        function handleScoreToggleChange(e) {
            if (!e.target.checked) return; 
            const mode = e.target.dataset.mode;
            if (mode === 'group') {
                scoreAllToggle.checked = false;
            } else if (mode === 'all') {
                scoreGroupToggle.checked = false;
            }
        }

        // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2] New Handler (Replaces handleScoreSave)
        function handleScoreChange(inputElement) {
            if (isScoreDistributing) return;
            isScoreDistributing = true;

            const card = inputElement.closest('.score-card');
            const clickedStudentId = card.dataset.studentId;
            const clickedGroupId = card.dataset.groupId;
            const itemId = inputElement.dataset.itemId;
            const newScoreValue = inputElement.value;
            const maxScore = parseFloat(inputElement.dataset.maxScore);

            // 1. Validation
            let scoreForSave = newScoreValue;
            if (scoreForSave === '') {
                scoreForSave = null; 
                inputElement.classList.remove('is-invalid', 'is-valid');
            } else {
                scoreForSave = parseFloat(scoreForSave);
                if (isNaN(scoreForSave) || scoreForSave < 0) {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                    isScoreDistributing = false;
                    return; // Don't save invalid input
                } else if (scoreForSave > maxScore) {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                } else {
                    inputElement.classList.add('is-valid');
                    inputElement.classList.remove('is-invalid');
                }
            }
            
            // 2. Propagation Logic
            let targetCards = [];
            if (scoreAllToggle.checked) {
                targetCards = Array.from(scoringGrid.querySelectorAll('.score-card'));
            } else if (scoreGroupToggle.checked && clickedGroupId) {
                targetCards = Array.from(scoringGrid.querySelectorAll(`.score-card[data-group-id="${clickedGroupId}"]`));
            } else {
                targetCards = [card];
            }

            let scoresToSave = [];

            // 3. Update UI and build payload
            targetCards.forEach(targetCard => {
                const studentId = targetCard.dataset.studentId;
                const input = targetCard.querySelector(`.score-input[data-item-id="${itemId}"]`);
                
                if (input && input !== inputElement) {
                    input.value = newScoreValue; // Update UI
                    // (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Validation classes)
                    input.className = inputElement.className; 
                }

                // Update local model
                const scoreKey = `${studentId}-${itemId}`;
                SCORES[scoreKey] = scoreForSave;

                // Add to payload
                scoresToSave.push({
                    student_id: parseInt(studentId),
                    graded_item_id: parseInt(itemId),
                    score: scoreForSave
                });
            });

            // 4. Save (Debounced)
            saveScoresBulk(scoresToSave);
            
            isScoreDistributing = false;
        }
        
        // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2] New Save Function
        function saveScoresBulk(scoresPayload) {
            clearTimeout(scoreSaveDebounce);
            scoreSaveDebounce = setTimeout(async () => {
                const payload = {
                    scores: scoresPayload,
                    course_id: COURSE_ID
                };
                const result = await saveApi("{{ url_for('teacher.save_scores_bulk') }}", payload);
                if (!result || result.status !== 'success') {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            }, 800);
        }

        // ===================================
        // --- 4. ASSESSMENT MODULE [REBUILT] ---
        // ===================================

        function initAssessment() {
            // 1. Populate Dropdown
            populateTopicDropdown();
            
            // 2. Add Listeners
            qualTopicSelect.addEventListener('change', renderAssessmentGrid);
            
            qualGroupToggle.addEventListener('change', handleQualToggleChange);
            qualAllToggle.addEventListener('change', handleQualToggleChange);
            
            assessmentGrid.addEventListener('click', handleRubricClick);
        }
        
        function populateTopicDropdown() {
            let currentUnitId = null;
            let optgroup = null;
            
            ASSESSMENT_TOPICS.forEach(topic => {
                if (topic.unit_id !== currentUnitId) {
                    currentUnitId = topic.unit_id;
                    optgroup = document.createElement('optgroup');
                    optgroup.label = `‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà: ${topic.unit_name}`;
                    qualTopicSelect.appendChild(optgroup);
                }
                
                const option = document.createElement('option');
                option.value = topic.topic_id;
                
                // --- [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1] Add indentation for sub-topics ---
                if (topic.parent_id) {
                    option.textContent = `‚Äî ${topic.topic_name}`;
                    option.style.paddingLeft = "1.5rem";
                } else {
                    option.textContent = topic.topic_name;
                    // option.style.fontWeight = "bold"; // (Optional)
                }
                // --- End [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1] ---
                
                option.dataset.unitId = topic.unit_id;
                
                if (optgroup) {
                    optgroup.appendChild(option);
                } else {
                    qualTopicSelect.appendChild(option);
                }
            });
            
            // 3. Auto-select suggested unit
            if (SUGGESTED_UNIT_ID) {
                const suggestedOption = qualTopicSelect.querySelector(`option[data-unit-id="${SUGGESTED_UNIT_ID}"]`);
                if (suggestedOption) {
                    suggestedOption.selected = true;
                    renderAssessmentGrid(); 
                }
            }
        }
        
        function renderAssessmentGrid() {
            const selectedTopicId = qualTopicSelect.value;
            
            if (!selectedTopicId) {
                assessmentGrid.innerHTML = '';
                qualPlaceholder.style.display = 'block';
                return;
            }
            
            qualPlaceholder.style.display = 'none';
            assessmentGrid.innerHTML = '';
            
            // 1. Find Rubrics for this topic
            const rubrics = findRubricsForTopic(selectedTopicId);
            if (!rubrics || rubrics.length === 0) {
                assessmentGrid.innerHTML = '<p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö Rubric ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Template)</p>';
                return;
            }
            
            // 2. Loop through STUDENTS and render cards
            STUDENTS.forEach(student => {
                const card = document.createElement('div');
                card.className = 'assessment-card';
                card.dataset.studentId = student.id;
                card.dataset.groupId = STUDENT_GROUP_MAP[student.id] || '';
                
                let buttonsHtml = '';
                const scoreKey = `${student.id}-${selectedTopicId}`;
                const currentScore = ASSESSMENT_DATA.existing_scores[scoreKey];
                
                rubrics.forEach(rubric => {
                    const isActive = (currentScore === rubric.value);
                    buttonsHtml += `
                        <button type="button" 
                                class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-primary'}" 
                                data-value="${rubric.value}">
                            ${rubric.label}
                        </button>
                    `;
                });
                
                card.innerHTML = `
                    <div class="student-info">
                        <span class="roll-number">(${student.roll || '-'})</span>
                        ${student.name}
                    </div>
                    <div class="btn-group btn-group-sm w-100 qual-button-group" 
                         role="group" 
                         data-topic-id="${selectedTopicId}">
                        ${buttonsHtml}
                    </div>
                `;
                assessmentGrid.appendChild(card);
            });
        }
        
        function findRubricsForTopic(topicId) {
            // (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            for (const template of ASSESSMENT_DATA.templates) {
                function searchInTopic(topic) {
                    if (topic.id == topicId) return true;
                    if (topic.children) {
                        for (const child of topic.children) {
                            if (searchInTopic(child)) return true;
                        }
                    }
                    return false;
                }
                
                for (const topTopic of template.topics) {
                    if (searchInTopic(topTopic)) {
                        return template.rubrics; 
                    }
                }
            }
            return [];
        }
        
        function handleQualToggleChange(e) {
            // (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            if (!e.target.checked) return; 
            const mode = e.target.dataset.mode;
            if (mode === 'group') {
                qualAllToggle.checked = false; 
            } else if (mode === 'all') {
                qualGroupToggle.checked = false; 
            }
        }
        
        function handleRubricClick(e) {
            // (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            const button = e.target.closest('.qual-button-group button');
            if (!button || isQualDistributing) return;
            
            isQualDistributing = true;
            
            const buttonGroup = button.closest('.qual-button-group');
            const card = button.closest('.assessment-card');
            
            const topicId = buttonGroup.dataset.topicId;
            const clickedStudentId = card.dataset.studentId;
            const clickedGroupId = card.dataset.groupId;
            
            let newValue;
            
            if (button.classList.contains('btn-primary')) {
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
                newValue = null;
            } else {
                newValue = parseFloat(button.dataset.value);
                buttonGroup.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                button.classList.add('btn-primary');
                button.classList.remove('btn-outline-primary');
            }
            
            let scoresToSave = []; 
            
            let targetCards = [];
            if (qualAllToggle.checked) {
                targetCards = Array.from(assessmentGrid.querySelectorAll('.assessment-card'));
            } else if (qualGroupToggle.checked && clickedGroupId) {
                targetCards = Array.from(assessmentGrid.querySelectorAll(`.assessment-card[data-group-id="${clickedGroupId}"]`));
            } else {
                targetCards = [card]; 
            }

            targetCards.forEach(targetCard => {
                const studentId = targetCard.dataset.studentId;
                
                targetCard.querySelectorAll('.qual-button-group button').forEach(btn => {
                    const btnValue = parseFloat(btn.dataset.value);
                    const shouldBeActive = (btnValue === newValue);
                    btn.classList.toggle('btn-primary', shouldBeActive);
                    btn.classList.toggle('btn-outline-primary', !shouldBeActive);
                });
                
                scoresToSave.push({
                    student_id: parseInt(studentId),
                    topic_id: parseInt(topicId),
                    score: newValue
                });
            });

            saveQualitativeScore(scoresToSave);
            
            isQualDistributing = false;
        }

        function saveQualitativeScore(scoresPayload) {
            // (Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ...
            scoresPayload.forEach(item => {
                const scoreKey = `${item.student_id}-${item.topic_id}`;
                if (item.score === null) {
                    delete ASSESSMENT_DATA.existing_scores[scoreKey];
                } else {
                    ASSESSMENT_DATA.existing_scores[scoreKey] = item.score;
                }
            });

            clearTimeout(qualSaveDebounce);
            qualSaveDebounce = setTimeout(async () => {
                const payload = {
                    scores: scoresPayload,
                    course_id: COURSE_ID
                };
                const result = await saveApi("{{ url_for('teacher.save_qualitative_scores_bulk') }}", payload);
                if (!result || result.status !== 'success') {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            }, 800); 
        }

        // ===================================
        // --- 5. GROUP MANAGEMENT [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3] ---
        // ===================================
        // (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å attendance.html ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£)

        function createStudentElement(enrollment) {
            return `<div class="list-group-item list-group-item-action p-2" data-id="${enrollment.id}">
                        <small>${enrollment.roll_number}. ${enrollment.name}</small>
                    </div>`;
        }

        function createGroupCard(group, membersHtml = '') {
            return `
                <div class="card mb-3 group-card" data-group-id="${group.id}">
                    <div class="card-header p-2 d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm group-name-input" value="${group.name}">
                        <button class="btn btn-xs btn-outline-danger ms-2 delete-group-btn border-0">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body p-2 list-group group-dropzone" style="min-height: 50px;">
                        ${membersHtml}
                    </div>
                </div>`;
        }
        
        function renderGroupManagerUI(groups = []) {
            const ungroupedList = document.getElementById('ungrouped-students-list');
            const groupsContainer = document.getElementById('groups-container');
            ungroupedList.innerHTML = '';
            groupsContainer.innerHTML = '';
            const groupedIds = new Set(groups.flatMap(g => g.enrollments));
            allEnrollments.filter(en => !groupedIds.has(en.id))
                .forEach(en => ungroupedList.innerHTML += createStudentElement(en));
            groups.forEach(group => {
                let membersHtml = '';
                allEnrollments.filter(en => group.enrollments.includes(en.id))
                    .forEach(member => membersHtml += createStudentElement(member));
                groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: group.id, name: group.name }, membersHtml));
            });
            initializeAllSortables();
        }
        
        async function saveGroups() {
            const saveBtn = document.getElementById('save-groups-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
            
            const payload = {
                groups: Array.from(document.querySelectorAll('#groups-container .group-card')).map(card => ({
                    id: card.dataset.groupId.startsWith('new-') ? null : parseInt(card.dataset.groupId),
                    name: card.querySelector('.group-name-input').value.trim(),
                    members: Array.from(card.querySelectorAll('.list-group-item[data-id]')).map(item => parseInt(item.dataset.id))
                })).filter(g => g.name),
                course_id: COURSE_ID // üëà ‡πÉ‡∏ä‡πâ Global Var
            };
            
            try {
                // üëà ‡πÉ‡∏ä‡πâ Global Var
                const response = await fetch(`/teacher/api/plan/${PLAN_ID}/groups`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Server error on save.');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                groupModal.hide();
                
                // üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡πâ‡∏≠‡∏á Reload ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô JS
                const newGroupMap = {};
                const newGroupsData = await response.json(); // (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤... ‡∏ã‡∏∂‡πà‡∏á API ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á)
                
                // üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å API ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ payload ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï STUDENT_GROUP_MAP
                payload.groups.forEach((group, index) => {
                    const groupId = group.id || `temp-id-${index}`; // ‡πÉ‡∏ä‡πâ ID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£)
                    group.members.forEach(studentId => {
                        // (BUG: payload ‡πÉ‡∏ä‡πâ enrollment_id, ‡πÅ‡∏ï‡πà MAP ‡πÉ‡∏ä‡πâ student_id)
                        // (BUG 2: allEnrollments ‡πÉ‡∏ä‡πâ enrollment_id)
                        
                        // üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ student_id ‡∏à‡∏≤‡∏Å enrollment_id
                        const enrollment = allEnrollments.find(en => en.id === studentId);
                        if(enrollment) {
                           STUDENT_GROUP_MAP[enrollment.student_id] = groupId;
                        }
                    });
                });
                
                // üëà [‡πÉ‡∏´‡∏°‡πà] Reload ‡∏´‡∏ô‡πâ‡∏≤ Grid ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                if (gradedItemSelect.value) renderScoreCards(gradedItemSelect.value);
                if (qualTopicSelect.value) renderAssessmentGrid();

            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°';
            }
        }
        
        function initializeAllSortables() {
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];
            document.querySelectorAll('#groupManagementModal .list-group').forEach(list =>
                sortableInstances.push(new Sortable(list, {
                    group: 'students',
                    animation: 150,
                    ghostClass: 'bg-primary-soft'
                }))
            );
        }
        
        async function openGroupManager() {
            if (!PLAN_ID) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'error');
            
            const loader = document.getElementById('group-manager-loader');
            const content = document.getElementById('group-manager-content');
            loader.classList.remove('d-none');
            content.style.display = 'none';
            // groupModal.show(); (Modal ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢ Button ‡πÅ‡∏•‡πâ‡∏ß)
            
            try {
                // üëà ‡πÉ‡∏ä‡πâ Global Vars
                const groupsUrl = `/teacher/api/plan/${PLAN_ID}/groups?course_id=${COURSE_ID}`; 
                const enrollmentsUrl = `{{ url_for('teacher.get_enrollments_for_classroom', classroom_id=0) }}`.replace('0', CLASSROOM_ID);
                
                const [enrollmentsRes, groupsRes] = await Promise.all([
                    fetch(enrollmentsUrl),
                    fetch(groupsUrl)
                ]);
                
                if (!enrollmentsRes.ok || !groupsRes.ok) throw new Error('Could not fetch initial data.');
                allEnrollments = await enrollmentsRes.json();
                const groups = await groupsRes.json();
                
                renderGroupManagerUI(groups);
                loader.classList.add('d-none');
                content.style.display = 'flex'; // üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô flex
                initializeAllSortables();
            } catch (error) {
                loader.innerHTML = `<div class="text-danger">${error.message}</div>`;
            }
        }

        // ===================================
        // --- 6. INITIALIZATION ---
        // ===================================
        
        function init() {
            // Tab 1: Attendance
            renderStudentCards();
            
            // Tab 2: Scoring
            initScoring();
            
            // Tab 3: Assessment
            initAssessment();
            
            // [‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3] Group Management Listeners
            const mobileManageGroupsBtn = document.getElementById('mobile-manage-groups-btn');
            if (mobileManageGroupsBtn) {
                 // üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ Modal ‡∏ñ‡∏π‡∏Å *‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î*
                 document.getElementById('groupManagementModal').addEventListener('show.bs.modal', openGroupManager);
            }

            document.getElementById('groupManagementModal').addEventListener('click', async (e) => {
                const target = e.target;
                const groupsContainer = document.getElementById('groups-container');
                if (target.closest('#save-groups-btn')) {
                    saveGroups();
                } else if (target.closest('#add-new-group-btn')) {
                    const groupHtml = createGroupCard({ id: `new-${Date.now()}`, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${groupsContainer.children.length + 1}` }, '');
                    groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
                    initializeAllSortables();
                } else if (target.closest('.delete-group-btn')) {
                    const card = target.closest('.group-card');
                    if (card) {
                        card.querySelectorAll('.list-group-item').forEach(item => document.getElementById('ungrouped-students-list').appendChild(item));
                        card.remove();
                    }
                } else if (target.closest('#auto-generate-groups-btn')) {
                    const { value: numGroups } = await Swal.fire({
                        target: document.getElementById('groupManagementModal'),
                        title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                        input: 'number',
                        inputLabel: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°?',
                        showCancelButton: true,
                        inputValidator: (v) => { if (!v || v < 1) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'; }
                    });
                    if (numGroups) {
                        const students = Array.from(document.querySelectorAll('#ungrouped-students-list .list-group-item[data-id]'));
                        for (let i = students.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [students[i], students[j]] = [students[j], students[i]];
                        }
                        groupsContainer.innerHTML = '';
                        const newGroupElements = [];
                        for (let i = 1; i <= numGroups; i++) {
                            const groupId = `new-${Date.now()}-${i}`;
                            groupsContainer.insertAdjacentHTML('beforeend', createGroupCard({ id: groupId, name: `‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${i}` }, ''));
                            newGroupElements.push(groupsContainer.querySelector(`[data-group-id="${groupId}"] .list-group`));
                        }
                        if (newGroupElements.length > 0) {
                            students.forEach((studentNode, index) => {
                                newGroupElements[index % numGroups].appendChild(studentNode);
                            });
                        }
                        initializeAllSortables();
                    }
                }
            });
        }
        
        init();

    }); // End DOMContentLoaded
</script>
{% endblock %}