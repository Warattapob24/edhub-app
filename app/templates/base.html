<!doctype html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}EdHub{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <meta name="csrf-token" content="{{ csrf_token() }}">

    <style>
        :root {
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
            --header-height: 56px;
        }
        body { font-size: 1rem; overflow-x: hidden; }

        .page-container {
            display: grid;
            /* DEFAULT (DESKTOP) */
            grid-template-columns: var(--sidebar-width) 1fr;
            transition: grid-template-columns 0.2s ease-in-out;
            position: relative;
        }        
        .page-container.sidebar-collapsed {
            grid-template-columns: var(--sidebar-collapsed-width) 1fr;
        }
        
        /* === MOBILE FIXES === */
        @media (max-width: 767px) {
            .page-container {
                /* On mobile, use 1 column to prevent sidebar from occupying space */
                grid-template-columns: 1fr; 
            }
        }
        /* ==================== */


        .sidebar {
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
        }

        /* --- main-content (FIXED: Add padding-top for sticky header) --- */
        .main-content {
            position: relative;
            background-color: #fff;
            /* FIXED: ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Navbar ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Sticky */
            padding-top: var(--header-height); 
            min-height: calc(100vh - var(--header-height, 60px));
            overflow-x: hidden;
        }
        /* FIXED: Remove top padding from the first child element of main-content if it has default padding */
        .main-content > div:first-child {
             padding-top: 0 !important; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏µ padding ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å block ‡∏•‡∏π‡∏Å */
        }
        
        .sidebar-collapsed .sidebar-heading span,
        .sidebar-collapsed .nav-link span {
            display: none;
        }
        .sidebar-collapsed .nav-link {
            justify-content: center;
        }

        #sidebar-toggle { cursor: pointer; }

        /* --- ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ navbar ‡∏ö‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å --- */
        header.navbar {
            position: sticky;
            top: 0;
            height: var(--header-height, 60px);
            z-index: 1030;
        }
    </style>
    {% block styles %}{% endblock %}
</head>

<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow" style="height: var(--header-height);">
        
        {# [NEW] Mobile Toggle (Collapse is handled by CSS and JS for desktop collapse) #}
        <button class="navbar-toggler d-md-none collapsed ms-2" type="button" 
                data-bs-toggle="collapse" data-bs-target="#sidebarMenu" 
                aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6 d-none d-md-block" href="{{ url_for('main.dashboard') }}">EdHub</a>
        <a class="navbar-brand me-0 px-3 fs-6 d-md-none" href="{{ url_for('main.dashboard') }}">EdHub</a>


        <div class="navbar-nav ms-auto flex-row align-items-center">
            <div class="nav-item dropdown">
                <a id="notification-bell" class="nav-link px-3" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {% if g_unread_notifications_count > 0 %}
                        <i class="bi bi-bell-fill fs-5"></i>
                        <span class="badge rounded-pill bg-danger" style="position: absolute; top: 8px; transform: scale(0.7);">
                            {{ g_unread_notifications_count }}
                        </span>
                    {% else %}
                        <i class="bi bi-bell fs-5"></i>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow-lg"
                    id="notification-dropdown-menu"
                    style="width: 350px; max-height: 400px; overflow-y: auto;">
                    <li><h6 class="dropdown-header">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item d-flex gap-2" href="#"><div><div class="fw-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="small text-white-50">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div></div></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-center small" href="#">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
                </ul>
            </div>

            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle fs-5"></i>
                    <span class="d-none d-sm-inline">{{ current_user.first_name or current_user.username }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow-lg">
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="page-container" id="page-container">
        {% block sidebar %}{% endblock %}
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% block main_content %}{% endblock %}
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initSidebarToggle();
            initSidebarScroll();
            initNotificationDropdown();
        });

        /* ==========================
           üß≠ Sidebar Toggle (Desktop Collapse)
        ========================== */
        function initSidebarToggle() {
            const pageContainer = document.getElementById('page-container');
            const toggleButton = document.getElementById('sidebar-toggle'); 

            if (!pageContainer || !toggleButton) return;
            
            // Only enable collapse/expand on desktop screens (>= 768px)
            if (window.innerWidth < 768) return; 

            // Load state from localStorage
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                pageContainer.classList.add('sidebar-collapsed');
            }

            // When click Toggle
            toggleButton.addEventListener('click', () => {
                pageContainer.classList.toggle('sidebar-collapsed');
                const isCollapsed = pageContainer.classList.contains('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            });
        }

        /* ==========================
           üß≠ Sidebar Scroll Position (Used for both Desktop and Mobile)
        ========================== */
        function initSidebarScroll() {
            const sidebar = document.getElementById('sidebarMenu');
            if (!sidebar) return;

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á scroll
            const savedScrollPos = localStorage.getItem('sidebarScrollPos');
            if (savedScrollPos) sidebar.scrollTop = parseInt(savedScrollPos, 10);

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á scroll
            sidebar.addEventListener('click', e => {
                if (e.target.closest('a.nav-link')) {
                    localStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
                    
                    // FIXED: If on mobile (sidebar is collapsed), close it after clicking
                    if (window.innerWidth < 768) {
                        const sidebarCollapse = bootstrap.Collapse.getInstance(document.getElementById('sidebarMenu'));
                        if (sidebarCollapse) sidebarCollapse.hide();
                    }
                }
            });
        }

        /* ==========================
           üîî Notification Dropdown (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
        ========================== */
        function initNotificationDropdown() {
            const bell = document.getElementById('notification-bell');
            const menu = document.getElementById('notification-dropdown-menu');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            if (!bell || !menu) return;

            bell.addEventListener('show.bs.dropdown', async () => {
                menu.innerHTML = `
                    <li><div class="d-flex justify-content-center p-3">
                        <div class="spinner-border spinner-border-sm"></div>
                    </div></li>
                `;
                try {
                    const response = await fetch("{{ url_for('main.get_notifications') }}");
                    if (!response.ok) throw new Error('Fetch failed');
                    const notifications = await response.json();

                    if (!notifications.length) {
                        menu.innerHTML = `<li><a class="dropdown-item text-muted" href="#">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</a></li>`;
                        return;
                    }

                    let listHtml = `
                        <li><h6 class="dropdown-header">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô</h6></li>
                        <li><hr class="dropdown-divider"></li>
                    `;

                    notifications.forEach(n => {
                        listHtml += `
                            <li>
                                <a class="dropdown-item d-flex gap-2 notification-item"
                                   href="${n.url || '#'}"
                                   data-notification-id="${n.id}">
                                    <div>
                                        <div class="fw-bold">${n.title}</div>
                                        <div class="small text-white-50">${n.message}</div>
                                        <div class="small text-muted mt-1">${n.timestamp}</div>
                                    </div>
                                </a>
                            </li>
                        `;
                    });

                    listHtml += `
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center small" href="/notifications">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
                    `;
                    menu.innerHTML = listHtml;

                } catch (err) {
                    console.error('Error fetching notifications:', err);
                    menu.innerHTML = `<li><a class="dropdown-item text-danger" href="#">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</a></li>`;
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚Üí mark ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô
            menu.addEventListener('click', async e => {
                const item = e.target.closest('.notification-item');
                if (!item) return;

                e.preventDefault();
                const notifId = item.dataset.notificationId;
                try {
                    await fetch(`/api/notifications/${notifId}/mark-read`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    window.location.href = item.href;
                } catch (err) {
                    console.error('Failed to mark as read:', err);
                    window.location.href = item.href;
                }
            });
        }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>